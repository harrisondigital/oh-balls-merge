(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const o of s)if(o.type==="childList")for(const n of o.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&i(n)}).observe(document,{childList:!0,subtree:!0});function e(s){const o={};return s.integrity&&(o.integrity=s.integrity),s.referrerPolicy&&(o.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?o.credentials="include":s.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(s){if(s.ep)return;s.ep=!0;const o=e(s);fetch(s.href,o)}})();class ko{constructor(t){this.objectManager=t,this.sceneManager=t.getById("SceneManager"),this.steamHandler=t.getById("SteamHandler"),this.enabled=!1,this.panel=null,this.showObjects=!1,window.logObjectInfo=this.logObjectInfo.bind(this),this.createPanel()}createPanel(){this.panel=document.createElement("div"),this.panel.id="devpanel-panel",this.panel.style.cssText=`
            position: fixed;
            top: 10px;
            right: 10px;
            width: 675px;
            height: calc(100vh - 20px);
            background: rgba(0, 0, 0, 0.9);
            color: #00ff00;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            padding: 10px;
            border: 2px solid #00ff00;
            border-radius: 5px;
            z-index: 1000;
            overflow-y: auto;
            display: none;
        `,this.panel.innerHTML=`
            <span id="devpanel-close" style="position: absolute; top: 10px; right: 10px; cursor: pointer; color: #ff0000; font-size: 20px; font-weight: bold; line-height: 1;">&times;</span>
            <h3 style="margin-top: 0; margin-bottom:5px; color: #00ffff;">ðŸ”§ Dev Panel</h3>
            <div style="border-bottom: 1px solid #00ff00; margin-bottom: 10px; padding-bottom: 5px;">
                <strong id="devpanel-objects-toggle" style="cursor:pointer;">Objects</strong><span id="devpanel-objects-toggle-indicator" style="cursor:pointer;">[+]</span><br/>
                <div id="devpanel-objects-data"></div>
            </div>
            <div style="border-bottom: 1px solid #00ff00; margin-bottom: 10px; padding-bottom: 5px;">
                <div id="devpanel-scene-data"></div>
            </div>
        `,document.body.appendChild(this.panel),this.panel.addEventListener("click",t=>{if(t.target.id==="devpanel-close"){this.enablePanel(!1);return}if(t.target.id==="devpanel-objects-toggle"||t.target.id==="devpanel-objects-toggle-indicator"){this.showObjects=!this.showObjects;return}})}enablePanel(t){this.enabled=t,this.panel.style.display=this.enabled?"block":"none"}renderPanel(){if(!this.enabled)return;const t=document.getElementById("devpanel-objects-data"),e=document.getElementById("devpanel-scene-data");if(t){t.style.display=this.showObjects?"block":"none";const i=document.getElementById("devpanel-objects-toggle-indicator");if(i&&(i.textContent=this.showObjects?"[-]":"[+]"),this.showObjects){const s=this.objectManager.getAllObjects(),o=new Map;Array.from(t.children).forEach(n=>{n.dataset.key&&o.set(n.dataset.key,n)}),s.forEach(({key:n,object:a})=>{let h=o.get(n);const m=this.getObjectState(a);h?o.delete(n):(h=document.createElement("div"),h.dataset.key=n,h.innerHTML=`${n}:<span style="color: grey; cursor:pointer" onclick="logObjectInfo('${n}', this)">[+]</span>:<span class="obj-state"></span> `,t.appendChild(h));const c=h.querySelector(".obj-state");c&&c.innerHTML!==m&&(c.innerHTML=m)}),o.forEach(n=>n.remove())}}e&&this.sceneManager&&this.sceneManager.currentScene&&(e.innerHTML=this.sceneManager.currentScene.getSceneStateHtml())}getObjectState(t){let e=typeof t?.getObjectStateHtml=="function"?t.getObjectStateHtml():"";return e?`<span style='color:#ffff00;'>&nbsp;${e}</span>`:""}logObjectInfo(t,e){const i=this.objectManager.getById(t);i&&typeof i.logObjectInfo=="function"?(e.style.color="yellow",i.logObjectInfo()):e.style.color="red",setTimeout(()=>{e.style.color="grey"},1e3)}destroy(){this.panel&&document.body.removeChild(this.panel),delete window.doAlert}}function vt(r,t,e,i,s,o){if(o===0){r.rect(t,e,i,s);return}o=Math.min(o,i/2,s/2),r.beginPath(),r.moveTo(t+o,e),r.lineTo(t+i-o,e),r.arcTo(t+i,e,t+i,e+o,o),r.lineTo(t+i,e+s-o),r.arcTo(t+i,e+s,t+i-o,e+s,o),r.lineTo(t+o,e+s),r.arcTo(t,e+s,t,e+s-o,o),r.lineTo(t,e+o),r.arcTo(t,e,t+o,e,o),r.closePath()}function Rs(r,t){if(typeof r=="string")return r;const e=r.style||t.style||"normal",i=r.weight||t.weight||"normal",s=r.size||t.size||16,o=r.family||t.family||"Arial";let n="";return e!=="normal"&&(n+=e+" "),i!=="normal"&&(n+=i+" "),`${n}${s}px ${o}`}function Ns(r,t,e){const i=r.split(`
`),s=[];for(const o of i){const n=o.trim();if(n===""){s.push("");continue}const a=n.split(" ");let h="";for(const m of a){const c=h?`${h} ${m}`:m;e(c).width>t&&h?(s.push(h),h=m):h=c}s.push(h)}return s}class Fo{constructor(t,e={}){if(this.canvas=t,this.ctx=t.getContext("2d"),this.controls=[],this.focusIndex=-1,this.modals=[],this.toasts=[],this.images=[],this.texts=[],this.theme={controlColor:"#4CAF50",controlSurfaceColor:"#333333",controlTextColor:"#ffffff",controlBorderColor:"#666666",controlFocusBorderColor:"#4CAF50",controlClickColor:"#388E3C",menuButtonColor:"#4CAF50",menuButtonActiveColor:"#388E3C",menuButtonClickColor:"#2E7D32",menuButtonBorderColor:"#666666",menuButtonFocusBorderColor:"#4CAF50",menuButtonFontSize:16,modalSurfaceColor:"#222222",modalBorderColor:"#888888",modalTextColor:"#ffffff",modalText2Color:"#cccccc",modalTextFontSize:18,modalText2FontSize:14,panelSurfaceColor:"#2a2a2a",panelBorderColor:"#4CAF50",borderRadius:6,borderWidth:2,fontFamily:"Arial",fontSize:16,padding:10},this.defaultFont={family:"Arial",size:16,weight:"normal",style:"normal"},this.options={backgroundColor:e.backgroundColor||"#1a1a1a",backgroundGradient:e.backgroundGradient||null,...e},!e.input)throw new Error("MarkJSCanvasUI requires an input manager. Pass an instance via options.input (e.g., new MarkJSInput(canvas))");this.input=e.input,this.keys=this.input.keys,this.mouse=this.input.mouse,this.gamepad=this.input.gamepad,this.onEscape=null,this.inputSubscription=this.input.subscribe(this)}destroy(){this.inputSubscription&&(this.inputSubscription.unsubscribe(),this.inputSubscription=null),this.controls=[],this.modals=[],this.toasts=[],this.images=[],this.texts=[],this.focusIndex=-1,this.onEscape=null}getCanvasMousePosition(t){const e=this.canvas.getBoundingClientRect(),i=this.canvas.width/e.width,s=this.canvas.height/e.height;return{x:(t.clientX-e.left)*i,y:(t.clientY-e.top)*s}}onKeyDown(t){if(this.keys[t.key]=!0,t.key==="Escape"){if(this.modals.length>0){const e=this.modals[this.modals.length-1];e.handleKeyDown&&e.handleKeyDown(t)}else this.onEscape&&this.onEscape();t.preventDefault();return}if(this.modals.length>0){const e=this.modals[this.modals.length-1];e.handleKeyDown&&e.handleKeyDown(t);return}if(t.key==="Tab"){t.preventDefault(),t.shiftKey?this.focusPrevious():this.focusNext();return}if(this.focusIndex>=0&&this.focusIndex<this.controls.length){const e=this.controls[this.focusIndex];e.handleKeyDown&&e.handleKeyDown(t)}}onKeyUp(t){}onMouseMove(t,e){this.updateCursor(t,e)}updateCursor(t,e){let i=!1;if(this.modals.length>0){const s=this.modals[this.modals.length-1];s.isOverButton&&s.isOverButton(t,e)&&(i=!0)}else for(let s=this.controls.length-1;s>=0;s--){const o=this.controls[s];if(o.constructor.name!=="Panel"){if(o.isOverInteractiveArea){if(o.isOverInteractiveArea(t,e)){i=!0;break}}else if(o.containsPoint(t,e)){i=!0;break}}}this.canvas.style.cursor=i?"pointer":"default"}onMouseDown(t,e,i){}onMouseUp(t,e,i){}onMouseClick(t,e,i){if(this.modals.length>0){this.modals[this.modals.length-1].handleClick(t,e,i);return}for(let s=this.controls.length-1;s>=0;s--){const o=this.controls[s];if(o.containsPoint(t,e)){this.focusIndex=s,o.handleClick&&o.handleClick(t,e,i);break}}}onGamepadConnected(t){}onTouchStart(t,e){this.onMouseDown(t,e,0)}onTouchMove(t,e){this.onMouseMove(t,e)}onTouchEnd(t,e){this.onMouseUp(t,e,0),this.onMouseClick(t,e,0)}onGamepadButton(t){if(this.modals.length>0){const e=this.modals[this.modals.length-1];e.handleGamepadButton&&e.handleGamepadButton(t);return}if(t===0){if(this.focusIndex>=0&&this.focusIndex<this.controls.length){const e=this.controls[this.focusIndex];e.activate&&e.activate()}}else if(t===1)this.onEscape&&this.onEscape();else if(t===12)this.focusPrevious();else if(t===13)this.focusNext();else if(t===14){if(this.focusIndex>=0&&this.focusIndex<this.controls.length){const e=this.controls[this.focusIndex];e.handleGamepadAxis?e.handleGamepadAxis(-1):e.handleGamepadLeft&&e.handleGamepadLeft()}}else if(t===15&&this.focusIndex>=0&&this.focusIndex<this.controls.length){const e=this.controls[this.focusIndex];e.handleGamepadAxis?e.handleGamepadAxis(1):e.handleGamepadRight&&e.handleGamepadRight()}}focusNext(){this.controls.length!==0&&(this.focusIndex=(this.focusIndex+1)%this.controls.length)}focusPrevious(){this.controls.length!==0&&(this.focusIndex=(this.focusIndex-1+this.controls.length)%this.controls.length)}focusControl(t){if(this.controls.length===0||t===null||t===void 0)return!1;const e=typeof t=="number"?t:this.controls.indexOf(t);return e>=0&&e<this.controls.length?(this.focusIndex=e,!0):!1}addControl(t){return t.manager=this,t.applyTheme(),this.controls.push(t),this.focusIndex===-1&&this.controls.length===1&&(this.focusIndex=0),t}getThemeValue(t,e){return this.theme[t]!==void 0?this.theme[t]:e}removeControl(t){const e=this.controls.indexOf(t);e>-1&&(this.controls.splice(e,1),this.focusIndex>=this.controls.length&&(this.focusIndex=this.controls.length-1))}removeAllControls(){this.controls=[],this.focusIndex=-1,this.texts=[],this.images=[],this.modals=[],this.toasts=[],this.onEscape=null}removeAllControlsExceptToasts(){this.controls=[],this.focusIndex=-1,this.texts=[],this.images=[],this.modals=[],this.onEscape=null}addText(t,e,i,s={}){const o=s.textColor||this.theme.textColor;let n;if(s.font)n=s.font;else{const h={};(s.fontFamily||s.family)&&(h.family=s.fontFamily||s.family),(s.fontSize||s.size)&&(h.size=s.fontSize||s.size),(s.fontWeight||s.weight)&&(h.weight=s.fontWeight||s.weight),(s.fontStyle||s.style)&&(h.style=s.fontStyle||s.style),n=Rs(h,this.defaultFont)}const a={text:t,x:e,y:i,font:n,color:o,align:s.align||"left",baseline:s.baseline||"top"};return this.texts.push(a),a}addImage(t,e,i,s,o){const n={image:t,x:e,y:i,width:s,height:o};return this.images.push(n),n}setBackground(t){this.options.backgroundColor=t,this.options.backgroundGradient=null,this.options.noBackground=!1}setBackgroundGradient(t,e="diagonal"){this.options.backgroundGradient=t,this.options.gradientDirection=e,this.options.noBackground=!1}setBackgroundNone(){this.options.noBackground=!0}setTheme(t={}){this.theme={...this.theme,...t},t.backgroundColor&&(this.options.backgroundColor=t.backgroundColor),(t.fontFamily||t.fontSize||t.fontWeight||t.fontStyle||t.family||t.size||t.weight||t.style)&&(this.defaultFont={...this.defaultFont,family:t.fontFamily||t.family||this.defaultFont.family,size:t.fontSize||t.size||this.defaultFont.size,weight:t.fontWeight||t.weight||this.defaultFont.weight,style:t.fontStyle||t.style||this.defaultFont.style})}showModal(t,e,i=[],s={}){const o=new qo(this,t,e,i,s);return this.modals.push(o),o}closeModal(t){const e=this.modals.indexOf(t);e>-1&&this.modals.splice(e,1)}showToast(t,e="info",i=3e3){const s=new Ro(this,t,e,i);return this.toasts.push(s),setTimeout(()=>{const o=this.toasts.indexOf(s);o>-1&&this.toasts.splice(o,1)},i),s}update(t){for(let e of this.controls)e.update&&e.update(t);for(let e of this.modals)e.update&&e.update(t)}render(){if(!this.options.noBackground){if(this.options.backgroundGradient){const t=this.options.gradientDirection||"diagonal";let e;t==="horizontal"?e=this.ctx.createLinearGradient(0,0,this.canvas.width,0):t==="vertical"?e=this.ctx.createLinearGradient(0,0,0,this.canvas.height):e=this.ctx.createLinearGradient(0,0,this.canvas.width,this.canvas.height);for(let i of this.options.backgroundGradient)e.addColorStop(i.offset,i.color);this.ctx.fillStyle=e}else this.ctx.fillStyle=this.options.backgroundColor;this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)}for(let t=0;t<this.controls.length;t++){const e=this.controls[t];e.constructor.name==="Panel"&&e.draw(this.ctx,!1)}for(let t of this.images)t.image.complete&&this.ctx.drawImage(t.image,t.x,t.y,t.width,t.height);for(let t of this.texts)this.ctx.font=t.font,this.ctx.fillStyle=t.color,this.ctx.textAlign=t.align,this.ctx.textBaseline=t.baseline,this.ctx.fillText(t.text,t.x,t.y);for(let t=0;t<this.controls.length;t++){const e=this.controls[t];if(e.constructor.name!=="Panel"){const i=t===this.focusIndex;e.draw(this.ctx,i)}}for(let t of this.modals)t.draw(this.ctx);for(let t=0;t<this.toasts.length;t++)this.toasts[t].draw(this.ctx,t)}}class Ei{constructor(t,e,i,s,o={}){this.x=t,this.y=e,this.width=i,this.height=s,this.manager=null,this._rawOptions=o,this.options={controlColor:"#4CAF50",controlSurfaceColor:"#333333",controlTextColor:"#ffffff",controlBorderColor:"#666666",controlFocusBorderColor:"#4CAF50",controlClickColor:"#388E3C",menuButtonColor:"#4CAF50",menuButtonActiveColor:"#388E3C",menuButtonClickColor:"#2E7D32",menuButtonBorderColor:"#666666",menuButtonFocusBorderColor:"#4CAF50",menuButtonFontSize:16,panelSurfaceColor:"#2a2a2a",panelBorderColor:"#4CAF50",borderRadius:6,borderWidth:2,fontFamily:"Arial",fontSize:16,padding:10,...o}}applyTheme(){if(!this.manager)return;const t=this.manager.theme,e=this.manager.defaultFont,i={controlColor:t.controlColor,controlSurfaceColor:t.controlSurfaceColor,controlTextColor:t.controlTextColor,textColor:t.controlTextColor,controlBorderColor:t.controlBorderColor,controlFocusBorderColor:t.controlFocusBorderColor,controlClickColor:t.controlClickColor,menuButtonColor:t.menuButtonColor,menuButtonActiveColor:t.menuButtonActiveColor,menuButtonClickColor:t.menuButtonClickColor,menuButtonBorderColor:t.menuButtonBorderColor,menuButtonFocusBorderColor:t.menuButtonFocusBorderColor,menuButtonFontSize:t.menuButtonFontSize,panelSurfaceColor:t.panelSurfaceColor,panelBorderColor:t.panelBorderColor,borderRadius:t.borderRadius,borderWidth:t.borderWidth,fontFamily:t.fontFamily,fontSize:t.fontSize,padding:t.padding};if(this._rawOptions.font)i.font=this._rawOptions.font;else{const s={};(this._rawOptions["font-family"]||this._rawOptions.fontFamily)&&(s.family=this._rawOptions["font-family"]||this._rawOptions.fontFamily),(this._rawOptions["font-size"]||this._rawOptions.fontSize)&&(s.size=this._rawOptions["font-size"]||this._rawOptions.fontSize),(this._rawOptions["font-weight"]||this._rawOptions.fontWeight)&&(s.weight=this._rawOptions["font-weight"]||this._rawOptions.fontWeight),(this._rawOptions["font-style"]||this._rawOptions.fontStyle)&&(s.style=this._rawOptions["font-style"]||this._rawOptions.fontStyle),i.font=Rs(s,e)}this.options={...i,...this._rawOptions},this.options.font||(this.options.font=Rs({},e))}containsPoint(t,e){return t>=this.x&&t<=this.x+this.width&&e>=this.y&&e<=this.y+this.height}drawBase(t,e){const i=this.options.borderRadius;t.fillStyle=this.options.controlSurfaceColor,i>0?(vt(t,this.x,this.y,this.width,this.height,i),t.fill()):t.fillRect(this.x,this.y,this.width,this.height),t.strokeStyle=e?this.options.controlFocusBorderColor:this.options.controlBorderColor,t.lineWidth=this.options.borderWidth,i>0?(vt(t,this.x,this.y,this.width,this.height,i),t.stroke()):t.strokeRect(this.x,this.y,this.width,this.height)}draw(t,e){this.drawBase(t,e)}}class Os extends Ei{constructor(t,e,i,s={}){const o=s.orientation||"vertical",n=s.gap||0,a=s.width||200,h=s.height||50;let m,c;o==="horizontal"?(m=i.length*a+(i.length-1)*n,c=h):(m=a,c=i.length*h+(i.length-1)*n),super(t,e,m,c,s),this.itemWidth=a,this.itemHeight=h,this.items=i,this.selectedIndex=0,this.orientation=o,this.gap=n,this.pressed=!1,this.pressedTime=0,this.pressedDuration=300}isOverInteractiveArea(t,e){for(let i=0;i<this.items.length;i++){const s=this.getItemBounds(i);if(t>=s.x&&t<=s.x+s.width&&e>=s.y&&e<=s.y+s.height)return!0}return!1}handleClick(t,e){for(let i=0;i<this.items.length;i++){const s=this.getItemBounds(i);if(t>=s.x&&t<=s.x+s.width&&e>=s.y&&e<=s.y+s.height){this.selectedIndex=i,this.pressed=!0,this.pressedTime=0,this.items[i].callback&&setTimeout(()=>{this.items[i].callback()},this.pressedDuration);break}}}getItemBounds(t){return this.orientation==="horizontal"?{x:this.x+t*(this.itemWidth+this.gap),y:this.y,width:this.itemWidth,height:this.itemHeight}:{x:this.x,y:this.y+t*(this.itemHeight+this.gap),width:this.itemWidth,height:this.itemHeight}}handleKeyDown(t){const e=this.orientation==="vertical",i=e?"ArrowUp":"ArrowLeft",s=e?"ArrowDown":"ArrowRight";t.key===i||t.key==="ArrowUp"||t.key==="ArrowLeft"?(this.selectedIndex=(this.selectedIndex-1+this.items.length)%this.items.length,t.preventDefault()):t.key===s||t.key==="ArrowDown"||t.key==="ArrowRight"?(this.selectedIndex=(this.selectedIndex+1)%this.items.length,t.preventDefault()):(t.key==="Enter"||t.key===" ")&&(this.pressed=!0,this.pressedTime=0,this.items[this.selectedIndex].callback&&setTimeout(()=>{this.items[this.selectedIndex].callback()},this.pressedDuration),t.preventDefault())}handleGamepadLeft(){this.selectedIndex=(this.selectedIndex-1+this.items.length)%this.items.length}handleGamepadRight(){this.selectedIndex=(this.selectedIndex+1)%this.items.length}activate(){this.pressed=!0,this.pressedTime=0,this.items[this.selectedIndex].callback&&setTimeout(()=>{this.items[this.selectedIndex].callback()},this.pressedDuration)}update(t){this.pressed&&(this.pressedTime+=t,this.pressedTime>=this.pressedDuration&&(this.pressed=!1,this.pressedTime=0))}draw(t,e){const i=this.options.borderRadius;for(let s=0;s<this.items.length;s++){const o=this.getItemBounds(s),n=s===this.selectedIndex;let a=this.options.menuButtonColor||this.options.controlColor;n&&this.pressed?a=this.options.menuButtonClickColor||this.options.menuButtonActiveColor||this.options.controlClickColor:n&&e?a=this.options.menuButtonActiveColor||this.options.controlColor:n?a=this.options.menuButtonColor||this.options.controlColor:a=this.options.controlSurfaceColor,t.fillStyle=a,i>0?(vt(t,o.x,o.y,o.width,o.height,i),t.fill()):t.fillRect(o.x,o.y,o.width,o.height);let h=this.options.menuButtonBorderColor||this.options.controlBorderColor;e&&n&&(h=this.options.menuButtonFocusBorderColor||this.options.controlFocusBorderColor),t.strokeStyle=h,t.lineWidth=this.options.borderWidth,i>0?(vt(t,o.x,o.y,o.width,o.height,i),t.stroke()):t.strokeRect(o.x,o.y,o.width,o.height),t.font=`${this.options.menuButtonFontSize||this.options.fontSize}px ${this.options.fontFamily}`,t.fillStyle=this.options.controlTextColor,t.textAlign="center",t.textBaseline="middle",t.fillText(this.items[s].label,o.x+o.width/2,o.y+o.height/2)}}}class Lo extends Ei{constructor(t,e,i,s,o,n={}){const a=n.width||250,h=n.height||50;super(t,e,a,h,n),this.label=i,this.value=s,this.callback=o}isOverInteractiveArea(t,e){const o=this.x+this.width-50-this.options.padding,n=this.y+(this.height-25)/2;return t>=o&&t<=o+50&&e>=n&&e<=n+25}handleClick(t,e){this.toggle()}handleKeyDown(t){(t.key==="Enter"||t.key===" ")&&(this.toggle(),t.preventDefault())}activate(){this.toggle()}toggle(){this.value=!this.value,this.callback&&this.callback(this.value)}draw(t,e){this.drawBase(t,e),t.font=this.options.font,t.fillStyle=this.options.textColor,t.textAlign="left",t.textBaseline="middle",t.fillText(this.label,this.x+this.options.padding,this.y+this.height/2);const i=50,s=25,n=this.x+this.width-i-this.options.padding-8,a=this.y+(this.height-s)/2,h=this.options.borderRadius>0?Math.min(s/2,this.options.borderRadius):s/2;t.fillStyle=this.value?this.options.controlColor:this.options.controlSurfaceColor,vt(t,n,a,i,s,h),t.fill();const m=18,c=3,_=this.value?n+i-m-c:n+c,d=a+(s-m)/2,u=this.options.borderRadius>0?Math.min(m/2,this.options.borderRadius):m/2;t.fillStyle=this.value?"#ffffff":"#cccccc",vt(t,_,d,m,m,u),t.fill(),t.strokeStyle=this.value?this.options.controlColor:"#888888",t.lineWidth=2,vt(t,_,d,m,m,u),t.stroke(),this.value||(t.strokeStyle="#888888",t.lineWidth=2,vt(t,n,a,i,s,h),t.stroke())}}class Ho extends Ei{constructor(t,e,i,s,o,n,a={}){const h=a.orientation||"horizontal",m=a.width||250,c=a.height||60;super(t,e,m,c,a),this.items=i,this.selectedIndex=s,this.label=o,this.callback=n,this.orientation=h,this.arrowSize=a.arrowSize||12}getArrowBounds(){return this.orientation==="horizontal"?{left:{x:this.x+this.options.padding,y:this.y,width:this.arrowSize*2,height:this.height},right:{x:this.x+this.width-this.options.padding-this.arrowSize*2,y:this.y,width:this.arrowSize*2,height:this.height}}:{up:{x:this.x,y:this.y+this.options.padding,width:this.width,height:this.arrowSize*2},down:{x:this.x,y:this.y+this.height-this.options.padding-this.arrowSize*2,width:this.width,height:this.arrowSize*2}}}containsPointInBounds(t,e,i){return t>=i.x&&t<=i.x+i.width&&e>=i.y&&e<=i.y+i.height}isOverInteractiveArea(t,e){const i=this.getArrowBounds();return this.orientation==="horizontal"?this.containsPointInBounds(t,e,i.left)||this.containsPointInBounds(t,e,i.right):this.containsPointInBounds(t,e,i.up)||this.containsPointInBounds(t,e,i.down)}handleClick(t,e){const i=this.getArrowBounds();this.orientation==="horizontal"?this.containsPointInBounds(t,e,i.left)?this.selectPrevious():this.containsPointInBounds(t,e,i.right)&&this.selectNext():this.containsPointInBounds(t,e,i.up)?this.selectPrevious():this.containsPointInBounds(t,e,i.down)&&this.selectNext()}selectPrevious(){this.selectedIndex=(this.selectedIndex-1+this.items.length)%this.items.length,this.callback&&this.callback(this.selectedIndex,this.items[this.selectedIndex])}selectNext(){this.selectedIndex=(this.selectedIndex+1)%this.items.length,this.callback&&this.callback(this.selectedIndex,this.items[this.selectedIndex])}handleKeyDown(t){this.orientation==="horizontal"?t.key==="ArrowLeft"?(this.selectPrevious(),t.preventDefault()):t.key==="ArrowRight"&&(this.selectNext(),t.preventDefault()):t.key==="ArrowUp"?(this.selectPrevious(),t.preventDefault()):t.key==="ArrowDown"&&(this.selectNext(),t.preventDefault())}handleGamepadLeft(){this.selectPrevious()}handleGamepadRight(){this.selectNext()}drawTriangle(t,e,i,s){const o=this.arrowSize;t.fillStyle=this.options.controlColor,t.beginPath(),s==="left"?(t.moveTo(e+o/2,i-o/2),t.lineTo(e+o/2,i+o/2),t.lineTo(e-o/2,i)):s==="right"?(t.moveTo(e-o/2,i-o/2),t.lineTo(e-o/2,i+o/2),t.lineTo(e+o/2,i)):s==="up"?(t.moveTo(e-o/2,i+o/2),t.lineTo(e+o/2,i+o/2),t.lineTo(e,i-o/2)):s==="down"&&(t.moveTo(e-o/2,i-o/2),t.lineTo(e+o/2,i-o/2),t.lineTo(e,i+o/2)),t.closePath(),t.fill()}draw(t,e){const i=this.options.borderRadius;t.fillStyle=this.options.controlSurfaceColor,i>0?(vt(t,this.x,this.y,this.width,this.height,i),t.fill()):t.fillRect(this.x,this.y,this.width,this.height);let s,o=0,n=this.y;if(this.label){t.font=`${this.options.fontSize}px ${this.options.fontFamily}`,t.fillStyle=this.options.controlTextColor,t.textAlign="left",t.textBaseline="top",t.fillText(this.label,this.x+this.options.padding,this.y+this.options.padding);const a=t.measureText(this.label);o=(a.actualBoundingBoxAscent+a.actualBoundingBoxDescent||16)+this.options.padding*1,n=this.y+o;const m=this.height-o;s=n+m/2}else s=this.y+this.height/2;if(this.orientation==="horizontal"){const a=this.x+this.options.padding+this.arrowSize;this.drawTriangle(t,a,s,"left");const h=this.x+this.width-this.options.padding-this.arrowSize;this.drawTriangle(t,h,s,"right"),t.font=this.options.font,t.fillStyle=this.options.textColor,t.textAlign="center",t.textBaseline="middle",t.fillText(this.items[this.selectedIndex],this.x+this.width/2,s)}else{this.height-o;const a=this.x+this.width/2,h=n+this.options.padding+this.arrowSize;this.drawTriangle(t,a,h,"up");const m=this.x+this.width/2,c=this.y+this.height-this.options.padding-this.arrowSize;this.drawTriangle(t,m,c,"down"),t.font=this.options.font,t.fillStyle=this.options.textColor,t.textAlign="center",t.textBaseline="middle",t.fillText(this.items[this.selectedIndex],this.x+this.width/2,s)}t.strokeStyle=e?this.options.controlFocusBorderColor:this.options.controlBorderColor,t.lineWidth=this.options.borderWidth,i>0?(vt(t,this.x,this.y,this.width,this.height,i),t.stroke()):t.strokeRect(this.x,this.y,this.width,this.height)}}class Do extends Ei{constructor(t,e,i,s,o,n,a,h,m={}){const c=m.width||300,_=m.height||80;super(t,e,c,_,m),this.min=i,this.max=s,this.value=o,this.step=n,this.label=a,this.callback=h,this.dragging=!1,this.zeroText=m.zeroText}isOverInteractiveArea(t,e){const i=this.y+this.height/2,s=this.x+this.options.padding,o=this.width-this.options.padding*2,n=4,a=(this.value-this.min)/(this.max-this.min),h=20,m=s+o*a-h/2,c=i-h/2,_=5;return t>=m-_&&t<=m+h+_&&e>=c-_&&e<=c+h+_||t>=s&&t<=s+o&&e>=i-n*2&&e<=i+n*2}handleClick(t,e){this.updateValueFromX(t)}handleKeyDown(t){t.key==="ArrowLeft"?(this.value=Math.max(this.min,this.value-this.step),this.callback&&this.callback(this.value),t.preventDefault()):t.key==="ArrowRight"&&(this.value=Math.min(this.max,this.value+this.step),this.callback&&this.callback(this.value),t.preventDefault())}handleGamepadAxis(t){t<0?this.value=Math.max(this.min,this.value-this.step):this.value=Math.min(this.max,this.value+this.step),this.callback&&this.callback(this.value)}updateValueFromX(t){const e=this.x+this.options.padding,i=this.width-this.options.padding*2,s=Math.max(0,Math.min(1,(t-e)/i));let o=this.min+s*(this.max-this.min);o=Math.round(o/this.step)*this.step,o=Math.max(this.min,Math.min(this.max,o)),o!==this.value&&(this.value=o,this.callback&&this.callback(this.value))}draw(t,e){this.drawBase(t,e),t.font=this.options.font,t.fillStyle=this.options.textColor,t.textAlign="left",t.textBaseline="top",t.fillText(this.label,this.x+this.options.padding,this.y+this.options.padding);const i=this.y+this.height/2,s=this.x+this.options.padding,o=this.width-this.options.padding*2,n=4,a=this.options.borderRadius>0?Math.min(n/2,this.options.borderRadius/2):n/2;t.fillStyle="#666666",vt(t,s,i-n/2,o,n,a),t.fill();const h=(this.value-this.min)/(this.max-this.min);t.fillStyle=this.options.controlColor,vt(t,s,i-n/2,o*h,n,a),t.fill();const m=20,_=s+o*h-m/2,d=s,u=s+o-m,f=Math.max(d,Math.min(u,_)),p=i-m/2,v=this.options.borderRadius>0?Math.min(m/2,this.options.borderRadius):m/2;t.fillStyle=this.options.controlColor,vt(t,f,p,m,m,v),t.fill(),t.strokeStyle=this.options.controlColor,t.lineWidth=2,vt(t,f,p,m,m,v),t.stroke(),t.font=this.options.font,t.fillStyle=this.options.textColor,t.textAlign="right",t.textBaseline="bottom";const y=this.value===0&&this.zeroText?this.zeroText:this.value.toString();t.fillText(y,this.x+this.width-this.options.padding,this.y+this.height-this.options.padding)}}class Eo extends Ei{constructor(t,e,i={}){const s=i.width||500,o=i.height||500;let n,a;i.manager&&i.manager.theme&&(n=i.manager.theme.panelSurfaceColor,a=i.manager.theme.panelBorderColor),super(t,e,s,o,{...i,panelSurfaceColor:i.panelSurfaceColor||n,panelBorderColor:i.panelBorderColor||a})}draw(t,e){const i=this.options.borderRadius||0;t.fillStyle=this.options.backgroundColor||this.options.panelSurfaceColor||this.options.controlSurfaceColor,i>0?(vt(t,this.x,this.y,this.width,this.height,i),t.fill()):t.fillRect(this.x,this.y,this.width,this.height),this.options.borderWidth>0&&(t.strokeStyle=this.options.borderColor||this.options.panelBorderColor||this.options.controlBorderColor,t.lineWidth=this.options.borderWidth,i>0?(vt(t,this.x,this.y,this.width,this.height,i),t.stroke()):t.strokeRect(this.x,this.y,this.width,this.height))}containsPoint(t,e){return!1}}class qo{constructor(t,e,i,s=[],o={}){this.manager=t,this.title=e,this.message=i,this.buttons=s.length>0?s:[{label:"OK",callback:()=>this.close()}],this.escapeButtonLabel=o.escapeButtonLabel||null;const n=t.theme;this.colors={modalSurfaceColor:o.modalSurfaceColor||n.modalSurfaceColor,modalBorderColor:o.modalBorderColor||n.modalBorderColor,modalTextColor:o.modalTextColor||n.modalTextColor,modalText2Color:o.modalText2Color||n.modalText2Color,menuButtonColor:o.menuButtonColor||n.menuButtonColor,menuButtonActiveColor:o.menuButtonActiveColor||n.menuButtonActiveColor,menuButtonClickColor:o.menuButtonClickColor||n.menuButtonClickColor,menuButtonBorderColor:o.menuButtonBorderColor||n.menuButtonBorderColor,menuButtonFocusBorderColor:o.menuButtonFocusBorderColor||n.menuButtonFocusBorderColor},this.textFontColor=o.textFontColor||n.controlTextColor,this.textFontSize=o.modalTextFontSize||n.modalTextFontSize,this.text2FontColor=o.text2FontColor||n.controlTextColor,this.text2FontSize=o.modalText2FontSize||n.modalText2FontSize,this.borderWidth=o.borderWidth||n.borderWidth,this.borderRadius=o.borderRadius||n.borderRadius;const a=t.canvas;if(this.overlayAlpha=.7,o.width&&o.height)this.width=Math.min(o.width,a.width*.9),this.height=Math.min(o.height,a.height*.9);else{const w=a.getContext("2d");w.font="18px Arial";const M=Math.min(600,a.width*.8)-40,S=Ns(i,M,W=>w.measureText(W)),C=Math.max(1,S.length),V=this.textFontSize+7,H=60,E=C*V+40,q=90,j=200;this.height=Math.max(j,Math.min(H+E+q,a.height*.8)),this.width=Math.min(600,a.width*.8)}this.x=(a.width-this.width)/2,this.y=(a.height-this.height)/2;const h=50,m=150,c=20,_=this.buttons.length*m+(this.buttons.length-1)*c,d=this.x+(this.width-_)/2,u=this.y+this.height-h-20,f=this.buttons.map(w=>({label:w.label,callback:()=>{w.callback&&w.callback(),this.close()}})),{menuButtonColor:p,menuButtonActiveColor:v,menuButtonClickColor:y,menuButtonBorderColor:x,menuButtonFocusBorderColor:A}=o;this.buttonMenu=new Os(d,u,f,{orientation:"horizontal",width:m,height:h,gap:c,menuButtonColor:p||t.theme.menuButtonColor,menuButtonActiveColor:v||t.theme.menuButtonActiveColor,menuButtonClickColor:y||t.theme.menuButtonClickColor,menuButtonBorderColor:x||t.theme.menuButtonBorderColor,menuButtonFocusBorderColor:A||t.theme.menuButtonFocusBorderColor,menuButtonFontSize:o.menuButtonFontSize||t.theme.menuButtonFontSize,controlTextColor:this.textFontColor,fontSize:this.textFontSize,borderWidth:this.borderWidth,borderRadius:this.borderRadius,padding:10}),this.buttonMenu.manager=t,this.buttonMenu.applyTheme()}handleClick(t,e){this.buttonMenu.isOverInteractiveArea(t,e)&&this.buttonMenu.handleClick(t,e)}handleKeyDown(t){if(t.key==="Escape"){let e=null;this.escapeButtonLabel?e=this.buttons.find(i=>i.label.toLowerCase()===this.escapeButtonLabel.toLowerCase()):e=this.buttons.find(i=>["exit","close","cancel"].includes(i.label.toLowerCase())),e&&e.callback&&e.callback(),this.close(),t.preventDefault()}else this.buttonMenu.handleKeyDown(t)}handleGamepadButton(t){if(t===1){let e=null;this.escapeButtonLabel?e=this.buttons.find(i=>i.label.toLowerCase()===this.escapeButtonLabel.toLowerCase()):e=this.buttons.find(i=>["exit","close","cancel"].includes(i.label.toLowerCase())),e&&e.callback&&e.callback(),this.close()}else t===0?this.buttonMenu.activate():t===14?this.buttonMenu.handleGamepadLeft():t===15&&this.buttonMenu.handleGamepadRight()}close(){this.manager.closeModal(this)}update(t){this.buttonMenu.update&&this.buttonMenu.update(t)}isOverButton(t,e){return this.buttonMenu.isOverInteractiveArea(t,e)}draw(t){const e=this.borderRadius;t.fillStyle=`rgba(0, 0, 0, ${this.overlayAlpha})`,t.fillRect(0,0,t.canvas.width,t.canvas.height),t.fillStyle=this.colors.modalSurfaceColor,vt(t,this.x,this.y,this.width,this.height,e),t.fill(),t.strokeStyle=this.colors.modalBorderColor,t.lineWidth=this.borderWidth,vt(t,this.x,this.y,this.width,this.height,e),t.stroke(),t.font="bold 24px Arial",t.fillStyle=this.colors.modalTextColor,t.textAlign="center",t.textBaseline="top",t.fillText(this.title,this.x+this.width/2,this.y+20),t.font=`${this.textFontSize}px Arial`,t.fillStyle=this.colors.modalTextColor,t.textAlign="center",t.textBaseline="top";const i=this.width-40,s=this.textFontSize+7,o=Ns(this.message,i,h=>t.measureText(h));let n=this.y+80,a=n;for(const h of o)t.fillText(h,this.x+this.width/2,n),a=n,n+=s;this.colors.modalText2Color&&this.options&&this.options.text2&&(t.font=`${this.text2FontSize}px Arial`,t.fillStyle=this.colors.modalText2Color,t.textAlign="center",t.textBaseline="top",t.fillText(this.options.text2,this.x+this.width/2,a+s+10)),this.buttonMenu&&this.buttonMenu.draw&&this.buttonMenu.draw(t,!0)}}class Ro{constructor(t,e,i,s){this.manager=t,this.message=e,this.type=i,this.duration=s,this.width=300,this.height=80,this.padding=15,this.typeConfig={info:{color:"#2196F3",icon:"â„¹"},success:{color:"#4CAF50",icon:"âœ“"},warning:{color:"#FF9800",icon:"âš "},error:{color:"#F44336",icon:"âœ•"},achievement:{color:"#FFD700",icon:"â˜…"}},this.config=this.typeConfig[i]||this.typeConfig.info}draw(t,e){const s=t.canvas.width-this.width-20,o=20+e*(this.height+10);t.fillStyle="#2a2a2a",t.fillRect(s,o,this.width,this.height),t.strokeStyle=this.config.color,t.lineWidth=3,t.strokeRect(s,o,this.width,this.height);const n=40,a=s+this.padding+n/2,h=o+this.height/2;t.fillStyle=this.config.color,t.beginPath(),t.arc(a,h,n/2,0,Math.PI*2),t.fill(),t.font=this.type==="achievement"?"bold 30px Arial":"bold 24px Arial",t.fillStyle="#fff",t.textAlign="center",t.textBaseline="middle",t.fillText(this.config.icon,a,h),t.font="14px Arial",t.fillStyle="#ffffff",t.textAlign="left",t.textBaseline="middle";const m=this.width-n-this.padding*3,c=s+n+this.padding*2,_=Ns(this.message,m,p=>t.measureText(p)),d=18,u=_.length*d;let f=o+(this.height-u)/2+d/2;for(let p of _)t.fillText(p.trim(),c,f),f+=d}}class No{constructor(t){this.objectManager=t,this.canvas=t.getById("Main").canvas,this.configManager=this.objectManager.getById("ConfigManager");const i=this.objectManager.getById("CanvasInputHandler").canvasInputMark;this.canvasUIMark=this.objectManager.register("MarkJSCanvasUI",new Fo(this.canvas,{backgroundColor:"#0080FF",input:i}))}setTheme(t={}){this.canvasUIMark.setTheme(t)}focusControl(t){this.canvasUIMark.focusControl(t)}addButton(t,e,i,s,o={}){const n=new Os(t,e,[{label:i,callback:s}],{...o});return this.canvasUIMark.addControl(n)}addToggle(t,e,i,s,o,n={}){const a=new Lo(t,e,i,s,o,{...n});return this.canvasUIMark.addControl(a)}addSlider(t,e,i,s,o,n,a,h,m={}){const c=new Do(t,e,s,o,n,a,i,h,{...m});return this.canvasUIMark.addControl(c)}addCarousel(t,e,i,s,o,n,a={}){let h=s.indexOf(o);h===-1&&(h=0);const m=new Ho(t,e,s,h,i,n,{...a});return this.canvasUIMark.addControl(m)}addMenu(t,e,i,s={}){const o=new Os(t,e,i,{...s});return this.canvasUIMark.addControl(o)}addPanel(t,e,i={}){const s=new Eo(t,e,{...i});return this.canvasUIMark.addControl(s)}removeControl(t){return this.canvasUIMark.removeControl(t)}removeAllControls(){this.canvasUIMark.removeAllControlsExceptToasts()}addText(t,e,i,s={}){this._addedTexts||(this._addedTexts=[]);const o=this.canvasUIMark.addText(t,e,i,s);return this._addedTexts.push({text:t,x:e,y:i,options:s}),o}restoreControlsAndTexts(){if(this.removeAllControls(),this._addedTexts)for(const t of this._addedTexts)this.canvasUIMark.addText(t.text,t.x,t.y,t.options)}addImage(t,e,i,s,o){return this.canvasUIMark.addImage(t,e,i,s,o)}setBackground(t){this.canvasUIMark.setBackground(t)}setBackgroundGradient(t,e="diagonal"){this.canvasUIMark.setBackgroundGradient(t,e)}setBackgroundNone(){this.canvasUIMark.setBackgroundNone()}showModal(t,e,i=[],s={}){return this.canvasUIMark.showModal(t,e,i,s)}showToast(t,e="info",i=5e3){return this.canvasUIMark.showToast(t,e,i)}setOnEscape(t){this.canvasUIMark.onEscape=t}clearOnEscape(){this.canvasUIMark.onEscape=null}update(t){this.canvasUIMark.update(t),this.canvasUIMark.render()}getcanvasUIMark(){return this.canvasUIMark}destroy(){this.canvasUIMark.destroy(),this.objectManager.deregister(this.canvasUIMark)}}class oe{constructor(t){this.objectManager=t,this.configManager=t.getById("ConfigManager"),this.sceneManager=t.getById("SceneManager"),this.translationManager=t.getById("TranslationManager"),this.canvas=t.getById("Main").canvas,this.ctx=this.canvas.getContext("2d"),this.nextScene=null}setbackground(){this.canvasUIHandler.setBackgroundGradient([{offset:0,color:"#0a0e27"},{offset:.5,color:"#1a1f3a"},{offset:1,color:"#2d3561"}],"diagonal")}enter(){this.canvasInputHandler=this.objectManager.getById("CanvasInputHandler"),this.canvasUIHandler=this.objectManager.getById("CanvasUIHandler"),typeof this.enterSub=="function"&&this.enterSub()}exit(){typeof this.exitSub=="function"&&this.exitSub()}updateFrame(t){return this.nextScene!=null?this.nextScene:(this.canvasInputHandler.update(t),this.canvasUIHandler.update(t),null)}getSceneStateHtml(){return`
        <strong>Scene: ${this.registeredName||this.constructor.name}</strong><br>
    `}txt(t){return this.translationManager.translate(t)}}var Us=function(r,t){return Us=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,i){e.__proto__=i}||function(e,i){for(var s in i)Object.prototype.hasOwnProperty.call(i,s)&&(e[s]=i[s])},Us(r,t)};function At(r,t){if(typeof t!="function"&&t!==null)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");Us(r,t);function e(){this.constructor=r}r.prototype=t===null?Object.create(t):(e.prototype=t.prototype,new e)}var bt=function(){return bt=Object.assign||function(t){for(var e,i=1,s=arguments.length;i<s;i++){e=arguments[i];for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o])}return t},bt.apply(this,arguments)},Et=function(r,t){(r===null||typeof r>"u")&&(r={});var e=bt({},r);for(var i in t)t.hasOwnProperty(i)&&typeof r[i]>"u"&&(e[i]=t[i]);if(typeof Object.getOwnPropertySymbols=="function")for(var s=Object.getOwnPropertySymbols(t),o=0;o<s.length;o++){var n=s[o];t.propertyIsEnumerable(n)&&typeof r[n]>"u"&&(e[n]=t[n])}return e},Oo=Math.random,wt=1e-9,Uo=Number.isFinite;function jo(r){return r|=r>>1,r|=r>>2,r|=r>>4,r|=r>>8,r|=r>>16,r+1}function Go(r){return r>0&&(r&r-1)===0}function uo(r,t,e){return typeof t>"u"?(e=1,t=0):typeof e>"u"&&(e=t,t=0),e>t?(r=(r-t)%(e-t),r+(r<0?e:t)):(r=(r-e)%(t-e),r+(r<=0?t:e))}function yt(r,t,e){return r<t?t:r>e?e:r}function Wo(r,t){return typeof r>"u"?(t=1,r=0):typeof t>"u"&&(t=r,r=0),r===t?r:Oo()*(t-r)+r}var Qe=Object.create(Math);Qe.EPSILON=wt;Qe.isFinite=Uo;Qe.nextPowerOfTwo=jo;Qe.isPowerOfTwo=Go;Qe.mod=uo;Qe.clamp=yt;Qe.random=Wo;var sr=Math.abs,ys=Math.sqrt,rr=Math.max,or=Math.min,l=(function(){function r(t,e){if(!(this instanceof r))return new r(t,e);typeof t>"u"?(this.x=0,this.y=0):typeof t=="object"?(this.x=t.x,this.y=t.y):(this.x=t,this.y=e)}return r.prototype._serialize=function(){return{x:this.x,y:this.y}},r._deserialize=function(t){var e=Object.create(r.prototype);return e.x=t.x,e.y=t.y,e},r.zero=function(){var t=Object.create(r.prototype);return t.x=0,t.y=0,t},r.neo=function(t,e){var i=Object.create(r.prototype);return i.x=t,i.y=e,i},r.clone=function(t){return r.neo(t.x,t.y)},r.prototype.toString=function(){return JSON.stringify(this)},r.isValid=function(t){return t===null||typeof t>"u"?!1:Number.isFinite(t.x)&&Number.isFinite(t.y)},r.assert=function(t){},r.prototype.clone=function(){return r.clone(this)},r.prototype.setZero=function(){return this.x=0,this.y=0,this},r.prototype.set=function(t,e){return typeof t=="object"?(this.x=t.x,this.y=t.y):(this.x=t,this.y=e),this},r.prototype.setNum=function(t,e){return this.x=t,this.y=e,this},r.prototype.setVec2=function(t){return this.x=t.x,this.y=t.y,this},r.prototype.wSet=function(t,e,i,s){return typeof i<"u"||typeof s<"u"?this.setCombine(t,e,i,s):this.setMul(t,e)},r.prototype.setCombine=function(t,e,i,s){var o=t*e.x+i*s.x,n=t*e.y+i*s.y;return this.x=o,this.y=n,this},r.prototype.setMul=function(t,e){var i=t*e.x,s=t*e.y;return this.x=i,this.y=s,this},r.prototype.add=function(t){return this.x+=t.x,this.y+=t.y,this},r.prototype.wAdd=function(t,e,i,s){return typeof i<"u"||typeof s<"u"?this.addCombine(t,e,i,s):this.addMul(t,e)},r.prototype.addCombine=function(t,e,i,s){var o=t*e.x+i*s.x,n=t*e.y+i*s.y;return this.x+=o,this.y+=n,this},r.prototype.addMul=function(t,e){var i=t*e.x,s=t*e.y;return this.x+=i,this.y+=s,this},r.prototype.wSub=function(t,e,i,s){return typeof i<"u"||typeof s<"u"?this.subCombine(t,e,i,s):this.subMul(t,e)},r.prototype.subCombine=function(t,e,i,s){var o=t*e.x+i*s.x,n=t*e.y+i*s.y;return this.x-=o,this.y-=n,this},r.prototype.subMul=function(t,e){var i=t*e.x,s=t*e.y;return this.x-=i,this.y-=s,this},r.prototype.sub=function(t){return this.x-=t.x,this.y-=t.y,this},r.prototype.mul=function(t){return this.x*=t,this.y*=t,this},r.prototype.length=function(){return r.lengthOf(this)},r.prototype.lengthSquared=function(){return r.lengthSquared(this)},r.prototype.normalize=function(){var t=this.length();if(t<wt)return 0;var e=1/t;return this.x*=e,this.y*=e,t},r.normalize=function(t){var e=r.lengthOf(t);if(e<wt)return r.zero();var i=1/e;return r.neo(t.x*i,t.y*i)},r.lengthOf=function(t){return ys(t.x*t.x+t.y*t.y)},r.lengthSquared=function(t){return t.x*t.x+t.y*t.y},r.distance=function(t,e){var i=t.x-e.x,s=t.y-e.y;return ys(i*i+s*s)},r.distanceSquared=function(t,e){var i=t.x-e.x,s=t.y-e.y;return i*i+s*s},r.areEqual=function(t,e){return t===e||typeof e=="object"&&e!==null&&t.x===e.x&&t.y===e.y},r.skew=function(t){return r.neo(-t.y,t.x)},r.dot=function(t,e){return t.x*e.x+t.y*e.y},r.cross=function(t,e){return typeof e=="number"?r.neo(e*t.y,-e*t.x):typeof t=="number"?r.neo(-t*e.y,t*e.x):t.x*e.y-t.y*e.x},r.crossVec2Vec2=function(t,e){return t.x*e.y-t.y*e.x},r.crossVec2Num=function(t,e){return r.neo(e*t.y,-e*t.x)},r.crossNumVec2=function(t,e){return r.neo(-t*e.y,t*e.x)},r.addCross=function(t,e,i){if(typeof i=="number")return r.neo(i*e.y+t.x,-i*e.x+t.y);if(typeof e=="number")return r.neo(-e*i.y+t.x,e*i.x+t.y)},r.addCrossVec2Num=function(t,e,i){return r.neo(i*e.y+t.x,-i*e.x+t.y)},r.addCrossNumVec2=function(t,e,i){return r.neo(-e*i.y+t.x,e*i.x+t.y)},r.add=function(t,e){return r.neo(t.x+e.x,t.y+e.y)},r.wAdd=function(t,e,i,s){return typeof i<"u"||typeof s<"u"?r.combine(t,e,i,s):r.mulNumVec2(t,e)},r.combine=function(t,e,i,s){return r.zero().setCombine(t,e,i,s)},r.sub=function(t,e){return r.neo(t.x-e.x,t.y-e.y)},r.mul=function(t,e){if(typeof t=="object")return r.neo(t.x*e,t.y*e);if(typeof e=="object")return r.neo(t*e.x,t*e.y)},r.mulVec2Num=function(t,e){return r.neo(t.x*e,t.y*e)},r.mulNumVec2=function(t,e){return r.neo(t*e.x,t*e.y)},r.prototype.neg=function(){return this.x=-this.x,this.y=-this.y,this},r.neg=function(t){return r.neo(-t.x,-t.y)},r.abs=function(t){return r.neo(sr(t.x),sr(t.y))},r.mid=function(t,e){return r.neo((t.x+e.x)*.5,(t.y+e.y)*.5)},r.upper=function(t,e){return r.neo(rr(t.x,e.x),rr(t.y,e.y))},r.lower=function(t,e){return r.neo(or(t.x,e.x),or(t.y,e.y))},r.prototype.clamp=function(t){var e=this.x*this.x+this.y*this.y;if(e>t*t){var i=t/ys(e);this.x*=i,this.y*=i}return this},r.clamp=function(t,e){var i=r.neo(t.x,t.y);return i.clamp(e),i},r.clampVec2=function(t,e,i){return{x:yt(t.x,e?.x,i?.x),y:yt(t.y,e?.y,i?.y)}},r.scaleFn=function(t,e){return function(i){return r.neo(i.x*t,i.y*e)}},r.translateFn=function(t,e){return function(i){return r.neo(i.x+t,i.y+e)}},r})(),Rt=Math.max,Nt=Math.min,ut=(function(){function r(t,e){if(!(this instanceof r))return new r(t,e);this.lowerBound=l.zero(),this.upperBound=l.zero(),typeof t=="object"&&this.lowerBound.setVec2(t),typeof e=="object"?this.upperBound.setVec2(e):typeof t=="object"&&this.upperBound.setVec2(t)}return r.prototype.isValid=function(){return r.isValid(this)},r.isValid=function(t){return t===null||typeof t>"u"?!1:l.isValid(t.lowerBound)&&l.isValid(t.upperBound)&&l.sub(t.upperBound,t.lowerBound).lengthSquared()>=0},r.assert=function(t){},r.prototype.getCenter=function(){return l.neo((this.lowerBound.x+this.upperBound.x)*.5,(this.lowerBound.y+this.upperBound.y)*.5)},r.prototype.getExtents=function(){return l.neo((this.upperBound.x-this.lowerBound.x)*.5,(this.upperBound.y-this.lowerBound.y)*.5)},r.prototype.getPerimeter=function(){return 2*(this.upperBound.x-this.lowerBound.x+this.upperBound.y-this.lowerBound.y)},r.prototype.combine=function(t,e){e=e||this;var i=t.lowerBound,s=t.upperBound,o=e.lowerBound,n=e.upperBound,a=Nt(i.x,o.x),h=Nt(i.y,o.y),m=Rt(n.x,s.x),c=Rt(n.y,s.y);this.lowerBound.setNum(a,h),this.upperBound.setNum(m,c)},r.prototype.combinePoints=function(t,e){this.lowerBound.setNum(Nt(t.x,e.x),Nt(t.y,e.y)),this.upperBound.setNum(Rt(t.x,e.x),Rt(t.y,e.y))},r.prototype.set=function(t){this.lowerBound.setNum(t.lowerBound.x,t.lowerBound.y),this.upperBound.setNum(t.upperBound.x,t.upperBound.y)},r.prototype.contains=function(t){var e=!0;return e=e&&this.lowerBound.x<=t.lowerBound.x,e=e&&this.lowerBound.y<=t.lowerBound.y,e=e&&t.upperBound.x<=this.upperBound.x,e=e&&t.upperBound.y<=this.upperBound.y,e},r.prototype.extend=function(t){return r.extend(this,t),this},r.extend=function(t,e){return t.lowerBound.x-=e,t.lowerBound.y-=e,t.upperBound.x+=e,t.upperBound.y+=e,t},r.testOverlap=function(t,e){var i=e.lowerBound.x-t.upperBound.x,s=t.lowerBound.x-e.upperBound.x,o=e.lowerBound.y-t.upperBound.y,n=t.lowerBound.y-e.upperBound.y;return!(i>0||o>0||s>0||n>0)},r.areEqual=function(t,e){return l.areEqual(t.lowerBound,e.lowerBound)&&l.areEqual(t.upperBound,e.upperBound)},r.diff=function(t,e){var i=Rt(0,Nt(t.upperBound.x,e.upperBound.x)-Rt(e.lowerBound.x,t.lowerBound.x)),s=Rt(0,Nt(t.upperBound.y,e.upperBound.y)-Rt(e.lowerBound.y,t.lowerBound.y)),o=t.upperBound.x-t.lowerBound.x,n=t.upperBound.y-t.lowerBound.y,a=e.upperBound.x-e.lowerBound.x,h=e.upperBound.y-e.lowerBound.y;return o*n+a*h-i*s},r.prototype.rayCast=function(t,e){var i=-1/0,s=1/0,o=e.p1,n=l.sub(e.p2,e.p1),a=l.abs(n),h=l.zero();if(a.x<wt){if(o.x<this.lowerBound.x||this.upperBound.x<o.x)return!1}else{var m=1/n.x,c=(this.lowerBound.x-o.x)*m,_=(this.upperBound.x-o.x)*m,d=-1;if(c>_){var u=c;c=_,_=u,d=1}if(c>i&&(h.setZero(),h.x=d,i=c),s=Nt(s,_),i>s)return!1}if(a.y<wt){if(o.y<this.lowerBound.y||this.upperBound.y<o.y)return!1}else{var m=1/n.y,c=(this.lowerBound.y-o.y)*m,_=(this.upperBound.y-o.y)*m,d=-1;if(c>_){var u=c;c=_,_=u,d=1}if(c>i&&(h.setZero(),h.y=d,i=c),s=Nt(s,_),i>s)return!1}return i<0||e.maxFraction<i?!1:(t.fraction=i,t.normal=h,!0)},r.prototype.toString=function(){return JSON.stringify(this)},r.combinePoints=function(t,e,i){return t.lowerBound.x=Nt(e.x,i.x),t.lowerBound.y=Nt(e.y,i.y),t.upperBound.x=Rt(e.x,i.x),t.upperBound.y=Rt(e.y,i.y),t},r.combinedPerimeter=function(t,e){var i=Nt(t.lowerBound.x,e.lowerBound.x),s=Nt(t.lowerBound.y,e.lowerBound.y),o=Rt(t.upperBound.x,e.upperBound.x),n=Rt(t.upperBound.y,e.upperBound.y);return 2*(o-i+n-s)},r})(),Ri=Math.PI,R=(function(){function r(){}return Object.defineProperty(r,"polygonRadius",{get:function(){return 2*r.linearSlop},enumerable:!1,configurable:!0}),r.lengthUnitsPerMeter=1,r.maxManifoldPoints=2,r.maxPolygonVertices=12,r.aabbExtension=.1,r.aabbMultiplier=2,r.linearSlop=.005,r.angularSlop=2/180*Ri,r.maxSubSteps=8,r.maxTOIContacts=32,r.maxTOIIterations=20,r.maxDistanceIterations=20,r.velocityThreshold=1,r.maxLinearCorrection=.2,r.maxAngularCorrection=8/180*Ri,r.maxTranslation=2,r.maxRotation=.5*Ri,r.baumgarte=.2,r.toiBaugarte=.75,r.timeToSleep=.5,r.linearSleepTolerance=.01,r.angularSleepTolerance=2/180*Ri,r})(),P=(function(){function r(){}return Object.defineProperty(r,"maxManifoldPoints",{get:function(){return R.maxManifoldPoints},enumerable:!1,configurable:!0}),Object.defineProperty(r,"maxPolygonVertices",{get:function(){return R.maxPolygonVertices},enumerable:!1,configurable:!0}),Object.defineProperty(r,"aabbExtension",{get:function(){return R.aabbExtension*R.lengthUnitsPerMeter},enumerable:!1,configurable:!0}),Object.defineProperty(r,"aabbMultiplier",{get:function(){return R.aabbMultiplier},enumerable:!1,configurable:!0}),Object.defineProperty(r,"linearSlop",{get:function(){return R.linearSlop*R.lengthUnitsPerMeter},enumerable:!1,configurable:!0}),Object.defineProperty(r,"linearSlopSquared",{get:function(){return R.linearSlop*R.lengthUnitsPerMeter*R.linearSlop*R.lengthUnitsPerMeter},enumerable:!1,configurable:!0}),Object.defineProperty(r,"angularSlop",{get:function(){return R.angularSlop},enumerable:!1,configurable:!0}),Object.defineProperty(r,"polygonRadius",{get:function(){return 2*R.linearSlop},enumerable:!1,configurable:!0}),Object.defineProperty(r,"maxSubSteps",{get:function(){return R.maxSubSteps},enumerable:!1,configurable:!0}),Object.defineProperty(r,"maxTOIContacts",{get:function(){return R.maxTOIContacts},enumerable:!1,configurable:!0}),Object.defineProperty(r,"maxTOIIterations",{get:function(){return R.maxTOIIterations},enumerable:!1,configurable:!0}),Object.defineProperty(r,"maxDistanceIterations",{get:function(){return R.maxDistanceIterations},enumerable:!1,configurable:!0}),Object.defineProperty(r,"velocityThreshold",{get:function(){return R.velocityThreshold*R.lengthUnitsPerMeter},enumerable:!1,configurable:!0}),Object.defineProperty(r,"maxLinearCorrection",{get:function(){return R.maxLinearCorrection*R.lengthUnitsPerMeter},enumerable:!1,configurable:!0}),Object.defineProperty(r,"maxAngularCorrection",{get:function(){return R.maxAngularCorrection},enumerable:!1,configurable:!0}),Object.defineProperty(r,"maxTranslation",{get:function(){return R.maxTranslation*R.lengthUnitsPerMeter},enumerable:!1,configurable:!0}),Object.defineProperty(r,"maxTranslationSquared",{get:function(){return R.maxTranslation*R.lengthUnitsPerMeter*R.maxTranslation*R.lengthUnitsPerMeter},enumerable:!1,configurable:!0}),Object.defineProperty(r,"maxRotation",{get:function(){return R.maxRotation},enumerable:!1,configurable:!0}),Object.defineProperty(r,"maxRotationSquared",{get:function(){return R.maxRotation*R.maxRotation},enumerable:!1,configurable:!0}),Object.defineProperty(r,"baumgarte",{get:function(){return R.baumgarte},enumerable:!1,configurable:!0}),Object.defineProperty(r,"toiBaugarte",{get:function(){return R.toiBaugarte},enumerable:!1,configurable:!0}),Object.defineProperty(r,"timeToSleep",{get:function(){return R.timeToSleep},enumerable:!1,configurable:!0}),Object.defineProperty(r,"linearSleepTolerance",{get:function(){return R.linearSleepTolerance*R.lengthUnitsPerMeter},enumerable:!1,configurable:!0}),Object.defineProperty(r,"linearSleepToleranceSqr",{get:function(){return R.linearSleepTolerance*R.lengthUnitsPerMeter*R.linearSleepTolerance*R.lengthUnitsPerMeter},enumerable:!1,configurable:!0}),Object.defineProperty(r,"angularSleepTolerance",{get:function(){return R.angularSleepTolerance},enumerable:!1,configurable:!0}),Object.defineProperty(r,"angularSleepToleranceSqr",{get:function(){return R.angularSleepTolerance*R.angularSleepTolerance},enumerable:!1,configurable:!0}),r})(),Fi=(function(){function r(t){this._list=[],this._max=1/0,this._hasCreateFn=!1,this._createCount=0,this._hasAllocateFn=!1,this._allocateCount=0,this._hasReleaseFn=!1,this._releaseCount=0,this._hasDisposeFn=!1,this._disposeCount=0,this._list=[],this._max=t.max||this._max,this._createFn=t.create,this._hasCreateFn=typeof this._createFn=="function",this._allocateFn=t.allocate,this._hasAllocateFn=typeof this._allocateFn=="function",this._releaseFn=t.release,this._hasReleaseFn=typeof this._releaseFn=="function",this._disposeFn=t.dispose,this._hasDisposeFn=typeof this._disposeFn=="function"}return r.prototype.max=function(t){return typeof t=="number"?(this._max=t,this):this._max},r.prototype.size=function(){return this._list.length},r.prototype.allocate=function(){var t;return this._list.length>0?t=this._list.shift():(this._createCount++,this._hasCreateFn?t=this._createFn():t={}),this._allocateCount++,this._hasAllocateFn&&this._allocateFn(t),t},r.prototype.release=function(t){this._list.length<this._max?(this._releaseCount++,this._hasReleaseFn&&this._releaseFn(t),this._list.push(t)):(this._disposeCount++,this._hasDisposeFn&&(t=this._disposeFn(t)))},r.prototype.toString=function(){return" +"+this._createCount+" >"+this._allocateCount+" <"+this._releaseCount+" -"+this._disposeCount+" ="+this._list.length+"/"+this._max},r})(),nr=Math.abs,zt=Math.max,$o=(function(){function r(t){this.aabb=new ut,this.userData=null,this.parent=null,this.child1=null,this.child2=null,this.height=-1,this.id=t}return r.prototype.toString=function(){return this.id+": "+this.userData},r.prototype.isLeaf=function(){return this.child1==null},r})(),ar=new Fi({create:function(){return new $o},release:function(r){r.userData=null,r.parent=null,r.child1=null,r.child2=null,r.height=-1,r.id=void 0}}),Xo=(function(){function r(){this.inputPool=new Fi({create:function(){return{}},release:function(t){}}),this.stackPool=new Fi({create:function(){return[]},release:function(t){t.length=0}}),this.iteratorPool=new Fi({create:function(){return new Yo},release:function(t){t.close()}}),this.m_root=null,this.m_nodes={},this.m_lastProxyId=0}return r.prototype.getUserData=function(t){var e=this.m_nodes[t];return e.userData},r.prototype.getFatAABB=function(t){var e=this.m_nodes[t];return e.aabb},r.prototype.allocateNode=function(){var t=ar.allocate();return t.id=++this.m_lastProxyId,this.m_nodes[t.id]=t,t},r.prototype.freeNode=function(t){delete this.m_nodes[t.id],ar.release(t)},r.prototype.createProxy=function(t,e){var i=this.allocateNode();return i.aabb.set(t),ut.extend(i.aabb,P.aabbExtension),i.userData=e,i.height=0,this.insertLeaf(i),i.id},r.prototype.destroyProxy=function(t){var e=this.m_nodes[t];this.removeLeaf(e),this.freeNode(e)},r.prototype.moveProxy=function(t,e,i){var s=this.m_nodes[t];return s.aabb.contains(e)?!1:(this.removeLeaf(s),s.aabb.set(e),e=s.aabb,ut.extend(e,P.aabbExtension),i.x<0?e.lowerBound.x+=i.x*P.aabbMultiplier:e.upperBound.x+=i.x*P.aabbMultiplier,i.y<0?e.lowerBound.y+=i.y*P.aabbMultiplier:e.upperBound.y+=i.y*P.aabbMultiplier,this.insertLeaf(s),!0)},r.prototype.insertLeaf=function(t){if(this.m_root==null){this.m_root=t,this.m_root.parent=null;return}for(var e=t.aabb,i=this.m_root;!i.isLeaf();){var s=i.child1,o=i.child2,n=i.aabb.getPerimeter(),a=ut.combinedPerimeter(i.aabb,e),h=2*a,m=2*(a-n),c=ut.combinedPerimeter(e,s.aabb),_=c+m;if(!s.isLeaf()){var d=s.aabb.getPerimeter();_-=d}var u=ut.combinedPerimeter(e,o.aabb),f=u+m;if(!o.isLeaf()){var d=o.aabb.getPerimeter();f-=d}if(h<_&&h<f)break;_<f?i=s:i=o}var p=i,v=p.parent,y=this.allocateNode();for(y.parent=v,y.userData=null,y.aabb.combine(e,p.aabb),y.height=p.height+1,v!=null?(v.child1===p?v.child1=y:v.child2=y,y.child1=p,y.child2=t,p.parent=y,t.parent=y):(y.child1=p,y.child2=t,p.parent=y,t.parent=y,this.m_root=y),i=t.parent;i!=null;){i=this.balance(i);var s=i.child1,o=i.child2;i.height=1+zt(s.height,o.height),i.aabb.combine(s.aabb,o.aabb),i=i.parent}},r.prototype.removeLeaf=function(t){if(t===this.m_root){this.m_root=null;return}var e=t.parent,i=e.parent,s;if(e.child1===t?s=e.child2:s=e.child1,i!=null){i.child1===e?i.child1=s:i.child2=s,s.parent=i,this.freeNode(e);for(var o=i;o!=null;){o=this.balance(o);var n=o.child1,a=o.child2;o.aabb.combine(n.aabb,a.aabb),o.height=1+zt(n.height,a.height),o=o.parent}}else this.m_root=s,s.parent=null,this.freeNode(e)},r.prototype.balance=function(t){var e=t;if(e.isLeaf()||e.height<2)return t;var i=e.child1,s=e.child2,o=s.height-i.height;if(o>1){var n=s.child1,a=s.child2;return s.child1=e,s.parent=e.parent,e.parent=s,s.parent!=null?s.parent.child1===t?s.parent.child1=s:s.parent.child2=s:this.m_root=s,n.height>a.height?(s.child2=n,e.child2=a,a.parent=e,e.aabb.combine(i.aabb,a.aabb),s.aabb.combine(e.aabb,n.aabb),e.height=1+zt(i.height,a.height),s.height=1+zt(e.height,n.height)):(s.child2=a,e.child2=n,n.parent=e,e.aabb.combine(i.aabb,n.aabb),s.aabb.combine(e.aabb,a.aabb),e.height=1+zt(i.height,n.height),s.height=1+zt(e.height,a.height)),s}if(o<-1){var h=i.child1,m=i.child2;return i.child1=e,i.parent=e.parent,e.parent=i,i.parent!=null?i.parent.child1===e?i.parent.child1=i:i.parent.child2=i:this.m_root=i,h.height>m.height?(i.child2=h,e.child1=m,m.parent=e,e.aabb.combine(s.aabb,m.aabb),i.aabb.combine(e.aabb,h.aabb),e.height=1+zt(s.height,m.height),i.height=1+zt(e.height,h.height)):(i.child2=m,e.child1=h,h.parent=e,e.aabb.combine(s.aabb,h.aabb),i.aabb.combine(e.aabb,m.aabb),e.height=1+zt(s.height,h.height),i.height=1+zt(e.height,m.height)),i}return e},r.prototype.getHeight=function(){return this.m_root==null?0:this.m_root.height},r.prototype.getAreaRatio=function(){if(this.m_root==null)return 0;for(var t=this.m_root,e=t.aabb.getPerimeter(),i=0,s,o=this.iteratorPool.allocate().preorder(this.m_root);s=o.next();)s.height<0||(i+=s.aabb.getPerimeter());return this.iteratorPool.release(o),i/e},r.prototype.computeHeight=function(t){var e;if(typeof t<"u"?e=this.m_nodes[t]:e=this.m_root,e.isLeaf())return 0;var i=this.computeHeight(e.child1.id),s=this.computeHeight(e.child2.id);return 1+zt(i,s)},r.prototype.validateStructure=function(t){if(t!=null){this.m_root;var e=t.child1,i=t.child2;t.isLeaf()||(this.validateStructure(e),this.validateStructure(i))}},r.prototype.validateMetrics=function(t){if(t!=null){var e=t.child1,i=t.child2;t.isLeaf()||(this.validateMetrics(e),this.validateMetrics(i))}},r.prototype.validate=function(){},r.prototype.getMaxBalance=function(){for(var t=0,e,i=this.iteratorPool.allocate().preorder(this.m_root);e=i.next();)if(!(e.height<=1)){var s=nr(e.child2.height-e.child1.height);t=zt(t,s)}return this.iteratorPool.release(i),t},r.prototype.rebuildBottomUp=function(){for(var t=[],e=0,i,s=this.iteratorPool.allocate().preorder(this.m_root);i=s.next();)i.height<0||(i.isLeaf()?(i.parent=null,t[e]=i,++e):this.freeNode(i));for(this.iteratorPool.release(s);e>1;){for(var o=1/0,n=-1,a=-1,h=0;h<e;++h)for(var m=t[h].aabb,c=h+1;c<e;++c){var _=t[c].aabb,d=ut.combinedPerimeter(m,_);d<o&&(n=h,a=c,o=d)}var u=t[n],f=t[a],p=this.allocateNode();p.child1=u,p.child2=f,p.height=1+zt(u.height,f.height),p.aabb.combine(u.aabb,f.aabb),p.parent=null,u.parent=p,f.parent=p,t[a]=t[e-1],t[n]=p,--e}this.m_root=t[0]},r.prototype.shiftOrigin=function(t){for(var e,i=this.iteratorPool.allocate().preorder(this.m_root);e=i.next();){var s=e.aabb;s.lowerBound.x-=t.x,s.lowerBound.y-=t.y,s.upperBound.x-=t.x,s.upperBound.y-=t.y}this.iteratorPool.release(i)},r.prototype.query=function(t,e){var i=this.stackPool.allocate();for(i.push(this.m_root);i.length>0;){var s=i.pop();if(s!=null&&ut.testOverlap(s.aabb,t))if(s.isLeaf()){var o=e(s.id);if(o===!1)return}else i.push(s.child1),i.push(s.child2)}this.stackPool.release(i)},r.prototype.rayCast=function(t,e){var i=t.p1,s=t.p2,o=l.sub(s,i);o.normalize();var n=l.crossNumVec2(1,o),a=l.abs(n),h=t.maxFraction,m=new ut,c=l.combine(1-h,i,h,s);m.combinePoints(i,c);var _=this.stackPool.allocate(),d=this.inputPool.allocate();for(_.push(this.m_root);_.length>0;){var u=_.pop();if(u!=null&&ut.testOverlap(u.aabb,m)!==!1){var f=u.aabb.getCenter(),p=u.aabb.getExtents(),v=nr(l.dot(n,l.sub(i,f)))-l.dot(a,p);if(!(v>0))if(u.isLeaf()){d.p1=l.clone(t.p1),d.p2=l.clone(t.p2),d.maxFraction=h;var y=e(d,u.id);if(y===0)break;y>0&&(h=y,c=l.combine(1-h,i,h,s),m.combinePoints(i,c))}else _.push(u.child1),_.push(u.child2)}}this.stackPool.release(_),this.inputPool.release(d)},r})(),Yo=(function(){function r(){this.parents=[],this.states=[]}return r.prototype.preorder=function(t){return this.parents.length=0,this.parents.push(t),this.states.length=0,this.states.push(0),this},r.prototype.next=function(){for(;this.parents.length>0;){var t=this.parents.length-1,e=this.parents[t];if(this.states[t]===0)return this.states[t]=1,e;if(this.states[t]===1&&(this.states[t]=2,e.child1))return this.parents.push(e.child1),this.states.push(1),e.child1;if(this.states[t]===2&&(this.states[t]=3,e.child2))return this.parents.push(e.child2),this.states.push(1),e.child2;this.parents.pop(),this.states.pop()}},r.prototype.close=function(){this.parents.length=0},r})(),Jo=Math.max,Ko=Math.min,Zo=(function(){function r(){var t=this;this.m_tree=new Xo,this.m_moveBuffer=[],this.query=function(e,i){t.m_tree.query(e,i)},this.queryCallback=function(e){if(e===t.m_queryProxyId)return!0;var i=Ko(e,t.m_queryProxyId),s=Jo(e,t.m_queryProxyId),o=t.m_tree.getUserData(i),n=t.m_tree.getUserData(s);return t.m_callback(o,n),!0}}return r.prototype.getUserData=function(t){return this.m_tree.getUserData(t)},r.prototype.testOverlap=function(t,e){var i=this.m_tree.getFatAABB(t),s=this.m_tree.getFatAABB(e);return ut.testOverlap(i,s)},r.prototype.getFatAABB=function(t){return this.m_tree.getFatAABB(t)},r.prototype.getProxyCount=function(){return this.m_moveBuffer.length},r.prototype.getTreeHeight=function(){return this.m_tree.getHeight()},r.prototype.getTreeBalance=function(){return this.m_tree.getMaxBalance()},r.prototype.getTreeQuality=function(){return this.m_tree.getAreaRatio()},r.prototype.rayCast=function(t,e){this.m_tree.rayCast(t,e)},r.prototype.shiftOrigin=function(t){this.m_tree.shiftOrigin(t)},r.prototype.createProxy=function(t,e){var i=this.m_tree.createProxy(t,e);return this.bufferMove(i),i},r.prototype.destroyProxy=function(t){this.unbufferMove(t),this.m_tree.destroyProxy(t)},r.prototype.moveProxy=function(t,e,i){var s=this.m_tree.moveProxy(t,e,i);s&&this.bufferMove(t)},r.prototype.touchProxy=function(t){this.bufferMove(t)},r.prototype.bufferMove=function(t){this.m_moveBuffer.push(t)},r.prototype.unbufferMove=function(t){for(var e=0;e<this.m_moveBuffer.length;++e)this.m_moveBuffer[e]===t&&(this.m_moveBuffer[e]=null)},r.prototype.updatePairs=function(t){for(this.m_callback=t;this.m_moveBuffer.length>0;)if(this.m_queryProxyId=this.m_moveBuffer.pop(),this.m_queryProxyId!==null){var e=this.m_tree.getFatAABB(this.m_queryProxyId);this.m_tree.query(e,this.queryCallback)}},r})(),_o=Math.sin,po=Math.cos,js=Math.sqrt;function b(r,t){return{x:r,y:t}}function Qo(r){return{s:_o(r),c:po(r)}}function ft(r,t,e){return r.x=t,r.y=e,r}function g(r,t){return r.x=t.x,r.y=t.y,r}function T(r){return r.x=0,r.y=0,r}function Hi(r){return r.x=-r.x,r.y=-r.y,r}function Wt(r,t){return r.x+=t.x,r.y+=t.y,r}function tn(r,t,e){return r.x=t.x+e.x,r.y=t.x+e.y,r}function Ae(r,t){return r.x-=t.x,r.y-=t.y,r}function L(r,t,e){return r.x=t.x-e.x,r.y=t.y-e.y,r}function lr(r,t){return r.x*=t,r.y*=t,r}function z(r,t,e){return r.x=t*e.x,r.y=t*e.y,r}function ee(r,t,e){return r.x+=t*e.x,r.y+=t*e.y,r}function ki(r,t,e){return r.x-=t*e.x,r.y-=t*e.y,r}function Z(r,t,e,i,s){return r.x=t*e.x+i*s.x,r.y=t*e.y+i*s.y,r}function me(r,t,e,i,s,o,n){return r.x=t*e.x+i*s.x+o*n.x,r.y=t*e.y+i*s.y+o*n.y,r}function en(r){var t=js(r.x*r.x+r.y*r.y);if(t!==0){var e=1/t;r.x*=e,r.y*=e}return t}function ie(r){var t=js(r.x*r.x+r.y*r.y);if(t>0){var e=1/t;r.x*=e,r.y*=e}return r}function Ye(r,t,e){var i=e*t.y,s=-e*t.x;return r.x=i,r.y=s,r}function Lt(r,t,e){var i=-t*e.y,s=t*e.x;return r.x=i,r.y=s,r}function N(r,t){return r.x*t.y-r.y*t.x}function I(r,t){return r.x*t.x+r.y*t.y}function Je(r){return r.x*r.x+r.y*r.y}function fo(r,t){var e=r.x-t.x,i=r.y-t.y;return js(e*e+i*i)}function Ke(r,t){var e=r.x-t.x,i=r.y-t.y;return e*e+i*i}function sn(r,t){return r.c=po(t),r.s=_o(t),r}function Xt(r,t,e){return r.x=t.c*e.x-t.s*e.y,r.y=t.s*e.x+t.c*e.y,r}function yi(r,t,e){var i=t.c*e.x+t.s*e.y,s=-t.s*e.x+t.c*e.y;return r.x=i,r.y=s,r}function rn(r,t,e,i){var s=t.c*i.x+t.s*i.y,o=-t.s*i.x+t.c*i.y,n=e.c*s-e.s*o,a=e.s*s+e.c*o;return r.x=n,r.y=a,r}function ti(r,t,e){return{p:b(r,t),q:Qo(e)}}function _s(r,t){return r.p.x=t.p.x,r.p.y=t.p.y,r.q.s=t.q.s,r.q.c=t.q.c,r}function F(r,t,e){var i=t.q.c*e.x-t.q.s*e.y+t.p.x,s=t.q.s*e.x+t.q.c*e.y+t.p.y;return r.x=i,r.y=s,r}function Gs(r,t,e){var i=e.x-t.p.x,s=e.y-t.p.y,o=t.q.c*i+t.q.s*s,n=-t.q.s*i+t.q.c*s;return r.x=o,r.y=n,r}function vo(r,t,e,i){var s=t.q.c*i.x-t.q.s*i.y+t.p.x,o=t.q.s*i.x+t.q.c*i.y+t.p.y,n=s-e.p.x,a=o-e.p.y,h=e.q.c*n+e.q.s*a,m=-e.q.s*n+e.q.c*a;return r.x=h,r.y=m,r}function yo(r,t,e){var i=t.q.c*e.q.c+t.q.s*e.q.s,s=t.q.c*e.q.s-t.q.s*e.q.c,o=t.q.c*(e.p.x-t.p.x)+t.q.s*(e.p.y-t.p.y),n=-t.q.s*(e.p.x-t.p.x)+t.q.c*(e.p.y-t.p.y);return r.q.c=i,r.q.s=s,r.p.x=o,r.p.y=n,r}var hr=Math.sin,cr=Math.cos,on=Math.atan2,B=(function(){function r(t){if(!(this instanceof r))return new r(t);typeof t=="number"?this.setAngle(t):typeof t=="object"?this.setRot(t):this.setIdentity()}return r.neo=function(t){var e=Object.create(r.prototype);return e.setAngle(t),e},r.clone=function(t){var e=Object.create(r.prototype);return e.s=t.s,e.c=t.c,e},r.identity=function(){var t=Object.create(r.prototype);return t.s=0,t.c=1,t},r.isValid=function(t){return t===null||typeof t>"u"?!1:Number.isFinite(t.s)&&Number.isFinite(t.c)},r.assert=function(t){},r.prototype.setIdentity=function(){this.s=0,this.c=1},r.prototype.set=function(t){typeof t=="object"?(this.s=t.s,this.c=t.c):(this.s=hr(t),this.c=cr(t))},r.prototype.setRot=function(t){this.s=t.s,this.c=t.c},r.prototype.setAngle=function(t){this.s=hr(t),this.c=cr(t)},r.prototype.getAngle=function(){return on(this.s,this.c)},r.prototype.getXAxis=function(){return l.neo(this.c,this.s)},r.prototype.getYAxis=function(){return l.neo(-this.s,this.c)},r.mul=function(t,e){if("c"in e&&"s"in e){var i=r.identity();return i.s=t.s*e.c+t.c*e.s,i.c=t.c*e.c-t.s*e.s,i}else if("x"in e&&"y"in e)return l.neo(t.c*e.x-t.s*e.y,t.s*e.x+t.c*e.y)},r.mulRot=function(t,e){var i=r.identity();return i.s=t.s*e.c+t.c*e.s,i.c=t.c*e.c-t.s*e.s,i},r.mulVec2=function(t,e){return l.neo(t.c*e.x-t.s*e.y,t.s*e.x+t.c*e.y)},r.mulSub=function(t,e,i){var s=t.c*(e.x-i.x)-t.s*(e.y-i.y),o=t.s*(e.x-i.x)+t.c*(e.y-i.y);return l.neo(s,o)},r.mulT=function(t,e){if("c"in e&&"s"in e){var i=r.identity();return i.s=t.c*e.s-t.s*e.c,i.c=t.c*e.c+t.s*e.s,i}else if("x"in e&&"y"in e)return l.neo(t.c*e.x+t.s*e.y,-t.s*e.x+t.c*e.y)},r.mulTRot=function(t,e){var i=r.identity();return i.s=t.c*e.s-t.s*e.c,i.c=t.c*e.c+t.s*e.s,i},r.mulTVec2=function(t,e){return l.neo(t.c*e.x+t.s*e.y,-t.s*e.x+t.c*e.y)},r})(),nn=Math.atan2,mr=Math.PI,He=b(0,0),gi=(function(){function r(){this.localCenter=l.zero(),this.c=l.zero(),this.a=0,this.alpha0=0,this.c0=l.zero(),this.a0=0}return r.prototype.recycle=function(){T(this.localCenter),T(this.c),this.a=0,this.alpha0=0,T(this.c0),this.a0=0},r.prototype.setTransform=function(t){F(He,t,this.localCenter),g(this.c,He),g(this.c0,He),this.a=this.a0=nn(t.q.s,t.q.c)},r.prototype.setLocalCenter=function(t,e){g(this.localCenter,t),F(He,e,this.localCenter),g(this.c,He),g(this.c0,He)},r.prototype.getTransform=function(t,e){e===void 0&&(e=0),sn(t.q,(1-e)*this.a0+e*this.a),Z(t.p,1-e,this.c0,e,this.c),Ae(t.p,Xt(He,t.q,this.localCenter))},r.prototype.advance=function(t){var e=(t-this.alpha0)/(1-this.alpha0);Z(this.c0,e,this.c,1-e,this.c0),this.a0=e*this.a+(1-e)*this.a0,this.alpha0=t},r.prototype.forward=function(){this.a0=this.a,g(this.c0,this.c)},r.prototype.normalize=function(){var t=uo(this.a0,-mr,+mr);this.a-=this.a0-t,this.a0=t},r.prototype.set=function(t){g(this.localCenter,t.localCenter),g(this.c,t.c),this.a=t.a,this.alpha0=t.alpha0,g(this.c0,t.c0),this.a0=t.a0},r})(),se=(function(){function r(t,e){if(!(this instanceof r))return new r(t,e);this.p=l.zero(),this.q=B.identity(),typeof t<"u"&&this.p.setVec2(t),typeof e<"u"&&this.q.setAngle(e)}return r.clone=function(t){var e=Object.create(r.prototype);return e.p=l.clone(t.p),e.q=B.clone(t.q),e},r.neo=function(t,e){var i=Object.create(r.prototype);return i.p=l.clone(t),i.q=B.clone(e),i},r.identity=function(){var t=Object.create(r.prototype);return t.p=l.zero(),t.q=B.identity(),t},r.prototype.setIdentity=function(){this.p.setZero(),this.q.setIdentity()},r.prototype.set=function(t,e){typeof e>"u"?(this.p.set(t.p),this.q.set(t.q)):(this.p.set(t),this.q.set(e))},r.prototype.setNum=function(t,e){this.p.setVec2(t),this.q.setAngle(e)},r.prototype.setTransform=function(t){this.p.setVec2(t.p),this.q.setRot(t.q)},r.isValid=function(t){return t===null||typeof t>"u"?!1:l.isValid(t.p)&&B.isValid(t.q)},r.assert=function(t){},r.mul=function(t,e){if(Array.isArray(e)){for(var i=[],s=0;s<e.length;s++)i[s]=r.mul(t,e[s]);return i}else{if("x"in e&&"y"in e)return r.mulVec2(t,e);if("p"in e&&"q"in e)return r.mulXf(t,e)}},r.mulAll=function(t,e){for(var i=[],s=0;s<e.length;s++)i[s]=r.mul(t,e[s]);return i},r.mulFn=function(t){return function(e){return r.mul(t,e)}},r.mulVec2=function(t,e){var i=t.q.c*e.x-t.q.s*e.y+t.p.x,s=t.q.s*e.x+t.q.c*e.y+t.p.y;return l.neo(i,s)},r.mulXf=function(t,e){var i=r.identity();return i.q=B.mulRot(t.q,e.q),i.p=l.add(B.mulVec2(t.q,e.p),t.p),i},r.mulT=function(t,e){if("x"in e&&"y"in e)return r.mulTVec2(t,e);if("p"in e&&"q"in e)return r.mulTXf(t,e)},r.mulTVec2=function(t,e){var i=e.x-t.p.x,s=e.y-t.p.y,o=t.q.c*i+t.q.s*s,n=-t.q.s*i+t.q.c*s;return l.neo(o,n)},r.mulTXf=function(t,e){var i=r.identity();return i.q.setRot(B.mulTRot(t.q,e.q)),i.p.setVec2(B.mulTVec2(t.q,l.sub(e.p,t.p))),i},r})(),an=(function(){function r(){this.v=l.zero(),this.w=0}return r})(),go=Math.sin,xo=Math.cos,ln=(function(){function r(){this.c=l.zero(),this.a=0}return r.prototype.getTransform=function(t,e){return t.q.c=xo(this.a),t.q.s=go(this.a),t.p.x=this.c.x-(t.q.c*e.x-t.q.s*e.y),t.p.y=this.c.y-(t.q.s*e.x+t.q.c*e.y),t},r})();function Ni(r,t,e,i){return r.q.c=xo(i),r.q.s=go(i),r.p.x=e.x-(r.q.c*t.x-r.q.s*t.y),r.p.y=e.y-(r.q.s*t.x+r.q.c*t.y),r}var ei=(function(){function r(){this.style={},this.appData={}}return r.isValid=function(t){return t===null||typeof t>"u"?!1:typeof t.m_type=="string"&&typeof t.m_radius=="number"},r})(),ur=new ut,dr=new ut,_r=b(0,0),hn={userData:null,friction:.2,restitution:0,density:0,isSensor:!1,filterGroupIndex:0,filterCategoryBits:1,filterMaskBits:65535},pr=(function(){function r(t,e){this.aabb=new ut,this.fixture=t,this.childIndex=e}return r})(),ps=(function(){function r(t,e,i){this.style={},this.appData={},e.shape?(i=e,e=e.shape):typeof i=="number"&&(i={density:i}),i=Et(i,hn),this.m_body=t,this.m_friction=i.friction,this.m_restitution=i.restitution,this.m_density=i.density,this.m_isSensor=i.isSensor,this.m_filterGroupIndex=i.filterGroupIndex,this.m_filterCategoryBits=i.filterCategoryBits,this.m_filterMaskBits=i.filterMaskBits,this.m_shape=e,this.m_next=null,this.m_proxies=[],this.m_proxyCount=0;for(var s=this.m_shape.getChildCount(),o=0;o<s;++o)this.m_proxies[o]=new pr(this,o);this.m_userData=i.userData,typeof i.style=="object"&&i.style!==null&&(this.style=i.style)}return r.prototype._reset=function(){var t=this.getBody(),e=t.m_world.m_broadPhase;this.destroyProxies(e),this.m_shape._reset&&this.m_shape._reset();for(var i=this.m_shape.getChildCount(),s=0;s<i;++s)this.m_proxies[s]=new pr(this,s);this.createProxies(e,t.m_xf),t.resetMassData()},r.prototype._serialize=function(){return{friction:this.m_friction,restitution:this.m_restitution,density:this.m_density,isSensor:this.m_isSensor,filterGroupIndex:this.m_filterGroupIndex,filterCategoryBits:this.m_filterCategoryBits,filterMaskBits:this.m_filterMaskBits,shape:this.m_shape}},r._deserialize=function(t,e,i){var s=i(ei,t.shape),o=s&&new r(e,s,t);return o},r.prototype.getType=function(){return this.m_shape.m_type},r.prototype.getShape=function(){return this.m_shape},r.prototype.isSensor=function(){return this.m_isSensor},r.prototype.setSensor=function(t){t!=this.m_isSensor&&(this.m_body.setAwake(!0),this.m_isSensor=t)},r.prototype.getUserData=function(){return this.m_userData},r.prototype.setUserData=function(t){this.m_userData=t},r.prototype.getBody=function(){return this.m_body},r.prototype.getNext=function(){return this.m_next},r.prototype.getDensity=function(){return this.m_density},r.prototype.setDensity=function(t){this.m_density=t},r.prototype.getFriction=function(){return this.m_friction},r.prototype.setFriction=function(t){this.m_friction=t},r.prototype.getRestitution=function(){return this.m_restitution},r.prototype.setRestitution=function(t){this.m_restitution=t},r.prototype.testPoint=function(t){return this.m_shape.testPoint(this.m_body.getTransform(),t)},r.prototype.rayCast=function(t,e,i){return this.m_shape.rayCast(t,e,this.m_body.getTransform(),i)},r.prototype.getMassData=function(t){this.m_shape.computeMass(t,this.m_density)},r.prototype.getAABB=function(t){return this.m_proxies[t].aabb},r.prototype.createProxies=function(t,e){this.m_proxyCount=this.m_shape.getChildCount();for(var i=0;i<this.m_proxyCount;++i){var s=this.m_proxies[i];this.m_shape.computeAABB(s.aabb,e,i),s.proxyId=t.createProxy(s.aabb,s)}},r.prototype.destroyProxies=function(t){for(var e=0;e<this.m_proxyCount;++e){var i=this.m_proxies[e];t.destroyProxy(i.proxyId),i.proxyId=null}this.m_proxyCount=0},r.prototype.synchronize=function(t,e,i){for(var s=0;s<this.m_proxyCount;++s){var o=this.m_proxies[s];this.m_shape.computeAABB(ur,e,o.childIndex),this.m_shape.computeAABB(dr,i,o.childIndex),o.aabb.combine(ur,dr),L(_r,i.p,e.p),t.moveProxy(o.proxyId,o.aabb,_r)}},r.prototype.setFilterData=function(t){this.m_filterGroupIndex=t.groupIndex,this.m_filterCategoryBits=t.categoryBits,this.m_filterMaskBits=t.maskBits,this.refilter()},r.prototype.getFilterGroupIndex=function(){return this.m_filterGroupIndex},r.prototype.setFilterGroupIndex=function(t){this.m_filterGroupIndex=t,this.refilter()},r.prototype.getFilterCategoryBits=function(){return this.m_filterCategoryBits},r.prototype.setFilterCategoryBits=function(t){this.m_filterCategoryBits=t,this.refilter()},r.prototype.getFilterMaskBits=function(){return this.m_filterMaskBits},r.prototype.setFilterMaskBits=function(t){this.m_filterMaskBits=t,this.refilter()},r.prototype.refilter=function(){if(this.m_body!=null){for(var t=this.m_body.getContactList();t;){var e=t.contact,i=e.getFixtureA(),s=e.getFixtureB();(i==this||s==this)&&e.flagForFiltering(),t=t.next}var o=this.m_body.getWorld();if(o!=null)for(var n=o.m_broadPhase,a=0;a<this.m_proxyCount;++a)n.touchProxy(this.m_proxies[a].proxyId)}},r.prototype.shouldCollide=function(t){if(t.m_filterGroupIndex===this.m_filterGroupIndex&&t.m_filterGroupIndex!==0)return t.m_filterGroupIndex>0;var e=(t.m_filterMaskBits&this.m_filterCategoryBits)!==0,i=(t.m_filterCategoryBits&this.m_filterMaskBits)!==0,s=e&&i;return s},r})(),vi="static",fr="kinematic",Jt="dynamic",Oi=b(0,0),De=b(0,0),Ui=b(0,0),ji=b(0,0),vr=ti(0,0,0),cn={type:vi,position:l.zero(),angle:0,linearVelocity:l.zero(),angularVelocity:0,linearDamping:0,angularDamping:0,fixedRotation:!1,bullet:!1,gravityScale:1,allowSleep:!0,awake:!0,active:!0,userData:null},$=(function(){function r(t,e){this.style={},this.appData={},e=Et(e,cn),this.m_world=t,this.m_awakeFlag=e.awake,this.m_autoSleepFlag=e.allowSleep,this.m_bulletFlag=e.bullet,this.m_fixedRotationFlag=e.fixedRotation,this.m_activeFlag=e.active,this.m_islandFlag=!1,this.m_toiFlag=!1,this.m_userData=e.userData,this.m_type=e.type,this.m_type==Jt?(this.m_mass=1,this.m_invMass=1):(this.m_mass=0,this.m_invMass=0),this.m_I=0,this.m_invI=0,this.m_xf=se.identity(),this.m_xf.p.setVec2(e.position),this.m_xf.q.setAngle(e.angle),this.m_sweep=new gi,this.m_sweep.setTransform(this.m_xf),this.c_velocity=new an,this.c_position=new ln,this.m_force=l.zero(),this.m_torque=0,this.m_linearVelocity=l.clone(e.linearVelocity),this.m_angularVelocity=e.angularVelocity,this.m_linearDamping=e.linearDamping,this.m_angularDamping=e.angularDamping,this.m_gravityScale=e.gravityScale,this.m_sleepTime=0,this.m_jointList=null,this.m_contactList=null,this.m_fixtureList=null,this.m_prev=null,this.m_next=null,this.m_destroyed=!1,typeof e.style=="object"&&e.style!==null&&(this.style=e.style)}return r.prototype._serialize=function(){for(var t=[],e=this.m_fixtureList;e;e=e.m_next)t.push(e);return{type:this.m_type,bullet:this.m_bulletFlag,position:this.m_xf.p,angle:this.m_xf.q.getAngle(),linearVelocity:this.m_linearVelocity,angularVelocity:this.m_angularVelocity,fixtures:t}},r._deserialize=function(t,e,i){var s=new r(e,t);if(t.fixtures)for(var o=t.fixtures.length-1;o>=0;o--){var n=i(ps,t.fixtures[o],s);s._addFixture(n)}return s},r.prototype.isWorldLocked=function(){return!!(this.m_world&&this.m_world.isLocked())},r.prototype.getWorld=function(){return this.m_world},r.prototype.getNext=function(){return this.m_next},r.prototype.setUserData=function(t){this.m_userData=t},r.prototype.getUserData=function(){return this.m_userData},r.prototype.getFixtureList=function(){return this.m_fixtureList},r.prototype.getJointList=function(){return this.m_jointList},r.prototype.getContactList=function(){return this.m_contactList},r.prototype.isStatic=function(){return this.m_type==vi},r.prototype.isDynamic=function(){return this.m_type==Jt},r.prototype.isKinematic=function(){return this.m_type==fr},r.prototype.setStatic=function(){return this.setType(vi),this},r.prototype.setDynamic=function(){return this.setType(Jt),this},r.prototype.setKinematic=function(){return this.setType(fr),this},r.prototype.getType=function(){return this.m_type},r.prototype.setType=function(t){if(this.isWorldLocked()!=!0&&this.m_type!=t){this.m_type=t,this.resetMassData(),this.m_type==vi&&(this.m_linearVelocity.setZero(),this.m_angularVelocity=0,this.m_sweep.forward(),this.synchronizeFixtures()),this.setAwake(!0),this.m_force.setZero(),this.m_torque=0;for(var e=this.m_contactList;e;){var i=e;e=e.next,this.m_world.destroyContact(i.contact)}this.m_contactList=null;for(var s=this.m_world.m_broadPhase,o=this.m_fixtureList;o;o=o.m_next)for(var n=0;n<o.m_proxyCount;++n)s.touchProxy(o.m_proxies[n].proxyId)}},r.prototype.isBullet=function(){return this.m_bulletFlag},r.prototype.setBullet=function(t){this.m_bulletFlag=!!t},r.prototype.isSleepingAllowed=function(){return this.m_autoSleepFlag},r.prototype.setSleepingAllowed=function(t){this.m_autoSleepFlag=!!t,this.m_autoSleepFlag==!1&&this.setAwake(!0)},r.prototype.isAwake=function(){return this.m_awakeFlag},r.prototype.setAwake=function(t){t?(this.m_awakeFlag=!0,this.m_sleepTime=0):(this.m_awakeFlag=!1,this.m_sleepTime=0,this.m_linearVelocity.setZero(),this.m_angularVelocity=0,this.m_force.setZero(),this.m_torque=0)},r.prototype.isActive=function(){return this.m_activeFlag},r.prototype.setActive=function(t){if(t!=this.m_activeFlag)if(this.m_activeFlag=!!t,this.m_activeFlag){for(var e=this.m_world.m_broadPhase,i=this.m_fixtureList;i;i=i.m_next)i.createProxies(e,this.m_xf);this.m_world.m_newFixture=!0}else{for(var e=this.m_world.m_broadPhase,i=this.m_fixtureList;i;i=i.m_next)i.destroyProxies(e);for(var s=this.m_contactList;s;){var o=s;s=s.next,this.m_world.destroyContact(o.contact)}this.m_contactList=null}},r.prototype.isFixedRotation=function(){return this.m_fixedRotationFlag},r.prototype.setFixedRotation=function(t){this.m_fixedRotationFlag!=t&&(this.m_fixedRotationFlag=!!t,this.m_angularVelocity=0,this.resetMassData())},r.prototype.getTransform=function(){return this.m_xf},r.prototype.setTransform=function(t,e){if(this.isWorldLocked()!=!0){typeof e=="number"?this.m_xf.setNum(t,e):this.m_xf.setTransform(t),this.m_sweep.setTransform(this.m_xf);for(var i=this.m_world.m_broadPhase,s=this.m_fixtureList;s;s=s.m_next)s.synchronize(i,this.m_xf,this.m_xf);this.setAwake(!0)}},r.prototype.synchronizeTransform=function(){this.m_sweep.getTransform(this.m_xf,1)},r.prototype.synchronizeFixtures=function(){this.m_sweep.getTransform(vr,0);for(var t=this.m_world.m_broadPhase,e=this.m_fixtureList;e;e=e.m_next)e.synchronize(t,vr,this.m_xf)},r.prototype.advance=function(t){this.m_sweep.advance(t),g(this.m_sweep.c,this.m_sweep.c0),this.m_sweep.a=this.m_sweep.a0,this.m_sweep.getTransform(this.m_xf,1)},r.prototype.getPosition=function(){return this.m_xf.p},r.prototype.setPosition=function(t){this.setTransform(t,this.m_sweep.a)},r.prototype.getAngle=function(){return this.m_sweep.a},r.prototype.setAngle=function(t){this.setTransform(this.m_xf.p,t)},r.prototype.getWorldCenter=function(){return this.m_sweep.c},r.prototype.getLocalCenter=function(){return this.m_sweep.localCenter},r.prototype.getLinearVelocity=function(){return this.m_linearVelocity},r.prototype.getLinearVelocityFromWorldPoint=function(t){var e=l.sub(t,this.m_sweep.c);return l.add(this.m_linearVelocity,l.crossNumVec2(this.m_angularVelocity,e))},r.prototype.getLinearVelocityFromLocalPoint=function(t){return this.getLinearVelocityFromWorldPoint(this.getWorldPoint(t))},r.prototype.setLinearVelocity=function(t){this.m_type!=vi&&(l.dot(t,t)>0&&this.setAwake(!0),this.m_linearVelocity.setVec2(t))},r.prototype.getAngularVelocity=function(){return this.m_angularVelocity},r.prototype.setAngularVelocity=function(t){this.m_type!=vi&&(t*t>0&&this.setAwake(!0),this.m_angularVelocity=t)},r.prototype.getLinearDamping=function(){return this.m_linearDamping},r.prototype.setLinearDamping=function(t){this.m_linearDamping=t},r.prototype.getAngularDamping=function(){return this.m_angularDamping},r.prototype.setAngularDamping=function(t){this.m_angularDamping=t},r.prototype.getGravityScale=function(){return this.m_gravityScale},r.prototype.setGravityScale=function(t){this.m_gravityScale=t},r.prototype.getMass=function(){return this.m_mass},r.prototype.getInertia=function(){return this.m_I+this.m_mass*l.dot(this.m_sweep.localCenter,this.m_sweep.localCenter)},r.prototype.getMassData=function(t){t.mass=this.m_mass,t.I=this.getInertia(),g(t.center,this.m_sweep.localCenter)},r.prototype.resetMassData=function(){if(this.m_mass=0,this.m_invMass=0,this.m_I=0,this.m_invI=0,T(this.m_sweep.localCenter),this.isStatic()||this.isKinematic()){g(this.m_sweep.c0,this.m_xf.p),g(this.m_sweep.c,this.m_xf.p),this.m_sweep.a0=this.m_sweep.a;return}T(De);for(var t=this.m_fixtureList;t;t=t.m_next)if(t.m_density!=0){var e={mass:0,center:b(0,0),I:0};t.getMassData(e),this.m_mass+=e.mass,ee(De,e.mass,e.center),this.m_I+=e.I}this.m_mass>0?(this.m_invMass=1/this.m_mass,z(De,this.m_invMass,De)):(this.m_mass=1,this.m_invMass=1),this.m_I>0&&this.m_fixedRotationFlag==!1?(this.m_I-=this.m_mass*I(De,De),this.m_invI=1/this.m_I):(this.m_I=0,this.m_invI=0),g(Oi,this.m_sweep.c),this.m_sweep.setLocalCenter(De,this.m_xf),L(Ui,this.m_sweep.c,Oi),Lt(ji,this.m_angularVelocity,Ui),Wt(this.m_linearVelocity,ji)},r.prototype.setMassData=function(t){this.isWorldLocked()!=!0&&this.m_type==Jt&&(this.m_invMass=0,this.m_I=0,this.m_invI=0,this.m_mass=t.mass,this.m_mass<=0&&(this.m_mass=1),this.m_invMass=1/this.m_mass,t.I>0&&this.m_fixedRotationFlag==!1&&(this.m_I=t.I-this.m_mass*I(t.center,t.center),this.m_invI=1/this.m_I),g(Oi,this.m_sweep.c),this.m_sweep.setLocalCenter(t.center,this.m_xf),L(Ui,this.m_sweep.c,Oi),Lt(ji,this.m_angularVelocity,Ui),Wt(this.m_linearVelocity,ji))},r.prototype.applyForce=function(t,e,i){i===void 0&&(i=!0),this.m_type==Jt&&(i&&this.m_awakeFlag==!1&&this.setAwake(!0),this.m_awakeFlag&&(this.m_force.add(t),this.m_torque+=l.crossVec2Vec2(l.sub(e,this.m_sweep.c),t)))},r.prototype.applyForceToCenter=function(t,e){e===void 0&&(e=!0),this.m_type==Jt&&(e&&this.m_awakeFlag==!1&&this.setAwake(!0),this.m_awakeFlag&&this.m_force.add(t))},r.prototype.applyTorque=function(t,e){e===void 0&&(e=!0),this.m_type==Jt&&(e&&this.m_awakeFlag==!1&&this.setAwake(!0),this.m_awakeFlag&&(this.m_torque+=t))},r.prototype.applyLinearImpulse=function(t,e,i){i===void 0&&(i=!0),this.m_type==Jt&&(i&&this.m_awakeFlag==!1&&this.setAwake(!0),this.m_awakeFlag&&(this.m_linearVelocity.addMul(this.m_invMass,t),this.m_angularVelocity+=this.m_invI*l.crossVec2Vec2(l.sub(e,this.m_sweep.c),t)))},r.prototype.applyAngularImpulse=function(t,e){e===void 0&&(e=!0),this.m_type==Jt&&(e&&this.m_awakeFlag==!1&&this.setAwake(!0),this.m_awakeFlag&&(this.m_angularVelocity+=this.m_invI*t))},r.prototype.shouldCollide=function(t){if(this.m_type!=Jt&&t.m_type!=Jt)return!1;for(var e=this.m_jointList;e;e=e.next)if(e.other==t&&e.joint.m_collideConnected==!1)return!1;return!0},r.prototype._addFixture=function(t){if(this.isWorldLocked()==!0)return null;if(this.m_activeFlag){var e=this.m_world.m_broadPhase;t.createProxies(e,this.m_xf)}return t.m_next=this.m_fixtureList,this.m_fixtureList=t,t.m_density>0&&this.resetMassData(),this.m_world.m_newFixture=!0,t},r.prototype.createFixture=function(t,e){if(this.isWorldLocked()==!0)return null;var i=new ps(this,t,e);return this._addFixture(i),i},r.prototype.destroyFixture=function(t){if(this.isWorldLocked()!=!0){if(this.m_fixtureList===t)this.m_fixtureList=t.m_next;else for(var e=this.m_fixtureList;e!=null;){if(e.m_next===t){e.m_next=t.m_next;break}e=e.m_next}for(var i=this.m_contactList;i;){var s=i.contact;i=i.next;var o=s.getFixtureA(),n=s.getFixtureB();(t==o||t==n)&&this.m_world.destroyContact(s)}if(this.m_activeFlag){var a=this.m_world.m_broadPhase;t.destroyProxies(a)}t.m_body=null,t.m_next=null,this.m_world.publish("remove-fixture",t),this.resetMassData()}},r.prototype.getWorldPoint=function(t){return se.mulVec2(this.m_xf,t)},r.prototype.getWorldVector=function(t){return B.mulVec2(this.m_xf.q,t)},r.prototype.getLocalPoint=function(t){return se.mulTVec2(this.m_xf,t)},r.prototype.getLocalVector=function(t){return B.mulTVec2(this.m_xf.q,t)},r.STATIC="static",r.KINEMATIC="kinematic",r.DYNAMIC="dynamic",r})(),yr=(function(){function r(){this.other=null,this.joint=null,this.prev=null,this.next=null}return r})(),xt=(function(){function r(t,e,i){this.m_type="unknown-joint",this.m_prev=null,this.m_next=null,this.m_edgeA=new yr,this.m_edgeB=new yr,this.m_islandFlag=!1,this.style={},this.appData={},e="bodyA"in t?t.bodyA:e,i="bodyB"in t?t.bodyB:i,this.m_bodyA=e,this.m_bodyB=i,this.m_collideConnected=!!t.collideConnected,this.m_userData=t.userData,typeof t.style=="object"&&t.style!==null&&(this.style=t.style)}return r.prototype.isActive=function(){return this.m_bodyA.isActive()&&this.m_bodyB.isActive()},r.prototype.getType=function(){return this.m_type},r.prototype.getBodyA=function(){return this.m_bodyA},r.prototype.getBodyB=function(){return this.m_bodyB},r.prototype.getNext=function(){return this.m_next},r.prototype.getUserData=function(){return this.m_userData},r.prototype.setUserData=function(t){this.m_userData=t},r.prototype.getCollideConnected=function(){return this.m_collideConnected},r.prototype.shiftOrigin=function(t){},r.prototype._resetAnchors=function(t){return this._reset(t)},r})(),Q={gjkCalls:0,gjkIters:0,gjkMaxIters:0,toiTime:0,toiMaxTime:0,toiCalls:0,toiIters:0,toiMaxIters:0,toiRootIters:0,toiMaxRootIters:0},mn=function(){return Date.now()},un=function(r){return Date.now()-r};const gr={now:mn,diff:un};var dn=Math.max,Gi=b(0,0),Wi=b(0,0),kt=b(0,0),$i=b(0,0),gs=b(0,0),_n=b(0,0),pn=b(0,0);Q.gjkCalls=0;Q.gjkIters=0;Q.gjkMaxIters=0;var Ws=(function(){function r(){this.proxyA=new Ze,this.proxyB=new Ze,this.transformA=se.identity(),this.transformB=se.identity(),this.useRadii=!1}return r.prototype.recycle=function(){this.proxyA.recycle(),this.proxyB.recycle(),this.transformA.setIdentity(),this.transformB.setIdentity(),this.useRadii=!1},r})(),$s=(function(){function r(){this.pointA=b(0,0),this.pointB=b(0,0),this.distance=0,this.iterations=0}return r.prototype.recycle=function(){T(this.pointA),T(this.pointB),this.distance=0,this.iterations=0},r})(),Xs=(function(){function r(){this.metric=0,this.indexA=[],this.indexB=[],this.count=0}return r.prototype.recycle=function(){this.metric=0,this.indexA.length=0,this.indexB.length=0,this.count=0},r})(),ii=function(r,t,e){++Q.gjkCalls;var i=e.proxyA,s=e.proxyB,o=e.transformA,n=e.transformB;Kt.recycle(),Kt.readCache(t,i,o,s,n);for(var a=Kt.m_v,h=P.maxDistanceIterations,m=[],c=[],_=0,d=0;d<h;){_=Kt.m_count;for(var u=0;u<_;++u)m[u]=a[u].indexA,c[u]=a[u].indexB;if(Kt.solve(),Kt.m_count===3)break;var f=Kt.getSearchDirection();if(Je(f)<wt*wt)break;var p=a[Kt.m_count];p.indexA=i.getSupport(yi(Gi,o.q,z(Gi,-1,f))),F(p.wA,o,i.getVertex(p.indexA)),p.indexB=s.getSupport(yi(Gi,n.q,f)),F(p.wB,n,s.getVertex(p.indexB)),L(p.w,p.wB,p.wA),++d,++Q.gjkIters;for(var v=!1,u=0;u<_;++u)if(p.indexA===m[u]&&p.indexB===c[u]){v=!0;break}if(v)break;++Kt.m_count}if(Q.gjkMaxIters=dn(Q.gjkMaxIters,d),Kt.getWitnessPoints(r.pointA,r.pointB),r.distance=fo(r.pointA,r.pointB),r.iterations=d,Kt.writeCache(t),e.useRadii){var y=i.m_radius,x=s.m_radius;if(r.distance>y+x&&r.distance>wt)r.distance-=y+x,L(Wi,r.pointB,r.pointA),ie(Wi),ee(r.pointA,y,Wi),ki(r.pointB,x,Wi);else{var A=L(Gi,r.pointA,r.pointB);g(r.pointA,A),g(r.pointB,A),r.distance=0}}},Ze=(function(){function r(){this.m_vertices=[],this.m_count=0,this.m_radius=0}return r.prototype.recycle=function(){this.m_vertices.length=0,this.m_count=0,this.m_radius=0},r.prototype.getVertexCount=function(){return this.m_count},r.prototype.getVertex=function(t){return this.m_vertices[t]},r.prototype.getSupport=function(t){for(var e=-1,i=-1/0,s=0;s<this.m_count;++s){var o=I(this.m_vertices[s],t);o>i&&(e=s,i=o)}return e},r.prototype.getSupportVertex=function(t){return this.m_vertices[this.getSupport(t)]},r.prototype.set=function(t,e){t.computeDistanceProxy(this,e)},r.prototype.setVertices=function(t,e,i){this.m_vertices=t,this.m_count=e,this.m_radius=i},r})(),xs=(function(){function r(){this.wA=b(0,0),this.indexA=0,this.wB=b(0,0),this.indexB=0,this.w=b(0,0),this.a=0}return r.prototype.recycle=function(){this.indexA=0,this.indexB=0,T(this.wA),T(this.wB),T(this.w),this.a=0},r.prototype.set=function(t){this.indexA=t.indexA,this.indexB=t.indexB,g(this.wA,t.wA),g(this.wB,t.wB),g(this.w,t.w),this.a=t.a},r})(),Xi=b(0,0),Ai=b(0,0),fn=(function(){function r(){this.m_v1=new xs,this.m_v2=new xs,this.m_v3=new xs,this.m_v=[this.m_v1,this.m_v2,this.m_v3]}return r.prototype.recycle=function(){this.m_v1.recycle(),this.m_v2.recycle(),this.m_v3.recycle(),this.m_count=0},r.prototype.toString=function(){return this.m_count===3?["+"+this.m_count,this.m_v1.a,this.m_v1.wA.x,this.m_v1.wA.y,this.m_v1.wB.x,this.m_v1.wB.y,this.m_v2.a,this.m_v2.wA.x,this.m_v2.wA.y,this.m_v2.wB.x,this.m_v2.wB.y,this.m_v3.a,this.m_v3.wA.x,this.m_v3.wA.y,this.m_v3.wB.x,this.m_v3.wB.y].toString():this.m_count===2?["+"+this.m_count,this.m_v1.a,this.m_v1.wA.x,this.m_v1.wA.y,this.m_v1.wB.x,this.m_v1.wB.y,this.m_v2.a,this.m_v2.wA.x,this.m_v2.wA.y,this.m_v2.wB.x,this.m_v2.wB.y].toString():this.m_count===1?["+"+this.m_count,this.m_v1.a,this.m_v1.wA.x,this.m_v1.wA.y,this.m_v1.wB.x,this.m_v1.wB.y].toString():"+"+this.m_count},r.prototype.readCache=function(t,e,i,s,o){this.m_count=t.count;for(var n=0;n<this.m_count;++n){var a=this.m_v[n];a.indexA=t.indexA[n],a.indexB=t.indexB[n];var h=e.getVertex(a.indexA),m=s.getVertex(a.indexB);F(a.wA,i,h),F(a.wB,o,m),L(a.w,a.wB,a.wA),a.a=0}if(this.m_count>1){var c=t.metric,_=this.getMetric();(_<.5*c||2*c<_||_<wt)&&(this.m_count=0)}if(this.m_count===0){var a=this.m_v[0];a.indexA=0,a.indexB=0;var h=e.getVertex(0),m=s.getVertex(0);F(a.wA,i,h),F(a.wB,o,m),L(a.w,a.wB,a.wA),a.a=1,this.m_count=1}},r.prototype.writeCache=function(t){t.metric=this.getMetric(),t.count=this.m_count;for(var e=0;e<this.m_count;++e)t.indexA[e]=this.m_v[e].indexA,t.indexB[e]=this.m_v[e].indexB},r.prototype.getSearchDirection=function(){var t=this.m_v1,e=this.m_v2;switch(this.m_count){case 1:return ft(Xi,-t.w.x,-t.w.y);case 2:{L(kt,e.w,t.w);var i=-N(kt,t.w);return i>0?ft(Xi,-kt.y,kt.x):ft(Xi,kt.y,-kt.x)}default:return T(Xi)}},r.prototype.getClosestPoint=function(){var t=this.m_v1,e=this.m_v2;switch(this.m_count){case 0:return T(Ai);case 1:return g(Ai,t.w);case 2:return Z(Ai,t.a,t.w,e.a,e.w);case 3:return T(Ai);default:return T(Ai)}},r.prototype.getWitnessPoints=function(t,e){var i=this.m_v1,s=this.m_v2,o=this.m_v3;switch(this.m_count){case 0:break;case 1:g(t,i.wA),g(e,i.wB);break;case 2:Z(t,i.a,i.wA,s.a,s.wA),Z(e,i.a,i.wB,s.a,s.wB);break;case 3:me(t,i.a,i.wA,s.a,s.wA,o.a,o.wA),g(e,t);break}},r.prototype.getMetric=function(){switch(this.m_count){case 0:return 0;case 1:return 0;case 2:return fo(this.m_v1.w,this.m_v2.w);case 3:return N(L(_n,this.m_v2.w,this.m_v1.w),L(pn,this.m_v3.w,this.m_v1.w));default:return 0}},r.prototype.solve=function(){switch(this.m_count){case 1:break;case 2:this.solve2();break;case 3:this.solve3();break}},r.prototype.solve2=function(){var t=this.m_v1.w,e=this.m_v2.w;L(kt,e,t);var i=-I(t,kt);if(i<=0){this.m_v1.a=1,this.m_count=1;return}var s=I(e,kt);if(s<=0){this.m_v2.a=1,this.m_count=1,this.m_v1.set(this.m_v2);return}var o=1/(s+i);this.m_v1.a=s*o,this.m_v2.a=i*o,this.m_count=2},r.prototype.solve3=function(){var t=this.m_v1.w,e=this.m_v2.w,i=this.m_v3.w;L(kt,e,t);var s=I(t,kt),o=I(e,kt),n=o,a=-s;L($i,i,t);var h=I(t,$i),m=I(i,$i),c=m,_=-h;L(gs,i,e);var d=I(e,gs),u=I(i,gs),f=u,p=-d,v=N(kt,$i),y=v*N(e,i),x=v*N(i,t),A=v*N(t,e);if(a<=0&&_<=0){this.m_v1.a=1,this.m_count=1;return}if(n>0&&a>0&&A<=0){var w=1/(n+a);this.m_v1.a=n*w,this.m_v2.a=a*w,this.m_count=2;return}if(c>0&&_>0&&x<=0){var M=1/(c+_);this.m_v1.a=c*M,this.m_v3.a=_*M,this.m_count=2,this.m_v2.set(this.m_v3);return}if(n<=0&&p<=0){this.m_v2.a=1,this.m_count=1,this.m_v1.set(this.m_v2);return}if(c<=0&&f<=0){this.m_v3.a=1,this.m_count=1,this.m_v1.set(this.m_v3);return}if(f>0&&p>0&&y<=0){var S=1/(f+p);this.m_v2.a=f*S,this.m_v3.a=p*S,this.m_count=2,this.m_v1.set(this.m_v3);return}var C=1/(y+x+A);this.m_v1.a=y*C,this.m_v2.a=x*C,this.m_v3.a=A*C,this.m_count=3},r})(),Kt=new fn,Ee=new Ws,xr=new Xs,bs=new $s,bo=function(r,t,e,i,s,o){return Ee.recycle(),Ee.proxyA.set(r,t),Ee.proxyB.set(e,i),_s(Ee.transformA,s),_s(Ee.transformB,o),Ee.useRadii=!0,bs.recycle(),xr.recycle(),ii(bs,xr,Ee),bs.distance<10*wt};ii.testOverlap=bo;ii.Input=Ws;ii.Output=$s;ii.Proxy=Ze;ii.Cache=Xs;(function(){function r(){this.proxyA=new Ze,this.proxyB=new Ze,this.transformA=se.identity(),this.transformB=se.identity(),this.translationB=l.zero()}return r.prototype.recycle=function(){this.proxyA.recycle(),this.proxyB.recycle(),this.transformA.setIdentity(),this.transformB.setIdentity(),T(this.translationB)},r})();var vn=Math.abs,Yi=Math.max,Ao=(function(){function r(){this.proxyA=new Ze,this.proxyB=new Ze,this.sweepA=new gi,this.sweepB=new gi}return r.prototype.recycle=function(){this.proxyA.recycle(),this.proxyB.recycle(),this.sweepA.recycle(),this.sweepB.recycle(),this.tMax=-1},r})(),$t;(function(r){r[r.e_unset=-1]="e_unset",r[r.e_unknown=0]="e_unknown",r[r.e_failed=1]="e_failed",r[r.e_overlapped=2]="e_overlapped",r[r.e_touching=3]="e_touching",r[r.e_separated=4]="e_separated"})($t||($t={}));var Bo=(function(){function r(){this.state=$t.e_unset,this.t=-1}return r.prototype.recycle=function(){this.state=$t.e_unset,this.t=-1},r})();Q.toiTime=0;Q.toiMaxTime=0;Q.toiCalls=0;Q.toiIters=0;Q.toiMaxIters=0;Q.toiRootIters=0;Q.toiMaxRootIters=0;var ri=new Ws,As=new $s,Bs=new Xs,St=ti(0,0,0),It=ti(0,0,0),Bi=b(0,0),ne=b(0,0),Ot=b(0,0),Ct=b(0,0),Ji=b(0,0),Ki=b(0,0),Zi=b(0,0),Qi=b(0,0),Ys=function(r,t){var e=gr.now();++Q.toiCalls,r.state=$t.e_unknown,r.t=t.tMax;var i=t.proxyA,s=t.proxyB,o=t.sweepA,n=t.sweepB;o.normalize(),n.normalize();var a=t.tMax,h=i.m_radius+s.m_radius,m=Yi(P.linearSlop,h-3*P.linearSlop),c=.25*P.linearSlop,_=0,d=P.maxTOIIterations,u=0;for(Bs.recycle(),ri.proxyA.setVertices(i.m_vertices,i.m_count,i.m_radius),ri.proxyB.setVertices(s.m_vertices,s.m_count,s.m_radius),ri.useRadii=!1;;){if(o.getTransform(St,_),n.getTransform(It,_),_s(ri.transformA,St),_s(ri.transformB,It),ii(As,Bs,ri),As.distance<=0){r.state=$t.e_overlapped,r.t=0;break}if(As.distance<m+c){r.state=$t.e_touching,r.t=_;break}wi.initialize(Bs,i,o,s,n,_);for(var f=!1,p=a,v=0;;){var y=wi.findMinSeparation(p);if(y>m+c){r.state=$t.e_separated,r.t=a,f=!0;break}if(y>m-c){_=p;break}var x=wi.evaluate(_);if(x<m-c){r.state=$t.e_failed,r.t=_,f=!0;break}if(x<=m+c){r.state=$t.e_touching,r.t=_,f=!0;break}for(var A=0,w=_,M=p;;){var S=void 0;A&1?S=w+(m-x)*(M-w)/(y-x):S=.5*(w+M),++A,++Q.toiRootIters;var C=wi.evaluate(S);if(vn(C-m)<c){p=S;break}if(C>m?(w=S,x=C):(M=S,y=C),A===50)break}if(Q.toiMaxRootIters=Yi(Q.toiMaxRootIters,A),++v,v===P.maxPolygonVertices)break}if(++u,++Q.toiIters,f)break;if(u===d){r.state=$t.e_failed,r.t=_;break}}Q.toiMaxIters=Yi(Q.toiMaxIters,u);var V=gr.diff(e);Q.toiMaxTime=Yi(Q.toiMaxTime,V),Q.toiTime+=V,wi.recycle()},ue;(function(r){r[r.e_unset=-1]="e_unset",r[r.e_points=1]="e_points",r[r.e_faceA=2]="e_faceA",r[r.e_faceB=3]="e_faceB"})(ue||(ue={}));var yn=(function(){function r(){this.m_proxyA=null,this.m_proxyB=null,this.m_sweepA=null,this.m_sweepB=null,this.m_type=ue.e_unset,this.m_localPoint=b(0,0),this.m_axis=b(0,0),this.indexA=-1,this.indexB=-1}return r.prototype.recycle=function(){this.m_proxyA=null,this.m_proxyB=null,this.m_sweepA=null,this.m_sweepB=null,this.m_type=ue.e_unset,T(this.m_localPoint),T(this.m_axis),this.indexA=-1,this.indexB=-1},r.prototype.initialize=function(t,e,i,s,o,n){var a=t.count;if(this.m_proxyA=e,this.m_proxyB=s,this.m_sweepA=i,this.m_sweepB=o,this.m_sweepA.getTransform(St,n),this.m_sweepB.getTransform(It,n),a===1){this.m_type=ue.e_points;var h=this.m_proxyA.getVertex(t.indexA[0]),m=this.m_proxyB.getVertex(t.indexB[0]);F(ne,St,h),F(Ot,It,m),L(this.m_axis,Ot,ne);var c=en(this.m_axis);return c}else if(t.indexA[0]===t.indexA[1]){this.m_type=ue.e_faceB;var _=s.getVertex(t.indexB[0]),d=s.getVertex(t.indexB[1]);Ye(this.m_axis,L(Bi,d,_),1),ie(this.m_axis),Xt(Ct,It.q,this.m_axis),Z(this.m_localPoint,.5,_,.5,d),F(Ot,It,this.m_localPoint);var u=e.getVertex(t.indexA[0]),f=se.mulVec2(St,u),c=I(f,Ct)-I(Ot,Ct);return c<0&&(Hi(this.m_axis),c=-c),c}else{this.m_type=ue.e_faceA;var p=this.m_proxyA.getVertex(t.indexA[0]),v=this.m_proxyA.getVertex(t.indexA[1]);Ye(this.m_axis,L(Bi,v,p),1),ie(this.m_axis),Xt(Ct,St.q,this.m_axis),Z(this.m_localPoint,.5,p,.5,v),F(ne,St,this.m_localPoint);var y=this.m_proxyB.getVertex(t.indexB[0]);F(Ot,It,y);var c=I(Ot,Ct)-I(ne,Ct);return c<0&&(Hi(this.m_axis),c=-c),c}},r.prototype.compute=function(t,e){switch(this.m_sweepA.getTransform(St,e),this.m_sweepB.getTransform(It,e),this.m_type){case ue.e_points:{t&&(yi(Ji,St.q,this.m_axis),yi(Ki,It.q,z(Bi,-1,this.m_axis)),this.indexA=this.m_proxyA.getSupport(Ji),this.indexB=this.m_proxyB.getSupport(Ki)),g(Zi,this.m_proxyA.getVertex(this.indexA)),g(Qi,this.m_proxyB.getVertex(this.indexB)),F(ne,St,Zi),F(Ot,It,Qi);var i=I(Ot,this.m_axis)-I(ne,this.m_axis);return i}case ue.e_faceA:{Xt(Ct,St.q,this.m_axis),F(ne,St,this.m_localPoint),t&&(yi(Ki,It.q,z(Bi,-1,Ct)),this.indexA=-1,this.indexB=this.m_proxyB.getSupport(Ki)),g(Qi,this.m_proxyB.getVertex(this.indexB)),F(Ot,It,Qi);var i=I(Ot,Ct)-I(ne,Ct);return i}case ue.e_faceB:{Xt(Ct,It.q,this.m_axis),F(Ot,It,this.m_localPoint),t&&(yi(Ji,St.q,z(Bi,-1,Ct)),this.indexB=-1,this.indexA=this.m_proxyA.getSupport(Ji)),g(Zi,this.m_proxyA.getVertex(this.indexA)),F(ne,St,Zi);var i=I(ne,Ct)-I(Ot,Ct);return i}default:return t&&(this.indexA=-1,this.indexB=-1),0}},r.prototype.findMinSeparation=function(t){return this.compute(!0,t)},r.prototype.evaluate=function(t){return this.compute(!1,t)},r})(),wi=new yn;Ys.Input=Ao;Ys.Output=Bo;var br=Math.abs,Ar=Math.sqrt,ts=Math.min,Js=(function(){function r(){this.dt=0,this.inv_dt=0,this.velocityIterations=0,this.positionIterations=0,this.warmStarting=!1,this.blockSolve=!0,this.inv_dt0=0,this.dtRatio=1}return r.prototype.reset=function(t){this.dt>0&&(this.inv_dt0=this.inv_dt),this.dt=t,this.inv_dt=t==0?0:1/t,this.dtRatio=t*this.inv_dt0},r})(),oi=new Js,pe=b(0,0),gt=b(0,0),es=b(0,0),ni=new Ao,ws=new Bo,Br=new gi,wr=new gi,Mr=new gi,gn=(function(){function r(t){this.contact=t,this.normals=[],this.tangents=[]}return r.prototype.recycle=function(){this.normals.length=0,this.tangents.length=0},Object.defineProperty(r.prototype,"normalImpulses",{get:function(){var t=this.contact,e=this.normals;e.length=0;for(var i=0;i<t.v_points.length;++i)e.push(t.v_points[i].normalImpulse);return e},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"tangentImpulses",{get:function(){var t=this.contact,e=this.tangents;e.length=0;for(var i=0;i<t.v_points.length;++i)e.push(t.v_points[i].tangentImpulse);return e},enumerable:!1,configurable:!0}),r})(),wo=(function(){function r(t){this.m_world=t,this.m_stack=[],this.m_bodies=[],this.m_contacts=[],this.m_joints=[]}return r.prototype.clear=function(){this.m_stack.length=0,this.m_bodies.length=0,this.m_contacts.length=0,this.m_joints.length=0},r.prototype.addBody=function(t){this.m_bodies.push(t)},r.prototype.addContact=function(t){this.m_contacts.push(t)},r.prototype.addJoint=function(t){this.m_joints.push(t)},r.prototype.solveWorld=function(t){for(var e=this.m_world,i=e.m_bodyList;i;i=i.m_next)i.m_islandFlag=!1;for(var s=e.m_contactList;s;s=s.m_next)s.m_islandFlag=!1;for(var o=e.m_jointList;o;o=o.m_next)o.m_islandFlag=!1;for(var n=this.m_stack,a=e.m_bodyList;a;a=a.m_next)if(!a.m_islandFlag&&!(a.isAwake()==!1||a.isActive()==!1)&&!a.isStatic()){for(this.clear(),n.push(a),a.m_islandFlag=!0;n.length>0;){var i=n.pop();if(this.addBody(i),i.m_awakeFlag=!0,!i.isStatic()){for(var h=i.m_contactList;h;h=h.next){var m=h.contact;if(!m.m_islandFlag&&!(m.isEnabled()==!1||m.isTouching()==!1)){var c=m.m_fixtureA.m_isSensor,_=m.m_fixtureB.m_isSensor;if(!(c||_)){this.addContact(m),m.m_islandFlag=!0;var d=h.other;d.m_islandFlag||(n.push(d),d.m_islandFlag=!0)}}}for(var u=i.m_jointList;u;u=u.next)if(u.joint.m_islandFlag!=!0){var d=u.other;d.isActive()!=!1&&(this.addJoint(u.joint),u.joint.m_islandFlag=!0,!d.m_islandFlag&&(n.push(d),d.m_islandFlag=!0))}}}this.solveIsland(t);for(var f=0;f<this.m_bodies.length;++f){var i=this.m_bodies[f];i.isStatic()&&(i.m_islandFlag=!1)}}},r.prototype.solveIsland=function(t){for(var e=this.m_world,i=e.m_gravity,s=e.m_allowSleep,o=t.dt,n=0;n<this.m_bodies.length;++n){var a=this.m_bodies[n];g(pe,a.m_sweep.c);var h=a.m_sweep.a;g(gt,a.m_linearVelocity);var m=a.m_angularVelocity;g(a.m_sweep.c0,a.m_sweep.c),a.m_sweep.a0=a.m_sweep.a,a.isDynamic()&&(ee(gt,o*a.m_gravityScale,i),ee(gt,o*a.m_invMass,a.m_force),m+=o*a.m_invI*a.m_torque,z(gt,1/(1+o*a.m_linearDamping),gt),m*=1/(1+o*a.m_angularDamping)),g(a.c_position.c,pe),a.c_position.a=h,g(a.c_velocity.v,gt),a.c_velocity.w=m}for(var n=0;n<this.m_contacts.length;++n){var c=this.m_contacts[n];c.initConstraint(t)}for(var n=0;n<this.m_contacts.length;++n){var c=this.m_contacts[n];c.initVelocityConstraint(t)}if(t.warmStarting)for(var n=0;n<this.m_contacts.length;++n){var c=this.m_contacts[n];c.warmStartConstraint(t)}for(var n=0;n<this.m_joints.length;++n){var _=this.m_joints[n];_.initVelocityConstraints(t)}for(var n=0;n<t.velocityIterations;++n){for(var d=0;d<this.m_joints.length;++d){var _=this.m_joints[d];_.solveVelocityConstraints(t)}for(var d=0;d<this.m_contacts.length;++d){var c=this.m_contacts[d];c.solveVelocityConstraint(t)}}for(var n=0;n<this.m_contacts.length;++n){var c=this.m_contacts[n];c.storeConstraintImpulses(t)}for(var n=0;n<this.m_bodies.length;++n){var a=this.m_bodies[n];g(pe,a.c_position.c);var h=a.c_position.a;g(gt,a.c_velocity.v);var m=a.c_velocity.w;z(es,o,gt);var u=Je(es);if(u>P.maxTranslationSquared){var f=P.maxTranslation/Ar(u);lr(gt,f)}var p=o*m;if(p*p>P.maxRotationSquared){var f=P.maxRotation/br(p);m*=f}ee(pe,o,gt),h+=o*m,g(a.c_position.c,pe),a.c_position.a=h,g(a.c_velocity.v,gt),a.c_velocity.w=m}for(var v=!1,n=0;n<t.positionIterations;++n){for(var y=0,d=0;d<this.m_contacts.length;++d){var c=this.m_contacts[d],x=c.solvePositionConstraint(t);y=ts(y,x)}for(var A=y>=-3*P.linearSlop,w=!0,d=0;d<this.m_joints.length;++d){var _=this.m_joints[d],M=_.solvePositionConstraints(t);w=w&&M}if(A&&w){v=!0;break}}for(var n=0;n<this.m_bodies.length;++n){var a=this.m_bodies[n];g(a.m_sweep.c,a.c_position.c),a.m_sweep.a=a.c_position.a,g(a.m_linearVelocity,a.c_velocity.v),a.m_angularVelocity=a.c_velocity.w,a.synchronizeTransform()}if(this.postSolveIsland(),s){for(var S=1/0,C=P.linearSleepToleranceSqr,V=P.angularSleepToleranceSqr,n=0;n<this.m_bodies.length;++n){var a=this.m_bodies[n];a.isStatic()||(a.m_autoSleepFlag==!1||a.m_angularVelocity*a.m_angularVelocity>V||Je(a.m_linearVelocity)>C?(a.m_sleepTime=0,S=0):(a.m_sleepTime+=o,S=ts(S,a.m_sleepTime)))}if(S>=P.timeToSleep&&v)for(var n=0;n<this.m_bodies.length;++n){var a=this.m_bodies[n];a.setAwake(!1)}}},r.prototype.solveWorldTOI=function(t){var e=this.m_world;if(e.m_stepComplete){for(var i=e.m_bodyList;i;i=i.m_next)i.m_islandFlag=!1,i.m_sweep.alpha0=0;for(var s=e.m_contactList;s;s=s.m_next)s.m_toiFlag=!1,s.m_islandFlag=!1,s.m_toiCount=0,s.m_toi=1}for(;;){for(var o=null,n=1,a=e.m_contactList;a;a=a.m_next)if(a.isEnabled()!=!1&&!(a.m_toiCount>P.maxSubSteps)){var h=1;if(a.m_toiFlag)h=a.m_toi;else{var m=a.getFixtureA(),c=a.getFixtureB();if(m.isSensor()||c.isSensor())continue;var _=m.getBody(),d=c.getBody(),u=_.isAwake()&&!_.isStatic(),f=d.isAwake()&&!d.isStatic();if(u==!1&&f==!1)continue;var p=_.isBullet()||!_.isDynamic(),v=d.isBullet()||!d.isDynamic();if(p==!1&&v==!1)continue;var y=_.m_sweep.alpha0;_.m_sweep.alpha0<d.m_sweep.alpha0?(y=d.m_sweep.alpha0,_.m_sweep.advance(y)):d.m_sweep.alpha0<_.m_sweep.alpha0&&(y=_.m_sweep.alpha0,d.m_sweep.advance(y));var x=a.getChildIndexA(),A=a.getChildIndexB();ni.proxyA.set(m.getShape(),x),ni.proxyB.set(c.getShape(),A),ni.sweepA.set(_.m_sweep),ni.sweepB.set(d.m_sweep),ni.tMax=1,Ys(ws,ni);var w=ws.t;ws.state==$t.e_touching?h=ts(y+(1-y)*w,1):h=1,a.m_toi=h,a.m_toiFlag=!0}h<n&&(o=a,n=h)}if(o==null||1-10*wt<n){e.m_stepComplete=!0;break}var M=o.getFixtureA(),S=o.getFixtureB(),C=M.getBody(),V=S.getBody();if(wr.set(C.m_sweep),Mr.set(V.m_sweep),C.advance(n),V.advance(n),o.update(e),o.m_toiFlag=!1,++o.m_toiCount,o.isEnabled()==!1||o.isTouching()==!1){o.setEnabled(!1),C.m_sweep.set(wr),V.m_sweep.set(Mr),C.synchronizeTransform(),V.synchronizeTransform();continue}C.setAwake(!0),V.setAwake(!0),this.clear(),this.addBody(C),this.addBody(V),this.addContact(o),C.m_islandFlag=!0,V.m_islandFlag=!0,o.m_islandFlag=!0;for(var H=[C,V],E=0;E<H.length;++E){var q=H[E];if(q.isDynamic())for(var j=q.m_contactList;j;j=j.next){var W=j.contact;if(!W.m_islandFlag){var Y=j.other;if(!(Y.isDynamic()&&!q.isBullet()&&!Y.isBullet())){var Tt=W.m_fixtureA.m_isSensor,dt=W.m_fixtureB.m_isSensor;if(!(Tt||dt)){if(Br.set(Y.m_sweep),Y.m_islandFlag==!1&&Y.advance(n),W.update(e),W.isEnabled()==!1||W.isTouching()==!1){Y.m_sweep.set(Br),Y.synchronizeTransform();continue}W.m_islandFlag=!0,this.addContact(W),!Y.m_islandFlag&&(Y.m_islandFlag=!0,Y.isStatic()||Y.setAwake(!0),this.addBody(Y))}}}}}oi.reset((1-n)*t.dt),oi.dtRatio=1,oi.positionIterations=20,oi.velocityIterations=t.velocityIterations,oi.warmStarting=!1,this.solveIslandTOI(oi,C,V);for(var E=0;E<this.m_bodies.length;++E){var q=this.m_bodies[E];if(q.m_islandFlag=!1,!!q.isDynamic()){q.synchronizeFixtures();for(var j=q.m_contactList;j;j=j.next)j.contact.m_toiFlag=!1,j.contact.m_islandFlag=!1}}if(e.findNewContacts(),e.m_subStepping){e.m_stepComplete=!1;break}}},r.prototype.solveIslandTOI=function(t,e,i){for(var c=0;c<this.m_bodies.length;++c){var s=this.m_bodies[c];g(s.c_position.c,s.m_sweep.c),s.c_position.a=s.m_sweep.a,g(s.c_velocity.v,s.m_linearVelocity),s.c_velocity.w=s.m_angularVelocity}for(var c=0;c<this.m_contacts.length;++c){var o=this.m_contacts[c];o.initConstraint(t)}for(var c=0;c<t.positionIterations;++c){for(var n=0,a=0;a<this.m_contacts.length;++a){var o=this.m_contacts[a],h=o.solvePositionConstraintTOI(t,e,i);n=ts(n,h)}var m=n>=-1.5*P.linearSlop;if(m)break}var c;g(e.m_sweep.c0,e.c_position.c),e.m_sweep.a0=e.c_position.a,g(i.m_sweep.c0,i.c_position.c),i.m_sweep.a0=i.c_position.a;for(var c=0;c<this.m_contacts.length;++c){var o=this.m_contacts[c];o.initVelocityConstraint(t)}for(var c=0;c<t.velocityIterations;++c)for(var a=0;a<this.m_contacts.length;++a){var o=this.m_contacts[a];o.solveVelocityConstraint(t)}for(var _=t.dt,c=0;c<this.m_bodies.length;++c){var s=this.m_bodies[c];g(pe,s.c_position.c);var d=s.c_position.a;g(gt,s.c_velocity.v);var u=s.c_velocity.w;z(es,_,gt);var f=Je(es);if(f>P.maxTranslationSquared){var p=P.maxTranslation/Ar(f);lr(gt,p)}var v=_*u;if(v*v>P.maxRotationSquared){var p=P.maxRotation/br(v);u*=p}ee(pe,_,gt),d+=_*u,g(s.c_position.c,pe),s.c_position.a=d,g(s.c_velocity.v,gt),s.c_velocity.w=u,g(s.m_sweep.c,pe),s.m_sweep.a=d,g(s.m_linearVelocity,gt),s.m_angularVelocity=u,s.synchronizeTransform()}this.postSolveIsland()},r.prototype.postSolveIsland=function(){for(var t=0;t<this.m_contacts.length;++t){var e=this.m_contacts[t];this.m_world.postSolve(e,e.m_impulse)}},r})();wo.TimeStep=Js;var re=(function(){function r(t,e,i,s){typeof t=="object"&&t!==null?(this.ex=l.clone(t),this.ey=l.clone(e)):typeof t=="number"?(this.ex=l.neo(t,i),this.ey=l.neo(e,s)):(this.ex=l.zero(),this.ey=l.zero())}return r.prototype.toString=function(){return JSON.stringify(this)},r.isValid=function(t){return t===null||typeof t>"u"?!1:l.isValid(t.ex)&&l.isValid(t.ey)},r.assert=function(t){},r.prototype.set=function(t,e,i,s){typeof t=="number"&&typeof e=="number"&&typeof i=="number"&&typeof s=="number"?(this.ex.setNum(t,i),this.ey.setNum(e,s)):typeof t=="object"&&typeof e=="object"?(this.ex.setVec2(t),this.ey.setVec2(e)):typeof t=="object"&&(this.ex.setVec2(t.ex),this.ey.setVec2(t.ey))},r.prototype.setIdentity=function(){this.ex.x=1,this.ey.x=0,this.ex.y=0,this.ey.y=1},r.prototype.setZero=function(){this.ex.x=0,this.ey.x=0,this.ex.y=0,this.ey.y=0},r.prototype.getInverse=function(){var t=this.ex.x,e=this.ey.x,i=this.ex.y,s=this.ey.y,o=t*s-e*i;o!==0&&(o=1/o);var n=new r;return n.ex.x=o*s,n.ey.x=-o*e,n.ex.y=-o*i,n.ey.y=o*t,n},r.prototype.solve=function(t){var e=this.ex.x,i=this.ey.x,s=this.ex.y,o=this.ey.y,n=e*o-i*s;n!==0&&(n=1/n);var a=l.zero();return a.x=n*(o*t.x-i*t.y),a.y=n*(e*t.y-s*t.x),a},r.mul=function(t,e){if(e&&"x"in e&&"y"in e){var i=t.ex.x*e.x+t.ey.x*e.y,s=t.ex.y*e.x+t.ey.y*e.y;return l.neo(i,s)}else if(e&&"ex"in e&&"ey"in e){var o=t.ex.x*e.ex.x+t.ey.x*e.ex.y,n=t.ex.x*e.ey.x+t.ey.x*e.ey.y,a=t.ex.y*e.ex.x+t.ey.y*e.ex.y,h=t.ex.y*e.ey.x+t.ey.y*e.ey.y;return new r(o,n,a,h)}},r.mulVec2=function(t,e){var i=t.ex.x*e.x+t.ey.x*e.y,s=t.ex.y*e.x+t.ey.y*e.y;return l.neo(i,s)},r.mulMat22=function(t,e){var i=t.ex.x*e.ex.x+t.ey.x*e.ex.y,s=t.ex.x*e.ey.x+t.ey.x*e.ey.y,o=t.ex.y*e.ex.x+t.ey.y*e.ex.y,n=t.ex.y*e.ey.x+t.ey.y*e.ey.y;return new r(i,s,o,n)},r.mulT=function(t,e){if(e&&"x"in e&&"y"in e)return l.neo(l.dot(e,t.ex),l.dot(e,t.ey));if(e&&"ex"in e&&"ey"in e){var i=l.neo(l.dot(t.ex,e.ex),l.dot(t.ey,e.ex)),s=l.neo(l.dot(t.ex,e.ey),l.dot(t.ey,e.ey));return new r(i,s)}},r.mulTVec2=function(t,e){return l.neo(l.dot(e,t.ex),l.dot(e,t.ey))},r.mulTMat22=function(t,e){var i=l.neo(l.dot(t.ex,e.ex),l.dot(t.ey,e.ex)),s=l.neo(l.dot(t.ex,e.ey),l.dot(t.ey,e.ey));return new r(i,s)},r.abs=function(t){return new r(l.abs(t.ex),l.abs(t.ey))},r.add=function(t,e){return new r(l.add(t.ex,e.ex),l.add(t.ey,e.ey))},r})(),xn=Math.sqrt,Ms=b(0,0),Cs=b(0,0),Mi=b(0,0),fe=b(0,0),ve=b(0,0),Ss=b(0,0),is=b(0,0),Ce=b(0,0),tt;(function(r){r[r.e_unset=-1]="e_unset",r[r.e_circles=0]="e_circles",r[r.e_faceA=1]="e_faceA",r[r.e_faceB=2]="e_faceB"})(tt||(tt={}));var U;(function(r){r[r.e_unset=-1]="e_unset",r[r.e_vertex=0]="e_vertex",r[r.e_face=1]="e_face"})(U||(U={}));var Xe;(function(r){r[r.nullState=0]="nullState",r[r.addState=1]="addState",r[r.persistState=2]="persistState",r[r.removeState=3]="removeState"})(Xe||(Xe={}));var Dt=(function(){function r(){this.v=b(0,0),this.id=new Co}return r.prototype.set=function(t){g(this.v,t.v),this.id.set(t.id)},r.prototype.recycle=function(){T(this.v),this.id.recycle()},r})(),Mo=(function(){function r(){this.localNormal=b(0,0),this.localPoint=b(0,0),this.points=[new Cr,new Cr],this.pointCount=0}return r.prototype.set=function(t){this.type=t.type,g(this.localNormal,t.localNormal),g(this.localPoint,t.localPoint),this.pointCount=t.pointCount,this.points[0].set(t.points[0]),this.points[1].set(t.points[1])},r.prototype.recycle=function(){this.type=tt.e_unset,T(this.localNormal),T(this.localPoint),this.pointCount=0,this.points[0].recycle(),this.points[1].recycle()},r.prototype.getWorldManifold=function(t,e,i,s,o){if(this.pointCount==0)return t;t=t||new So,t.pointCount=this.pointCount;var n=t.normal,a=t.points,h=t.separations;switch(this.type){case tt.e_circles:{ft(n,1,0);var m=this.points[0];F(Ms,e,this.localPoint),F(Cs,s,m.localPoint),L(Ss,Cs,Ms);var c=Je(Ss);if(c>wt*wt){var _=xn(c);z(n,1/_,Ss)}Z(fe,1,Ms,i,n),Z(ve,1,Cs,-o,n),Z(a[0],.5,fe,.5,ve),h[0]=I(L(Mi,ve,fe),n);break}case tt.e_faceA:{Xt(n,e.q,this.localNormal),F(is,e,this.localPoint);for(var d=0;d<this.pointCount;++d){var m=this.points[d];F(Ce,s,m.localPoint),Z(fe,1,Ce,i-I(L(Mi,Ce,is),n),n),Z(ve,1,Ce,-o,n),Z(a[d],.5,fe,.5,ve),h[d]=I(L(Mi,ve,fe),n)}break}case tt.e_faceB:{Xt(n,s.q,this.localNormal),F(is,s,this.localPoint);for(var d=0;d<this.pointCount;++d){var m=this.points[d];F(Ce,e,m.localPoint),Z(ve,1,Ce,o-I(L(Mi,Ce,is),n),n),Z(fe,1,Ce,-i,n),Z(a[d],.5,fe,.5,ve),h[d]=I(L(Mi,fe,ve),n)}Hi(n);break}}return t},r.clipSegmentToLine=Di,r.ClipVertex=Dt,r.getPointStates=bn,r.PointState=Xe,r})(),Cr=(function(){function r(){this.localPoint=b(0,0),this.normalImpulse=0,this.tangentImpulse=0,this.id=new Co}return r.prototype.set=function(t){g(this.localPoint,t.localPoint),this.normalImpulse=t.normalImpulse,this.tangentImpulse=t.tangentImpulse,this.id.set(t.id)},r.prototype.recycle=function(){T(this.localPoint),this.normalImpulse=0,this.tangentImpulse=0,this.id.recycle()},r})(),Co=(function(){function r(){this.key=-1,this.indexA=-1,this.indexB=-1,this.typeA=U.e_unset,this.typeB=U.e_unset}return r.prototype.setFeatures=function(t,e,i,s){this.indexA=t,this.indexB=i,this.typeA=e,this.typeB=s,this.key=this.indexA+this.indexB*4+this.typeA*16+this.typeB*64},r.prototype.set=function(t){this.indexA=t.indexA,this.indexB=t.indexB,this.typeA=t.typeA,this.typeB=t.typeB,this.key=this.indexA+this.indexB*4+this.typeA*16+this.typeB*64},r.prototype.swapFeatures=function(){var t=this.indexA,e=this.indexB,i=this.typeA,s=this.typeB;this.indexA=e,this.indexB=t,this.typeA=s,this.typeB=i,this.key=this.indexA+this.indexB*4+this.typeA*16+this.typeB*64},r.prototype.recycle=function(){this.indexA=0,this.indexB=0,this.typeA=U.e_unset,this.typeB=U.e_unset,this.key=-1},r})(),So=(function(){function r(){this.normal=b(0,0),this.points=[b(0,0),b(0,0)],this.separations=[0,0],this.pointCount=0}return r.prototype.recycle=function(){T(this.normal),T(this.points[0]),T(this.points[1]),this.separations[0]=0,this.separations[1]=0,this.pointCount=0},r})();function bn(r,t,e,i){for(var s=0;s<e.pointCount;++s){var o=e.points[s].id;r[s]=Xe.removeState;for(var n=0;n<i.pointCount;++n)if(i.points[n].id.key===o.key){r[s]=Xe.persistState;break}}for(var s=0;s<i.pointCount;++s){var o=i.points[s].id;t[s]=Xe.addState;for(var n=0;n<e.pointCount;++n)if(e.points[n].id.key===o.key){t[s]=Xe.persistState;break}}}function Di(r,t,e,i,s){var o=0,n=I(e,t[0].v)-i,a=I(e,t[1].v)-i;if(n<=0&&r[o++].set(t[0]),a<=0&&r[o++].set(t[1]),n*a<0){var h=n/(n-a);Z(r[o].v,1-h,t[0].v,h,t[1].v),r[o].id.setFeatures(s,U.e_vertex,t[0].id.indexB,U.e_face),++o}return o}var An=Math.sqrt,Bn=Math.max,wn=Math.min,Sr=new Fi({create:function(){return new de},release:function(r){r.recycle()}}),ai=new Mo,ss=new So,Ir=(function(){function r(t){this.prev=null,this.next=null,this.other=null,this.contact=t}return r.prototype.recycle=function(){this.prev=null,this.next=null,this.other=null},r})();function Vr(r,t){return An(r*t)}function Pr(r,t){return r>t?r:t}var qe=[],Tr=(function(){function r(){this.rA=b(0,0),this.rB=b(0,0),this.normalImpulse=0,this.tangentImpulse=0,this.normalMass=0,this.tangentMass=0,this.velocityBias=0}return r.prototype.recycle=function(){T(this.rA),T(this.rB),this.normalImpulse=0,this.tangentImpulse=0,this.normalMass=0,this.tangentMass=0,this.velocityBias=0},r})(),ye=b(0,0),it=b(0,0),ge=b(0,0),st=b(0,0),Se=b(0,0),Re=ti(0,0,0),Ne=ti(0,0,0),rs=b(0,0),os=b(0,0),li=b(0,0),ns=b(0,0),Is=b(0,0),Vs=b(0,0),rt=b(0,0),X=b(0,0),Ci=b(0,0),Ut=b(0,0),hi=b(0,0),ci=b(0,0),Ft=b(0,0),xe=b(0,0),K=b(0,0),jt=b(0,0),ot=b(0,0),nt=b(0,0),ae=b(0,0),de=(function(){function r(){this.m_nodeA=new Ir(this),this.m_nodeB=new Ir(this),this.m_fixtureA=null,this.m_fixtureB=null,this.m_indexA=-1,this.m_indexB=-1,this.m_evaluateFcn=null,this.m_manifold=new Mo,this.m_prev=null,this.m_next=null,this.m_toi=1,this.m_toiCount=0,this.m_toiFlag=!1,this.m_friction=0,this.m_restitution=0,this.m_tangentSpeed=0,this.m_enabledFlag=!0,this.m_islandFlag=!1,this.m_touchingFlag=!1,this.m_filterFlag=!1,this.m_bulletHitFlag=!1,this.m_impulse=new gn(this),this.v_points=[new Tr,new Tr],this.v_normal=b(0,0),this.v_normalMass=new re,this.v_K=new re,this.v_pointCount=0,this.v_tangentSpeed=0,this.v_friction=0,this.v_restitution=0,this.v_invMassA=0,this.v_invMassB=0,this.v_invIA=0,this.v_invIB=0,this.p_localPoints=[b(0,0),b(0,0)],this.p_localNormal=b(0,0),this.p_localPoint=b(0,0),this.p_localCenterA=b(0,0),this.p_localCenterB=b(0,0),this.p_type=tt.e_unset,this.p_radiusA=0,this.p_radiusB=0,this.p_pointCount=0,this.p_invMassA=0,this.p_invMassB=0,this.p_invIA=0,this.p_invIB=0}return r.prototype.initialize=function(t,e,i,s,o){this.m_fixtureA=t,this.m_fixtureB=i,this.m_indexA=e,this.m_indexB=s,this.m_evaluateFcn=o,this.m_friction=Vr(this.m_fixtureA.m_friction,this.m_fixtureB.m_friction),this.m_restitution=Pr(this.m_fixtureA.m_restitution,this.m_fixtureB.m_restitution)},r.prototype.recycle=function(){this.m_nodeA.recycle(),this.m_nodeB.recycle(),this.m_fixtureA=null,this.m_fixtureB=null,this.m_indexA=-1,this.m_indexB=-1,this.m_evaluateFcn=null,this.m_manifold.recycle(),this.m_prev=null,this.m_next=null,this.m_toi=1,this.m_toiCount=0,this.m_toiFlag=!1,this.m_friction=0,this.m_restitution=0,this.m_tangentSpeed=0,this.m_enabledFlag=!0,this.m_islandFlag=!1,this.m_touchingFlag=!1,this.m_filterFlag=!1,this.m_bulletHitFlag=!1,this.m_impulse.recycle();for(var t=0,e=this.v_points;t<e.length;t++){var i=e[t];i.recycle()}T(this.v_normal),this.v_normalMass.setZero(),this.v_K.setZero(),this.v_pointCount=0,this.v_tangentSpeed=0,this.v_friction=0,this.v_restitution=0,this.v_invMassA=0,this.v_invMassB=0,this.v_invIA=0,this.v_invIB=0;for(var s=0,o=this.p_localPoints;s<o.length;s++){var n=o[s];T(n)}T(this.p_localNormal),T(this.p_localPoint),T(this.p_localCenterA),T(this.p_localCenterB),this.p_type=tt.e_unset,this.p_radiusA=0,this.p_radiusB=0,this.p_pointCount=0,this.p_invMassA=0,this.p_invMassB=0,this.p_invIA=0,this.p_invIB=0},r.prototype.initConstraint=function(t){var e=this.m_fixtureA,i=this.m_fixtureB;if(!(e===null||i===null)){var s=e.m_body,o=i.m_body;if(!(s===null||o===null)){var n=e.m_shape,a=i.m_shape;if(!(n===null||a===null)){var h=this.m_manifold,m=h.pointCount;this.v_invMassA=s.m_invMass,this.v_invMassB=o.m_invMass,this.v_invIA=s.m_invI,this.v_invIB=o.m_invI,this.v_friction=this.m_friction,this.v_restitution=this.m_restitution,this.v_tangentSpeed=this.m_tangentSpeed,this.v_pointCount=m,this.v_K.setZero(),this.v_normalMass.setZero(),this.p_invMassA=s.m_invMass,this.p_invMassB=o.m_invMass,this.p_invIA=s.m_invI,this.p_invIB=o.m_invI,g(this.p_localCenterA,s.m_sweep.localCenter),g(this.p_localCenterB,o.m_sweep.localCenter),this.p_radiusA=n.m_radius,this.p_radiusB=a.m_radius,this.p_type=h.type,g(this.p_localNormal,h.localNormal),g(this.p_localPoint,h.localPoint),this.p_pointCount=m;for(var c=0;c<P.maxManifoldPoints;++c)this.v_points[c].recycle(),T(this.p_localPoints[c]);for(var c=0;c<m;++c){var _=h.points[c],d=this.v_points[c];t.warmStarting&&(d.normalImpulse=t.dtRatio*_.normalImpulse,d.tangentImpulse=t.dtRatio*_.tangentImpulse),g(this.p_localPoints[c],_.localPoint)}}}}},r.prototype.getManifold=function(){return this.m_manifold},r.prototype.getWorldManifold=function(t){var e=this.m_fixtureA,i=this.m_fixtureB;if(!(e===null||i===null)){var s=e.m_body,o=i.m_body;if(!(s===null||o===null)){var n=e.m_shape,a=i.m_shape;if(!(n===null||a===null))return this.m_manifold.getWorldManifold(t,s.getTransform(),n.m_radius,o.getTransform(),a.m_radius)}}},r.prototype.setEnabled=function(t){this.m_enabledFlag=!!t},r.prototype.isEnabled=function(){return this.m_enabledFlag},r.prototype.isTouching=function(){return this.m_touchingFlag},r.prototype.getNext=function(){return this.m_next},r.prototype.getFixtureA=function(){return this.m_fixtureA},r.prototype.getFixtureB=function(){return this.m_fixtureB},r.prototype.getChildIndexA=function(){return this.m_indexA},r.prototype.getChildIndexB=function(){return this.m_indexB},r.prototype.flagForFiltering=function(){this.m_filterFlag=!0},r.prototype.setFriction=function(t){this.m_friction=t},r.prototype.getFriction=function(){return this.m_friction},r.prototype.resetFriction=function(){var t=this.m_fixtureA,e=this.m_fixtureB;t===null||e===null||(this.m_friction=Vr(t.m_friction,e.m_friction))},r.prototype.setRestitution=function(t){this.m_restitution=t},r.prototype.getRestitution=function(){return this.m_restitution},r.prototype.resetRestitution=function(){var t=this.m_fixtureA,e=this.m_fixtureB;t===null||e===null||(this.m_restitution=Pr(t.m_restitution,e.m_restitution))},r.prototype.setTangentSpeed=function(t){this.m_tangentSpeed=t},r.prototype.getTangentSpeed=function(){return this.m_tangentSpeed},r.prototype.evaluate=function(t,e,i){var s=this.m_fixtureA,o=this.m_fixtureB;s===null||o===null||this.m_evaluateFcn(t,e,s,this.m_indexA,i,o,this.m_indexB)},r.prototype.update=function(t){var e=this.m_fixtureA,i=this.m_fixtureB;if(!(e===null||i===null)){var s=e.m_body,o=i.m_body;if(!(s===null||o===null)){var n=e.m_shape,a=i.m_shape;if(!(n===null||a===null)){this.m_enabledFlag=!0;var h=!1,m=this.m_touchingFlag,c=e.m_isSensor,_=i.m_isSensor,d=c||_,u=s.m_xf,f=o.m_xf;if(d)h=bo(n,this.m_indexA,a,this.m_indexB,u,f),this.m_manifold.pointCount=0;else{ai.recycle(),ai.set(this.m_manifold),this.m_manifold.recycle(),this.evaluate(this.m_manifold,u,f),h=this.m_manifold.pointCount>0;for(var p=0;p<this.m_manifold.pointCount;++p){var v=this.m_manifold.points[p];v.normalImpulse=0,v.tangentImpulse=0;for(var y=0;y<ai.pointCount;++y){var x=ai.points[y];if(x.id.key===v.id.key){v.normalImpulse=x.normalImpulse,v.tangentImpulse=x.tangentImpulse;break}}}h!==m&&(s.setAwake(!0),o.setAwake(!0))}this.m_touchingFlag=h;var A=typeof t=="object"&&t!==null;!m&&h&&A&&t.beginContact(this),m&&!h&&A&&t.endContact(this),!d&&h&&A&&ai&&t.preSolve(this,ai)}}}},r.prototype.solvePositionConstraint=function(t){return this._solvePositionConstraint(t,null,null)},r.prototype.solvePositionConstraintTOI=function(t,e,i){return this._solvePositionConstraint(t,e,i)},r.prototype._solvePositionConstraint=function(t,e,i){var s=e!==null&&i!==null,o=0,n=this.m_fixtureA,a=this.m_fixtureB;if(n===null||a===null)return o;var h=n.m_body,m=a.m_body;if(h===null||m===null)return o;var c=h.c_position,_=m.c_position,d=this.p_localCenterA,u=this.p_localCenterB,f=0,p=0;(!s||h===e||h===i)&&(f=this.p_invMassA,p=this.p_invIA);var v=0,y=0;(!s||m===e||m===i)&&(v=this.p_invMassB,y=this.p_invIB),g(ye,c.c);var x=c.a;g(ge,_.c);for(var A=_.a,w=0;w<this.p_pointCount;++w){Ni(Re,d,ye,x),Ni(Ne,u,ge,A);var M=void 0;switch(this.p_type){case tt.e_circles:{F(rs,Re,this.p_localPoint),F(os,Ne,this.p_localPoints[0]),L(X,os,rs),ie(X),Z(Ci,.5,rs,.5,os),M=I(os,X)-I(rs,X)-this.p_radiusA-this.p_radiusB;break}case tt.e_faceA:{Xt(X,Re.q,this.p_localNormal),F(ns,Re,this.p_localPoint),F(li,Ne,this.p_localPoints[w]),M=I(li,X)-I(ns,X)-this.p_radiusA-this.p_radiusB,g(Ci,li);break}case tt.e_faceB:{Xt(X,Ne.q,this.p_localNormal),F(ns,Ne,this.p_localPoint),F(li,Re,this.p_localPoints[w]),M=I(li,X)-I(ns,X)-this.p_radiusA-this.p_radiusB,g(Ci,li),Hi(X);break}default:return o}L(Is,Ci,ye),L(Vs,Ci,ge),o=wn(o,M);var S=s?P.toiBaugarte:P.baumgarte,C=P.linearSlop,V=P.maxLinearCorrection,H=yt(S*(M+C),-V,0),E=N(Is,X),q=N(Vs,X),j=f+v+p*E*E+y*q*q,W=j>0?-H/j:0;z(rt,W,X),ki(ye,f,rt),x-=p*N(Is,rt),ee(ge,v,rt),A+=y*N(Vs,rt)}return g(c.c,ye),c.a=x,g(_.c,ge),_.a=A,o},r.prototype.initVelocityConstraint=function(t){var e=this.m_fixtureA,i=this.m_fixtureB;if(!(e===null||i===null)){var s=e.m_body,o=i.m_body;if(!(s===null||o===null)){var n=s.c_velocity,a=o.c_velocity,h=s.c_position,m=o.c_position,c=this.p_radiusA,_=this.p_radiusB,d=this.m_manifold,u=this.v_invMassA,f=this.v_invMassB,p=this.v_invIA,v=this.v_invIB,y=this.p_localCenterA,x=this.p_localCenterB;g(ye,h.c);var A=h.a;g(it,n.v);var w=n.w;g(ge,m.c);var M=m.a;g(st,a.v);var S=a.w;Ni(Re,y,ye,A),Ni(Ne,x,ge,M),ss.recycle(),d.getWorldManifold(ss,Re,c,Ne,_),g(this.v_normal,ss.normal);for(var C=0;C<this.v_pointCount;++C){var V=this.v_points[C],H=ss.points[C];L(V.rA,H,ye),L(V.rB,H,ge);var E=N(V.rA,this.v_normal),q=N(V.rB,this.v_normal),j=u+f+p*E*E+v*q*q;V.normalMass=j>0?1/j:0,Ye(Se,this.v_normal,1);var W=N(V.rA,Se),Y=N(V.rB,Se),Tt=u+f+p*W*W+v*Y*Y;V.tangentMass=Tt>0?1/Tt:0,V.velocityBias=0;var dt=0;dt+=I(this.v_normal,st),dt+=I(this.v_normal,Lt(ae,S,V.rB)),dt-=I(this.v_normal,it),dt-=I(this.v_normal,Lt(ae,w,V.rA)),dt<-P.velocityThreshold&&(V.velocityBias=-this.v_restitution*dt)}if(this.v_pointCount==2&&t.blockSolve){var Yt=this.v_points[0],Mt=this.v_points[1],et=N(Yt.rA,this.v_normal),xi=N(Yt.rB,this.v_normal),qt=N(Mt.rA,this.v_normal),Me=N(Mt.rB,this.v_normal),Fe=u+f+p*et*et+v*xi*xi,bi=u+f+p*qt*qt+v*Me*Me,si=u+f+p*et*qt+v*xi*Me,vs=1e3;if(Fe*Fe<vs*(Fe*bi-si*si)){this.v_K.ex.setNum(Fe,si),this.v_K.ey.setNum(si,bi);var Qs=this.v_K.ex.x,tr=this.v_K.ey.x,er=this.v_K.ex.y,ir=this.v_K.ey.y,Le=Qs*ir-tr*er;Le!==0&&(Le=1/Le),this.v_normalMass.ex.x=Le*ir,this.v_normalMass.ey.x=-Le*tr,this.v_normalMass.ex.y=-Le*er,this.v_normalMass.ey.y=Le*Qs}else this.v_pointCount=1}g(h.c,ye),h.a=A,g(n.v,it),n.w=w,g(m.c,ge),m.a=M,g(a.v,st),a.w=S}}},r.prototype.warmStartConstraint=function(t){var e=this.m_fixtureA,i=this.m_fixtureB;if(!(e===null||i===null)){var s=e.m_body,o=i.m_body;if(!(s===null||o===null)){var n=s.c_velocity,a=o.c_velocity,h=this.v_invMassA,m=this.v_invIA,c=this.v_invMassB,_=this.v_invIB;g(it,n.v);var d=n.w;g(st,a.v);var u=a.w;g(X,this.v_normal),Ye(Se,X,1);for(var f=0;f<this.v_pointCount;++f){var p=this.v_points[f];Z(rt,p.normalImpulse,X,p.tangentImpulse,Se),d-=m*N(p.rA,rt),ki(it,h,rt),u+=_*N(p.rB,rt),ee(st,c,rt)}g(n.v,it),n.w=d,g(a.v,st),a.w=u}}},r.prototype.storeConstraintImpulses=function(t){for(var e=this.m_manifold,i=0;i<this.v_pointCount;++i)e.points[i].normalImpulse=this.v_points[i].normalImpulse,e.points[i].tangentImpulse=this.v_points[i].tangentImpulse},r.prototype.solveVelocityConstraint=function(t){var e=this.m_fixtureA,i=this.m_fixtureB;if(!(e===null||i===null)){var s=e.m_body,o=i.m_body;if(!(s===null||o===null)){var n=s.c_velocity,a=o.c_velocity,h=this.v_invMassA,m=this.v_invIA,c=this.v_invMassB,_=this.v_invIB;g(it,n.v);var d=n.w;g(st,a.v);var u=a.w;g(X,this.v_normal),Ye(Se,X,1);for(var f=this.v_friction,p=0;p<this.v_pointCount;++p){var v=this.v_points[p];T(Ut),Wt(Ut,st),Wt(Ut,Lt(ae,u,v.rB)),Ae(Ut,it),Ae(Ut,Lt(ae,d,v.rA));var y=I(Ut,Se)-this.v_tangentSpeed,x=v.tangentMass*-y,A=f*v.normalImpulse,w=yt(v.tangentImpulse+x,-A,A);x=w-v.tangentImpulse,v.tangentImpulse=w,z(rt,x,Se),ki(it,h,rt),d-=m*N(v.rA,rt),ee(st,c,rt),u+=_*N(v.rB,rt)}if(this.v_pointCount==1||t.blockSolve==!1)for(var M=0;M<this.v_pointCount;++M){var v=this.v_points[M];T(Ut),Wt(Ut,st),Wt(Ut,Lt(ae,u,v.rB)),Ae(Ut,it),Ae(Ut,Lt(ae,d,v.rA));var S=I(Ut,X),x=-v.normalMass*(S-v.velocityBias),w=Bn(v.normalImpulse+x,0);x=w-v.normalImpulse,v.normalImpulse=w,z(rt,x,X),ki(it,h,rt),d-=m*N(v.rA,rt),ee(st,c,rt),u+=_*N(v.rB,rt)}else{var C=this.v_points[0],V=this.v_points[1];ft(xe,C.normalImpulse,V.normalImpulse),T(hi),Wt(hi,st),Wt(hi,Lt(ae,u,C.rB)),Ae(hi,it),Ae(hi,Lt(ae,d,C.rA)),T(ci),Wt(ci,st),Wt(ci,Lt(ae,u,V.rB)),Ae(ci,it),Ae(ci,Lt(ae,d,V.rA));var H=I(hi,X),E=I(ci,X);for(ft(Ft,H-C.velocityBias,E-V.velocityBias),Ft.x-=this.v_K.ex.x*xe.x+this.v_K.ey.x*xe.y,Ft.y-=this.v_K.ex.y*xe.x+this.v_K.ey.y*xe.y;;){if(T(K),K.x=-(this.v_normalMass.ex.x*Ft.x+this.v_normalMass.ey.x*Ft.y),K.y=-(this.v_normalMass.ex.y*Ft.x+this.v_normalMass.ey.y*Ft.y),K.x>=0&&K.y>=0){L(jt,K,xe),z(ot,jt.x,X),z(nt,jt.y,X),me(it,-h,ot,-h,nt,1,it),d-=m*(N(C.rA,ot)+N(V.rA,nt)),me(st,c,ot,c,nt,1,st),u+=_*(N(C.rB,ot)+N(V.rB,nt)),C.normalImpulse=K.x,V.normalImpulse=K.y;break}if(K.x=-C.normalMass*Ft.x,K.y=0,H=0,E=this.v_K.ex.y*K.x+Ft.y,K.x>=0&&E>=0){L(jt,K,xe),z(ot,jt.x,X),z(nt,jt.y,X),me(it,-h,ot,-h,nt,1,it),d-=m*(N(C.rA,ot)+N(V.rA,nt)),me(st,c,ot,c,nt,1,st),u+=_*(N(C.rB,ot)+N(V.rB,nt)),C.normalImpulse=K.x,V.normalImpulse=K.y;break}if(K.x=0,K.y=-V.normalMass*Ft.y,H=this.v_K.ey.x*K.y+Ft.x,E=0,K.y>=0&&H>=0){L(jt,K,xe),z(ot,jt.x,X),z(nt,jt.y,X),me(it,-h,ot,-h,nt,1,it),d-=m*(N(C.rA,ot)+N(V.rA,nt)),me(st,c,ot,c,nt,1,st),u+=_*(N(C.rB,ot)+N(V.rB,nt)),C.normalImpulse=K.x,V.normalImpulse=K.y;break}if(K.x=0,K.y=0,H=Ft.x,E=Ft.y,H>=0&&E>=0){L(jt,K,xe),z(ot,jt.x,X),z(nt,jt.y,X),me(it,-h,ot,-h,nt,1,it),d-=m*(N(C.rA,ot)+N(V.rA,nt)),me(st,c,ot,c,nt,1,st),u+=_*(N(C.rB,ot)+N(V.rB,nt)),C.normalImpulse=K.x,V.normalImpulse=K.y;break}break}}g(n.v,it),n.w=d,g(a.v,st),a.w=u}}},r.addType=function(t,e,i){qe[t]=qe[t]||{},qe[t][e]=i},r.create=function(t,e,i,s){var o=t.m_shape.m_type,n=i.m_shape.m_type,a=Sr.allocate(),h;if(h=qe[o]&&qe[o][n])a.initialize(t,e,i,s,h);else if(h=qe[n]&&qe[n][o])a.initialize(i,s,t,e,h);else return null;t=a.m_fixtureA,i=a.m_fixtureB,e=a.getChildIndexA(),s=a.getChildIndexB();var m=t.m_body,c=i.m_body;return a.m_nodeA.contact=a,a.m_nodeA.other=c,a.m_nodeA.prev=null,a.m_nodeA.next=m.m_contactList,m.m_contactList!=null&&(m.m_contactList.prev=a.m_nodeA),m.m_contactList=a.m_nodeA,a.m_nodeB.contact=a,a.m_nodeB.other=m,a.m_nodeB.prev=null,a.m_nodeB.next=c.m_contactList,c.m_contactList!=null&&(c.m_contactList.prev=a.m_nodeB),c.m_contactList=a.m_nodeB,t.isSensor()==!1&&i.isSensor()==!1&&(m.setAwake(!0),c.setAwake(!0)),a},r.destroy=function(t,e){var i=t.m_fixtureA,s=t.m_fixtureB;if(!(i===null||s===null)){var o=i.m_body,n=s.m_body;o===null||n===null||(t.isTouching()&&e.endContact(t),t.m_nodeA.prev&&(t.m_nodeA.prev.next=t.m_nodeA.next),t.m_nodeA.next&&(t.m_nodeA.next.prev=t.m_nodeA.prev),t.m_nodeA==o.m_contactList&&(o.m_contactList=t.m_nodeA.next),t.m_nodeB.prev&&(t.m_nodeB.prev.next=t.m_nodeB.next),t.m_nodeB.next&&(t.m_nodeB.next.prev=t.m_nodeB.prev),t.m_nodeB==n.m_contactList&&(n.m_contactList=t.m_nodeB.next),t.m_manifold.pointCount>0&&!i.m_isSensor&&!s.m_isSensor&&(o.setAwake(!0),n.setAwake(!0)),Sr.release(t))}},r})(),Mn={gravity:l.zero(),allowSleep:!0,warmStarting:!0,continuousPhysics:!0,subStepping:!1,blockSolve:!0,velocityIterations:8,positionIterations:3},qi=(function(){function r(t){if(!(this instanceof r))return new r(t);this.s_step=new Js,t?l.isValid(t)&&(t={gravity:t}):t={},t=Et(t,Mn),this.m_solver=new wo(this),this.m_broadPhase=new Zo,this.m_contactList=null,this.m_contactCount=0,this.m_bodyList=null,this.m_bodyCount=0,this.m_jointList=null,this.m_jointCount=0,this.m_stepComplete=!0,this.m_allowSleep=t.allowSleep,this.m_gravity=l.clone(t.gravity),this.m_clearForces=!0,this.m_newFixture=!1,this.m_locked=!1,this.m_warmStarting=t.warmStarting,this.m_continuousPhysics=t.continuousPhysics,this.m_subStepping=t.subStepping,this.m_blockSolve=t.blockSolve,this.m_velocityIterations=t.velocityIterations,this.m_positionIterations=t.positionIterations,this.m_t=0,this.m_step_callback=[]}return r.prototype._serialize=function(){for(var t=[],e=[],i=this.getBodyList();i;i=i.getNext())t.push(i);for(var s=this.getJointList();s;s=s.getNext())typeof s._serialize=="function"&&e.push(s);return{gravity:this.m_gravity,bodies:t,joints:e}},r._deserialize=function(t,e,i){if(!t)return new r;var s=new r(t.gravity);if(t.bodies)for(var o=t.bodies.length-1;o>=0;o-=1)s._addBody(i($,t.bodies[o],s));if(t.joints)for(var o=t.joints.length-1;o>=0;o--)s.createJoint(i(xt,t.joints[o],s));return s},r.prototype.getBodyList=function(){return this.m_bodyList},r.prototype.getJointList=function(){return this.m_jointList},r.prototype.getContactList=function(){return this.m_contactList},r.prototype.getBodyCount=function(){return this.m_bodyCount},r.prototype.getJointCount=function(){return this.m_jointCount},r.prototype.getContactCount=function(){return this.m_contactCount},r.prototype.setGravity=function(t){this.m_gravity.set(t)},r.prototype.getGravity=function(){return this.m_gravity},r.prototype.isLocked=function(){return this.m_locked},r.prototype.setAllowSleeping=function(t){if(t!=this.m_allowSleep&&(this.m_allowSleep=t,this.m_allowSleep==!1))for(var e=this.m_bodyList;e;e=e.m_next)e.setAwake(!0)},r.prototype.getAllowSleeping=function(){return this.m_allowSleep},r.prototype.setWarmStarting=function(t){this.m_warmStarting=t},r.prototype.getWarmStarting=function(){return this.m_warmStarting},r.prototype.setContinuousPhysics=function(t){this.m_continuousPhysics=t},r.prototype.getContinuousPhysics=function(){return this.m_continuousPhysics},r.prototype.setSubStepping=function(t){this.m_subStepping=t},r.prototype.getSubStepping=function(){return this.m_subStepping},r.prototype.setAutoClearForces=function(t){this.m_clearForces=t},r.prototype.getAutoClearForces=function(){return this.m_clearForces},r.prototype.clearForces=function(){for(var t=this.m_bodyList;t;t=t.getNext())t.m_force.setZero(),t.m_torque=0},r.prototype.queryAABB=function(t,e){var i=this.m_broadPhase;this.m_broadPhase.query(t,function(s){var o=i.getUserData(s);return e(o.fixture)})},r.prototype.rayCast=function(t,e,i){var s=this.m_broadPhase;this.m_broadPhase.rayCast({maxFraction:1,p1:t,p2:e},function(o,n){var a=s.getUserData(n),h=a.fixture,m=a.childIndex,c={},_=h.rayCast(c,o,m);if(_){var d=c.fraction,u=l.add(l.mulNumVec2(1-d,o.p1),l.mulNumVec2(d,o.p2));return i(h,u,c.normal,d)}return o.maxFraction})},r.prototype.getProxyCount=function(){return this.m_broadPhase.getProxyCount()},r.prototype.getTreeHeight=function(){return this.m_broadPhase.getTreeHeight()},r.prototype.getTreeBalance=function(){return this.m_broadPhase.getTreeBalance()},r.prototype.getTreeQuality=function(){return this.m_broadPhase.getTreeQuality()},r.prototype.shiftOrigin=function(t){if(!this.isLocked()){for(var e=this.m_bodyList;e;e=e.m_next)e.m_xf.p.sub(t),e.m_sweep.c0.sub(t),e.m_sweep.c.sub(t);for(var i=this.m_jointList;i;i=i.m_next)i.shiftOrigin(t);this.m_broadPhase.shiftOrigin(t)}},r.prototype._addBody=function(t){this.isLocked()||(t.m_prev=null,t.m_next=this.m_bodyList,this.m_bodyList&&(this.m_bodyList.m_prev=t),this.m_bodyList=t,++this.m_bodyCount)},r.prototype.createBody=function(t,e){if(this.isLocked())return null;var i={};t&&(l.isValid(t)?i={position:t,angle:e}:typeof t=="object"&&(i=t));var s=new $(this,i);return this._addBody(s),s},r.prototype.createDynamicBody=function(t,e){var i={};return t&&(l.isValid(t)?i={position:t,angle:e}:typeof t=="object"&&(i=t)),i.type="dynamic",this.createBody(i)},r.prototype.createKinematicBody=function(t,e){var i={};return t&&(l.isValid(t)?i={position:t,angle:e}:typeof t=="object"&&(i=t)),i.type="kinematic",this.createBody(i)},r.prototype.destroyBody=function(t){if(!this.isLocked()){if(t.m_destroyed)return!1;for(var e=t.m_jointList;e;){var i=e;e=e.next,this.publish("remove-joint",i.joint),this.destroyJoint(i.joint),t.m_jointList=e}t.m_jointList=null;for(var s=t.m_contactList;s;){var o=s;s=s.next,this.destroyContact(o.contact),t.m_contactList=s}t.m_contactList=null;for(var n=t.m_fixtureList;n;){var a=n;n=n.m_next,this.publish("remove-fixture",a),a.destroyProxies(this.m_broadPhase),t.m_fixtureList=n}return t.m_fixtureList=null,t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t==this.m_bodyList&&(this.m_bodyList=t.m_next),t.m_destroyed=!0,--this.m_bodyCount,this.publish("remove-body",t),!0}},r.prototype.createJoint=function(t){if(this.isLocked())return null;if(t.m_prev=null,t.m_next=this.m_jointList,this.m_jointList&&(this.m_jointList.m_prev=t),this.m_jointList=t,++this.m_jointCount,t.m_edgeA.joint=t,t.m_edgeA.other=t.m_bodyB,t.m_edgeA.prev=null,t.m_edgeA.next=t.m_bodyA.m_jointList,t.m_bodyA.m_jointList&&(t.m_bodyA.m_jointList.prev=t.m_edgeA),t.m_bodyA.m_jointList=t.m_edgeA,t.m_edgeB.joint=t,t.m_edgeB.other=t.m_bodyA,t.m_edgeB.prev=null,t.m_edgeB.next=t.m_bodyB.m_jointList,t.m_bodyB.m_jointList&&(t.m_bodyB.m_jointList.prev=t.m_edgeB),t.m_bodyB.m_jointList=t.m_edgeB,t.m_collideConnected==!1)for(var e=t.m_bodyB.getContactList();e;e=e.next)e.other==t.m_bodyA&&e.contact.flagForFiltering();return t},r.prototype.destroyJoint=function(t){if(!this.isLocked()){t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t==this.m_jointList&&(this.m_jointList=t.m_next);var e=t.m_bodyA,i=t.m_bodyB;if(e.setAwake(!0),i.setAwake(!0),t.m_edgeA.prev&&(t.m_edgeA.prev.next=t.m_edgeA.next),t.m_edgeA.next&&(t.m_edgeA.next.prev=t.m_edgeA.prev),t.m_edgeA==e.m_jointList&&(e.m_jointList=t.m_edgeA.next),t.m_edgeA.prev=null,t.m_edgeA.next=null,t.m_edgeB.prev&&(t.m_edgeB.prev.next=t.m_edgeB.next),t.m_edgeB.next&&(t.m_edgeB.next.prev=t.m_edgeB.prev),t.m_edgeB==i.m_jointList&&(i.m_jointList=t.m_edgeB.next),t.m_edgeB.prev=null,t.m_edgeB.next=null,--this.m_jointCount,t.m_collideConnected==!1)for(var s=i.getContactList();s;)s.other==e&&s.contact.flagForFiltering(),s=s.next;this.publish("remove-joint",t)}},r.prototype.step=function(t,e,i){if(this.publish("pre-step",t),(e|0)!==e&&(e=0),e=e||this.m_velocityIterations,i=i||this.m_positionIterations,this.m_newFixture&&(this.findNewContacts(),this.m_newFixture=!1),this.m_locked=!0,this.s_step.reset(t),this.s_step.velocityIterations=e,this.s_step.positionIterations=i,this.s_step.warmStarting=this.m_warmStarting,this.s_step.blockSolve=this.m_blockSolve,this.updateContacts(),this.m_stepComplete&&t>0){this.m_solver.solveWorld(this.s_step);for(var s=this.m_bodyList;s;s=s.getNext())s.m_islandFlag!=!1&&(s.isStatic()||s.synchronizeFixtures());this.findNewContacts()}this.m_continuousPhysics&&t>0&&this.m_solver.solveWorldTOI(this.s_step),this.m_clearForces&&this.clearForces(),this.m_locked=!1;for(var o;o=this.m_step_callback.shift();)o(this);this.publish("post-step",t)},r.prototype.queueUpdate=function(t){this.isLocked()?this.m_step_callback.push(t):t(this)},r.prototype.findNewContacts=function(){var t=this;this.m_broadPhase.updatePairs(function(e,i){return t.createContact(e,i)})},r.prototype.createContact=function(t,e){var i=t.fixture,s=e.fixture,o=t.childIndex,n=e.childIndex,a=i.getBody(),h=s.getBody();if(a!=h){for(var m=h.getContactList();m;){if(m.other==a){var c=m.contact.getFixtureA(),_=m.contact.getFixtureB(),d=m.contact.getChildIndexA(),u=m.contact.getChildIndexB();if(c==i&&_==s&&d==o&&u==n||c==s&&_==i&&d==n&&u==o)return}m=m.next}if(h.shouldCollide(a)!=!1&&s.shouldCollide(i)!=!1){var f=de.create(i,o,s,n);f!=null&&(f.m_prev=null,this.m_contactList!=null&&(f.m_next=this.m_contactList,this.m_contactList.m_prev=f),this.m_contactList=f,++this.m_contactCount)}}},r.prototype.updateContacts=function(){for(var t,e=this.m_contactList;t=e;){e=t.getNext();var i=t.getFixtureA(),s=t.getFixtureB(),o=t.getChildIndexA(),n=t.getChildIndexB(),a=i.getBody(),h=s.getBody();if(t.m_filterFlag){if(h.shouldCollide(a)==!1){this.destroyContact(t);continue}if(s.shouldCollide(i)==!1){this.destroyContact(t);continue}t.m_filterFlag=!1}var m=a.isAwake()&&!a.isStatic(),c=h.isAwake()&&!h.isStatic();if(!(m==!1&&c==!1)){var _=i.m_proxies[o].proxyId,d=s.m_proxies[n].proxyId,u=this.m_broadPhase.testOverlap(_,d);if(u==!1){this.destroyContact(t);continue}t.update(this)}}},r.prototype.destroyContact=function(t){t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t==this.m_contactList&&(this.m_contactList=t.m_next),de.destroy(t,this),--this.m_contactCount},r.prototype.on=function(t,e){return typeof t!="string"||typeof e!="function"?this:(this._listeners||(this._listeners={}),this._listeners[t]||(this._listeners[t]=[]),this._listeners[t].push(e),this)},r.prototype.off=function(t,e){if(typeof t!="string"||typeof e!="function")return this;var i=this._listeners&&this._listeners[t];if(!i||!i.length)return this;var s=i.indexOf(e);return s>=0&&i.splice(s,1),this},r.prototype.publish=function(t,e,i,s){var o=this._listeners&&this._listeners[t];if(!o||!o.length)return 0;for(var n=0;n<o.length;n++)o[n].call(this,e,i,s);return o.length},r.prototype.beginContact=function(t){this.publish("begin-contact",t)},r.prototype.endContact=function(t){this.publish("end-contact",t)},r.prototype.preSolve=function(t,e){this.publish("pre-solve",t,e)},r.prototype.postSolve=function(t,e){this.publish("post-solve",t,e)},r})(),G=(function(){function r(t,e,i){if(!(this instanceof r))return new r(t,e,i);typeof t>"u"?(this.x=0,this.y=0,this.z=0):typeof t=="object"?(this.x=t.x,this.y=t.y,this.z=t.z):(this.x=t,this.y=e,this.z=i)}return r.prototype._serialize=function(){return{x:this.x,y:this.y,z:this.z}},r._deserialize=function(t){var e=Object.create(r.prototype);return e.x=t.x,e.y=t.y,e.z=t.z,e},r.neo=function(t,e,i){var s=Object.create(r.prototype);return s.x=t,s.y=e,s.z=i,s},r.zero=function(){var t=Object.create(r.prototype);return t.x=0,t.y=0,t.z=0,t},r.clone=function(t){return r.neo(t.x,t.y,t.z)},r.prototype.toString=function(){return JSON.stringify(this)},r.isValid=function(t){return t===null||typeof t>"u"?!1:Number.isFinite(t.x)&&Number.isFinite(t.y)&&Number.isFinite(t.z)},r.assert=function(t){},r.prototype.setZero=function(){return this.x=0,this.y=0,this.z=0,this},r.prototype.set=function(t,e,i){return this.x=t,this.y=e,this.z=i,this},r.prototype.add=function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this},r.prototype.sub=function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this},r.prototype.mul=function(t){return this.x*=t,this.y*=t,this.z*=t,this},r.areEqual=function(t,e){return t===e||typeof t=="object"&&t!==null&&typeof e=="object"&&e!==null&&t.x===e.x&&t.y===e.y&&t.z===e.z},r.dot=function(t,e){return t.x*e.x+t.y*e.y+t.z*e.z},r.cross=function(t,e){return new r(t.y*e.z-t.z*e.y,t.z*e.x-t.x*e.z,t.x*e.y-t.y*e.x)},r.add=function(t,e){return new r(t.x+e.x,t.y+e.y,t.z+e.z)},r.sub=function(t,e){return new r(t.x-e.x,t.y-e.y,t.z-e.z)},r.mul=function(t,e){return new r(e*t.x,e*t.y,e*t.z)},r.prototype.neg=function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},r.neg=function(t){return new r(-t.x,-t.y,-t.z)},r})(),zr=b(0,0),kr=b(0,0),_e=(function(r){At(t,r);function t(e,i){var s=this;return s instanceof t?(s=r.call(this)||this,s.m_type=t.TYPE,s.m_radius=P.polygonRadius,s.m_vertex1=e?l.clone(e):l.zero(),s.m_vertex2=i?l.clone(i):l.zero(),s.m_vertex0=l.zero(),s.m_vertex3=l.zero(),s.m_hasVertex0=!1,s.m_hasVertex3=!1,s):new t(e,i)}return t.prototype._serialize=function(){return{type:this.m_type,vertex1:this.m_vertex1,vertex2:this.m_vertex2,vertex0:this.m_vertex0,vertex3:this.m_vertex3,hasVertex0:this.m_hasVertex0,hasVertex3:this.m_hasVertex3}},t._deserialize=function(e){var i=new t(e.vertex1,e.vertex2);return i.m_hasVertex0&&i.setPrevVertex(e.vertex0),i.m_hasVertex3&&i.setNextVertex(e.vertex3),i},t.prototype._reset=function(){},t.prototype.getRadius=function(){return this.m_radius},t.prototype.getType=function(){return this.m_type},t.prototype.setNext=function(e){return this.setNextVertex(e)},t.prototype.setNextVertex=function(e){return e?(this.m_vertex3.setVec2(e),this.m_hasVertex3=!0):(this.m_vertex3.setZero(),this.m_hasVertex3=!1),this},t.prototype.getNextVertex=function(){return this.m_vertex3},t.prototype.setPrev=function(e){return this.setPrevVertex(e)},t.prototype.setPrevVertex=function(e){return e?(this.m_vertex0.setVec2(e),this.m_hasVertex0=!0):(this.m_vertex0.setZero(),this.m_hasVertex0=!1),this},t.prototype.getPrevVertex=function(){return this.m_vertex0},t.prototype._set=function(e,i){return this.m_vertex1.setVec2(e),this.m_vertex2.setVec2(i),this.m_hasVertex0=!1,this.m_hasVertex3=!1,this},t.prototype._clone=function(){var e=new t;return e.m_type=this.m_type,e.m_radius=this.m_radius,e.m_vertex1.setVec2(this.m_vertex1),e.m_vertex2.setVec2(this.m_vertex2),e.m_vertex0.setVec2(this.m_vertex0),e.m_vertex3.setVec2(this.m_vertex3),e.m_hasVertex0=this.m_hasVertex0,e.m_hasVertex3=this.m_hasVertex3,e},t.prototype.getChildCount=function(){return 1},t.prototype.testPoint=function(e,i){return!1},t.prototype.rayCast=function(e,i,s,o){var n=B.mulTVec2(s.q,l.sub(i.p1,s.p)),a=B.mulTVec2(s.q,l.sub(i.p2,s.p)),h=l.sub(a,n),m=this.m_vertex1,c=this.m_vertex2,_=l.sub(c,m),d=l.neo(_.y,-_.x);d.normalize();var u=l.dot(d,l.sub(m,n)),f=l.dot(d,h);if(f==0)return!1;var p=u/f;if(p<0||i.maxFraction<p)return!1;var v=l.add(n,l.mulNumVec2(p,h)),y=l.sub(c,m),x=l.dot(y,y);if(x==0)return!1;var A=l.dot(l.sub(v,m),y)/x;return A<0||1<A?!1:(e.fraction=p,u>0?e.normal=B.mulVec2(s.q,d).neg():e.normal=B.mulVec2(s.q,d),!0)},t.prototype.computeAABB=function(e,i,s){F(zr,i,this.m_vertex1),F(kr,i,this.m_vertex2),ut.combinePoints(e,zr,kr),ut.extend(e,this.m_radius)},t.prototype.computeMass=function(e,i){e.mass=0,Z(e.center,.5,this.m_vertex1,.5,this.m_vertex2),e.I=0},t.prototype.computeDistanceProxy=function(e){e.m_vertices[0]=this.m_vertex1,e.m_vertices[1]=this.m_vertex2,e.m_vertices.length=2,e.m_count=2,e.m_radius=this.m_radius},t.TYPE="edge",t})(ei),Fr=b(0,0),Lr=b(0,0),fs=(function(r){At(t,r);function t(e,i){var s=this;return s instanceof t?(s=r.call(this)||this,s.m_type=t.TYPE,s.m_radius=P.polygonRadius,s.m_vertices=[],s.m_count=0,s.m_prevVertex=null,s.m_nextVertex=null,s.m_hasPrevVertex=!1,s.m_hasNextVertex=!1,s.m_isLoop=!!i,e&&e.length&&(i?s._createLoop(e):s._createChain(e)),s):new t(e,i)}return t.prototype._serialize=function(){var e={type:this.m_type,vertices:this.m_isLoop?this.m_vertices.slice(0,this.m_vertices.length-1):this.m_vertices,isLoop:this.m_isLoop,hasPrevVertex:this.m_hasPrevVertex,hasNextVertex:this.m_hasNextVertex,prevVertex:null,nextVertex:null};return this.m_prevVertex&&(e.prevVertex=this.m_prevVertex),this.m_nextVertex&&(e.nextVertex=this.m_nextVertex),e},t._deserialize=function(e,i,s){var o=[];if(e.vertices)for(var n=0;n<e.vertices.length;n++)o.push(s(l,e.vertices[n]));var a=new t(o,e.isLoop);return e.prevVertex&&a.setPrevVertex(e.prevVertex),e.nextVertex&&a.setNextVertex(e.nextVertex),a},t.prototype.getType=function(){return this.m_type},t.prototype.getRadius=function(){return this.m_radius},t.prototype._createLoop=function(e){if(!(e.length<3)){var i;this.m_vertices=[],this.m_count=e.length+1;for(var i=0;i<e.length;++i)this.m_vertices[i]=l.clone(e[i]);return this.m_vertices[e.length]=l.clone(e[0]),this.m_prevVertex=this.m_vertices[this.m_count-2],this.m_nextVertex=this.m_vertices[1],this.m_hasPrevVertex=!0,this.m_hasNextVertex=!0,this}},t.prototype._createChain=function(e){var i;this.m_vertices=[],this.m_count=e.length;for(var i=0;i<e.length;++i)this.m_vertices[i]=l.clone(e[i]);return this.m_prevVertex=null,this.m_nextVertex=null,this.m_hasPrevVertex=!1,this.m_hasNextVertex=!1,this},t.prototype._reset=function(){this.m_isLoop?this._createLoop(this.m_vertices.slice(0,this.m_vertices.length-1)):this._createChain(this.m_vertices)},t.prototype.setPrevVertex=function(e){this.m_prevVertex=e,this.m_hasPrevVertex=!0},t.prototype.getPrevVertex=function(){return this.m_prevVertex},t.prototype.setNextVertex=function(e){this.m_nextVertex=e,this.m_hasNextVertex=!0},t.prototype.getNextVertex=function(){return this.m_nextVertex},t.prototype._clone=function(){var e=new t;return e._createChain(this.m_vertices),e.m_type=this.m_type,e.m_radius=this.m_radius,e.m_prevVertex=this.m_prevVertex,e.m_nextVertex=this.m_nextVertex,e.m_hasPrevVertex=this.m_hasPrevVertex,e.m_hasNextVertex=this.m_hasNextVertex,e},t.prototype.getChildCount=function(){return this.m_count-1},t.prototype.getChildEdge=function(e,i){e.m_type=_e.TYPE,e.m_radius=this.m_radius,e.m_vertex1=this.m_vertices[i],e.m_vertex2=this.m_vertices[i+1],i>0?(e.m_vertex0=this.m_vertices[i-1],e.m_hasVertex0=!0):(e.m_vertex0=this.m_prevVertex,e.m_hasVertex0=this.m_hasPrevVertex),i<this.m_count-2?(e.m_vertex3=this.m_vertices[i+2],e.m_hasVertex3=!0):(e.m_vertex3=this.m_nextVertex,e.m_hasVertex3=this.m_hasNextVertex)},t.prototype.getVertex=function(e){return e<this.m_count?this.m_vertices[e]:this.m_vertices[0]},t.prototype.isLoop=function(){return this.m_isLoop},t.prototype.testPoint=function(e,i){return!1},t.prototype.rayCast=function(e,i,s,o){var n=new _e(this.getVertex(o),this.getVertex(o+1));return n.rayCast(e,i,s,0)},t.prototype.computeAABB=function(e,i,s){F(Fr,i,this.getVertex(s)),F(Lr,i,this.getVertex(s+1)),ut.combinePoints(e,Fr,Lr)},t.prototype.computeMass=function(e,i){e.mass=0,T(e.center),e.I=0},t.prototype.computeDistanceProxy=function(e,i){e.m_vertices[0]=this.getVertex(i),e.m_vertices[1]=this.getVertex(i+1),e.m_count=2,e.m_radius=this.m_radius},t.TYPE="chain",t})(ei),Hr=Math.max,Ps=Math.min,$e=b(0,0),Dr=b(0,0),Si=b(0,0),mi=b(0,0),Oe=b(0,0),Ie=b(0,0),Be=(function(r){At(t,r);function t(e){var i=this;return i instanceof t?(i=r.call(this)||this,i.m_type=t.TYPE,i.m_radius=P.polygonRadius,i.m_centroid=l.zero(),i.m_vertices=[],i.m_normals=[],i.m_count=0,e&&e.length&&i._set(e),i):new t(e)}return t.prototype._serialize=function(){return{type:this.m_type,vertices:this.m_vertices}},t._deserialize=function(e,i,s){var o=[];if(e.vertices)for(var n=0;n<e.vertices.length;n++)o.push(s(l,e.vertices[n]));var a=new t(o);return a},t.prototype.getType=function(){return this.m_type},t.prototype.getRadius=function(){return this.m_radius},t.prototype._clone=function(){var e=new t;e.m_type=this.m_type,e.m_radius=this.m_radius,e.m_count=this.m_count,e.m_centroid.setVec2(this.m_centroid);for(var i=0;i<this.m_count;i++)e.m_vertices.push(this.m_vertices[i].clone());for(var i=0;i<this.m_normals.length;i++)e.m_normals.push(this.m_normals[i].clone());return e},t.prototype.getChildCount=function(){return 1},t.prototype._reset=function(){this._set(this.m_vertices)},t.prototype._set=function(e){if(e.length<3){this._setAsBox(1,1);return}for(var i=Ps(e.length,P.maxPolygonVertices),s=[],o=0;o<i;++o){for(var n=e[o],a=!0,h=0;h<s.length;++h)if(l.distanceSquared(n,s[h])<.25*P.linearSlopSquared){a=!1;break}a&&s.push(l.clone(n))}if(i=s.length,i<3){this._setAsBox(1,1);return}for(var m=0,c=s[0].x,o=1;o<i;++o){var _=s[o].x;(_>c||_===c&&s[o].y<s[m].y)&&(m=o,c=_)}for(var d=[],u=0,f=m;;){d[u]=f;for(var p=0,h=1;h<i;++h){if(p===f){p=h;continue}var v=l.sub(s[p],s[d[u]]),n=l.sub(s[h],s[d[u]]),y=l.crossVec2Vec2(v,n);y<0&&(p=h),y===0&&n.lengthSquared()>v.lengthSquared()&&(p=h)}if(++u,f=p,p===m)break}if(u<3){this._setAsBox(1,1);return}this.m_count=u,this.m_vertices=[];for(var o=0;o<u;++o)this.m_vertices[o]=s[d[o]];for(var o=0;o<u;++o){var x=o,A=o+1<u?o+1:0,w=l.sub(this.m_vertices[A],this.m_vertices[x]);this.m_normals[o]=l.crossVec2Num(w,1),this.m_normals[o].normalize()}this.m_centroid=Cn(this.m_vertices,u)},t.prototype._setAsBox=function(e,i,s,o){if(this.m_vertices[0]=l.neo(e,-i),this.m_vertices[1]=l.neo(e,i),this.m_vertices[2]=l.neo(-e,i),this.m_vertices[3]=l.neo(-e,-i),this.m_normals[0]=l.neo(1,0),this.m_normals[1]=l.neo(0,1),this.m_normals[2]=l.neo(-1,0),this.m_normals[3]=l.neo(0,-1),this.m_count=4,s&&l.isValid(s)){o=o||0,g(this.m_centroid,s);var n=se.identity();n.p.setVec2(s),n.q.setAngle(o);for(var a=0;a<this.m_count;++a)this.m_vertices[a]=se.mulVec2(n,this.m_vertices[a]),this.m_normals[a]=B.mulVec2(n.q,this.m_normals[a])}},t.prototype.testPoint=function(e,i){for(var s=Gs($e,e,i),o=0;o<this.m_count;++o){var n=I(this.m_normals[o],s)-I(this.m_normals[o],this.m_vertices[o]);if(n>0)return!1}return!0},t.prototype.rayCast=function(e,i,s,o){for(var n=B.mulTVec2(s.q,l.sub(i.p1,s.p)),a=B.mulTVec2(s.q,l.sub(i.p2,s.p)),h=l.sub(a,n),m=0,c=i.maxFraction,_=-1,d=0;d<this.m_count;++d){var u=l.dot(this.m_normals[d],l.sub(this.m_vertices[d],n)),f=l.dot(this.m_normals[d],h);if(f==0){if(u<0)return!1}else f<0&&u<m*f?(m=u/f,_=d):f>0&&u<c*f&&(c=u/f);if(c<m)return!1}return _>=0?(e.fraction=m,e.normal=B.mulVec2(s.q,this.m_normals[_]),!0):!1},t.prototype.computeAABB=function(e,i,s){for(var o=1/0,n=1/0,a=-1/0,h=-1/0,m=0;m<this.m_count;++m){var c=F($e,i,this.m_vertices[m]);o=Ps(o,c.x),a=Hr(a,c.x),n=Ps(n,c.y),h=Hr(h,c.y)}ft(e.lowerBound,o-this.m_radius,n-this.m_radius),ft(e.upperBound,a+this.m_radius,h+this.m_radius)},t.prototype.computeMass=function(e,i){T(Oe);var s=0,o=0;T(Ie);for(var n=0;n<this.m_count;++n)Wt(Ie,this.m_vertices[n]);z(Ie,1/this.m_count,Ie);for(var a=1/3,n=0;n<this.m_count;++n){L(Si,this.m_vertices[n],Ie),n+1<this.m_count?L(mi,this.m_vertices[n+1],Ie):L(mi,this.m_vertices[0],Ie);var h=N(Si,mi),m=.5*h;s+=m,Z($e,m*a,Si,m*a,mi),Wt(Oe,$e);var c=Si.x,_=Si.y,d=mi.x,u=mi.y,f=c*c+d*c+d*d,p=_*_+u*_+u*u;o+=.25*a*h*(f+p)}e.mass=i*s,z(Oe,1/s,Oe),tn(e.center,Oe,Ie),e.I=i*o,e.I+=e.mass*(I(e.center,e.center)-I(Oe,Oe))},t.prototype.validate=function(){for(var e=0;e<this.m_count;++e){var i=e,s=e<this.m_count-1?i+1:0,o=this.m_vertices[i];L(Dr,this.m_vertices[s],o);for(var n=0;n<this.m_count;++n)if(!(n==i||n==s)){var a=N(Dr,L($e,this.m_vertices[n],o));if(a<0)return!1}}return!0},t.prototype.computeDistanceProxy=function(e){for(var i=0;i<this.m_count;++i)e.m_vertices[i]=this.m_vertices[i];e.m_vertices.length=this.m_count,e.m_count=this.m_count,e.m_radius=this.m_radius},t.TYPE="polygon",t})(ei);function Cn(r,t){for(var e=l.zero(),i=0,s=l.zero(),o,n=1/3,o=0;o<t;++o){var a=s,h=r[o],m=o+1<t?r[o+1]:r[0],c=l.sub(h,a),_=l.sub(m,a),d=l.crossVec2Vec2(c,_),u=.5*d;i+=u,me($e,1,a,1,h,1,m),ee(e,u*n,$e)}return e.mul(1/i),e}var Sn=Math.sqrt,In=Math.PI,Er=b(0,0),we=(function(r){At(t,r);function t(e,i){var s=this;return s instanceof t?(s=r.call(this)||this,s.m_type=t.TYPE,s.m_p=l.zero(),s.m_radius=1,typeof e=="object"&&l.isValid(e)?(s.m_p.setVec2(e),typeof i=="number"&&(s.m_radius=i)):typeof e=="number"&&(s.m_radius=e),s):new t(e,i)}return t.prototype._serialize=function(){return{type:this.m_type,p:this.m_p,radius:this.m_radius}},t._deserialize=function(e){return new t(e.p,e.radius)},t.prototype._reset=function(){},t.prototype.getType=function(){return this.m_type},t.prototype.getRadius=function(){return this.m_radius},t.prototype.getCenter=function(){return this.m_p},t.prototype._clone=function(){var e=new t;return e.m_type=this.m_type,e.m_radius=this.m_radius,e.m_p=this.m_p.clone(),e},t.prototype.getChildCount=function(){return 1},t.prototype.testPoint=function(e,i){var s=F(Er,e,this.m_p);return Ke(i,s)<=this.m_radius*this.m_radius},t.prototype.rayCast=function(e,i,s,o){var n=l.add(s.p,B.mulVec2(s.q,this.m_p)),a=l.sub(i.p1,n),h=l.dot(a,a)-this.m_radius*this.m_radius,m=l.sub(i.p2,i.p1),c=l.dot(a,m),_=l.dot(m,m),d=c*c-_*h;if(d<0||_<wt)return!1;var u=-(c+Sn(d));return 0<=u&&u<=i.maxFraction*_?(u/=_,e.fraction=u,e.normal=l.add(a,l.mulNumVec2(u,m)),e.normal.normalize(),!0):!1},t.prototype.computeAABB=function(e,i,s){var o=F(Er,i,this.m_p);ft(e.lowerBound,o.x-this.m_radius,o.y-this.m_radius),ft(e.upperBound,o.x+this.m_radius,o.y+this.m_radius)},t.prototype.computeMass=function(e,i){e.mass=i*In*this.m_radius*this.m_radius,g(e.center,this.m_p),e.I=e.mass*(.5*this.m_radius*this.m_radius+Je(this.m_p))},t.prototype.computeDistanceProxy=function(e){e.m_vertices[0]=this.m_p,e.m_vertices.length=1,e.m_count=1,e.m_radius=this.m_radius},t.TYPE="circle",t})(ei),Vn=Math.abs,Pn=Math.PI,Tn={frequencyHz:0,dampingRatio:0},qr=(function(r){At(t,r);function t(e,i,s,o,n){var a=this;if(!(a instanceof t))return new t(e,i,s,o,n);if(s&&o&&"m_type"in o&&"x"in s&&"y"in s){var h=s;s=o,o=h}return e=Et(e,Tn),a=r.call(this,e,i,s)||this,i=a.m_bodyA,s=a.m_bodyB,a.m_type=t.TYPE,a.m_localAnchorA=l.clone(o?i.getLocalPoint(o):e.localAnchorA||l.zero()),a.m_localAnchorB=l.clone(n?s.getLocalPoint(n):e.localAnchorB||l.zero()),a.m_length=Number.isFinite(e.length)?e.length:l.distance(i.getWorldPoint(a.m_localAnchorA),s.getWorldPoint(a.m_localAnchorB)),a.m_frequencyHz=e.frequencyHz,a.m_dampingRatio=e.dampingRatio,a.m_impulse=0,a.m_gamma=0,a.m_bias=0,a}return t.prototype._serialize=function(){return{type:this.m_type,bodyA:this.m_bodyA,bodyB:this.m_bodyB,collideConnected:this.m_collideConnected,frequencyHz:this.m_frequencyHz,dampingRatio:this.m_dampingRatio,localAnchorA:this.m_localAnchorA,localAnchorB:this.m_localAnchorB,length:this.m_length,impulse:this.m_impulse,gamma:this.m_gamma,bias:this.m_bias}},t._deserialize=function(e,i,s){e=bt({},e),e.bodyA=s($,e.bodyA,i),e.bodyB=s($,e.bodyB,i);var o=new t(e);return o},t.prototype._reset=function(e){e.anchorA?this.m_localAnchorA.setVec2(this.m_bodyA.getLocalPoint(e.anchorA)):e.localAnchorA&&this.m_localAnchorA.setVec2(e.localAnchorA),e.anchorB?this.m_localAnchorB.setVec2(this.m_bodyB.getLocalPoint(e.anchorB)):e.localAnchorB&&this.m_localAnchorB.setVec2(e.localAnchorB),e.length>0?this.m_length=+e.length:e.length<0||(e.anchorA||e.anchorA||e.anchorA||e.anchorA)&&(this.m_length=l.distance(this.m_bodyA.getWorldPoint(this.m_localAnchorA),this.m_bodyB.getWorldPoint(this.m_localAnchorB))),Number.isFinite(e.frequencyHz)&&(this.m_frequencyHz=e.frequencyHz),Number.isFinite(e.dampingRatio)&&(this.m_dampingRatio=e.dampingRatio)},t.prototype.getLocalAnchorA=function(){return this.m_localAnchorA},t.prototype.getLocalAnchorB=function(){return this.m_localAnchorB},t.prototype.setLength=function(e){this.m_length=e},t.prototype.getLength=function(){return this.m_length},t.prototype.setFrequency=function(e){this.m_frequencyHz=e},t.prototype.getFrequency=function(){return this.m_frequencyHz},t.prototype.setDampingRatio=function(e){this.m_dampingRatio=e},t.prototype.getDampingRatio=function(){return this.m_dampingRatio},t.prototype.getAnchorA=function(){return this.m_bodyA.getWorldPoint(this.m_localAnchorA)},t.prototype.getAnchorB=function(){return this.m_bodyB.getWorldPoint(this.m_localAnchorB)},t.prototype.getReactionForce=function(e){return l.mulNumVec2(this.m_impulse,this.m_u).mul(e)},t.prototype.getReactionTorque=function(e){return 0},t.prototype.initVelocityConstraints=function(e){this.m_localCenterA=this.m_bodyA.m_sweep.localCenter,this.m_localCenterB=this.m_bodyB.m_sweep.localCenter,this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var i=this.m_bodyA.c_position.c,s=this.m_bodyA.c_position.a,o=this.m_bodyA.c_velocity.v,n=this.m_bodyA.c_velocity.w,a=this.m_bodyB.c_position.c,h=this.m_bodyB.c_position.a,m=this.m_bodyB.c_velocity.v,c=this.m_bodyB.c_velocity.w,_=B.neo(s),d=B.neo(h);this.m_rA=B.mulVec2(_,l.sub(this.m_localAnchorA,this.m_localCenterA)),this.m_rB=B.mulVec2(d,l.sub(this.m_localAnchorB,this.m_localCenterB)),this.m_u=l.sub(l.add(a,this.m_rB),l.add(i,this.m_rA));var u=this.m_u.length();u>P.linearSlop?this.m_u.mul(1/u):this.m_u.setNum(0,0);var f=l.crossVec2Vec2(this.m_rA,this.m_u),p=l.crossVec2Vec2(this.m_rB,this.m_u),v=this.m_invMassA+this.m_invIA*f*f+this.m_invMassB+this.m_invIB*p*p;if(this.m_mass=v!=0?1/v:0,this.m_frequencyHz>0){var y=u-this.m_length,x=2*Pn*this.m_frequencyHz,A=2*this.m_mass*this.m_dampingRatio*x,w=this.m_mass*x*x,M=e.dt;this.m_gamma=M*(A+M*w),this.m_gamma=this.m_gamma!=0?1/this.m_gamma:0,this.m_bias=y*M*w*this.m_gamma,v+=this.m_gamma,this.m_mass=v!=0?1/v:0}else this.m_gamma=0,this.m_bias=0;if(e.warmStarting){this.m_impulse*=e.dtRatio;var S=l.mulNumVec2(this.m_impulse,this.m_u);o.subMul(this.m_invMassA,S),n-=this.m_invIA*l.crossVec2Vec2(this.m_rA,S),m.addMul(this.m_invMassB,S),c+=this.m_invIB*l.crossVec2Vec2(this.m_rB,S)}else this.m_impulse=0;this.m_bodyA.c_velocity.v.setVec2(o),this.m_bodyA.c_velocity.w=n,this.m_bodyB.c_velocity.v.setVec2(m),this.m_bodyB.c_velocity.w=c},t.prototype.solveVelocityConstraints=function(e){var i=this.m_bodyA.c_velocity.v,s=this.m_bodyA.c_velocity.w,o=this.m_bodyB.c_velocity.v,n=this.m_bodyB.c_velocity.w,a=l.add(i,l.crossNumVec2(s,this.m_rA)),h=l.add(o,l.crossNumVec2(n,this.m_rB)),m=l.dot(this.m_u,h)-l.dot(this.m_u,a),c=-this.m_mass*(m+this.m_bias+this.m_gamma*this.m_impulse);this.m_impulse+=c;var _=l.mulNumVec2(c,this.m_u);i.subMul(this.m_invMassA,_),s-=this.m_invIA*l.crossVec2Vec2(this.m_rA,_),o.addMul(this.m_invMassB,_),n+=this.m_invIB*l.crossVec2Vec2(this.m_rB,_),this.m_bodyA.c_velocity.v.setVec2(i),this.m_bodyA.c_velocity.w=s,this.m_bodyB.c_velocity.v.setVec2(o),this.m_bodyB.c_velocity.w=n},t.prototype.solvePositionConstraints=function(e){if(this.m_frequencyHz>0)return!0;var i=this.m_bodyA.c_position.c,s=this.m_bodyA.c_position.a,o=this.m_bodyB.c_position.c,n=this.m_bodyB.c_position.a,a=B.neo(s),h=B.neo(n),m=B.mulSub(a,this.m_localAnchorA,this.m_localCenterA),c=B.mulSub(h,this.m_localAnchorB,this.m_localCenterB),_=l.sub(l.add(o,c),l.add(i,m)),d=_.normalize(),u=yt(d-this.m_length,-P.maxLinearCorrection,P.maxLinearCorrection),f=-this.m_mass*u,p=l.mulNumVec2(f,_);return i.subMul(this.m_invMassA,p),s-=this.m_invIA*l.crossVec2Vec2(m,p),o.addMul(this.m_invMassB,p),n+=this.m_invIB*l.crossVec2Vec2(c,p),this.m_bodyA.c_position.c.setVec2(i),this.m_bodyA.c_position.a=s,this.m_bodyB.c_position.c.setVec2(o),this.m_bodyB.c_position.a=n,Vn(u)<P.linearSlop},t.TYPE="distance-joint",t})(xt),zn={maxForce:0,maxTorque:0},Rr=(function(r){At(t,r);function t(e,i,s,o){var n=this;return n instanceof t?(e=Et(e,zn),n=r.call(this,e,i,s)||this,i=n.m_bodyA,s=n.m_bodyB,n.m_type=t.TYPE,n.m_localAnchorA=l.clone(o?i.getLocalPoint(o):e.localAnchorA||l.zero()),n.m_localAnchorB=l.clone(o?s.getLocalPoint(o):e.localAnchorB||l.zero()),n.m_linearImpulse=l.zero(),n.m_angularImpulse=0,n.m_maxForce=e.maxForce,n.m_maxTorque=e.maxTorque,n):new t(e,i,s,o)}return t.prototype._serialize=function(){return{type:this.m_type,bodyA:this.m_bodyA,bodyB:this.m_bodyB,collideConnected:this.m_collideConnected,maxForce:this.m_maxForce,maxTorque:this.m_maxTorque,localAnchorA:this.m_localAnchorA,localAnchorB:this.m_localAnchorB}},t._deserialize=function(e,i,s){e=bt({},e),e.bodyA=s($,e.bodyA,i),e.bodyB=s($,e.bodyB,i);var o=new t(e);return o},t.prototype._reset=function(e){e.anchorA?this.m_localAnchorA.setVec2(this.m_bodyA.getLocalPoint(e.anchorA)):e.localAnchorA&&this.m_localAnchorA.setVec2(e.localAnchorA),e.anchorB?this.m_localAnchorB.setVec2(this.m_bodyB.getLocalPoint(e.anchorB)):e.localAnchorB&&this.m_localAnchorB.setVec2(e.localAnchorB),Number.isFinite(e.maxForce)&&(this.m_maxForce=e.maxForce),Number.isFinite(e.maxTorque)&&(this.m_maxTorque=e.maxTorque)},t.prototype.getLocalAnchorA=function(){return this.m_localAnchorA},t.prototype.getLocalAnchorB=function(){return this.m_localAnchorB},t.prototype.setMaxForce=function(e){this.m_maxForce=e},t.prototype.getMaxForce=function(){return this.m_maxForce},t.prototype.setMaxTorque=function(e){this.m_maxTorque=e},t.prototype.getMaxTorque=function(){return this.m_maxTorque},t.prototype.getAnchorA=function(){return this.m_bodyA.getWorldPoint(this.m_localAnchorA)},t.prototype.getAnchorB=function(){return this.m_bodyB.getWorldPoint(this.m_localAnchorB)},t.prototype.getReactionForce=function(e){return l.mulNumVec2(e,this.m_linearImpulse)},t.prototype.getReactionTorque=function(e){return e*this.m_angularImpulse},t.prototype.initVelocityConstraints=function(e){this.m_localCenterA=this.m_bodyA.m_sweep.localCenter,this.m_localCenterB=this.m_bodyB.m_sweep.localCenter,this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var i=this.m_bodyA.c_position.a,s=this.m_bodyA.c_velocity.v,o=this.m_bodyA.c_velocity.w,n=this.m_bodyB.c_position.a,a=this.m_bodyB.c_velocity.v,h=this.m_bodyB.c_velocity.w,m=B.neo(i),c=B.neo(n);this.m_rA=B.mulVec2(m,l.sub(this.m_localAnchorA,this.m_localCenterA)),this.m_rB=B.mulVec2(c,l.sub(this.m_localAnchorB,this.m_localCenterB));var _=this.m_invMassA,d=this.m_invMassB,u=this.m_invIA,f=this.m_invIB,p=new re;if(p.ex.x=_+d+u*this.m_rA.y*this.m_rA.y+f*this.m_rB.y*this.m_rB.y,p.ex.y=-u*this.m_rA.x*this.m_rA.y-f*this.m_rB.x*this.m_rB.y,p.ey.x=p.ex.y,p.ey.y=_+d+u*this.m_rA.x*this.m_rA.x+f*this.m_rB.x*this.m_rB.x,this.m_linearMass=p.getInverse(),this.m_angularMass=u+f,this.m_angularMass>0&&(this.m_angularMass=1/this.m_angularMass),e.warmStarting){this.m_linearImpulse.mul(e.dtRatio),this.m_angularImpulse*=e.dtRatio;var v=l.neo(this.m_linearImpulse.x,this.m_linearImpulse.y);s.subMul(_,v),o-=u*(l.crossVec2Vec2(this.m_rA,v)+this.m_angularImpulse),a.addMul(d,v),h+=f*(l.crossVec2Vec2(this.m_rB,v)+this.m_angularImpulse)}else this.m_linearImpulse.setZero(),this.m_angularImpulse=0;this.m_bodyA.c_velocity.v=s,this.m_bodyA.c_velocity.w=o,this.m_bodyB.c_velocity.v=a,this.m_bodyB.c_velocity.w=h},t.prototype.solveVelocityConstraints=function(e){var i=this.m_bodyA.c_velocity.v,s=this.m_bodyA.c_velocity.w,o=this.m_bodyB.c_velocity.v,n=this.m_bodyB.c_velocity.w,a=this.m_invMassA,h=this.m_invMassB,m=this.m_invIA,c=this.m_invIB,_=e.dt;{var d=n-s,u=-this.m_angularMass*d,f=this.m_angularImpulse,p=_*this.m_maxTorque;this.m_angularImpulse=yt(this.m_angularImpulse+u,-p,p),u=this.m_angularImpulse-f,s-=m*u,n+=c*u}{var d=l.sub(l.add(o,l.crossNumVec2(n,this.m_rB)),l.add(i,l.crossNumVec2(s,this.m_rA))),u=l.neg(re.mulVec2(this.m_linearMass,d)),f=this.m_linearImpulse;this.m_linearImpulse.add(u);var p=_*this.m_maxForce;this.m_linearImpulse.lengthSquared()>p*p&&(this.m_linearImpulse.normalize(),this.m_linearImpulse.mul(p)),u=l.sub(this.m_linearImpulse,f),i.subMul(a,u),s-=m*l.crossVec2Vec2(this.m_rA,u),o.addMul(h,u),n+=c*l.crossVec2Vec2(this.m_rB,u)}this.m_bodyA.c_velocity.v=i,this.m_bodyA.c_velocity.w=s,this.m_bodyB.c_velocity.v=o,this.m_bodyB.c_velocity.w=n},t.prototype.solvePositionConstraints=function(e){return!0},t.TYPE="friction-joint",t})(xt),ke=(function(){function r(t,e,i){typeof t=="object"&&t!==null?(this.ex=G.clone(t),this.ey=G.clone(e),this.ez=G.clone(i)):(this.ex=G.zero(),this.ey=G.zero(),this.ez=G.zero())}return r.prototype.toString=function(){return JSON.stringify(this)},r.isValid=function(t){return t===null||typeof t>"u"?!1:G.isValid(t.ex)&&G.isValid(t.ey)&&G.isValid(t.ez)},r.assert=function(t){},r.prototype.setZero=function(){return this.ex.setZero(),this.ey.setZero(),this.ez.setZero(),this},r.prototype.solve33=function(t){var e=this.ey.y*this.ez.z-this.ey.z*this.ez.y,i=this.ey.z*this.ez.x-this.ey.x*this.ez.z,s=this.ey.x*this.ez.y-this.ey.y*this.ez.x,o=this.ex.x*e+this.ex.y*i+this.ex.z*s;o!==0&&(o=1/o);var n=new G;return e=this.ey.y*this.ez.z-this.ey.z*this.ez.y,i=this.ey.z*this.ez.x-this.ey.x*this.ez.z,s=this.ey.x*this.ez.y-this.ey.y*this.ez.x,n.x=o*(t.x*e+t.y*i+t.z*s),e=t.y*this.ez.z-t.z*this.ez.y,i=t.z*this.ez.x-t.x*this.ez.z,s=t.x*this.ez.y-t.y*this.ez.x,n.y=o*(this.ex.x*e+this.ex.y*i+this.ex.z*s),e=this.ey.y*t.z-this.ey.z*t.y,i=this.ey.z*t.x-this.ey.x*t.z,s=this.ey.x*t.y-this.ey.y*t.x,n.z=o*(this.ex.x*e+this.ex.y*i+this.ex.z*s),n},r.prototype.solve22=function(t){var e=this.ex.x,i=this.ey.x,s=this.ex.y,o=this.ey.y,n=e*o-i*s;n!==0&&(n=1/n);var a=l.zero();return a.x=n*(o*t.x-i*t.y),a.y=n*(e*t.y-s*t.x),a},r.prototype.getInverse22=function(t){var e=this.ex.x,i=this.ey.x,s=this.ex.y,o=this.ey.y,n=e*o-i*s;n!==0&&(n=1/n),t.ex.x=n*o,t.ey.x=-n*i,t.ex.z=0,t.ex.y=-n*s,t.ey.y=n*e,t.ey.z=0,t.ez.x=0,t.ez.y=0,t.ez.z=0},r.prototype.getSymInverse33=function(t){var e=G.dot(this.ex,G.cross(this.ey,this.ez));e!==0&&(e=1/e);var i=this.ex.x,s=this.ey.x,o=this.ez.x,n=this.ey.y,a=this.ez.y,h=this.ez.z;t.ex.x=e*(n*h-a*a),t.ex.y=e*(o*a-s*h),t.ex.z=e*(s*a-o*n),t.ey.x=t.ex.y,t.ey.y=e*(i*h-o*o),t.ey.z=e*(o*s-i*a),t.ez.x=t.ex.z,t.ez.y=t.ey.z,t.ez.z=e*(i*n-s*s)},r.mul=function(t,e){if(e&&"z"in e&&"y"in e&&"x"in e){var i=t.ex.x*e.x+t.ey.x*e.y+t.ez.x*e.z,s=t.ex.y*e.x+t.ey.y*e.y+t.ez.y*e.z,o=t.ex.z*e.x+t.ey.z*e.y+t.ez.z*e.z;return new G(i,s,o)}else if(e&&"y"in e&&"x"in e){var i=t.ex.x*e.x+t.ey.x*e.y,s=t.ex.y*e.x+t.ey.y*e.y;return l.neo(i,s)}},r.mulVec3=function(t,e){var i=t.ex.x*e.x+t.ey.x*e.y+t.ez.x*e.z,s=t.ex.y*e.x+t.ey.y*e.y+t.ez.y*e.z,o=t.ex.z*e.x+t.ey.z*e.y+t.ez.z*e.z;return new G(i,s,o)},r.mulVec2=function(t,e){var i=t.ex.x*e.x+t.ey.x*e.y,s=t.ex.y*e.x+t.ey.y*e.y;return l.neo(i,s)},r.add=function(t,e){return new r(G.add(t.ex,e.ex),G.add(t.ey,e.ey),G.add(t.ez,e.ez))},r})(),Nr=Math.abs,mt;(function(r){r[r.inactiveLimit=0]="inactiveLimit",r[r.atLowerLimit=1]="atLowerLimit",r[r.atUpperLimit=2]="atUpperLimit",r[r.equalLimits=3]="equalLimits"})(mt||(mt={}));var ui={lowerAngle:0,upperAngle:0,maxMotorTorque:0,motorSpeed:0,enableLimit:!1,enableMotor:!1},ze=(function(r){At(t,r);function t(e,i,s,o){var n=this,a,h,m,c,_,d;return n instanceof t?(e=e??{},n=r.call(this,e,i,s)||this,i=n.m_bodyA,s=n.m_bodyB,n.m_mass=new ke,n.m_limitState=mt.inactiveLimit,n.m_type=t.TYPE,l.isValid(o)?n.m_localAnchorA=i.getLocalPoint(o):l.isValid(e.localAnchorA)?n.m_localAnchorA=l.clone(e.localAnchorA):n.m_localAnchorA=l.zero(),l.isValid(o)?n.m_localAnchorB=s.getLocalPoint(o):l.isValid(e.localAnchorB)?n.m_localAnchorB=l.clone(e.localAnchorB):n.m_localAnchorB=l.zero(),Number.isFinite(e.referenceAngle)?n.m_referenceAngle=e.referenceAngle:n.m_referenceAngle=s.getAngle()-i.getAngle(),n.m_impulse=new G,n.m_motorImpulse=0,n.m_lowerAngle=(a=e.lowerAngle)!==null&&a!==void 0?a:ui.lowerAngle,n.m_upperAngle=(h=e.upperAngle)!==null&&h!==void 0?h:ui.upperAngle,n.m_maxMotorTorque=(m=e.maxMotorTorque)!==null&&m!==void 0?m:ui.maxMotorTorque,n.m_motorSpeed=(c=e.motorSpeed)!==null&&c!==void 0?c:ui.motorSpeed,n.m_enableLimit=(_=e.enableLimit)!==null&&_!==void 0?_:ui.enableLimit,n.m_enableMotor=(d=e.enableMotor)!==null&&d!==void 0?d:ui.enableMotor,n):new t(e,i,s,o)}return t.prototype._serialize=function(){return{type:this.m_type,bodyA:this.m_bodyA,bodyB:this.m_bodyB,collideConnected:this.m_collideConnected,lowerAngle:this.m_lowerAngle,upperAngle:this.m_upperAngle,maxMotorTorque:this.m_maxMotorTorque,motorSpeed:this.m_motorSpeed,enableLimit:this.m_enableLimit,enableMotor:this.m_enableMotor,localAnchorA:this.m_localAnchorA,localAnchorB:this.m_localAnchorB,referenceAngle:this.m_referenceAngle}},t._deserialize=function(e,i,s){e=bt({},e),e.bodyA=s($,e.bodyA,i),e.bodyB=s($,e.bodyB,i);var o=new t(e);return o},t.prototype._reset=function(e){e.anchorA?this.m_localAnchorA.setVec2(this.m_bodyA.getLocalPoint(e.anchorA)):e.localAnchorA&&this.m_localAnchorA.setVec2(e.localAnchorA),e.anchorB?this.m_localAnchorB.setVec2(this.m_bodyB.getLocalPoint(e.anchorB)):e.localAnchorB&&this.m_localAnchorB.setVec2(e.localAnchorB),Number.isFinite(e.referenceAngle)&&(this.m_referenceAngle=e.referenceAngle),e.enableLimit!==void 0&&(this.m_enableLimit=e.enableLimit),Number.isFinite(e.lowerAngle)&&(this.m_lowerAngle=e.lowerAngle),Number.isFinite(e.upperAngle)&&(this.m_upperAngle=e.upperAngle),Number.isFinite(e.maxMotorTorque)&&(this.m_maxMotorTorque=e.maxMotorTorque),Number.isFinite(e.motorSpeed)&&(this.m_motorSpeed=e.motorSpeed),e.enableMotor!==void 0&&(this.m_enableMotor=e.enableMotor)},t.prototype.getLocalAnchorA=function(){return this.m_localAnchorA},t.prototype.getLocalAnchorB=function(){return this.m_localAnchorB},t.prototype.getReferenceAngle=function(){return this.m_referenceAngle},t.prototype.getJointAngle=function(){var e=this.m_bodyA,i=this.m_bodyB;return i.m_sweep.a-e.m_sweep.a-this.m_referenceAngle},t.prototype.getJointSpeed=function(){var e=this.m_bodyA,i=this.m_bodyB;return i.m_angularVelocity-e.m_angularVelocity},t.prototype.isMotorEnabled=function(){return this.m_enableMotor},t.prototype.enableMotor=function(e){e!=this.m_enableMotor&&(this.m_bodyA.setAwake(!0),this.m_bodyB.setAwake(!0),this.m_enableMotor=e)},t.prototype.getMotorTorque=function(e){return e*this.m_motorImpulse},t.prototype.setMotorSpeed=function(e){e!=this.m_motorSpeed&&(this.m_bodyA.setAwake(!0),this.m_bodyB.setAwake(!0),this.m_motorSpeed=e)},t.prototype.getMotorSpeed=function(){return this.m_motorSpeed},t.prototype.setMaxMotorTorque=function(e){e!=this.m_maxMotorTorque&&(this.m_bodyA.setAwake(!0),this.m_bodyB.setAwake(!0),this.m_maxMotorTorque=e)},t.prototype.getMaxMotorTorque=function(){return this.m_maxMotorTorque},t.prototype.isLimitEnabled=function(){return this.m_enableLimit},t.prototype.enableLimit=function(e){e!=this.m_enableLimit&&(this.m_bodyA.setAwake(!0),this.m_bodyB.setAwake(!0),this.m_enableLimit=e,this.m_impulse.z=0)},t.prototype.getLowerLimit=function(){return this.m_lowerAngle},t.prototype.getUpperLimit=function(){return this.m_upperAngle},t.prototype.setLimits=function(e,i){(e!=this.m_lowerAngle||i!=this.m_upperAngle)&&(this.m_bodyA.setAwake(!0),this.m_bodyB.setAwake(!0),this.m_impulse.z=0,this.m_lowerAngle=e,this.m_upperAngle=i)},t.prototype.getAnchorA=function(){return this.m_bodyA.getWorldPoint(this.m_localAnchorA)},t.prototype.getAnchorB=function(){return this.m_bodyB.getWorldPoint(this.m_localAnchorB)},t.prototype.getReactionForce=function(e){return l.neo(this.m_impulse.x,this.m_impulse.y).mul(e)},t.prototype.getReactionTorque=function(e){return e*this.m_impulse.z},t.prototype.initVelocityConstraints=function(e){this.m_localCenterA=this.m_bodyA.m_sweep.localCenter,this.m_localCenterB=this.m_bodyB.m_sweep.localCenter,this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var i=this.m_bodyA.c_position.a,s=this.m_bodyA.c_velocity.v,o=this.m_bodyA.c_velocity.w,n=this.m_bodyB.c_position.a,a=this.m_bodyB.c_velocity.v,h=this.m_bodyB.c_velocity.w,m=B.neo(i),c=B.neo(n);this.m_rA=B.mulVec2(m,l.sub(this.m_localAnchorA,this.m_localCenterA)),this.m_rB=B.mulVec2(c,l.sub(this.m_localAnchorB,this.m_localCenterB));var _=this.m_invMassA,d=this.m_invMassB,u=this.m_invIA,f=this.m_invIB,p=u+f===0;if(this.m_mass.ex.x=_+d+this.m_rA.y*this.m_rA.y*u+this.m_rB.y*this.m_rB.y*f,this.m_mass.ey.x=-this.m_rA.y*this.m_rA.x*u-this.m_rB.y*this.m_rB.x*f,this.m_mass.ez.x=-this.m_rA.y*u-this.m_rB.y*f,this.m_mass.ex.y=this.m_mass.ey.x,this.m_mass.ey.y=_+d+this.m_rA.x*this.m_rA.x*u+this.m_rB.x*this.m_rB.x*f,this.m_mass.ez.y=this.m_rA.x*u+this.m_rB.x*f,this.m_mass.ex.z=this.m_mass.ez.x,this.m_mass.ey.z=this.m_mass.ez.y,this.m_mass.ez.z=u+f,this.m_motorMass=u+f,this.m_motorMass>0&&(this.m_motorMass=1/this.m_motorMass),(this.m_enableMotor==!1||p)&&(this.m_motorImpulse=0),this.m_enableLimit&&p==!1){var v=n-i-this.m_referenceAngle;Nr(this.m_upperAngle-this.m_lowerAngle)<2*P.angularSlop?this.m_limitState=mt.equalLimits:v<=this.m_lowerAngle?(this.m_limitState!=mt.atLowerLimit&&(this.m_impulse.z=0),this.m_limitState=mt.atLowerLimit):v>=this.m_upperAngle?(this.m_limitState!=mt.atUpperLimit&&(this.m_impulse.z=0),this.m_limitState=mt.atUpperLimit):(this.m_limitState=mt.inactiveLimit,this.m_impulse.z=0)}else this.m_limitState=mt.inactiveLimit;if(e.warmStarting){this.m_impulse.mul(e.dtRatio),this.m_motorImpulse*=e.dtRatio;var y=l.neo(this.m_impulse.x,this.m_impulse.y);s.subMul(_,y),o-=u*(l.crossVec2Vec2(this.m_rA,y)+this.m_motorImpulse+this.m_impulse.z),a.addMul(d,y),h+=f*(l.crossVec2Vec2(this.m_rB,y)+this.m_motorImpulse+this.m_impulse.z)}else this.m_impulse.setZero(),this.m_motorImpulse=0;this.m_bodyA.c_velocity.v=s,this.m_bodyA.c_velocity.w=o,this.m_bodyB.c_velocity.v=a,this.m_bodyB.c_velocity.w=h},t.prototype.solveVelocityConstraints=function(e){var i=this.m_bodyA.c_velocity.v,s=this.m_bodyA.c_velocity.w,o=this.m_bodyB.c_velocity.v,n=this.m_bodyB.c_velocity.w,a=this.m_invMassA,h=this.m_invMassB,m=this.m_invIA,c=this.m_invIB,_=m+c===0;if(this.m_enableMotor&&this.m_limitState!=mt.equalLimits&&_==!1){var d=n-s-this.m_motorSpeed,u=-this.m_motorMass*d,f=this.m_motorImpulse,p=e.dt*this.m_maxMotorTorque;this.m_motorImpulse=yt(this.m_motorImpulse+u,-p,p),u=this.m_motorImpulse-f,s-=m*u,n+=c*u}if(this.m_enableLimit&&this.m_limitState!=mt.inactiveLimit&&_==!1){var v=l.zero();v.addCombine(1,o,1,l.crossNumVec2(n,this.m_rB)),v.subCombine(1,i,1,l.crossNumVec2(s,this.m_rA));var y=n-s,d=new G(v.x,v.y,y),u=G.neg(this.m_mass.solve33(d));if(this.m_limitState==mt.equalLimits)this.m_impulse.add(u);else if(this.m_limitState==mt.atLowerLimit){var x=this.m_impulse.z+u.z;if(x<0){var A=l.combine(-1,v,this.m_impulse.z,l.neo(this.m_mass.ez.x,this.m_mass.ez.y)),w=this.m_mass.solve22(A);u.x=w.x,u.y=w.y,u.z=-this.m_impulse.z,this.m_impulse.x+=w.x,this.m_impulse.y+=w.y,this.m_impulse.z=0}else this.m_impulse.add(u)}else if(this.m_limitState==mt.atUpperLimit){var x=this.m_impulse.z+u.z;if(x>0){var A=l.combine(-1,v,this.m_impulse.z,l.neo(this.m_mass.ez.x,this.m_mass.ez.y)),w=this.m_mass.solve22(A);u.x=w.x,u.y=w.y,u.z=-this.m_impulse.z,this.m_impulse.x+=w.x,this.m_impulse.y+=w.y,this.m_impulse.z=0}else this.m_impulse.add(u)}var M=l.neo(u.x,u.y);i.subMul(a,M),s-=m*(l.crossVec2Vec2(this.m_rA,M)+u.z),o.addMul(h,M),n+=c*(l.crossVec2Vec2(this.m_rB,M)+u.z)}else{var d=l.zero();d.addCombine(1,o,1,l.crossNumVec2(n,this.m_rB)),d.subCombine(1,i,1,l.crossNumVec2(s,this.m_rA));var u=this.m_mass.solve22(l.neg(d));this.m_impulse.x+=u.x,this.m_impulse.y+=u.y,i.subMul(a,u),s-=m*l.crossVec2Vec2(this.m_rA,u),o.addMul(h,u),n+=c*l.crossVec2Vec2(this.m_rB,u)}this.m_bodyA.c_velocity.v=i,this.m_bodyA.c_velocity.w=s,this.m_bodyB.c_velocity.v=o,this.m_bodyB.c_velocity.w=n},t.prototype.solvePositionConstraints=function(e){var i=this.m_bodyA.c_position.c,s=this.m_bodyA.c_position.a,o=this.m_bodyB.c_position.c,n=this.m_bodyB.c_position.a,a=B.neo(s),h=B.neo(n),m=0,c=0,_=this.m_invIA+this.m_invIB==0;if(this.m_enableLimit&&this.m_limitState!=mt.inactiveLimit&&_==!1){var d=n-s-this.m_referenceAngle,u=0;if(this.m_limitState==mt.equalLimits){var f=yt(d-this.m_lowerAngle,-P.maxAngularCorrection,P.maxAngularCorrection);u=-this.m_motorMass*f,m=Nr(f)}else if(this.m_limitState==mt.atLowerLimit){var f=d-this.m_lowerAngle;m=-f,f=yt(f+P.angularSlop,-P.maxAngularCorrection,0),u=-this.m_motorMass*f}else if(this.m_limitState==mt.atUpperLimit){var f=d-this.m_upperAngle;m=f,f=yt(f-P.angularSlop,0,P.maxAngularCorrection),u=-this.m_motorMass*f}s-=this.m_invIA*u,n+=this.m_invIB*u}{a.setAngle(s),h.setAngle(n);var p=B.mulVec2(a,l.sub(this.m_localAnchorA,this.m_localCenterA)),v=B.mulVec2(h,l.sub(this.m_localAnchorB,this.m_localCenterB)),f=l.zero();f.addCombine(1,o,1,v),f.subCombine(1,i,1,p),c=f.length();var y=this.m_invMassA,x=this.m_invMassB,A=this.m_invIA,w=this.m_invIB,M=new re;M.ex.x=y+x+A*p.y*p.y+w*v.y*v.y,M.ex.y=-A*p.x*p.y-w*v.x*v.y,M.ey.x=M.ex.y,M.ey.y=y+x+A*p.x*p.x+w*v.x*v.x;var S=l.neg(M.solve(f));i.subMul(y,S),s-=A*l.crossVec2Vec2(p,S),o.addMul(x,S),n+=w*l.crossVec2Vec2(v,S)}return this.m_bodyA.c_position.c.setVec2(i),this.m_bodyA.c_position.a=s,this.m_bodyB.c_position.c.setVec2(o),this.m_bodyB.c_position.a=n,c<=P.linearSlop&&m<=P.angularSlop},t.TYPE="revolute-joint",t})(xt),Ii=Math.abs,Or=Math.max,kn=Math.min,Vt;(function(r){r[r.inactiveLimit=0]="inactiveLimit",r[r.atLowerLimit=1]="atLowerLimit",r[r.atUpperLimit=2]="atUpperLimit",r[r.equalLimits=3]="equalLimits"})(Vt||(Vt={}));var Fn={enableLimit:!1,lowerTranslation:0,upperTranslation:0,enableMotor:!1,maxMotorForce:0,motorSpeed:0},Ur=(function(r){At(t,r);function t(e,i,s,o,n){var a=this;return a instanceof t?(e=Et(e,Fn),a=r.call(this,e,i,s)||this,i=a.m_bodyA,s=a.m_bodyB,a.m_type=t.TYPE,a.m_localAnchorA=l.clone(o?i.getLocalPoint(o):e.localAnchorA||l.zero()),a.m_localAnchorB=l.clone(o?s.getLocalPoint(o):e.localAnchorB||l.zero()),a.m_localXAxisA=l.clone(n?i.getLocalVector(n):e.localAxisA||l.neo(1,0)),a.m_localXAxisA.normalize(),a.m_localYAxisA=l.crossNumVec2(1,a.m_localXAxisA),a.m_referenceAngle=Number.isFinite(e.referenceAngle)?e.referenceAngle:s.getAngle()-i.getAngle(),a.m_impulse=new G,a.m_motorMass=0,a.m_motorImpulse=0,a.m_lowerTranslation=e.lowerTranslation,a.m_upperTranslation=e.upperTranslation,a.m_maxMotorForce=e.maxMotorForce,a.m_motorSpeed=e.motorSpeed,a.m_enableLimit=e.enableLimit,a.m_enableMotor=e.enableMotor,a.m_limitState=Vt.inactiveLimit,a.m_axis=l.zero(),a.m_perp=l.zero(),a.m_K=new ke,a):new t(e,i,s,o,n)}return t.prototype._serialize=function(){return{type:this.m_type,bodyA:this.m_bodyA,bodyB:this.m_bodyB,collideConnected:this.m_collideConnected,lowerTranslation:this.m_lowerTranslation,upperTranslation:this.m_upperTranslation,maxMotorForce:this.m_maxMotorForce,motorSpeed:this.m_motorSpeed,enableLimit:this.m_enableLimit,enableMotor:this.m_enableMotor,localAnchorA:this.m_localAnchorA,localAnchorB:this.m_localAnchorB,localAxisA:this.m_localXAxisA,referenceAngle:this.m_referenceAngle}},t._deserialize=function(e,i,s){e=bt({},e),e.bodyA=s($,e.bodyA,i),e.bodyB=s($,e.bodyB,i),e.localAxisA=l.clone(e.localAxisA);var o=new t(e);return o},t.prototype._reset=function(e){e.anchorA?this.m_localAnchorA.setVec2(this.m_bodyA.getLocalPoint(e.anchorA)):e.localAnchorA&&this.m_localAnchorA.setVec2(e.localAnchorA),e.anchorB?this.m_localAnchorB.setVec2(this.m_bodyB.getLocalPoint(e.anchorB)):e.localAnchorB&&this.m_localAnchorB.setVec2(e.localAnchorB),e.localAxisA&&(this.m_localXAxisA.setVec2(e.localAxisA),this.m_localYAxisA.setVec2(l.crossNumVec2(1,e.localAxisA))),Number.isFinite(e.referenceAngle)&&(this.m_referenceAngle=e.referenceAngle),typeof e.enableLimit<"u"&&(this.m_enableLimit=!!e.enableLimit),Number.isFinite(e.lowerTranslation)&&(this.m_lowerTranslation=e.lowerTranslation),Number.isFinite(e.upperTranslation)&&(this.m_upperTranslation=e.upperTranslation),typeof e.enableMotor<"u"&&(this.m_enableMotor=!!e.enableMotor),Number.isFinite(e.maxMotorForce)&&(this.m_maxMotorForce=e.maxMotorForce),Number.isFinite(e.motorSpeed)&&(this.m_motorSpeed=e.motorSpeed)},t.prototype.getLocalAnchorA=function(){return this.m_localAnchorA},t.prototype.getLocalAnchorB=function(){return this.m_localAnchorB},t.prototype.getLocalAxisA=function(){return this.m_localXAxisA},t.prototype.getReferenceAngle=function(){return this.m_referenceAngle},t.prototype.getJointTranslation=function(){var e=this.m_bodyA.getWorldPoint(this.m_localAnchorA),i=this.m_bodyB.getWorldPoint(this.m_localAnchorB),s=l.sub(i,e),o=this.m_bodyA.getWorldVector(this.m_localXAxisA),n=l.dot(s,o);return n},t.prototype.getJointSpeed=function(){var e=this.m_bodyA,i=this.m_bodyB,s=B.mulVec2(e.m_xf.q,l.sub(this.m_localAnchorA,e.m_sweep.localCenter)),o=B.mulVec2(i.m_xf.q,l.sub(this.m_localAnchorB,i.m_sweep.localCenter)),n=l.add(e.m_sweep.c,s),a=l.add(i.m_sweep.c,o),h=l.sub(a,n),m=B.mulVec2(e.m_xf.q,this.m_localXAxisA),c=e.m_linearVelocity,_=i.m_linearVelocity,d=e.m_angularVelocity,u=i.m_angularVelocity,f=l.dot(h,l.crossNumVec2(d,m))+l.dot(m,l.sub(l.addCrossNumVec2(_,u,o),l.addCrossNumVec2(c,d,s)));return f},t.prototype.isLimitEnabled=function(){return this.m_enableLimit},t.prototype.enableLimit=function(e){e!=this.m_enableLimit&&(this.m_bodyA.setAwake(!0),this.m_bodyB.setAwake(!0),this.m_enableLimit=e,this.m_impulse.z=0)},t.prototype.getLowerLimit=function(){return this.m_lowerTranslation},t.prototype.getUpperLimit=function(){return this.m_upperTranslation},t.prototype.setLimits=function(e,i){(e!=this.m_lowerTranslation||i!=this.m_upperTranslation)&&(this.m_bodyA.setAwake(!0),this.m_bodyB.setAwake(!0),this.m_lowerTranslation=e,this.m_upperTranslation=i,this.m_impulse.z=0)},t.prototype.isMotorEnabled=function(){return this.m_enableMotor},t.prototype.enableMotor=function(e){e!=this.m_enableMotor&&(this.m_bodyA.setAwake(!0),this.m_bodyB.setAwake(!0),this.m_enableMotor=e)},t.prototype.setMotorSpeed=function(e){e!=this.m_motorSpeed&&(this.m_bodyA.setAwake(!0),this.m_bodyB.setAwake(!0),this.m_motorSpeed=e)},t.prototype.setMaxMotorForce=function(e){e!=this.m_maxMotorForce&&(this.m_bodyA.setAwake(!0),this.m_bodyB.setAwake(!0),this.m_maxMotorForce=e)},t.prototype.getMaxMotorForce=function(){return this.m_maxMotorForce},t.prototype.getMotorSpeed=function(){return this.m_motorSpeed},t.prototype.getMotorForce=function(e){return e*this.m_motorImpulse},t.prototype.getAnchorA=function(){return this.m_bodyA.getWorldPoint(this.m_localAnchorA)},t.prototype.getAnchorB=function(){return this.m_bodyB.getWorldPoint(this.m_localAnchorB)},t.prototype.getReactionForce=function(e){return l.combine(this.m_impulse.x,this.m_perp,this.m_motorImpulse+this.m_impulse.z,this.m_axis).mul(e)},t.prototype.getReactionTorque=function(e){return e*this.m_impulse.y},t.prototype.initVelocityConstraints=function(e){this.m_localCenterA=this.m_bodyA.m_sweep.localCenter,this.m_localCenterB=this.m_bodyB.m_sweep.localCenter,this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var i=this.m_bodyA.c_position.c,s=this.m_bodyA.c_position.a,o=this.m_bodyA.c_velocity.v,n=this.m_bodyA.c_velocity.w,a=this.m_bodyB.c_position.c,h=this.m_bodyB.c_position.a,m=this.m_bodyB.c_velocity.v,c=this.m_bodyB.c_velocity.w,_=B.neo(s),d=B.neo(h),u=B.mulVec2(_,l.sub(this.m_localAnchorA,this.m_localCenterA)),f=B.mulVec2(d,l.sub(this.m_localAnchorB,this.m_localCenterB)),p=l.zero();p.addCombine(1,a,1,f),p.subCombine(1,i,1,u);var v=this.m_invMassA,y=this.m_invMassB,x=this.m_invIA,A=this.m_invIB;this.m_axis=B.mulVec2(_,this.m_localXAxisA),this.m_a1=l.crossVec2Vec2(l.add(p,u),this.m_axis),this.m_a2=l.crossVec2Vec2(f,this.m_axis),this.m_motorMass=v+y+x*this.m_a1*this.m_a1+A*this.m_a2*this.m_a2,this.m_motorMass>0&&(this.m_motorMass=1/this.m_motorMass);{this.m_perp=B.mulVec2(_,this.m_localYAxisA),this.m_s1=l.crossVec2Vec2(l.add(p,u),this.m_perp),this.m_s2=l.crossVec2Vec2(f,this.m_perp),l.crossVec2Vec2(u,this.m_perp);var w=v+y+x*this.m_s1*this.m_s1+A*this.m_s2*this.m_s2,M=x*this.m_s1+A*this.m_s2,S=x*this.m_s1*this.m_a1+A*this.m_s2*this.m_a2,C=x+A;C==0&&(C=1);var V=x*this.m_a1+A*this.m_a2,H=v+y+x*this.m_a1*this.m_a1+A*this.m_a2*this.m_a2;this.m_K.ex.set(w,M,S),this.m_K.ey.set(M,C,V),this.m_K.ez.set(S,V,H)}if(this.m_enableLimit){var E=l.dot(this.m_axis,p);Ii(this.m_upperTranslation-this.m_lowerTranslation)<2*P.linearSlop?this.m_limitState=Vt.equalLimits:E<=this.m_lowerTranslation?this.m_limitState!=Vt.atLowerLimit&&(this.m_limitState=Vt.atLowerLimit,this.m_impulse.z=0):E>=this.m_upperTranslation?this.m_limitState!=Vt.atUpperLimit&&(this.m_limitState=Vt.atUpperLimit,this.m_impulse.z=0):(this.m_limitState=Vt.inactiveLimit,this.m_impulse.z=0)}else this.m_limitState=Vt.inactiveLimit,this.m_impulse.z=0;if(this.m_enableMotor==!1&&(this.m_motorImpulse=0),e.warmStarting){this.m_impulse.mul(e.dtRatio),this.m_motorImpulse*=e.dtRatio;var q=l.combine(this.m_impulse.x,this.m_perp,this.m_motorImpulse+this.m_impulse.z,this.m_axis),j=this.m_impulse.x*this.m_s1+this.m_impulse.y+(this.m_motorImpulse+this.m_impulse.z)*this.m_a1,W=this.m_impulse.x*this.m_s2+this.m_impulse.y+(this.m_motorImpulse+this.m_impulse.z)*this.m_a2;o.subMul(v,q),n-=x*j,m.addMul(y,q),c+=A*W}else this.m_impulse.setZero(),this.m_motorImpulse=0;this.m_bodyA.c_velocity.v.setVec2(o),this.m_bodyA.c_velocity.w=n,this.m_bodyB.c_velocity.v.setVec2(m),this.m_bodyB.c_velocity.w=c},t.prototype.solveVelocityConstraints=function(e){var i=this.m_bodyA.c_velocity.v,s=this.m_bodyA.c_velocity.w,o=this.m_bodyB.c_velocity.v,n=this.m_bodyB.c_velocity.w,a=this.m_invMassA,h=this.m_invMassB,m=this.m_invIA,c=this.m_invIB;if(this.m_enableMotor&&this.m_limitState!=Vt.equalLimits){var _=l.dot(this.m_axis,l.sub(o,i))+this.m_a2*n-this.m_a1*s,d=this.m_motorMass*(this.m_motorSpeed-_),u=this.m_motorImpulse,f=e.dt*this.m_maxMotorForce;this.m_motorImpulse=yt(this.m_motorImpulse+d,-f,f),d=this.m_motorImpulse-u;var p=l.mulNumVec2(d,this.m_axis),v=d*this.m_a1,y=d*this.m_a2;i.subMul(a,p),s-=m*v,o.addMul(h,p),n+=c*y}var x=l.zero();if(x.x+=l.dot(this.m_perp,o)+this.m_s2*n,x.x-=l.dot(this.m_perp,i)+this.m_s1*s,x.y=n-s,this.m_enableLimit&&this.m_limitState!=Vt.inactiveLimit){var A=0;A+=l.dot(this.m_axis,o)+this.m_a2*n,A-=l.dot(this.m_axis,i)+this.m_a1*s;var _=new G(x.x,x.y,A),w=G.clone(this.m_impulse),M=this.m_K.solve33(G.neg(_));this.m_impulse.add(M),this.m_limitState==Vt.atLowerLimit?this.m_impulse.z=Or(this.m_impulse.z,0):this.m_limitState==Vt.atUpperLimit&&(this.m_impulse.z=kn(this.m_impulse.z,0));var S=l.combine(-1,x,-(this.m_impulse.z-w.z),l.neo(this.m_K.ez.x,this.m_K.ez.y)),C=l.add(this.m_K.solve22(S),l.neo(w.x,w.y));this.m_impulse.x=C.x,this.m_impulse.y=C.y,M=G.sub(this.m_impulse,w);var p=l.combine(M.x,this.m_perp,M.z,this.m_axis),v=M.x*this.m_s1+M.y+M.z*this.m_a1,y=M.x*this.m_s2+M.y+M.z*this.m_a2;i.subMul(a,p),s-=m*v,o.addMul(h,p),n+=c*y}else{var M=this.m_K.solve22(l.neg(x));this.m_impulse.x+=M.x,this.m_impulse.y+=M.y;var p=l.mulNumVec2(M.x,this.m_perp),v=M.x*this.m_s1+M.y,y=M.x*this.m_s2+M.y;i.subMul(a,p),s-=m*v,o.addMul(h,p),n+=c*y}this.m_bodyA.c_velocity.v=i,this.m_bodyA.c_velocity.w=s,this.m_bodyB.c_velocity.v=o,this.m_bodyB.c_velocity.w=n},t.prototype.solvePositionConstraints=function(e){var i=this.m_bodyA.c_position.c,s=this.m_bodyA.c_position.a,o=this.m_bodyB.c_position.c,n=this.m_bodyB.c_position.a,a=B.neo(s),h=B.neo(n),m=this.m_invMassA,c=this.m_invMassB,_=this.m_invIA,d=this.m_invIB,u=B.mulVec2(a,l.sub(this.m_localAnchorA,this.m_localCenterA)),f=B.mulVec2(h,l.sub(this.m_localAnchorB,this.m_localCenterB)),p=l.sub(l.add(o,f),l.add(i,u)),v=B.mulVec2(a,this.m_localXAxisA),y=l.crossVec2Vec2(l.add(p,u),v),x=l.crossVec2Vec2(f,v),A=B.mulVec2(a,this.m_localYAxisA),w=l.crossVec2Vec2(l.add(p,u),A),M=l.crossVec2Vec2(f,A),S=new G,C=l.zero();C.x=l.dot(A,p),C.y=n-s-this.m_referenceAngle;var V=Ii(C.x),H=Ii(C.y),E=P.linearSlop,q=P.maxLinearCorrection,j=!1,W=0;if(this.m_enableLimit){var Y=l.dot(v,p);Ii(this.m_upperTranslation-this.m_lowerTranslation)<2*E?(W=yt(Y,-q,q),V=Or(V,Ii(Y)),j=!0):Y<=this.m_lowerTranslation?(W=yt(Y-this.m_lowerTranslation+E,-q,0),V=Math.max(V,this.m_lowerTranslation-Y),j=!0):Y>=this.m_upperTranslation&&(W=yt(Y-this.m_upperTranslation-E,0,q),V=Math.max(V,Y-this.m_upperTranslation),j=!0)}if(j){var Tt=m+c+_*w*w+d*M*M,dt=_*w+d*M,Yt=_*w*y+d*M*x,Mt=_+d;Mt==0&&(Mt=1);var et=_*y+d*x,xi=m+c+_*y*y+d*x*x,qt=new ke;qt.ex.set(Tt,dt,Yt),qt.ey.set(dt,Mt,et),qt.ez.set(Yt,et,xi);var Me=new G;Me.x=C.x,Me.y=C.y,Me.z=W,S=qt.solve33(G.neg(Me))}else{var Tt=m+c+_*w*w+d*M*M,dt=_*w+d*M,Mt=_+d;Mt==0&&(Mt=1);var qt=new re;qt.ex.setNum(Tt,dt),qt.ey.setNum(dt,Mt);var Fe=qt.solve(l.neg(C));S.x=Fe.x,S.y=Fe.y,S.z=0}var bi=l.combine(S.x,A,S.z,v),si=S.x*w+S.y+S.z*y,vs=S.x*M+S.y+S.z*x;return i.subMul(m,bi),s-=_*si,o.addMul(c,bi),n+=d*vs,this.m_bodyA.c_position.c=i,this.m_bodyA.c_position.a=s,this.m_bodyB.c_position.c=o,this.m_bodyB.c_position.a=n,V<=P.linearSlop&&H<=P.angularSlop},t.TYPE="prismatic-joint",t})(xt),Ln={ratio:1},jr=(function(r){At(t,r);function t(e,i,s,o,n,a){var h=this;if(!(h instanceof t))return new t(e,i,s,o,n,a);e=Et(e,Ln),h=r.call(this,e,i,s)||this,i=h.m_bodyA,s=h.m_bodyB,h.m_type=t.TYPE,h.m_joint1=o||e.joint1,h.m_joint2=n||e.joint2,h.m_ratio=Number.isFinite(a)?a:e.ratio,h.m_type1=h.m_joint1.getType(),h.m_type2=h.m_joint2.getType();var m,c;h.m_bodyC=h.m_joint1.getBodyA(),h.m_bodyA=h.m_joint1.getBodyB();var _=h.m_bodyA.m_xf,d=h.m_bodyA.m_sweep.a,u=h.m_bodyC.m_xf,f=h.m_bodyC.m_sweep.a;if(h.m_type1===ze.TYPE){var p=h.m_joint1;h.m_localAnchorC=p.m_localAnchorA,h.m_localAnchorA=p.m_localAnchorB,h.m_referenceAngleA=p.m_referenceAngle,h.m_localAxisC=l.zero(),m=d-f-h.m_referenceAngleA}else{var v=h.m_joint1;h.m_localAnchorC=v.m_localAnchorA,h.m_localAnchorA=v.m_localAnchorB,h.m_referenceAngleA=v.m_referenceAngle,h.m_localAxisC=v.m_localXAxisA;var y=h.m_localAnchorC,x=B.mulTVec2(u.q,l.add(B.mulVec2(_.q,h.m_localAnchorA),l.sub(_.p,u.p)));m=l.dot(x,h.m_localAxisC)-l.dot(y,h.m_localAxisC)}h.m_bodyD=h.m_joint2.getBodyA(),h.m_bodyB=h.m_joint2.getBodyB();var A=h.m_bodyB.m_xf,w=h.m_bodyB.m_sweep.a,M=h.m_bodyD.m_xf,S=h.m_bodyD.m_sweep.a;if(h.m_type2===ze.TYPE){var p=h.m_joint2;h.m_localAnchorD=p.m_localAnchorA,h.m_localAnchorB=p.m_localAnchorB,h.m_referenceAngleB=p.m_referenceAngle,h.m_localAxisD=l.zero(),c=w-S-h.m_referenceAngleB}else{var v=h.m_joint2;h.m_localAnchorD=v.m_localAnchorA,h.m_localAnchorB=v.m_localAnchorB,h.m_referenceAngleB=v.m_referenceAngle,h.m_localAxisD=v.m_localXAxisA;var C=h.m_localAnchorD,V=B.mulTVec2(M.q,l.add(B.mulVec2(A.q,h.m_localAnchorB),l.sub(A.p,M.p)));c=l.dot(V,h.m_localAxisD)-l.dot(C,h.m_localAxisD)}return h.m_constant=m+h.m_ratio*c,h.m_impulse=0,h}return t.prototype._serialize=function(){return{type:this.m_type,bodyA:this.m_bodyA,bodyB:this.m_bodyB,collideConnected:this.m_collideConnected,joint1:this.m_joint1,joint2:this.m_joint2,ratio:this.m_ratio}},t._deserialize=function(e,i,s){e=bt({},e),e.bodyA=s($,e.bodyA,i),e.bodyB=s($,e.bodyB,i),e.joint1=s(xt,e.joint1,i),e.joint2=s(xt,e.joint2,i);var o=new t(e);return o},t.prototype._reset=function(e){Number.isFinite(e.ratio)&&(this.m_ratio=e.ratio)},t.prototype.getJoint1=function(){return this.m_joint1},t.prototype.getJoint2=function(){return this.m_joint2},t.prototype.setRatio=function(e){this.m_ratio=e},t.prototype.getRatio=function(){return this.m_ratio},t.prototype.getAnchorA=function(){return this.m_bodyA.getWorldPoint(this.m_localAnchorA)},t.prototype.getAnchorB=function(){return this.m_bodyB.getWorldPoint(this.m_localAnchorB)},t.prototype.getReactionForce=function(e){return l.mulNumVec2(this.m_impulse,this.m_JvAC).mul(e)},t.prototype.getReactionTorque=function(e){var i=this.m_impulse*this.m_JwA;return e*i},t.prototype.initVelocityConstraints=function(e){this.m_lcA=this.m_bodyA.m_sweep.localCenter,this.m_lcB=this.m_bodyB.m_sweep.localCenter,this.m_lcC=this.m_bodyC.m_sweep.localCenter,this.m_lcD=this.m_bodyD.m_sweep.localCenter,this.m_mA=this.m_bodyA.m_invMass,this.m_mB=this.m_bodyB.m_invMass,this.m_mC=this.m_bodyC.m_invMass,this.m_mD=this.m_bodyD.m_invMass,this.m_iA=this.m_bodyA.m_invI,this.m_iB=this.m_bodyB.m_invI,this.m_iC=this.m_bodyC.m_invI,this.m_iD=this.m_bodyD.m_invI;var i=this.m_bodyA.c_position.a,s=this.m_bodyA.c_velocity.v,o=this.m_bodyA.c_velocity.w,n=this.m_bodyB.c_position.a,a=this.m_bodyB.c_velocity.v,h=this.m_bodyB.c_velocity.w,m=this.m_bodyC.c_position.a,c=this.m_bodyC.c_velocity.v,_=this.m_bodyC.c_velocity.w,d=this.m_bodyD.c_position.a,u=this.m_bodyD.c_velocity.v,f=this.m_bodyD.c_velocity.w,p=B.neo(i),v=B.neo(n),y=B.neo(m),x=B.neo(d);if(this.m_mass=0,this.m_type1==ze.TYPE)this.m_JvAC=l.zero(),this.m_JwA=1,this.m_JwC=1,this.m_mass+=this.m_iA+this.m_iC;else{var A=B.mulVec2(y,this.m_localAxisC),w=B.mulSub(y,this.m_localAnchorC,this.m_lcC),M=B.mulSub(p,this.m_localAnchorA,this.m_lcA);this.m_JvAC=A,this.m_JwC=l.crossVec2Vec2(w,A),this.m_JwA=l.crossVec2Vec2(M,A),this.m_mass+=this.m_mC+this.m_mA+this.m_iC*this.m_JwC*this.m_JwC+this.m_iA*this.m_JwA*this.m_JwA}if(this.m_type2==ze.TYPE)this.m_JvBD=l.zero(),this.m_JwB=this.m_ratio,this.m_JwD=this.m_ratio,this.m_mass+=this.m_ratio*this.m_ratio*(this.m_iB+this.m_iD);else{var A=B.mulVec2(x,this.m_localAxisD),S=B.mulSub(x,this.m_localAnchorD,this.m_lcD),C=B.mulSub(v,this.m_localAnchorB,this.m_lcB);this.m_JvBD=l.mulNumVec2(this.m_ratio,A),this.m_JwD=this.m_ratio*l.crossVec2Vec2(S,A),this.m_JwB=this.m_ratio*l.crossVec2Vec2(C,A),this.m_mass+=this.m_ratio*this.m_ratio*(this.m_mD+this.m_mB)+this.m_iD*this.m_JwD*this.m_JwD+this.m_iB*this.m_JwB*this.m_JwB}this.m_mass=this.m_mass>0?1/this.m_mass:0,e.warmStarting?(s.addMul(this.m_mA*this.m_impulse,this.m_JvAC),o+=this.m_iA*this.m_impulse*this.m_JwA,a.addMul(this.m_mB*this.m_impulse,this.m_JvBD),h+=this.m_iB*this.m_impulse*this.m_JwB,c.subMul(this.m_mC*this.m_impulse,this.m_JvAC),_-=this.m_iC*this.m_impulse*this.m_JwC,u.subMul(this.m_mD*this.m_impulse,this.m_JvBD),f-=this.m_iD*this.m_impulse*this.m_JwD):this.m_impulse=0,this.m_bodyA.c_velocity.v.setVec2(s),this.m_bodyA.c_velocity.w=o,this.m_bodyB.c_velocity.v.setVec2(a),this.m_bodyB.c_velocity.w=h,this.m_bodyC.c_velocity.v.setVec2(c),this.m_bodyC.c_velocity.w=_,this.m_bodyD.c_velocity.v.setVec2(u),this.m_bodyD.c_velocity.w=f},t.prototype.solveVelocityConstraints=function(e){var i=this.m_bodyA.c_velocity.v,s=this.m_bodyA.c_velocity.w,o=this.m_bodyB.c_velocity.v,n=this.m_bodyB.c_velocity.w,a=this.m_bodyC.c_velocity.v,h=this.m_bodyC.c_velocity.w,m=this.m_bodyD.c_velocity.v,c=this.m_bodyD.c_velocity.w,_=l.dot(this.m_JvAC,i)-l.dot(this.m_JvAC,a)+l.dot(this.m_JvBD,o)-l.dot(this.m_JvBD,m);_+=this.m_JwA*s-this.m_JwC*h+(this.m_JwB*n-this.m_JwD*c);var d=-this.m_mass*_;this.m_impulse+=d,i.addMul(this.m_mA*d,this.m_JvAC),s+=this.m_iA*d*this.m_JwA,o.addMul(this.m_mB*d,this.m_JvBD),n+=this.m_iB*d*this.m_JwB,a.subMul(this.m_mC*d,this.m_JvAC),h-=this.m_iC*d*this.m_JwC,m.subMul(this.m_mD*d,this.m_JvBD),c-=this.m_iD*d*this.m_JwD,this.m_bodyA.c_velocity.v.setVec2(i),this.m_bodyA.c_velocity.w=s,this.m_bodyB.c_velocity.v.setVec2(o),this.m_bodyB.c_velocity.w=n,this.m_bodyC.c_velocity.v.setVec2(a),this.m_bodyC.c_velocity.w=h,this.m_bodyD.c_velocity.v.setVec2(m),this.m_bodyD.c_velocity.w=c},t.prototype.solvePositionConstraints=function(e){var i=this.m_bodyA.c_position.c,s=this.m_bodyA.c_position.a,o=this.m_bodyB.c_position.c,n=this.m_bodyB.c_position.a,a=this.m_bodyC.c_position.c,h=this.m_bodyC.c_position.a,m=this.m_bodyD.c_position.c,c=this.m_bodyD.c_position.a,_=B.neo(s),d=B.neo(n),u=B.neo(h),f=B.neo(c),p=0,v,y,x,A,w,M,S,C,V=0;if(this.m_type1==ze.TYPE)x=l.zero(),w=1,S=1,V+=this.m_iA+this.m_iC,v=s-h-this.m_referenceAngleA;else{var H=B.mulVec2(u,this.m_localAxisC),E=B.mulSub(u,this.m_localAnchorC,this.m_lcC),q=B.mulSub(_,this.m_localAnchorA,this.m_lcA);x=H,S=l.crossVec2Vec2(E,H),w=l.crossVec2Vec2(q,H),V+=this.m_mC+this.m_mA+this.m_iC*S*S+this.m_iA*w*w;var j=l.sub(this.m_localAnchorC,this.m_lcC),W=B.mulTVec2(u,l.add(q,l.sub(i,a)));v=l.dot(l.sub(W,j),this.m_localAxisC)}if(this.m_type2==ze.TYPE)A=l.zero(),M=this.m_ratio,C=this.m_ratio,V+=this.m_ratio*this.m_ratio*(this.m_iB+this.m_iD),y=n-c-this.m_referenceAngleB;else{var H=B.mulVec2(f,this.m_localAxisD),Y=B.mulSub(f,this.m_localAnchorD,this.m_lcD),Tt=B.mulSub(d,this.m_localAnchorB,this.m_lcB);A=l.mulNumVec2(this.m_ratio,H),C=this.m_ratio*l.crossVec2Vec2(Y,H),M=this.m_ratio*l.crossVec2Vec2(Tt,H),V+=this.m_ratio*this.m_ratio*(this.m_mD+this.m_mB)+this.m_iD*C*C+this.m_iB*M*M;var dt=l.sub(this.m_localAnchorD,this.m_lcD),Yt=B.mulTVec2(f,l.add(Tt,l.sub(o,m)));y=l.dot(Yt,this.m_localAxisD)-l.dot(dt,this.m_localAxisD)}var Mt=v+this.m_ratio*y-this.m_constant,et=0;return V>0&&(et=-Mt/V),i.addMul(this.m_mA*et,x),s+=this.m_iA*et*w,o.addMul(this.m_mB*et,A),n+=this.m_iB*et*M,a.subMul(this.m_mC*et,x),h-=this.m_iC*et*S,m.subMul(this.m_mD*et,A),c-=this.m_iD*et*C,this.m_bodyA.c_position.c.setVec2(i),this.m_bodyA.c_position.a=s,this.m_bodyB.c_position.c.setVec2(o),this.m_bodyB.c_position.a=n,this.m_bodyC.c_position.c.setVec2(a),this.m_bodyC.c_position.a=h,this.m_bodyD.c_position.c.setVec2(m),this.m_bodyD.c_position.a=c,p<P.linearSlop},t.TYPE="gear-joint",t})(xt),Hn={maxForce:1,maxTorque:1,correctionFactor:.3},Gr=(function(r){At(t,r);function t(e,i,s){var o=this;return o instanceof t?(e=Et(e,Hn),o=r.call(this,e,i,s)||this,i=o.m_bodyA,s=o.m_bodyB,o.m_type=t.TYPE,o.m_linearOffset=l.isValid(e.linearOffset)?l.clone(e.linearOffset):i.getLocalPoint(s.getPosition()),o.m_angularOffset=Number.isFinite(e.angularOffset)?e.angularOffset:s.getAngle()-i.getAngle(),o.m_linearImpulse=l.zero(),o.m_angularImpulse=0,o.m_maxForce=e.maxForce,o.m_maxTorque=e.maxTorque,o.m_correctionFactor=e.correctionFactor,o):new t(e,i,s)}return t.prototype._serialize=function(){return{type:this.m_type,bodyA:this.m_bodyA,bodyB:this.m_bodyB,collideConnected:this.m_collideConnected,maxForce:this.m_maxForce,maxTorque:this.m_maxTorque,correctionFactor:this.m_correctionFactor,linearOffset:this.m_linearOffset,angularOffset:this.m_angularOffset}},t._deserialize=function(e,i,s){e=bt({},e),e.bodyA=s($,e.bodyA,i),e.bodyB=s($,e.bodyB,i);var o=new t(e);return o},t.prototype._reset=function(e){Number.isFinite(e.angularOffset)&&(this.m_angularOffset=e.angularOffset),Number.isFinite(e.maxForce)&&(this.m_maxForce=e.maxForce),Number.isFinite(e.maxTorque)&&(this.m_maxTorque=e.maxTorque),Number.isFinite(e.correctionFactor)&&(this.m_correctionFactor=e.correctionFactor),l.isValid(e.linearOffset)&&this.m_linearOffset.set(e.linearOffset)},t.prototype.setMaxForce=function(e){this.m_maxForce=e},t.prototype.getMaxForce=function(){return this.m_maxForce},t.prototype.setMaxTorque=function(e){this.m_maxTorque=e},t.prototype.getMaxTorque=function(){return this.m_maxTorque},t.prototype.setCorrectionFactor=function(e){this.m_correctionFactor=e},t.prototype.getCorrectionFactor=function(){return this.m_correctionFactor},t.prototype.setLinearOffset=function(e){(e.x!=this.m_linearOffset.x||e.y!=this.m_linearOffset.y)&&(this.m_bodyA.setAwake(!0),this.m_bodyB.setAwake(!0),this.m_linearOffset.set(e))},t.prototype.getLinearOffset=function(){return this.m_linearOffset},t.prototype.setAngularOffset=function(e){e!=this.m_angularOffset&&(this.m_bodyA.setAwake(!0),this.m_bodyB.setAwake(!0),this.m_angularOffset=e)},t.prototype.getAngularOffset=function(){return this.m_angularOffset},t.prototype.getAnchorA=function(){return this.m_bodyA.getPosition()},t.prototype.getAnchorB=function(){return this.m_bodyB.getPosition()},t.prototype.getReactionForce=function(e){return l.mulNumVec2(e,this.m_linearImpulse)},t.prototype.getReactionTorque=function(e){return e*this.m_angularImpulse},t.prototype.initVelocityConstraints=function(e){this.m_localCenterA=this.m_bodyA.m_sweep.localCenter,this.m_localCenterB=this.m_bodyB.m_sweep.localCenter,this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var i=this.m_bodyA.c_position.c,s=this.m_bodyA.c_position.a,o=this.m_bodyA.c_velocity.v,n=this.m_bodyA.c_velocity.w,a=this.m_bodyB.c_position.c,h=this.m_bodyB.c_position.a,m=this.m_bodyB.c_velocity.v,c=this.m_bodyB.c_velocity.w,_=B.neo(s),d=B.neo(h);this.m_rA=B.mulVec2(_,l.sub(this.m_linearOffset,this.m_localCenterA)),this.m_rB=B.mulVec2(d,l.neg(this.m_localCenterB));var u=this.m_invMassA,f=this.m_invMassB,p=this.m_invIA,v=this.m_invIB,y=new re;if(y.ex.x=u+f+p*this.m_rA.y*this.m_rA.y+v*this.m_rB.y*this.m_rB.y,y.ex.y=-p*this.m_rA.x*this.m_rA.y-v*this.m_rB.x*this.m_rB.y,y.ey.x=y.ex.y,y.ey.y=u+f+p*this.m_rA.x*this.m_rA.x+v*this.m_rB.x*this.m_rB.x,this.m_linearMass=y.getInverse(),this.m_angularMass=p+v,this.m_angularMass>0&&(this.m_angularMass=1/this.m_angularMass),this.m_linearError=l.zero(),this.m_linearError.addCombine(1,a,1,this.m_rB),this.m_linearError.subCombine(1,i,1,this.m_rA),this.m_angularError=h-s-this.m_angularOffset,e.warmStarting){this.m_linearImpulse.mul(e.dtRatio),this.m_angularImpulse*=e.dtRatio;var x=l.neo(this.m_linearImpulse.x,this.m_linearImpulse.y);o.subMul(u,x),n-=p*(l.crossVec2Vec2(this.m_rA,x)+this.m_angularImpulse),m.addMul(f,x),c+=v*(l.crossVec2Vec2(this.m_rB,x)+this.m_angularImpulse)}else this.m_linearImpulse.setZero(),this.m_angularImpulse=0;this.m_bodyA.c_velocity.v=o,this.m_bodyA.c_velocity.w=n,this.m_bodyB.c_velocity.v=m,this.m_bodyB.c_velocity.w=c},t.prototype.solveVelocityConstraints=function(e){var i=this.m_bodyA.c_velocity.v,s=this.m_bodyA.c_velocity.w,o=this.m_bodyB.c_velocity.v,n=this.m_bodyB.c_velocity.w,a=this.m_invMassA,h=this.m_invMassB,m=this.m_invIA,c=this.m_invIB,_=e.dt,d=e.inv_dt;{var u=n-s+d*this.m_correctionFactor*this.m_angularError,f=-this.m_angularMass*u,p=this.m_angularImpulse,v=_*this.m_maxTorque;this.m_angularImpulse=yt(this.m_angularImpulse+f,-v,v),f=this.m_angularImpulse-p,s-=m*f,n+=c*f}{var u=l.zero();u.addCombine(1,o,1,l.crossNumVec2(n,this.m_rB)),u.subCombine(1,i,1,l.crossNumVec2(s,this.m_rA)),u.addMul(d*this.m_correctionFactor,this.m_linearError);var f=l.neg(re.mulVec2(this.m_linearMass,u)),p=l.clone(this.m_linearImpulse);this.m_linearImpulse.add(f);var v=_*this.m_maxForce;this.m_linearImpulse.clamp(v),f=l.sub(this.m_linearImpulse,p),i.subMul(a,f),s-=m*l.crossVec2Vec2(this.m_rA,f),o.addMul(h,f),n+=c*l.crossVec2Vec2(this.m_rB,f)}this.m_bodyA.c_velocity.v=i,this.m_bodyA.c_velocity.w=s,this.m_bodyB.c_velocity.v=o,this.m_bodyB.c_velocity.w=n},t.prototype.solvePositionConstraints=function(e){return!0},t.TYPE="motor-joint",t})(xt),Dn=Math.PI,En={maxForce:0,frequencyHz:5,dampingRatio:.7},Wr=(function(r){At(t,r);function t(e,i,s,o){var n=this;return n instanceof t?(e=Et(e,En),n=r.call(this,e,i,s)||this,i=n.m_bodyA,s=n.m_bodyB,n.m_type=t.TYPE,l.isValid(o)?n.m_targetA=l.clone(o):l.isValid(e.target)?n.m_targetA=l.clone(e.target):n.m_targetA=l.zero(),n.m_localAnchorB=se.mulTVec2(s.getTransform(),n.m_targetA),n.m_maxForce=e.maxForce,n.m_impulse=l.zero(),n.m_frequencyHz=e.frequencyHz,n.m_dampingRatio=e.dampingRatio,n.m_beta=0,n.m_gamma=0,n.m_rB=l.zero(),n.m_localCenterB=l.zero(),n.m_invMassB=0,n.m_invIB=0,n.m_mass=new re,n.m_C=l.zero(),n):new t(e,i,s,o)}return t.prototype._serialize=function(){return{type:this.m_type,bodyA:this.m_bodyA,bodyB:this.m_bodyB,collideConnected:this.m_collideConnected,target:this.m_targetA,maxForce:this.m_maxForce,frequencyHz:this.m_frequencyHz,dampingRatio:this.m_dampingRatio,_localAnchorB:this.m_localAnchorB}},t._deserialize=function(e,i,s){e=bt({},e),e.bodyA=s($,e.bodyA,i),e.bodyB=s($,e.bodyB,i),e.target=l.clone(e.target);var o=new t(e);return e._localAnchorB&&(o.m_localAnchorB=e._localAnchorB),o},t.prototype._reset=function(e){Number.isFinite(e.maxForce)&&(this.m_maxForce=e.maxForce),Number.isFinite(e.frequencyHz)&&(this.m_frequencyHz=e.frequencyHz),Number.isFinite(e.dampingRatio)&&(this.m_dampingRatio=e.dampingRatio)},t.prototype.setTarget=function(e){l.areEqual(e,this.m_targetA)||(this.m_bodyB.setAwake(!0),this.m_targetA.set(e))},t.prototype.getTarget=function(){return this.m_targetA},t.prototype.setMaxForce=function(e){this.m_maxForce=e},t.prototype.getMaxForce=function(){return this.m_maxForce},t.prototype.setFrequency=function(e){this.m_frequencyHz=e},t.prototype.getFrequency=function(){return this.m_frequencyHz},t.prototype.setDampingRatio=function(e){this.m_dampingRatio=e},t.prototype.getDampingRatio=function(){return this.m_dampingRatio},t.prototype.getAnchorA=function(){return l.clone(this.m_targetA)},t.prototype.getAnchorB=function(){return this.m_bodyB.getWorldPoint(this.m_localAnchorB)},t.prototype.getReactionForce=function(e){return l.mulNumVec2(e,this.m_impulse)},t.prototype.getReactionTorque=function(e){return e*0},t.prototype.shiftOrigin=function(e){this.m_targetA.sub(e)},t.prototype.initVelocityConstraints=function(e){this.m_localCenterB=this.m_bodyB.m_sweep.localCenter,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIB=this.m_bodyB.m_invI;var i=this.m_bodyB.c_position,s=this.m_bodyB.c_velocity,o=i.c,n=i.a,a=s.v,h=s.w,m=B.neo(n),c=this.m_bodyB.getMass(),_=2*Dn*this.m_frequencyHz,d=2*c*this.m_dampingRatio*_,u=c*(_*_),f=e.dt;this.m_gamma=f*(d+f*u),this.m_gamma!=0&&(this.m_gamma=1/this.m_gamma),this.m_beta=f*u*this.m_gamma,this.m_rB=B.mulVec2(m,l.sub(this.m_localAnchorB,this.m_localCenterB));var p=new re;p.ex.x=this.m_invMassB+this.m_invIB*this.m_rB.y*this.m_rB.y+this.m_gamma,p.ex.y=-this.m_invIB*this.m_rB.x*this.m_rB.y,p.ey.x=p.ex.y,p.ey.y=this.m_invMassB+this.m_invIB*this.m_rB.x*this.m_rB.x+this.m_gamma,this.m_mass=p.getInverse(),this.m_C.setVec2(o),this.m_C.addCombine(1,this.m_rB,-1,this.m_targetA),this.m_C.mul(this.m_beta),h*=.98,e.warmStarting?(this.m_impulse.mul(e.dtRatio),a.addMul(this.m_invMassB,this.m_impulse),h+=this.m_invIB*l.crossVec2Vec2(this.m_rB,this.m_impulse)):this.m_impulse.setZero(),s.v.setVec2(a),s.w=h},t.prototype.solveVelocityConstraints=function(e){var i=this.m_bodyB.c_velocity,s=l.clone(i.v),o=i.w,n=l.crossNumVec2(o,this.m_rB);n.add(s),n.addCombine(1,this.m_C,this.m_gamma,this.m_impulse),n.neg();var a=re.mulVec2(this.m_mass,n),h=l.clone(this.m_impulse);this.m_impulse.add(a);var m=e.dt*this.m_maxForce;this.m_impulse.clamp(m),a=l.sub(this.m_impulse,h),s.addMul(this.m_invMassB,a),o+=this.m_invIB*l.crossVec2Vec2(this.m_rB,a),i.v.setVec2(s),i.w=o},t.prototype.solvePositionConstraints=function(e){return!0},t.TYPE="mouse-joint",t})(xt),qn=Math.abs,Rn={collideConnected:!0},$r=(function(r){At(t,r);function t(e,i,s,o,n,a,h,m){var c=this;return c instanceof t?(e=Et(e,Rn),c=r.call(this,e,i,s)||this,i=c.m_bodyA,s=c.m_bodyB,c.m_type=t.TYPE,c.m_groundAnchorA=l.clone(o||e.groundAnchorA||l.neo(-1,1)),c.m_groundAnchorB=l.clone(n||e.groundAnchorB||l.neo(1,1)),c.m_localAnchorA=l.clone(a?i.getLocalPoint(a):e.localAnchorA||l.neo(-1,0)),c.m_localAnchorB=l.clone(h?s.getLocalPoint(h):e.localAnchorB||l.neo(1,0)),c.m_lengthA=Number.isFinite(e.lengthA)?e.lengthA:l.distance(a,o),c.m_lengthB=Number.isFinite(e.lengthB)?e.lengthB:l.distance(h,n),c.m_ratio=Number.isFinite(m)?m:e.ratio,c.m_constant=c.m_lengthA+c.m_ratio*c.m_lengthB,c.m_impulse=0,c):new t(e,i,s,o,n,a,h,m)}return t.prototype._serialize=function(){return{type:this.m_type,bodyA:this.m_bodyA,bodyB:this.m_bodyB,collideConnected:this.m_collideConnected,groundAnchorA:this.m_groundAnchorA,groundAnchorB:this.m_groundAnchorB,localAnchorA:this.m_localAnchorA,localAnchorB:this.m_localAnchorB,lengthA:this.m_lengthA,lengthB:this.m_lengthB,ratio:this.m_ratio}},t._deserialize=function(e,i,s){e=bt({},e),e.bodyA=s($,e.bodyA,i),e.bodyB=s($,e.bodyB,i);var o=new t(e);return o},t.prototype._reset=function(e){l.isValid(e.groundAnchorA)&&this.m_groundAnchorA.set(e.groundAnchorA),l.isValid(e.groundAnchorB)&&this.m_groundAnchorB.set(e.groundAnchorB),l.isValid(e.localAnchorA)?this.m_localAnchorA.set(e.localAnchorA):l.isValid(e.anchorA)&&this.m_localAnchorA.set(this.m_bodyA.getLocalPoint(e.anchorA)),l.isValid(e.localAnchorB)?this.m_localAnchorB.set(e.localAnchorB):l.isValid(e.anchorB)&&this.m_localAnchorB.set(this.m_bodyB.getLocalPoint(e.anchorB)),Number.isFinite(e.lengthA)&&(this.m_lengthA=e.lengthA),Number.isFinite(e.lengthB)&&(this.m_lengthB=e.lengthB),Number.isFinite(e.ratio)&&(this.m_ratio=e.ratio)},t.prototype.getGroundAnchorA=function(){return this.m_groundAnchorA},t.prototype.getGroundAnchorB=function(){return this.m_groundAnchorB},t.prototype.getLengthA=function(){return this.m_lengthA},t.prototype.getLengthB=function(){return this.m_lengthB},t.prototype.getRatio=function(){return this.m_ratio},t.prototype.getCurrentLengthA=function(){var e=this.m_bodyA.getWorldPoint(this.m_localAnchorA),i=this.m_groundAnchorA;return l.distance(e,i)},t.prototype.getCurrentLengthB=function(){var e=this.m_bodyB.getWorldPoint(this.m_localAnchorB),i=this.m_groundAnchorB;return l.distance(e,i)},t.prototype.shiftOrigin=function(e){this.m_groundAnchorA.sub(e),this.m_groundAnchorB.sub(e)},t.prototype.getAnchorA=function(){return this.m_bodyA.getWorldPoint(this.m_localAnchorA)},t.prototype.getAnchorB=function(){return this.m_bodyB.getWorldPoint(this.m_localAnchorB)},t.prototype.getReactionForce=function(e){return l.mulNumVec2(this.m_impulse,this.m_uB).mul(e)},t.prototype.getReactionTorque=function(e){return 0},t.prototype.initVelocityConstraints=function(e){this.m_localCenterA=this.m_bodyA.m_sweep.localCenter,this.m_localCenterB=this.m_bodyB.m_sweep.localCenter,this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var i=this.m_bodyA.c_position.c,s=this.m_bodyA.c_position.a,o=this.m_bodyA.c_velocity.v,n=this.m_bodyA.c_velocity.w,a=this.m_bodyB.c_position.c,h=this.m_bodyB.c_position.a,m=this.m_bodyB.c_velocity.v,c=this.m_bodyB.c_velocity.w,_=B.neo(s),d=B.neo(h);this.m_rA=B.mulVec2(_,l.sub(this.m_localAnchorA,this.m_localCenterA)),this.m_rB=B.mulVec2(d,l.sub(this.m_localAnchorB,this.m_localCenterB)),this.m_uA=l.sub(l.add(i,this.m_rA),this.m_groundAnchorA),this.m_uB=l.sub(l.add(a,this.m_rB),this.m_groundAnchorB);var u=this.m_uA.length(),f=this.m_uB.length();u>10*P.linearSlop?this.m_uA.mul(1/u):this.m_uA.setZero(),f>10*P.linearSlop?this.m_uB.mul(1/f):this.m_uB.setZero();var p=l.crossVec2Vec2(this.m_rA,this.m_uA),v=l.crossVec2Vec2(this.m_rB,this.m_uB),y=this.m_invMassA+this.m_invIA*p*p,x=this.m_invMassB+this.m_invIB*v*v;if(this.m_mass=y+this.m_ratio*this.m_ratio*x,this.m_mass>0&&(this.m_mass=1/this.m_mass),e.warmStarting){this.m_impulse*=e.dtRatio;var A=l.mulNumVec2(-this.m_impulse,this.m_uA),w=l.mulNumVec2(-this.m_ratio*this.m_impulse,this.m_uB);o.addMul(this.m_invMassA,A),n+=this.m_invIA*l.crossVec2Vec2(this.m_rA,A),m.addMul(this.m_invMassB,w),c+=this.m_invIB*l.crossVec2Vec2(this.m_rB,w)}else this.m_impulse=0;this.m_bodyA.c_velocity.v=o,this.m_bodyA.c_velocity.w=n,this.m_bodyB.c_velocity.v=m,this.m_bodyB.c_velocity.w=c},t.prototype.solveVelocityConstraints=function(e){var i=this.m_bodyA.c_velocity.v,s=this.m_bodyA.c_velocity.w,o=this.m_bodyB.c_velocity.v,n=this.m_bodyB.c_velocity.w,a=l.add(i,l.crossNumVec2(s,this.m_rA)),h=l.add(o,l.crossNumVec2(n,this.m_rB)),m=-l.dot(this.m_uA,a)-this.m_ratio*l.dot(this.m_uB,h),c=-this.m_mass*m;this.m_impulse+=c;var _=l.mulNumVec2(-c,this.m_uA),d=l.mulNumVec2(-this.m_ratio*c,this.m_uB);i.addMul(this.m_invMassA,_),s+=this.m_invIA*l.crossVec2Vec2(this.m_rA,_),o.addMul(this.m_invMassB,d),n+=this.m_invIB*l.crossVec2Vec2(this.m_rB,d),this.m_bodyA.c_velocity.v=i,this.m_bodyA.c_velocity.w=s,this.m_bodyB.c_velocity.v=o,this.m_bodyB.c_velocity.w=n},t.prototype.solvePositionConstraints=function(e){var i=this.m_bodyA.c_position.c,s=this.m_bodyA.c_position.a,o=this.m_bodyB.c_position.c,n=this.m_bodyB.c_position.a,a=B.neo(s),h=B.neo(n),m=B.mulVec2(a,l.sub(this.m_localAnchorA,this.m_localCenterA)),c=B.mulVec2(h,l.sub(this.m_localAnchorB,this.m_localCenterB)),_=l.sub(l.add(i,this.m_rA),this.m_groundAnchorA),d=l.sub(l.add(o,this.m_rB),this.m_groundAnchorB),u=_.length(),f=d.length();u>10*P.linearSlop?_.mul(1/u):_.setZero(),f>10*P.linearSlop?d.mul(1/f):d.setZero();var p=l.crossVec2Vec2(m,_),v=l.crossVec2Vec2(c,d),y=this.m_invMassA+this.m_invIA*p*p,x=this.m_invMassB+this.m_invIB*v*v,A=y+this.m_ratio*this.m_ratio*x;A>0&&(A=1/A);var w=this.m_constant-u-this.m_ratio*f,M=qn(w),S=-A*w,C=l.mulNumVec2(-S,_),V=l.mulNumVec2(-this.m_ratio*S,d);return i.addMul(this.m_invMassA,C),s+=this.m_invIA*l.crossVec2Vec2(m,C),o.addMul(this.m_invMassB,V),n+=this.m_invIB*l.crossVec2Vec2(c,V),this.m_bodyA.c_position.c=i,this.m_bodyA.c_position.a=s,this.m_bodyB.c_position.c=o,this.m_bodyB.c_position.a=n,M<P.linearSlop},t.TYPE="pulley-joint",t})(xt),Nn=Math.min,Li;(function(r){r[r.inactiveLimit=0]="inactiveLimit",r[r.atLowerLimit=1]="atLowerLimit",r[r.atUpperLimit=2]="atUpperLimit",r[r.equalLimits=3]="equalLimits"})(Li||(Li={}));var On={maxLength:0},Xr=(function(r){At(t,r);function t(e,i,s,o){var n=this;return n instanceof t?(e=Et(e,On),n=r.call(this,e,i,s)||this,i=n.m_bodyA,s=n.m_bodyB,n.m_type=t.TYPE,n.m_localAnchorA=l.clone(o?i.getLocalPoint(o):e.localAnchorA||l.neo(-1,0)),n.m_localAnchorB=l.clone(o?s.getLocalPoint(o):e.localAnchorB||l.neo(1,0)),n.m_maxLength=e.maxLength,n.m_mass=0,n.m_impulse=0,n.m_length=0,n.m_state=Li.inactiveLimit,n):new t(e,i,s,o)}return t.prototype._serialize=function(){return{type:this.m_type,bodyA:this.m_bodyA,bodyB:this.m_bodyB,collideConnected:this.m_collideConnected,localAnchorA:this.m_localAnchorA,localAnchorB:this.m_localAnchorB,maxLength:this.m_maxLength}},t._deserialize=function(e,i,s){e=bt({},e),e.bodyA=s($,e.bodyA,i),e.bodyB=s($,e.bodyB,i);var o=new t(e);return o},t.prototype._reset=function(e){Number.isFinite(e.maxLength)&&(this.m_maxLength=e.maxLength)},t.prototype.getLocalAnchorA=function(){return this.m_localAnchorA},t.prototype.getLocalAnchorB=function(){return this.m_localAnchorB},t.prototype.setMaxLength=function(e){this.m_maxLength=e},t.prototype.getMaxLength=function(){return this.m_maxLength},t.prototype.getLimitState=function(){return this.m_state},t.prototype.getAnchorA=function(){return this.m_bodyA.getWorldPoint(this.m_localAnchorA)},t.prototype.getAnchorB=function(){return this.m_bodyB.getWorldPoint(this.m_localAnchorB)},t.prototype.getReactionForce=function(e){return l.mulNumVec2(this.m_impulse,this.m_u).mul(e)},t.prototype.getReactionTorque=function(e){return 0},t.prototype.initVelocityConstraints=function(e){this.m_localCenterA=this.m_bodyA.m_sweep.localCenter,this.m_localCenterB=this.m_bodyB.m_sweep.localCenter,this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var i=this.m_bodyA.c_position.c,s=this.m_bodyA.c_position.a,o=this.m_bodyA.c_velocity.v,n=this.m_bodyA.c_velocity.w,a=this.m_bodyB.c_position.c,h=this.m_bodyB.c_position.a,m=this.m_bodyB.c_velocity.v,c=this.m_bodyB.c_velocity.w,_=B.neo(s),d=B.neo(h);this.m_rA=B.mulSub(_,this.m_localAnchorA,this.m_localCenterA),this.m_rB=B.mulSub(d,this.m_localAnchorB,this.m_localCenterB),this.m_u=l.zero(),this.m_u.addCombine(1,a,1,this.m_rB),this.m_u.subCombine(1,i,1,this.m_rA),this.m_length=this.m_u.length();var u=this.m_length-this.m_maxLength;if(u>0?this.m_state=Li.atUpperLimit:this.m_state=Li.inactiveLimit,this.m_length>P.linearSlop)this.m_u.mul(1/this.m_length);else{this.m_u.setZero(),this.m_mass=0,this.m_impulse=0;return}var f=l.crossVec2Vec2(this.m_rA,this.m_u),p=l.crossVec2Vec2(this.m_rB,this.m_u),v=this.m_invMassA+this.m_invIA*f*f+this.m_invMassB+this.m_invIB*p*p;if(this.m_mass=v!=0?1/v:0,e.warmStarting){this.m_impulse*=e.dtRatio;var y=l.mulNumVec2(this.m_impulse,this.m_u);o.subMul(this.m_invMassA,y),n-=this.m_invIA*l.crossVec2Vec2(this.m_rA,y),m.addMul(this.m_invMassB,y),c+=this.m_invIB*l.crossVec2Vec2(this.m_rB,y)}else this.m_impulse=0;this.m_bodyA.c_velocity.v.setVec2(o),this.m_bodyA.c_velocity.w=n,this.m_bodyB.c_velocity.v.setVec2(m),this.m_bodyB.c_velocity.w=c},t.prototype.solveVelocityConstraints=function(e){var i=this.m_bodyA.c_velocity.v,s=this.m_bodyA.c_velocity.w,o=this.m_bodyB.c_velocity.v,n=this.m_bodyB.c_velocity.w,a=l.addCrossNumVec2(i,s,this.m_rA),h=l.addCrossNumVec2(o,n,this.m_rB),m=this.m_length-this.m_maxLength,c=l.dot(this.m_u,l.sub(h,a));m<0&&(c+=e.inv_dt*m);var _=-this.m_mass*c,d=this.m_impulse;this.m_impulse=Nn(0,this.m_impulse+_),_=this.m_impulse-d;var u=l.mulNumVec2(_,this.m_u);i.subMul(this.m_invMassA,u),s-=this.m_invIA*l.crossVec2Vec2(this.m_rA,u),o.addMul(this.m_invMassB,u),n+=this.m_invIB*l.crossVec2Vec2(this.m_rB,u),this.m_bodyA.c_velocity.v=i,this.m_bodyA.c_velocity.w=s,this.m_bodyB.c_velocity.v=o,this.m_bodyB.c_velocity.w=n},t.prototype.solvePositionConstraints=function(e){var i=this.m_bodyA.c_position.c,s=this.m_bodyA.c_position.a,o=this.m_bodyB.c_position.c,n=this.m_bodyB.c_position.a,a=B.neo(s),h=B.neo(n),m=B.mulSub(a,this.m_localAnchorA,this.m_localCenterA),c=B.mulSub(h,this.m_localAnchorB,this.m_localCenterB),_=l.zero();_.addCombine(1,o,1,c),_.subCombine(1,i,1,m);var d=_.normalize(),u=d-this.m_maxLength;u=yt(u,0,P.maxLinearCorrection);var f=-this.m_mass*u,p=l.mulNumVec2(f,_);return i.subMul(this.m_invMassA,p),s-=this.m_invIA*l.crossVec2Vec2(m,p),o.addMul(this.m_invMassB,p),n+=this.m_invIB*l.crossVec2Vec2(c,p),this.m_bodyA.c_position.c.setVec2(i),this.m_bodyA.c_position.a=s,this.m_bodyB.c_position.c.setVec2(o),this.m_bodyB.c_position.a=n,d-this.m_maxLength<P.linearSlop},t.TYPE="rope-joint",t})(xt),Un=Math.abs,jn=Math.PI,Gn={frequencyHz:0,dampingRatio:0},Yr=(function(r){At(t,r);function t(e,i,s,o){var n=this;return n instanceof t?(e=Et(e,Gn),n=r.call(this,e,i,s)||this,i=n.m_bodyA,s=n.m_bodyB,n.m_type=t.TYPE,n.m_localAnchorA=l.clone(o?i.getLocalPoint(o):e.localAnchorA||l.zero()),n.m_localAnchorB=l.clone(o?s.getLocalPoint(o):e.localAnchorB||l.zero()),n.m_referenceAngle=Number.isFinite(e.referenceAngle)?e.referenceAngle:s.getAngle()-i.getAngle(),n.m_frequencyHz=e.frequencyHz,n.m_dampingRatio=e.dampingRatio,n.m_impulse=new G,n.m_bias=0,n.m_gamma=0,n.m_mass=new ke,n):new t(e,i,s,o)}return t.prototype._serialize=function(){return{type:this.m_type,bodyA:this.m_bodyA,bodyB:this.m_bodyB,collideConnected:this.m_collideConnected,frequencyHz:this.m_frequencyHz,dampingRatio:this.m_dampingRatio,localAnchorA:this.m_localAnchorA,localAnchorB:this.m_localAnchorB,referenceAngle:this.m_referenceAngle}},t._deserialize=function(e,i,s){e=bt({},e),e.bodyA=s($,e.bodyA,i),e.bodyB=s($,e.bodyB,i);var o=new t(e);return o},t.prototype._reset=function(e){e.anchorA?this.m_localAnchorA.setVec2(this.m_bodyA.getLocalPoint(e.anchorA)):e.localAnchorA&&this.m_localAnchorA.setVec2(e.localAnchorA),e.anchorB?this.m_localAnchorB.setVec2(this.m_bodyB.getLocalPoint(e.anchorB)):e.localAnchorB&&this.m_localAnchorB.setVec2(e.localAnchorB),Number.isFinite(e.frequencyHz)&&(this.m_frequencyHz=e.frequencyHz),Number.isFinite(e.dampingRatio)&&(this.m_dampingRatio=e.dampingRatio)},t.prototype.getLocalAnchorA=function(){return this.m_localAnchorA},t.prototype.getLocalAnchorB=function(){return this.m_localAnchorB},t.prototype.getReferenceAngle=function(){return this.m_referenceAngle},t.prototype.setFrequency=function(e){this.m_frequencyHz=e},t.prototype.getFrequency=function(){return this.m_frequencyHz},t.prototype.setDampingRatio=function(e){this.m_dampingRatio=e},t.prototype.getDampingRatio=function(){return this.m_dampingRatio},t.prototype.getAnchorA=function(){return this.m_bodyA.getWorldPoint(this.m_localAnchorA)},t.prototype.getAnchorB=function(){return this.m_bodyB.getWorldPoint(this.m_localAnchorB)},t.prototype.getReactionForce=function(e){return l.neo(this.m_impulse.x,this.m_impulse.y).mul(e)},t.prototype.getReactionTorque=function(e){return e*this.m_impulse.z},t.prototype.initVelocityConstraints=function(e){this.m_localCenterA=this.m_bodyA.m_sweep.localCenter,this.m_localCenterB=this.m_bodyB.m_sweep.localCenter,this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var i=this.m_bodyA.c_position.a,s=this.m_bodyA.c_velocity.v,o=this.m_bodyA.c_velocity.w,n=this.m_bodyB.c_position.a,a=this.m_bodyB.c_velocity.v,h=this.m_bodyB.c_velocity.w,m=B.neo(i),c=B.neo(n);this.m_rA=B.mulVec2(m,l.sub(this.m_localAnchorA,this.m_localCenterA)),this.m_rB=B.mulVec2(c,l.sub(this.m_localAnchorB,this.m_localCenterB));var _=this.m_invMassA,d=this.m_invMassB,u=this.m_invIA,f=this.m_invIB,p=new ke;if(p.ex.x=_+d+this.m_rA.y*this.m_rA.y*u+this.m_rB.y*this.m_rB.y*f,p.ey.x=-this.m_rA.y*this.m_rA.x*u-this.m_rB.y*this.m_rB.x*f,p.ez.x=-this.m_rA.y*u-this.m_rB.y*f,p.ex.y=p.ey.x,p.ey.y=_+d+this.m_rA.x*this.m_rA.x*u+this.m_rB.x*this.m_rB.x*f,p.ez.y=this.m_rA.x*u+this.m_rB.x*f,p.ex.z=p.ez.x,p.ey.z=p.ez.y,p.ez.z=u+f,this.m_frequencyHz>0){p.getInverse22(this.m_mass);var v=u+f,y=v>0?1/v:0,x=n-i-this.m_referenceAngle,A=2*jn*this.m_frequencyHz,w=2*y*this.m_dampingRatio*A,M=y*A*A,S=e.dt;this.m_gamma=S*(w+S*M),this.m_gamma=this.m_gamma!=0?1/this.m_gamma:0,this.m_bias=x*S*M*this.m_gamma,v+=this.m_gamma,this.m_mass.ez.z=v!=0?1/v:0}else p.ez.z==0?(p.getInverse22(this.m_mass),this.m_gamma=0,this.m_bias=0):(p.getSymInverse33(this.m_mass),this.m_gamma=0,this.m_bias=0);if(e.warmStarting){this.m_impulse.mul(e.dtRatio);var C=l.neo(this.m_impulse.x,this.m_impulse.y);s.subMul(_,C),o-=u*(l.crossVec2Vec2(this.m_rA,C)+this.m_impulse.z),a.addMul(d,C),h+=f*(l.crossVec2Vec2(this.m_rB,C)+this.m_impulse.z)}else this.m_impulse.setZero();this.m_bodyA.c_velocity.v=s,this.m_bodyA.c_velocity.w=o,this.m_bodyB.c_velocity.v=a,this.m_bodyB.c_velocity.w=h},t.prototype.solveVelocityConstraints=function(e){var i=this.m_bodyA.c_velocity.v,s=this.m_bodyA.c_velocity.w,o=this.m_bodyB.c_velocity.v,n=this.m_bodyB.c_velocity.w,a=this.m_invMassA,h=this.m_invMassB,m=this.m_invIA,c=this.m_invIB;if(this.m_frequencyHz>0){var _=n-s,d=-this.m_mass.ez.z*(_+this.m_bias+this.m_gamma*this.m_impulse.z);this.m_impulse.z+=d,s-=m*d,n+=c*d;var u=l.zero();u.addCombine(1,o,1,l.crossNumVec2(n,this.m_rB)),u.subCombine(1,i,1,l.crossNumVec2(s,this.m_rA));var f=l.neg(ke.mulVec2(this.m_mass,u));this.m_impulse.x+=f.x,this.m_impulse.y+=f.y;var p=l.clone(f);i.subMul(a,p),s-=m*l.crossVec2Vec2(this.m_rA,p),o.addMul(h,p),n+=c*l.crossVec2Vec2(this.m_rB,p)}else{var u=l.zero();u.addCombine(1,o,1,l.crossNumVec2(n,this.m_rB)),u.subCombine(1,i,1,l.crossNumVec2(s,this.m_rA));var _=n-s,v=new G(u.x,u.y,_),y=G.neg(ke.mulVec3(this.m_mass,v));this.m_impulse.add(y);var p=l.neo(y.x,y.y);i.subMul(a,p),s-=m*(l.crossVec2Vec2(this.m_rA,p)+y.z),o.addMul(h,p),n+=c*(l.crossVec2Vec2(this.m_rB,p)+y.z)}this.m_bodyA.c_velocity.v=i,this.m_bodyA.c_velocity.w=s,this.m_bodyB.c_velocity.v=o,this.m_bodyB.c_velocity.w=n},t.prototype.solvePositionConstraints=function(e){var i=this.m_bodyA.c_position.c,s=this.m_bodyA.c_position.a,o=this.m_bodyB.c_position.c,n=this.m_bodyB.c_position.a,a=B.neo(s),h=B.neo(n),m=this.m_invMassA,c=this.m_invMassB,_=this.m_invIA,d=this.m_invIB,u=B.mulVec2(a,l.sub(this.m_localAnchorA,this.m_localCenterA)),f=B.mulVec2(h,l.sub(this.m_localAnchorB,this.m_localCenterB)),p,v,y=new ke;if(y.ex.x=m+c+u.y*u.y*_+f.y*f.y*d,y.ey.x=-u.y*u.x*_-f.y*f.x*d,y.ez.x=-u.y*_-f.y*d,y.ex.y=y.ey.x,y.ey.y=m+c+u.x*u.x*_+f.x*f.x*d,y.ez.y=u.x*_+f.x*d,y.ex.z=y.ez.x,y.ey.z=y.ez.y,y.ez.z=_+d,this.m_frequencyHz>0){var x=l.zero();x.addCombine(1,o,1,f),x.subCombine(1,i,1,u),p=x.length(),v=0;var A=l.neg(y.solve22(x));i.subMul(m,A),s-=_*l.crossVec2Vec2(u,A),o.addMul(c,A),n+=d*l.crossVec2Vec2(f,A)}else{var x=l.zero();x.addCombine(1,o,1,f),x.subCombine(1,i,1,u);var w=n-s-this.m_referenceAngle;p=x.length(),v=Un(w);var M=new G(x.x,x.y,w),S=new G;if(y.ez.z>0)S=G.neg(y.solve33(M));else{var C=l.neg(y.solve22(x));S.set(C.x,C.y,0)}var A=l.neo(S.x,S.y);i.subMul(m,A),s-=_*(l.crossVec2Vec2(u,A)+S.z),o.addMul(c,A),n+=d*(l.crossVec2Vec2(f,A)+S.z)}return this.m_bodyA.c_position.c=i,this.m_bodyA.c_position.a=s,this.m_bodyB.c_position.c=o,this.m_bodyB.c_position.a=n,p<=P.linearSlop&&v<=P.angularSlop},t.TYPE="weld-joint",t})(xt),Wn=Math.abs,$n=Math.PI,Xn={enableMotor:!1,maxMotorTorque:0,motorSpeed:0,frequencyHz:2,dampingRatio:.7},Jr=(function(r){At(t,r);function t(e,i,s,o,n){var a=this;return a instanceof t?(e=Et(e,Xn),a=r.call(this,e,i,s)||this,i=a.m_bodyA,s=a.m_bodyB,a.m_ax=l.zero(),a.m_ay=l.zero(),a.m_type=t.TYPE,a.m_localAnchorA=l.clone(o?i.getLocalPoint(o):e.localAnchorA||l.zero()),a.m_localAnchorB=l.clone(o?s.getLocalPoint(o):e.localAnchorB||l.zero()),l.isValid(n)?a.m_localXAxisA=i.getLocalVector(n):l.isValid(e.localAxisA)?a.m_localXAxisA=l.clone(e.localAxisA):l.isValid(e.localAxis)?a.m_localXAxisA=l.clone(e.localAxis):a.m_localXAxisA=l.neo(1,0),a.m_localYAxisA=l.crossNumVec2(1,a.m_localXAxisA),a.m_mass=0,a.m_impulse=0,a.m_motorMass=0,a.m_motorImpulse=0,a.m_springMass=0,a.m_springImpulse=0,a.m_maxMotorTorque=e.maxMotorTorque,a.m_motorSpeed=e.motorSpeed,a.m_enableMotor=e.enableMotor,a.m_frequencyHz=e.frequencyHz,a.m_dampingRatio=e.dampingRatio,a.m_bias=0,a.m_gamma=0,a):new t(e,i,s,o,n)}return t.prototype._serialize=function(){return{type:this.m_type,bodyA:this.m_bodyA,bodyB:this.m_bodyB,collideConnected:this.m_collideConnected,enableMotor:this.m_enableMotor,maxMotorTorque:this.m_maxMotorTorque,motorSpeed:this.m_motorSpeed,frequencyHz:this.m_frequencyHz,dampingRatio:this.m_dampingRatio,localAnchorA:this.m_localAnchorA,localAnchorB:this.m_localAnchorB,localAxisA:this.m_localXAxisA}},t._deserialize=function(e,i,s){e=bt({},e),e.bodyA=s($,e.bodyA,i),e.bodyB=s($,e.bodyB,i);var o=new t(e);return o},t.prototype._reset=function(e){e.anchorA?this.m_localAnchorA.setVec2(this.m_bodyA.getLocalPoint(e.anchorA)):e.localAnchorA&&this.m_localAnchorA.setVec2(e.localAnchorA),e.anchorB?this.m_localAnchorB.setVec2(this.m_bodyB.getLocalPoint(e.anchorB)):e.localAnchorB&&this.m_localAnchorB.setVec2(e.localAnchorB),e.localAxisA&&(this.m_localXAxisA.setVec2(e.localAxisA),this.m_localYAxisA.setVec2(l.crossNumVec2(1,e.localAxisA))),e.enableMotor!==void 0&&(this.m_enableMotor=e.enableMotor),Number.isFinite(e.maxMotorTorque)&&(this.m_maxMotorTorque=e.maxMotorTorque),Number.isFinite(e.motorSpeed)&&(this.m_motorSpeed=e.motorSpeed),Number.isFinite(e.frequencyHz)&&(this.m_frequencyHz=e.frequencyHz),Number.isFinite(e.dampingRatio)&&(this.m_dampingRatio=e.dampingRatio)},t.prototype.getLocalAnchorA=function(){return this.m_localAnchorA},t.prototype.getLocalAnchorB=function(){return this.m_localAnchorB},t.prototype.getLocalAxisA=function(){return this.m_localXAxisA},t.prototype.getJointTranslation=function(){var e=this.m_bodyA,i=this.m_bodyB,s=e.getWorldPoint(this.m_localAnchorA),o=i.getWorldPoint(this.m_localAnchorB),n=l.sub(o,s),a=e.getWorldVector(this.m_localXAxisA),h=l.dot(n,a);return h},t.prototype.getJointSpeed=function(){var e=this.m_bodyA.m_angularVelocity,i=this.m_bodyB.m_angularVelocity;return i-e},t.prototype.isMotorEnabled=function(){return this.m_enableMotor},t.prototype.enableMotor=function(e){e!=this.m_enableMotor&&(this.m_bodyA.setAwake(!0),this.m_bodyB.setAwake(!0),this.m_enableMotor=e)},t.prototype.setMotorSpeed=function(e){e!=this.m_motorSpeed&&(this.m_bodyA.setAwake(!0),this.m_bodyB.setAwake(!0),this.m_motorSpeed=e)},t.prototype.getMotorSpeed=function(){return this.m_motorSpeed},t.prototype.setMaxMotorTorque=function(e){e!=this.m_maxMotorTorque&&(this.m_bodyA.setAwake(!0),this.m_bodyB.setAwake(!0),this.m_maxMotorTorque=e)},t.prototype.getMaxMotorTorque=function(){return this.m_maxMotorTorque},t.prototype.getMotorTorque=function(e){return e*this.m_motorImpulse},t.prototype.setSpringFrequencyHz=function(e){this.m_frequencyHz=e},t.prototype.getSpringFrequencyHz=function(){return this.m_frequencyHz},t.prototype.setSpringDampingRatio=function(e){this.m_dampingRatio=e},t.prototype.getSpringDampingRatio=function(){return this.m_dampingRatio},t.prototype.getAnchorA=function(){return this.m_bodyA.getWorldPoint(this.m_localAnchorA)},t.prototype.getAnchorB=function(){return this.m_bodyB.getWorldPoint(this.m_localAnchorB)},t.prototype.getReactionForce=function(e){return l.combine(this.m_impulse,this.m_ay,this.m_springImpulse,this.m_ax).mul(e)},t.prototype.getReactionTorque=function(e){return e*this.m_motorImpulse},t.prototype.initVelocityConstraints=function(e){this.m_localCenterA=this.m_bodyA.m_sweep.localCenter,this.m_localCenterB=this.m_bodyB.m_sweep.localCenter,this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var i=this.m_invMassA,s=this.m_invMassB,o=this.m_invIA,n=this.m_invIB,a=this.m_bodyA.c_position.c,h=this.m_bodyA.c_position.a,m=this.m_bodyA.c_velocity.v,c=this.m_bodyA.c_velocity.w,_=this.m_bodyB.c_position.c,d=this.m_bodyB.c_position.a,u=this.m_bodyB.c_velocity.v,f=this.m_bodyB.c_velocity.w,p=B.neo(h),v=B.neo(d),y=B.mulVec2(p,l.sub(this.m_localAnchorA,this.m_localCenterA)),x=B.mulVec2(v,l.sub(this.m_localAnchorB,this.m_localCenterB)),A=l.zero();if(A.addCombine(1,_,1,x),A.subCombine(1,a,1,y),this.m_ay=B.mulVec2(p,this.m_localYAxisA),this.m_sAy=l.crossVec2Vec2(l.add(A,y),this.m_ay),this.m_sBy=l.crossVec2Vec2(x,this.m_ay),this.m_mass=i+s+o*this.m_sAy*this.m_sAy+n*this.m_sBy*this.m_sBy,this.m_mass>0&&(this.m_mass=1/this.m_mass),this.m_springMass=0,this.m_bias=0,this.m_gamma=0,this.m_frequencyHz>0){this.m_ax=B.mulVec2(p,this.m_localXAxisA),this.m_sAx=l.crossVec2Vec2(l.add(A,y),this.m_ax),this.m_sBx=l.crossVec2Vec2(x,this.m_ax);var w=i+s+o*this.m_sAx*this.m_sAx+n*this.m_sBx*this.m_sBx;if(w>0){this.m_springMass=1/w;var M=l.dot(A,this.m_ax),S=2*$n*this.m_frequencyHz,C=2*this.m_springMass*this.m_dampingRatio*S,V=this.m_springMass*S*S,H=e.dt;this.m_gamma=H*(C+H*V),this.m_gamma>0&&(this.m_gamma=1/this.m_gamma),this.m_bias=M*H*V*this.m_gamma,this.m_springMass=w+this.m_gamma,this.m_springMass>0&&(this.m_springMass=1/this.m_springMass)}}else this.m_springImpulse=0;if(this.m_enableMotor?(this.m_motorMass=o+n,this.m_motorMass>0&&(this.m_motorMass=1/this.m_motorMass)):(this.m_motorMass=0,this.m_motorImpulse=0),e.warmStarting){this.m_impulse*=e.dtRatio,this.m_springImpulse*=e.dtRatio,this.m_motorImpulse*=e.dtRatio;var E=l.combine(this.m_impulse,this.m_ay,this.m_springImpulse,this.m_ax),q=this.m_impulse*this.m_sAy+this.m_springImpulse*this.m_sAx+this.m_motorImpulse,j=this.m_impulse*this.m_sBy+this.m_springImpulse*this.m_sBx+this.m_motorImpulse;m.subMul(this.m_invMassA,E),c-=this.m_invIA*q,u.addMul(this.m_invMassB,E),f+=this.m_invIB*j}else this.m_impulse=0,this.m_springImpulse=0,this.m_motorImpulse=0;this.m_bodyA.c_velocity.v.setVec2(m),this.m_bodyA.c_velocity.w=c,this.m_bodyB.c_velocity.v.setVec2(u),this.m_bodyB.c_velocity.w=f},t.prototype.solveVelocityConstraints=function(e){var i=this.m_invMassA,s=this.m_invMassB,o=this.m_invIA,n=this.m_invIB,a=this.m_bodyA.c_velocity.v,h=this.m_bodyA.c_velocity.w,m=this.m_bodyB.c_velocity.v,c=this.m_bodyB.c_velocity.w;{var _=l.dot(this.m_ax,m)-l.dot(this.m_ax,a)+this.m_sBx*c-this.m_sAx*h,d=-this.m_springMass*(_+this.m_bias+this.m_gamma*this.m_springImpulse);this.m_springImpulse+=d;var u=l.mulNumVec2(d,this.m_ax),f=d*this.m_sAx,p=d*this.m_sBx;a.subMul(i,u),h-=o*f,m.addMul(s,u),c+=n*p}{var _=c-h-this.m_motorSpeed,d=-this.m_motorMass*_,v=this.m_motorImpulse,y=e.dt*this.m_maxMotorTorque;this.m_motorImpulse=yt(this.m_motorImpulse+d,-y,y),d=this.m_motorImpulse-v,h-=o*d,c+=n*d}{var _=l.dot(this.m_ay,m)-l.dot(this.m_ay,a)+this.m_sBy*c-this.m_sAy*h,d=-this.m_mass*_;this.m_impulse+=d;var u=l.mulNumVec2(d,this.m_ay),f=d*this.m_sAy,p=d*this.m_sBy;a.subMul(i,u),h-=o*f,m.addMul(s,u),c+=n*p}this.m_bodyA.c_velocity.v.setVec2(a),this.m_bodyA.c_velocity.w=h,this.m_bodyB.c_velocity.v.setVec2(m),this.m_bodyB.c_velocity.w=c},t.prototype.solvePositionConstraints=function(e){var i=this.m_bodyA.c_position.c,s=this.m_bodyA.c_position.a,o=this.m_bodyB.c_position.c,n=this.m_bodyB.c_position.a,a=B.neo(s),h=B.neo(n),m=B.mulVec2(a,l.sub(this.m_localAnchorA,this.m_localCenterA)),c=B.mulVec2(h,l.sub(this.m_localAnchorB,this.m_localCenterB)),_=l.zero();_.addCombine(1,o,1,c),_.subCombine(1,i,1,m);var d=B.mulVec2(a,this.m_localYAxisA),u=l.crossVec2Vec2(l.add(_,m),d),f=l.crossVec2Vec2(c,d),p=l.dot(_,d),v=this.m_invMassA+this.m_invMassB+this.m_invIA*this.m_sAy*this.m_sAy+this.m_invIB*this.m_sBy*this.m_sBy,y=v!=0?-p/v:0,x=l.mulNumVec2(y,d),A=y*u,w=y*f;return i.subMul(this.m_invMassA,x),s-=this.m_invIA*A,o.addMul(this.m_invMassB,x),n+=this.m_invIB*w,this.m_bodyA.c_position.c.setVec2(i),this.m_bodyA.c_position.a=s,this.m_bodyB.c_position.c.setVec2(o),this.m_bodyB.c_position.a=n,Wn(p)<=P.linearSlop},t.TYPE="wheel-joint",t})(xt),at,Yn=0,Kr={World:qi,Body:$,Joint:xt,Fixture:ps,Shape:ei},Zr={Vec2:l,Vec3:G,World:qi,Body:$,Joint:xt,Fixture:ps,Shape:ei},Jn=(at={},at[$.STATIC]=$,at[$.DYNAMIC]=$,at[$.KINEMATIC]=$,at[fs.TYPE]=fs,at[Be.TYPE]=Be,at[_e.TYPE]=_e,at[we.TYPE]=we,at[qr.TYPE]=qr,at[Rr.TYPE]=Rr,at[jr.TYPE]=jr,at[Gr.TYPE]=Gr,at[Wr.TYPE]=Wr,at[Ur.TYPE]=Ur,at[$r.TYPE]=$r,at[ze.TYPE]=ze,at[Xr.TYPE]=Xr,at[Yr.TYPE]=Yr,at[Jr.TYPE]=Jr,at),Kn={rootClass:qi,preSerialize:function(r){return r},postSerialize:function(r,t){return r},preDeserialize:function(r){return r},postDeserialize:function(r,t){return r}},Ks=(function(){function r(t){var e=this;this.toJson=function(i){var s=e.options.preSerialize,o=e.options.postSerialize,n=[],a=[i],h={};function m(f,p){if(f.__sid=f.__sid||++Yn,!h[f.__sid]){a.push(f);var v=n.length+a.length,y={refIndex:v,refType:p};h[f.__sid]=y}return h[f.__sid]}function c(f){f=s(f);var p=f._serialize();return p=o(p,f),p}function _(f,p){if(p===void 0&&(p=!1),typeof f!="object"||f===null)return f;if(typeof f._serialize=="function"){if(!p){for(var v in Kr)if(f instanceof Kr[v])return m(f,v)}f=c(f)}if(Array.isArray(f)){for(var y=[],x=0;x<f.length;x++)y[x]=_(f[x]);f=y}else{var y={};for(var x in f)f.hasOwnProperty(x)&&(y[x]=_(f[x]));f=y}return f}for(;a.length;){var d=a.shift(),u=_(d,!0);n.push(u)}return n},this.fromJson=function(i){var s=e.options.preDeserialize,o=e.options.postDeserialize,n=e.options.rootClass,a={};function h(_,d,u){(!_||!_._deserialize)&&(_=Jn[d.type]);var f=_&&_._deserialize;if(f){d=s(d);var p=_._deserialize,v=p(d,u,m);return v=o(v,d),v}}function m(_,d,u){var f=d.refIndex&&d.refType;if(!f)return h(_,d,u);var p=d;Zr[p.refType]&&(_=Zr[p.refType]);var v=p.refIndex;if(!a[v]){var y=i[v],x=h(_,y,u);a[v]=x}return a[v]}var c=h(n,i[0],null);return c},this.options=bt(bt({},Kn),t)}return r})(),Io=new Ks({rootClass:qi});Ks.fromJson=Io.fromJson;Ks.toJson=Io.toJson;(function(){function r(){}return r.mount=function(t){throw new Error("Not implemented")},r.start=function(t){var e=r.mount();return e.start(t),e},r})();var Zn=(function(r){At(t,r);function t(e,i,s,o){var n=this;return n instanceof t?(n=r.call(this)||this,n._setAsBox(e,i,s,o),n):new t(e,i,s,o)}return t.TYPE="polygon",t})(Be);de.addType(we.TYPE,we.TYPE,Qn);function Qn(r,t,e,i,s,o,n){ta(r,e.getShape(),t,o.getShape(),s)}var Qr=b(0,0),to=b(0,0),ta=function(r,t,e,i,s){r.pointCount=0,F(Qr,e,t.m_p),F(to,s,i.m_p);var o=Ke(to,Qr),n=t.m_radius,a=i.m_radius,h=n+a;o>h*h||(r.type=tt.e_circles,g(r.localPoint,t.m_p),T(r.localNormal),r.pointCount=1,g(r.points[0].localPoint,i.m_p),r.points[0].id.setFeatures(0,U.e_vertex,0,U.e_vertex))};de.addType(_e.TYPE,we.TYPE,ea);de.addType(fs.TYPE,we.TYPE,ia);function ea(r,t,e,i,s,o,n){var a=e.getShape(),h=o.getShape();Vo(r,a,t,h,s)}function ia(r,t,e,i,s,o,n){var a=e.getShape(),h=new _e;a.getChildEdge(h,i);var m=h,c=o.getShape();Vo(r,m,t,c,s)}var Ue=b(0,0),Ts=b(0,0),zs=b(0,0),be=b(0,0),je=b(0,0),di=b(0,0),Vo=function(r,t,e,i,s){r.pointCount=0,vo(be,s,e,i.m_p);var o=t.m_vertex1,n=t.m_vertex2;L(Ue,n,o);var a=I(Ue,n)-I(Ue,be),h=I(Ue,be)-I(Ue,o),m=t.m_radius+i.m_radius;if(h<=0){g(je,o);var c=Ke(be,o);if(c>m*m)return;if(t.m_hasVertex0){var _=t.m_vertex0,d=o;L(Ts,d,_);var u=I(Ts,d)-I(Ts,be);if(u>0)return}r.type=tt.e_circles,T(r.localNormal),g(r.localPoint,je),r.pointCount=1,g(r.points[0].localPoint,i.m_p),r.points[0].id.setFeatures(0,U.e_vertex,0,U.e_vertex);return}if(a<=0){g(je,n);var f=Ke(be,je);if(f>m*m)return;if(t.m_hasVertex3){var p=t.m_vertex3,v=n;L(zs,p,v);var y=I(zs,be)-I(zs,v);if(y>0)return}r.type=tt.e_circles,T(r.localNormal),g(r.localPoint,je),r.pointCount=1,g(r.points[0].localPoint,i.m_p),r.points[0].id.setFeatures(1,U.e_vertex,0,U.e_vertex);return}var x=Je(Ue);Z(je,a/x,o,h/x,n);var A=Ke(be,je);A>m*m||(Lt(di,1,Ue),I(di,be)-I(di,o)<0&&Hi(di),ie(di),r.type=tt.e_faceA,g(r.localNormal,di),g(r.localPoint,o),r.pointCount=1,g(r.points[0].localPoint,i.m_p),r.points[0].id.setFeatures(0,U.e_face,0,U.e_vertex))},as=[new Dt,new Dt],ls=[new Dt,new Dt],Ge=[new Dt,new Dt],hs=b(0,0),eo=b(0,0),ks=b(0,0),Fs=ti(0,0,0),We=b(0,0),_i=b(0,0),cs=b(0,0),io=b(0,0),so=b(0,0),Ve=b(0,0),Ls=b(0,0),ro=b(0,0);de.addType(Be.TYPE,Be.TYPE,sa);function sa(r,t,e,i,s,o,n){oa(r,e.getShape(),t,o.getShape(),s)}function oo(r,t,e,i,s){var o=r.m_count,n=e.m_count,a=r.m_normals,h=r.m_vertices,m=e.m_vertices;yo(Fs,i,t);for(var c=0,_=-1/0,d=0;d<o;++d){Xt(ks,Fs.q,a[d]),F(eo,Fs,h[d]);for(var u=1/0,f=0;f<n;++f){var p=I(ks,m[f])-I(ks,eo);p<u&&(u=p)}u>_&&(_=u,c=d)}s.maxSeparation=_,s.bestIndex=c}function ra(r,t,e,i,s,o){var n=t.m_normals,a=s.m_count,h=s.m_vertices,m=s.m_normals;rn(ro,o.q,e.q,n[i]);for(var c=0,_=1/0,d=0;d<a;++d){var u=I(ro,m[d]);u<_&&(_=u,c=d)}var f=c,p=f+1<a?f+1:0;F(r[0].v,o,h[f]),r[0].id.setFeatures(i,U.e_face,f,U.e_vertex),F(r[1].v,o,h[p]),r[1].id.setFeatures(i,U.e_face,p,U.e_vertex)}var pi={maxSeparation:0,bestIndex:0},oa=function(r,t,e,i,s){r.pointCount=0;var o=t.m_radius+i.m_radius;oo(t,e,i,s,pi);var n=pi.bestIndex,a=pi.maxSeparation;if(!(a>o)){oo(i,s,t,e,pi);var h=pi.bestIndex,m=pi.maxSeparation;if(!(m>o)){var c,_,d,u,f,p,v=.1*P.linearSlop;m>a+v?(c=i,_=t,d=s,u=e,f=h,r.type=tt.e_faceB,p=!0):(c=t,_=i,d=e,u=s,f=n,r.type=tt.e_faceA,p=!1),as[0].recycle(),as[1].recycle(),ra(as,c,d,f,_,u);var y=c.m_count,x=c.m_vertices,A=f,w=f+1<y?f+1:0;g(We,x[A]),g(_i,x[w]),L(cs,_i,We),ie(cs),Ye(io,cs,1),Z(so,.5,We,.5,_i),Xt(Ve,d.q,cs),Ye(Ls,Ve,1),F(We,d,We),F(_i,d,_i);var M=I(Ls,We),S=-I(Ve,We)+o,C=I(Ve,_i)+o;ls[0].recycle(),ls[1].recycle(),Ge[0].recycle(),Ge[1].recycle(),ft(hs,-Ve.x,-Ve.y);var V=Di(ls,as,hs,S,A);if(!(V<2)){ft(hs,Ve.x,Ve.y);var H=Di(Ge,ls,hs,C,w);if(!(H<2)){g(r.localNormal,io),g(r.localPoint,so);for(var E=0,q=0;q<Ge.length;++q){var j=I(Ls,Ge[q].v)-M;if(j<=o){var W=r.points[E];Gs(W.localPoint,u,Ge[q].v),W.id.set(Ge[q].id),p&&W.id.swapFeatures(),++E}}r.pointCount=E}}}}};de.addType(Be.TYPE,we.TYPE,na);function na(r,t,e,i,s,o,n){aa(r,e.getShape(),t,o.getShape(),s)}var Zt=b(0,0),Hs=b(0,0),aa=function(r,t,e,i,s){r.pointCount=0,vo(Zt,s,e,i.m_p);for(var o=0,n=-1/0,a=t.m_radius+i.m_radius,h=t.m_count,m=t.m_vertices,c=t.m_normals,_=0;_<h;++_){var d=I(c[_],Zt)-I(c[_],m[_]);if(d>a)return;d>n&&(n=d,o=_)}var u=o,f=u+1<h?u+1:0,p=m[u],v=m[f];if(n<wt){r.pointCount=1,r.type=tt.e_faceA,g(r.localNormal,c[o]),Z(r.localPoint,.5,p,.5,v),g(r.points[0].localPoint,i.m_p),r.points[0].id.setFeatures(0,U.e_vertex,0,U.e_vertex);return}var y=I(Zt,v)-I(Zt,p)-I(p,v)+I(p,p),x=I(Zt,p)-I(Zt,v)-I(v,p)+I(v,v);if(y<=0){if(Ke(Zt,p)>a*a)return;r.pointCount=1,r.type=tt.e_faceA,L(r.localNormal,Zt,p),ie(r.localNormal),g(r.localPoint,p),g(r.points[0].localPoint,i.m_p),r.points[0].id.setFeatures(0,U.e_vertex,0,U.e_vertex)}else if(x<=0){if(Ke(Zt,v)>a*a)return;r.pointCount=1,r.type=tt.e_faceA,L(r.localNormal,Zt,v),ie(r.localNormal),g(r.localPoint,v),g(r.points[0].localPoint,i.m_p),r.points[0].id.setFeatures(0,U.e_vertex,0,U.e_vertex)}else{Z(Hs,.5,p,.5,v);var A=I(Zt,c[u])-I(Hs,c[u]);if(A>a)return;r.pointCount=1,r.type=tt.e_faceA,g(r.localNormal,c[u]),g(r.localPoint,Hs),g(r.points[0].localPoint,i.m_p),r.points[0].id.setFeatures(0,U.e_vertex,0,U.e_vertex)}},la=Math.min;de.addType(_e.TYPE,Be.TYPE,ha);de.addType(fs.TYPE,Be.TYPE,ca);function ha(r,t,e,i,s,o,n){To(r,e.getShape(),t,o.getShape(),s)}var no=new _e;function ca(r,t,e,i,s,o,n){var a=e.getShape();a.getChildEdge(no,i),To(r,no,t,o.getShape(),s)}var Gt;(function(r){r[r.e_unknown=-1]="e_unknown",r[r.e_edgeA=1]="e_edgeA",r[r.e_edgeB=2]="e_edgeB"})(Gt||(Gt={}));var ao;(function(r){r[r.e_isolated=0]="e_isolated",r[r.e_concave=1]="e_concave",r[r.e_convex=2]="e_convex"})(ao||(ao={}));var Po=(function(){function r(){}return r})(),ma=(function(){function r(){this.vertices=[],this.normals=[],this.count=0;for(var t=0;t<P.maxPolygonVertices;t++)this.vertices.push(b(0,0)),this.normals.push(b(0,0))}return r})(),ua=(function(){function r(){this.v1=b(0,0),this.v2=b(0,0),this.normal=b(0,0),this.sideNormal1=b(0,0),this.sideNormal2=b(0,0)}return r.prototype.recycle=function(){T(this.v1),T(this.v2),T(this.normal),T(this.sideNormal1),T(this.sideNormal2)},r})(),ms=[new Dt,new Dt],Pe=[new Dt,new Dt],Qt=[new Dt,new Dt],le=new Po,Bt=new Po,ct=new ma,D=new ua,us=b(0,0),Vi=b(0,0),fi=b(0,0),Pi=b(0,0),Ti=ti(0,0,0),J=b(0,0),he=b(0,0),k=b(0,0),ce=b(0,0),lt=b(0,0),ht=b(0,0),lo=b(0,0),Te=b(0,0),To=function(r,t,e,i,s){yo(Ti,e,s),F(us,Ti,i.m_centroid);var o=t.m_vertex0,n=t.m_vertex1,a=t.m_vertex2,h=t.m_vertex3,m=t.m_hasVertex0,c=t.m_hasVertex3;L(fi,a,n),ie(fi),ft(k,fi.y,-fi.x);var _=I(k,us)-I(k,n),d=0,u=0,f=!1,p=!1;T(he),T(ce),m&&(L(Vi,n,o),ie(Vi),ft(he,Vi.y,-Vi.x),f=N(Vi,fi)>=0,d=l.dot(he,us)-l.dot(he,o)),c&&(L(Pi,h,a),ie(Pi),ft(ce,Pi.y,-Pi.x),p=l.crossVec2Vec2(fi,Pi)>0,u=l.dot(ce,us)-l.dot(ce,a));var v;T(J),T(lt),T(ht),m&&c?f&&p?(v=d>=0||_>=0||u>=0,v?(g(J,k),g(lt,he),g(ht,ce)):(z(J,-1,k),z(lt,-1,k),z(ht,-1,k))):f?(v=d>=0||_>=0&&u>=0,v?(g(J,k),g(lt,he),g(ht,k)):(z(J,-1,k),z(lt,-1,ce),z(ht,-1,k))):p?(v=u>=0||d>=0&&_>=0,v?(g(J,k),g(lt,k),g(ht,ce)):(z(J,-1,k),z(lt,-1,k),z(ht,-1,he))):(v=d>=0&&_>=0&&u>=0,v?(g(J,k),g(lt,k),g(ht,k)):(z(J,-1,k),z(lt,-1,ce),z(ht,-1,he))):m?f?(v=d>=0||_>=0,v?(g(J,k),g(lt,he),z(ht,-1,k)):(z(J,-1,k),g(lt,k),z(ht,-1,k))):(v=d>=0&&_>=0,v?(g(J,k),g(lt,k),z(ht,-1,k)):(z(J,-1,k),g(lt,k),z(ht,-1,he))):c?p?(v=_>=0||u>=0,v?(g(J,k),z(lt,-1,k),g(ht,ce)):(z(J,-1,k),z(lt,-1,k),g(ht,k))):(v=_>=0&&u>=0,v?(g(J,k),z(lt,-1,k),g(ht,k)):(z(J,-1,k),z(lt,-1,ce),g(ht,k))):(v=_>=0,v?(g(J,k),z(lt,-1,k),z(ht,-1,k)):(z(J,-1,k),g(lt,k),g(ht,k))),ct.count=i.m_count;for(var y=0;y<i.m_count;++y)F(ct.vertices[y],Ti,i.m_vertices[y]),Xt(ct.normals[y],Ti.q,i.m_normals[y]);var x=i.m_radius+t.m_radius;r.pointCount=0;{le.type=Gt.e_edgeA,le.index=v?0:1,le.separation=1/0;for(var y=0;y<ct.count;++y){var A=ct.vertices[y],w=I(J,A)-I(J,n);w<le.separation&&(le.separation=w)}}if(le.type!=Gt.e_unknown&&!(le.separation>x)){{Bt.type=Gt.e_unknown,Bt.index=-1,Bt.separation=-1/0,ft(lo,-J.y,J.x);for(var y=0;y<ct.count;++y){z(Te,-1,ct.normals[y]);var M=I(Te,ct.vertices[y])-I(Te,n),S=I(Te,ct.vertices[y])-I(Te,a),w=la(M,S);if(w>x){Bt.type=Gt.e_edgeB,Bt.index=y,Bt.separation=w;break}if(I(Te,lo)>=0){if(I(Te,J)-I(ht,J)<-P.angularSlop)continue}else if(I(Te,J)-I(lt,J)<-P.angularSlop)continue;w>Bt.separation&&(Bt.type=Gt.e_edgeB,Bt.index=y,Bt.separation=w)}}if(!(Bt.type!=Gt.e_unknown&&Bt.separation>x)){var C=.98,V=.001,H;if(Bt.type==Gt.e_unknown?H=le:Bt.separation>C*le.separation+V?H=Bt:H=le,Qt[0].recycle(),Qt[1].recycle(),H.type==Gt.e_edgeA){r.type=tt.e_faceA;for(var E=0,q=I(J,ct.normals[0]),y=1;y<ct.count;++y){var j=I(J,ct.normals[y]);j<q&&(q=j,E=y)}var W=E,Y=W+1<ct.count?W+1:0;g(Qt[0].v,ct.vertices[W]),Qt[0].id.setFeatures(0,U.e_face,W,U.e_vertex),g(Qt[1].v,ct.vertices[Y]),Qt[1].id.setFeatures(0,U.e_face,Y,U.e_vertex),v?(D.i1=0,D.i2=1,g(D.v1,n),g(D.v2,a),g(D.normal,k)):(D.i1=1,D.i2=0,g(D.v1,a),g(D.v2,n),z(D.normal,-1,k))}else r.type=tt.e_faceB,g(Qt[0].v,n),Qt[0].id.setFeatures(0,U.e_vertex,H.index,U.e_face),g(Qt[1].v,a),Qt[1].id.setFeatures(0,U.e_vertex,H.index,U.e_face),D.i1=H.index,D.i2=D.i1+1<ct.count?D.i1+1:0,g(D.v1,ct.vertices[D.i1]),g(D.v2,ct.vertices[D.i2]),g(D.normal,ct.normals[D.i1]);ft(D.sideNormal1,D.normal.y,-D.normal.x),ft(D.sideNormal2,-D.sideNormal1.x,-D.sideNormal1.y),D.sideOffset1=I(D.sideNormal1,D.v1),D.sideOffset2=I(D.sideNormal2,D.v2),ms[0].recycle(),ms[1].recycle(),Pe[0].recycle(),Pe[1].recycle();var Tt=Di(ms,Qt,D.sideNormal1,D.sideOffset1,D.i1);if(!(Tt<P.maxManifoldPoints)){var dt=Di(Pe,ms,D.sideNormal2,D.sideOffset2,D.i2);if(!(dt<P.maxManifoldPoints)){H.type==Gt.e_edgeA?(g(r.localNormal,D.normal),g(r.localPoint,D.v1)):(g(r.localNormal,i.m_normals[D.i1]),g(r.localPoint,i.m_vertices[D.i1]));for(var Yt=0,y=0;y<P.maxManifoldPoints;++y){var Mt=I(D.normal,Pe[y].v)-I(D.normal,D.v1);if(Mt<=x){var et=r.points[Yt];H.type==Gt.e_edgeA?(Gs(et.localPoint,Ti,Pe[y].v),et.id.set(Pe[y].id)):(g(et.localPoint,Pe[y].v),et.id.set(Pe[y].id),et.id.swapFeatures()),++Yt}}r.pointCount=Yt}}}}};(function(){function r(t,e){this._refMap={},this._map={},this._xmap={},this._data=[],this._entered=[],this._exited=[],this._key=t,this._listener=e}return r.prototype.update=function(t){if(!Array.isArray(t))throw"Invalid data: "+t;this._entered.length=0,this._exited.length=0,this._data.length=t.length;for(var e=0;e<t.length;e++)if(!(typeof t[e]!="object"||t[e]===null)){var i=t[e],s=this._key(i);this._map[s]?delete this._map[s]:this._entered.push(i),this._data[e]=i,this._xmap[s]=i}for(var s in this._map)this._exited.push(this._map[s]),delete this._map[s];var o=this._map;this._map=this._xmap,this._xmap=o;for(var e=0;e<this._exited.length;e++){var i=this._exited[e],n=this._key(i),a=this._refMap[n];this._listener.exit(i,a),delete this._refMap[n]}for(var e=0;e<this._entered.length;e++){var i=this._entered[e],n=this._key(i),a=this._listener.enter(i);a&&(this._refMap[n]=a)}for(var e=0;e<this._data.length;e++)if(!(typeof t[e]!="object"||t[e]===null)){var i=this._data[e],n=this._key(i),a=this._refMap[n];this._listener.update(i,a)}this._entered.length=0,this._exited.length=0,this._data.length=0},r.prototype.ref=function(t){return this._refMap[this._key(t)]},r})();const zo=80;function _t(r){return r/zo}function Ht(r){return r*zo}class da{constructor(){this.world=null,this.eventHandlers=new Map,this.contactListeners=[]}create(){return this.world=new qi({allowSleep:!0}),this.world.on("begin-contact",t=>{this.handleContactEvent("collisionStart",t)}),this.world.on("end-contact",t=>{this.handleContactEvent("collisionEnd",t)}),this}handleContactEvent(t,e){if(this.eventHandlers.has(t)){const i=this.eventHandlers.get(t),s={pairs:[{bodyA:e.getFixtureA().getBody(),bodyB:e.getFixtureB().getBody()}]};i.forEach(o=>{o(s)})}}setGravity(t,e){if(this.world){const i=_t(t),s=_t(e);this.world.setGravity({x:i,y:s})}}setTimeScale(t){this.timeScale=t||1}update(t){this.world&&this.world.step(.016666666666666666,6,3)}addBody(t){this.world&&t&&t.body}removeBody(t){if(this.world&&t){const e=t.body||t;this.world.destroyBody(e)}}getAllBodies(){if(!this.world)return[];const t=[];for(let e=this.world.getBodyList();e;e=e.getNext())t.push(e);return t}getBodiesByLabel(t){return this.getAllBodies().filter(i=>i.getUserData()?.label===t)}on(t,e){this.eventHandlers.has(t)||this.eventHandlers.set(t,[]),this.eventHandlers.get(t).push(e)}off(t,e){if(this.eventHandlers.has(t)){const i=this.eventHandlers.get(t),s=i.indexOf(e);s>-1&&i.splice(s,1)}}destroy(){this.world&&(this.eventHandlers.clear(),this.eventHandlers=null,this.world=null)}}class Ds{constructor(t){this.body=t}getPosition(){const t=this.body.getPosition();return{x:Ht(t.x),y:Ht(t.y)}}setPosition(t,e){const i=_t(t),s=_t(e);this.body.setTransform({x:i,y:s},this.body.getAngle())}getVelocity(){const t=this.body.getLinearVelocity();return{x:Ht(t.x),y:Ht(t.y)}}setVelocity(t,e){const i=_t(t),s=_t(e);this.body.setLinearVelocity({x:i,y:s})}getAngularVelocity(){return this.body.getAngularVelocity()}setAngularVelocity(t){this.body.setAngularVelocity(t)}setStatic(t){t?this.body.setType("static"):this.body.setType("dynamic")}isStatic(){return this.body.getType()==="static"}setSleeping(t){this.body.setAwake(!t)}isSleeping(){return!this.body.isAwake()}setUserData(t){this.body.setUserData(t)}get id(){return this.body.getUserData()?.id||0}get label(){return this.body.getUserData()?.label||""}get angle(){return this.body.getAngle()}get speed(){const t=this.getVelocity();return Math.sqrt(t.x*t.x+t.y*t.y)}get bounds(){const t=new ut;let e=!0;for(let i=this.body.getFixtureList();i;i=i.getNext()){const s=i.getShape(),o=this.body.getTransform(),n=new ut;s.computeAABB(n,o,0),e?(t.lowerBound.set(n.lowerBound),t.upperBound.set(n.upperBound),e=!1):t.combine(n)}return{min:{x:Ht(t.lowerBound.x),y:Ht(t.lowerBound.y)},max:{x:Ht(t.upperBound.x),y:Ht(t.upperBound.y)}}}get circleRadius(){for(let t=this.body.getFixtureList();t;t=t.getNext()){const e=t.getShape();if(e.getType()===we.TYPE)return Ht(e.getRadius())}return 0}}class pt{static world=null;static setWorld(t){pt.world=t}static createRectangle(t,e,i,s,o={}){if(!pt.world)throw new Error("World not set. Call PhysicsBodyFactory.setWorld(world) first.");const n=_t(t),a=_t(e),h=_t(i),m=_t(s),c={type:o.isStatic?"static":"dynamic",position:{x:n,y:a},linearDamping:0,angularDamping:0};o.angle!==void 0&&(c.angle=o.angle);const _=pt.world.createBody(c),d={shape:new Zn(h/2,m/2),density:o.density||1,friction:o.friction||.3,restitution:o.restitution||.1};_.createFixture(d);const u={id:pt.generateId(),...o.userData};return _.setUserData(u),new Ds(_)}static createCircle(t,e,i,s={}){if(!pt.world)throw new Error("World not set. Call PhysicsBodyFactory.setWorld(world) first.");const o=_t(t),n=_t(e),a=_t(i),h={type:s.isStatic?"static":"dynamic",position:{x:o,y:n},linearDamping:s.linearDamping??0,angularDamping:s.angularDamping??0},m=pt.world.createBody(h),c={shape:new we(a),density:s.density||1,friction:s.friction||.3,restitution:s.restitution||.1};m.createFixture(c);const _={id:pt.generateId(),...s.userData};return m.setUserData(_),new Ds(m)}static createPolygon(t,e={}){if(!pt.world)throw new Error("World not set. Call PhysicsBodyFactory.setWorld(world) first.");let i=t.map(m=>l(_t(m.x),_t(m.y))),s,o;if(e.position)s={x:_t(e.position.x),y:_t(e.position.y)},o=i;else{let m={x:0,y:0};i.forEach(c=>{m.x+=c.x,m.y+=c.y}),m.x/=i.length,m.y/=i.length,o=i.map(c=>l(c.x-m.x,c.y-m.y)),s={x:m.x,y:m.y}}const n={type:e.isStatic?"static":"dynamic",position:s,linearDamping:e.linearDamping??0,angularDamping:e.angularDamping??0},a=pt.world.createBody(n);if(e.isStatic&&o.length>1){for(let m=0;m<o.length-1;m++){const c=o[m],_=o[m+1],d={shape:new _e(c,_),density:e.density||1,friction:e.friction||.3,restitution:e.restitution||.1};a.createFixture(d)}if(o.length>2){const m=o[o.length-1],c=o[0],_={shape:new _e(m,c),density:e.density||1,friction:e.friction||.3,restitution:e.restitution||.1};a.createFixture(_)}}else{const m={shape:new Be(o),density:e.density||1,friction:e.friction||.3,restitution:e.restitution||.1};a.createFixture(m)}const h={id:pt.generateId(),...e.userData};return a.setUserData(h),new Ds(a)}static idCounter=1;static generateId(){return pt.idCounter++}}class ho{static getCollisionPairs(t){return t.pairs.map(e=>({bodyA:e.bodyA,bodyB:e.bodyB}))}}class co{constructor(t,e,i,s,o=!1){this.objectManager=t,this.sceneManager=t.getById("SceneManager"),this.sceneBallsX=t.getById("SceneBallsX"),this.playBall=o,this.deadBall=!1,this.combiningBall=!1,this.zapBall=!1,this.zapZoneTimerId=null,this.size=s,this.radius=this.calculateRadius(this.size);const n={radius:this.radius,size:this.size},a={label:"ball",ball:this,render:n};this.physicsBody=pt.createCircle(e,i,this.radius,{label:"ball",density:1,friction:.1,restitution:.7,linearDamping:.1,angularDamping:.1,userData:a}),this.physicsBody.setStatic(!0),this.sceneBallsX.addBody(this.physicsBody)}getBallStateHtml(){let t="",e=this.physicsBody.body.getUserData(),i=e.render.radius,s=this.sceneBallsX.getColorForSize(e.render.size);const o=_t(i);let a=o*o*Math.PI*1;t+=this.physicsBody.id+":&nbsp;",t+='<svg width="12" height="12" style="vertical-align:middle;"><circle cx="6" cy="6" r="6" fill="'+s+'"/></svg>&nbsp;',t+="Size:"+this.size+"&nbsp;",t+="Mass:"+a.toFixed(2)+"&nbsp;",t+="Speed:"+this.physicsBody.speed.toFixed(3)+"&nbsp;";const h=this.physicsBody.getPosition();t+="Pos:"+h.x.toFixed(0)+","+h.y.toFixed(0)+"&nbsp;";const m=this.physicsBody.getVelocity();return t+="Vel:"+m.x.toFixed(3)+","+m.y.toFixed(3)+"&nbsp;",t+="Ang Vel:"+this.physicsBody.getAngularVelocity().toFixed(3)+"&nbsp;",t+=this.physicsBody.isSleeping()?"S":"",t+=this.playBall?"P":"",t+=this.zapBall?"Z":"",t+=this.deadBall?"D":"",t+="<br/>",t}calculateRadius(t){return 25+(t-1)*8}getPosition(){return this.physicsBody.getPosition()}setPosition(t,e){this.physicsBody.setPosition(t,e)}setStatic(t){this.physicsBody.setStatic(t)}leaveZapZone(){this.playBall=!1,this.zapBall=!1,this.cancelZapZoneTimerId()}enterZapZone(){this.zapBall=!0}setZapZoneTimerId(t){this.zapZoneTimerId=t}cancelZapZoneTimerId(){this.zapZoneTimerId&&(clearTimeout(this.zapZoneTimerId),this.zapZoneTimerId=null)}release(){if(!this.physicsBody){alert("Error: Ball physics body is null in release()"),this.destroy();return}this.physicsBody.setStatic(!1),this.physicsBody.setAngularVelocity(0),this.physicsBody.setVelocity(0,0),this.playBall=!1}destroy(){try{this.sceneBallsX&&this.sceneBallsX.physics&&this.sceneBallsX.removeBody(this.physicsBody)}catch{}this.physicsBody=null,this.objectManager=null,this.sceneManager=null,this.combiningBall=!1}}class _a{constructor(t){this.objectManager=t,this.sceneManager=t.getById("SceneManager"),this.audioHandler=t.getById("AudioHandler"),this.particlesHandler=t.getById("ParticlesHandler"),this.achievementsManager=t.getById("AchievementsManager"),this.hapticsHandler=t.getById("HapticsHandler"),this.physics=null,this.sceneBallsX=null,this.canvasHeight=this.sceneManager.canvas.height,this.canvasWidth=this.sceneManager.canvas.width,this.gameOver=!1,this.playBall=null,this.lastCleanupTime=0,this.lastDropTime=0,this.lastPlayBallPosition=this.canvasWidth/2,this.combineQueue=[],this.combineSFX=this.audioHandler.getGameCombineSFX(),this.combineSFXLength=this.combineSFX.length}getBallBodies(){return this.physics?this.physics.getBodiesByLabel("ball")||[]:[]}getBallsStateHtml(){let t="<strong>Ball Details</strong><br>";return this.getBallBodies().forEach(i=>{const s=i.getUserData()?.ball;s&&(t+=`${s.getBallStateHtml()}`)}),t}keepXWithinBounds(t,e){const i=e.radius,s=te+i+2,o=this.canvasWidth-te-i-2;return Math.max(s,Math.min(o,t))}ballInZapZone(){let t=this.getBallBodies();for(const e of t){const i=e.getUserData()?.ball;if(i&&i.zapBall)return!0}return!1}spawnPlayBall(){if(this.playBall!==null||this.gameOver||performance.now()-this.lastDropTime<1e3||this.ballInZapZone())return;const t=512,e=-100;this.playBall=new co(this.objectManager,t,e,Math.floor(Math.random()*6)+1,!0);let i=this.keepXWithinBounds(this.lastPlayBallPosition,this.playBall);this.playBall.setPosition(i,102)}dropPlayBall(){this.playBall!==null&&(this.playBall.release(),this.lastDropTime=performance.now(),this.playBall=null)}relocatePlayBall(t,e){t=this.keepXWithinBounds(t,this.playBall),this.playBall.setPosition(t,e),this.lastPlayBallPosition=t}positionPlayBall(t){if(this.playBall===null)return;const e=this.playBall.getPosition();this.relocatePlayBall(t,e.y)}movePlayBall(t){if(this.playBall===null)return;const e=this.playBall.getPosition();let s=e.x+t*5;this.relocatePlayBall(s,e.y)}handleTouchAction(t,e,i){if(this.playBall===null)return;let s=this.playBall.getPosition(),o=this.keepXWithinBounds(e,this.playBall);this.playBall.setPosition(o,s.y),this.lastPlayBallPosition=o,this.sceneManager.canvas.style.cursor="move",t==="touchend"&&(this.dropPlayBall(),this.sceneManager.canvas.style.cursor="default")}queueCombine(t,e){return!t||!e?!1:(this.combineQueue.push({ballA:t,ballB:e}),!0)}dequeueCombine(){return this.combineQueue.length===0?null:this.combineQueue.shift()}processCombineQueue(){for(;this.combineQueue.length>0;){const t=this.dequeueCombine();if(!t)break;const{ballA:e,ballB:i}=t;!e||!i||this.combineBallsMerge(e,i)}}combineBallsMerge(t,e){t.cancelZapZoneTimerId(),e.cancelZapZoneTimerId(),this.sceneBallsX.score+=t.size*t.size*2,this.achievementsManager.registerScore(this.sceneBallsX.score);const i=t.size<15?t.size+1:15,s=t.getPosition(),o=e.getPosition(),n=(s.x+o.x)/2,a=(s.y+o.y)/2,h=t.physicsBody.getVelocity(),m=e.physicsBody.getVelocity(),c=(h.x+m.x)/2,_=(h.y+m.y)/2,d=new co(this.objectManager,n,a,i,!1),u=this.sceneBallsX.getColorForSize(i);d.physicsBody.setVelocity(c,_),d.physicsBody.setStatic(!1),this.particlesHandler.combineEffect([n,a],u);let f=Math.floor(Math.random()*this.combineSFXLength),p=this.combineSFX[f];this.audioHandler.playSFX(p),this.hapticsHandler.pulse("combine"),this.achievementsManager.registerBall(i),t.destroy(),e.destroy(),t=null,e=null}combineBalls(t,e){if(t.combiningBall||e.combiningBall||t.playBall||e.playBall)return!1;t.combiningBall=!0,e.combiningBall=!0,this.queueCombine(t,e)}gameOver_BonusBalls(){let t=this.getBallBodies(),e="Bonus Balls: ",i=0;t.forEach(s=>{let o=s.getUserData()?.ball;!o.playBall&&!o.deadBall&&(i+=300,e+=o.physicsBody.id+" ",e+="; ",setTimeout(()=>{this.sceneBallsX.score+=o.size*o.size;let n=Math.floor(Math.random()*this.combineSFXLength)+1,a=this.combineSFX[n-1];this.audioHandler.playSFX(a),this.hapticsHandler.pulse("combine"),this.achievementsManager.registerScore(this.sceneBallsX.score);let h=o.getPosition();const m=this.sceneBallsX.getColorForSize(o.size);this.particlesHandler.combineEffect([h.x,h.y],m),o.destroy(),o=null},i))})}gameOver_DeadBalls(){if(this.gameOver)return;this.gameOver=!0;let t=this.getBallBodies(),e="Ball Left: ";t.forEach(i=>{let s=i.getUserData()?.ball,o=500;e+=s.physicsBody.id+" ",s.playBall?(s.cancelZapZoneTimerId(),s.destroy(),s=null,e+="PlayBall "):s.zapBall&&(s.deadBall=!0,s.physicsBody.fillStyle="#000000",e+="Dead ",s.cancelZapZoneTimerId(),o+=250,setTimeout(()=>{let n=s.getPosition();this.particlesHandler.combineEffect([n.x,n.y],"#FFFFFF"),s.destroy(),s=null},o)),e+="; ",s&&s.setStatic(!0)})}updateFrame(){this.spawnPlayBall(),this.updateBallStates(),this.processCombineQueue()}updateBallStates(){this.getBallBodies(),this.cleanup()}cleanup(){let t=performance.now();if(t-this.lastCleanupTime<15e3)return;this.lastCleanupTime=t,this.getBallBodies().forEach(i=>{const s=i.getUserData()?.ball;s&&s.getPosition().y>this.canvasHeight+100&&s.destroy()})}start(){this.physics=this.objectManager.getById("PhysicsEngine"),this.sceneBallsX=this.objectManager.getById("SceneBallsX")}destroy(){this.getBallBodies().forEach(e=>{let i=e.getUserData()?.ball;i&&(i.destroy(),i=null)}),this.sceneManager=null,this.sceneBallsX=null,this.objectManager=null,this.audioHandler=null}}class pa{constructor(t,e={}){this.canvas=t,this.ctx=t.getContext("2d"),this.lasers=[],this.defaultOptions={beamStyle:e.beamStyle??"solid",coords1:e.coords1??[0,t.height/2],coords2:e.coords2??[t.width,t.height/2],shootDuration:e.shootDuration??800,fadeDuration:e.fadeDuration??800,beamColor:e.beamColor??"#00ffff",glowColor:e.glowColor??"#00ffff",tipColor:e.tipColor??e.glowColor??"#00ffff",glowSize:e.glowSize??24,beamWidth:e.beamWidth??4,tipSize:e.tipSize??24,tipStyle:e.tipStyle??"arrow",particleConfig:Object.assign({color:"#fff",glowColor:"#00ffff",size:6,speed:3,life:600,fade:!0,rate:.8},e.particleConfig||{})}}fire(t=1){return this.addLaser(t,{})}addLaser(t=1,e={}){const i=Object.assign({},this.defaultOptions,e),s={id:Date.now()+Math.random(),active:!0,opacity:1,progress:0,timer:0,phase:t===0?"fade":"shoot",direction:t,particles:[],...i};return t===0&&(s.progress=1),this.lasers.push(s),s.id}removeLaser(t){const e=this.lasers.findIndex(i=>i.id===t);return e!==-1?(this.lasers.splice(e,1),!0):!1}getActiveLaserCount(){return this.lasers.filter(t=>t.active).length}clearAllLasers(){this.lasers=[]}destroy(){if(Array.isArray(this.lasers))for(let t=0;t<this.lasers.length;t++){const e=this.lasers[t];e&&Array.isArray(e.particles)&&(e.particles.length=0);for(const i in e)Object.hasOwnProperty.call(e,i)&&(e[i]=null)}this.lasers=[],this.canvas=null,this.ctx=null,this.defaultOptions=null}update(t){for(let e=this.lasers.length-1;e>=0;e--){const i=this.lasers[e];if(!i.active){this.lasers.splice(e,1);continue}i.timer+=t,i.phase==="shoot"?(i.progress=Math.min(1,i.timer/i.shootDuration),i.progress>=1&&(i.phase="fade",i.timer=0)):i.phase==="fade"&&(i.opacity=1-Math.min(1,i.timer/i.fadeDuration),i.opacity<=0&&(i.active=!1,i.phase="idle")),this._updateParticles(i,t)}}render(){for(const t of this.lasers)t.active&&this._renderLaser(t)}_renderLaser(t){const e=this.ctx;let i,s,o,n;t.direction>=0?([i,s]=t.coords1,[o,n]=t.coords2):([i,s]=t.coords2,[o,n]=t.coords1);const a=i+(o-i)*t.progress,h=s+(n-s)*t.progress;switch(e.save(),e.globalAlpha=t.opacity,e.shadowColor=t.glowColor,e.shadowBlur=t.glowSize,e.lineCap="round",e.lineWidth=t.beamWidth,e.strokeStyle=t.beamColor,t.beamStyle){case"solid":this._drawSolidBeam(i,s,a,h);break;case"dashed":this._drawDashedBeam(i,s,a,h);break;case"crackling":this._drawCracklingBeam(i,s,a,h,t);break;case"tazer":this._drawTazerBeam(i,s,a,h,t);break;case"pulsing":this._drawPulsingBeam(i,s,a,h,t);break;case"charged":this._drawChargedBeam(i,s,a,h,t);break;case"plasma":this._drawPlasmaBeam(i,s,a,h,t);break;case"disruptor":this._drawDisruptorBeam(i,s,a,h,t);break;default:this._drawSolidBeam(i,s,a,h);break}e.shadowBlur=0,t.direction!==0&&t.phase==="shoot"&&this._drawBeamTip(a,h,i,s,o,n,t),t.phase==="shoot"&&this._emitParticles(a,h,t),this._renderParticles(e,t),e.restore()}_drawSolidBeam(t,e,i,s){this.ctx.beginPath(),this.ctx.moveTo(t,e),this.ctx.lineTo(i,s),this.ctx.stroke()}_drawDashedBeam(t,e,i,s){this.ctx.setLineDash([16,8]),this.ctx.beginPath(),this.ctx.moveTo(t,e),this.ctx.lineTo(i,s),this.ctx.stroke(),this.ctx.setLineDash([])}_drawCracklingBeam(t,e,i,s,o){const n=Math.sqrt((i-t)**2+(s-e)**2),a=Math.floor(n/8),h=o.beamWidth*1.5;this.ctx.beginPath(),this.ctx.moveTo(t,e);for(let m=1;m<=a;m++){const c=m/a,_=t+(i-t)*c,d=e+(s-e)*c,u=(Math.random()-.5)*h,f=(Math.random()-.5)*h;this.ctx.lineTo(_+u,d+f)}this.ctx.lineTo(i,s),this.ctx.stroke()}_drawTazerBeam(t,e,i,s,o){const n=Math.sqrt((i-t)**2+(s-e)**2),a=Math.floor(n/12),h=o.beamWidth*4;this.ctx.beginPath(),this.ctx.moveTo(t,e);for(let m=1;m<=a;m++){const c=m/a,_=t+(i-t)*c,d=e+(s-e)*c,u=m%2===0?1:-1,f=(Math.random()-.5)*h+u*h*.3,p=(Math.random()-.5)*h+u*h*.3;this.ctx.lineTo(_+f,d+p)}this.ctx.lineTo(i,s),this.ctx.stroke()}_drawPulsingBeam(t,e,i,s,o){const h=Math.sin(o.timer*3*.01)*.6+1;this.ctx.lineWidth=o.beamWidth*h,this.ctx.beginPath(),this.ctx.moveTo(t,e),this.ctx.lineTo(i,s),this.ctx.stroke()}_drawChargedBeam(t,e,i,s,o){const a=o.beamWidth*.8;this.ctx.lineWidth=o.beamWidth*.3;for(let h=0;h<4;h++){const m=h/4*Math.PI*2,c=Math.cos(m)*a,_=Math.sin(m)*a;this.ctx.beginPath(),this.ctx.moveTo(t+c,e+_),this.ctx.lineTo(i+c,s+_),this.ctx.stroke()}}_drawPlasmaBeam(t,e,i,s,o){this.ctx.save(),this.ctx.lineWidth=o.beamWidth*3,this.ctx.globalAlpha=o.opacity*.3,this.ctx.beginPath(),this.ctx.moveTo(t,e),this.ctx.lineTo(i,s),this.ctx.stroke(),this.ctx.lineWidth=o.beamWidth*1.8,this.ctx.globalAlpha=o.opacity*.6,this.ctx.beginPath(),this.ctx.moveTo(t,e),this.ctx.lineTo(i,s),this.ctx.stroke(),this.ctx.lineWidth=o.beamWidth*.8,this.ctx.globalAlpha=o.opacity,this.ctx.strokeStyle="#ffffff",this.ctx.beginPath(),this.ctx.moveTo(t,e),this.ctx.lineTo(i,s),this.ctx.stroke(),this.ctx.restore()}_drawDisruptorBeam(t,e,i,s,o){const a=o.beamWidth*2,h=.3,m=i-t,c=s-e,_=Math.sqrt(m*m+c*c),d=-c/_,u=m/_;this.ctx.lineWidth=o.beamWidth/3;for(let f=0;f<3;f++){const p=(f-1)*a,v=t+d*p,y=e+u*p,x=i+d*p,A=s+u*p,w=8;this.ctx.beginPath(),this.ctx.moveTo(v,y);for(let M=1;M<=w;M++){const S=M/w;let C=v+(x-v)*S,V=y+(A-y)*S;if(Math.random()<h){const H=t+(i-t)*S,E=e+(s-e)*S,q=.7;C=C*(1-q)+H*q,V=V*(1-q)+E*q}this.ctx.lineTo(C,V)}this.ctx.stroke()}}_drawBeamTip(t,e,i,s,o,n,a){if(this.ctx.save(),this.ctx.globalAlpha=a.opacity*.9,this.ctx.fillStyle=a.tipColor,this.ctx.shadowColor=a.tipColor,this.ctx.shadowBlur=a.glowSize*1.5,a.tipStyle==="circle")this.ctx.beginPath(),this.ctx.arc(t,e,a.tipSize*.6,0,Math.PI*2),this.ctx.fill();else{const h=o-i,m=n-s,c=Math.atan2(m,h);this.ctx.translate(t,e),this.ctx.rotate(c),this.ctx.beginPath(),this.ctx.moveTo(a.tipSize,0),this.ctx.lineTo(-a.tipSize*.4,-a.tipSize*.3),this.ctx.lineTo(-a.tipSize*.4,a.tipSize*.3),this.ctx.closePath(),this.ctx.fill()}this.ctx.restore()}_emitParticles(t,e,i){const s=Math.floor(i.particleConfig.rate*5);for(let o=0;o<s;o++)if(Math.random()<i.particleConfig.rate){const n=Math.random()*Math.PI*2,a=i.particleConfig.speed*(1+Math.random()*2);i.particles.push({x:t+(Math.random()-.5)*i.beamWidth*.5,y:e+(Math.random()-.5)*i.beamWidth*.5,vx:Math.cos(n)*a,vy:Math.sin(n)*a,life:i.particleConfig.life*(.5+Math.random()*.5),age:0,size:i.particleConfig.size*(.3+Math.random()*.4),length:8+Math.random()*12,color:i.particleConfig.color,glowColor:i.particleConfig.glowColor,fade:i.particleConfig.fade,trail:Math.random()>.5})}}_updateParticles(t,e){for(let i of t.particles)i.x+=i.vx,i.y+=i.vy,i.age+=e;t.particles=t.particles.filter(i=>i.age<i.life)}_renderParticles(t,e){for(let i of e.particles){const s=i.fade?1-i.age/i.life:1;if(!(s<=.01)){if(t.save(),t.globalAlpha=s*e.opacity,i.trail){t.strokeStyle=i.glowColor,t.shadowColor=i.glowColor,t.shadowBlur=i.size*3,t.lineWidth=i.size*.5,t.lineCap="round";const o=i.x-i.vx*(i.length/10),n=i.y-i.vy*(i.length/10);t.beginPath(),t.moveTo(i.x,i.y),t.lineTo(o,n),t.stroke()}else t.shadowColor=i.glowColor,t.shadowBlur=i.size*4,t.beginPath(),t.arc(i.x,i.y,i.size,0,Math.PI*2),t.fillStyle=i.color,t.fill();t.restore()}}}}class fa{constructor(t){this.objectManager=t,this.canvas=this.objectManager.getById("Main").canvas,this.LaserbeamMark=this.objectManager.register("MarkJSLaserbeam",new pa(this.canvas,{beamStyle:"solid"}))}fire(t){let e={coords1:[0,180],coords2:[this.canvas.width,180],beamStyle:"solid"};this.laserId=this.LaserbeamMark.addLaser(t,e),this.laserId=this.LaserbeamMark.addLaser(-t,e)}render(){this.LaserbeamMark.render()}update(t){this.LaserbeamMark.update(t)}destroy(){this.LaserbeamMark&&(this.LaserbeamMark.destroy(),this.objectManager.deregister(this.LaserbeamMark),this.LaserbeamMark=null)}}class Pt{constructor(t,e={}){this.canvas=t,this.ctx=t.getContext("2d"),this.effects=[]}update(t){const e=performance.now();for(let i=this.effects.length-1;i>=0;i--){let s=this.effects[i];if(s.particles.length===0){this.effects.splice(i,1);continue}for(let o=s.particles.length-1;o>=0;o--){let n=s.particles[o];if(typeof s.updateParticle=="function"){if(s.updateParticle(n,t,e)===!1){s.particles.splice(o,1);continue}}else n.gravity<0&&!n.exploded?(n.yv+=n.gravity,n.y<n.peakY&&(n.exploded=!0,n.xv=(Math.random()-.5)*4,n.yv=Math.random()*2+1)):n.yv+=n.gravity,n.xv*=n.friction,n.yv*=n.friction,n.x+=n.xv,n.y+=n.yv;if(e-n.created>=n.ttl){s.particles.splice(o,1);continue}}s.particles.length===0&&this.effects.splice(i,1)}}render(){this.drawEffects()}drawEffects(){const t=performance.now();for(let e=this.effects.length-1;e>=0;e--){let i=this.effects[e];for(let s=i.particles.length-1;s>=0;s--){let o=i.particles[s];const a=1-(t-o.created)/o.ttl;this.ctx.save(),this.ctx.globalAlpha=Math.max(0,Math.min(1,a));const h=`rgb(${o.r}, ${o.g}, ${o.b})`;this.ctx.fillStyle=h;const m=Math.max(o.size,.5),c=o.x,_=o.y,d=o.shape||"circle",u=i&&i.options&&typeof i.options.glowStrength<"u"?Number(i.options.glowStrength):0;if(u>0?(this.ctx.shadowColor=h,this.ctx.shadowBlur=Math.max(0,Math.round(m*u)),this.ctx.shadowOffsetX=0,this.ctx.shadowOffsetY=0):this.ctx.shadowBlur=0,d==="circle")this.ctx.beginPath(),this.ctx.arc(c,_,m,0,Math.PI*2),this.ctx.fill();else if(d==="square")this.ctx.translate(c,_),this.ctx.rotate(o.angle||0),this.ctx.fillRect(-m,-m,m*2,m*2);else if(d==="rect"||d==="ribbon"){const f=m*(d==="ribbon"?3:2),p=m;this.ctx.translate(c,_),this.ctx.rotate(o.angle||0),this.ctx.fillRect(-f/2,-p/2,f,p)}else if(d==="star"){const p=m*1.6,v=m*.6;let y=Math.PI/2*3,x=c,A=_;this.ctx.beginPath(),this.ctx.moveTo(x,A-p);for(let w=0;w<5;w++){const M=x+Math.cos(y)*p,S=A+Math.sin(y)*p;this.ctx.lineTo(M,S),y+=Math.PI/5;const C=x+Math.cos(y)*v,V=A+Math.sin(y)*v;this.ctx.lineTo(C,V),y+=Math.PI/5}this.ctx.closePath(),this.ctx.fill()}else this.ctx.beginPath(),this.ctx.arc(c,_,m,0,Math.PI*2),this.ctx.fill();this.ctx.restore()}}}addEffect(t,e,i={}){const[s,o]=e;let n;switch(t){case"explosion":n=new Pt.Explosion(s,o,i);break;case"confetti":n=new Pt.Confetti(s,o,i);break;case"fireworks":n=new Pt.Fireworks(s,o,i);break;default:throw new Error(`Unknown effect type: ${t}`)}this.effects.push(n)}destroy(){if(Array.isArray(this.effects))for(let t=0;t<this.effects.length;t++){const e=this.effects[t];e&&Array.isArray(e.particles)&&(e.particles.length=0);for(const i in e)Object.hasOwnProperty.call(e,i)&&(e[i]=null)}this.effects=[],this.canvas=null,this.ctx=null}static Explosion=class{constructor(t,e,i){this.type="explosion",this.particles=[],this.particlesPerExplosion=i.particlesPerExplosion??30,this.particlesMinSpeed=i.particlesMinSpeed??3,this.particlesMaxSpeed=i.particlesMaxSpeed??6,this.particlesMinSize=i.particlesMinSize??1,this.particlesMaxSize=i.particlesMaxSize??6,this.options=Object.assign({jitter:1,frictionMin:.96,frictionMax:.995,gravity:.02,lifetimeMinMs:600,lifetimeMaxMs:1400,rMin:113,rMax:222,gMin:0,gMax:100,bMin:105,bMax:255},i);for(let s=0;s<this.particlesPerExplosion;s++)this.particles.push(new Pt.Particle(t,e,this.particlesMinSpeed,this.particlesMaxSpeed,this.particlesMinSize,this.particlesMaxSize,this.options));this.updateParticle=function(s,o,n){return s.yv+=s.gravity,s.xv*=s.friction,s.yv*=s.friction,s.x+=s.xv,s.y+=s.yv,!0}}};static Confetti=class{constructor(t,e,i){this.type="confetti",this.particles=[],this.particlesPerExplosion=i.particlesPerExplosion??50,this.particlesMinSpeed=i.particlesMinSpeed??1,this.particlesMaxSpeed=i.particlesMaxSpeed??4,this.particlesMinSize=i.particlesMinSize??2,this.particlesMaxSize=i.particlesMaxSize??8,this.options=Object.assign({jitter:1,frictionMin:.98,frictionMax:.999,gravity:.01,lifetimeMinMs:2e3,lifetimeMaxMs:4e3,rMin:200,rMax:255,gMin:100,gMax:255,bMin:50,bMax:200},i);for(let s=0;s<this.particlesPerExplosion;s++){const o=new Pt.Particle(t,e,this.particlesMinSpeed,this.particlesMaxSpeed,this.particlesMinSize,this.particlesMaxSize,this.options),n=["square","circle","ribbon","star"];o.shape=n[Math.floor(Math.random()*n.length)],o.angle=Math.random()*Math.PI*2,o.angularVelocity=(Math.random()-.5)*.2,o.sway=.5+Math.random()*1.5,o.swayFreq=.6+Math.random()*1.6,o.swayPhase=Math.random()*Math.PI*2,this.particles.push(o)}this.updateParticle=function(s,o,n){const a=n*.001,h=Math.max(.5,Math.min(2,o/16)),m=.02;return s.xv+=Math.sin(a*(s.swayFreq||1)+(s.swayPhase||0))*m*(s.sway||1)*h,s.angle=(s.angle||0)+(s.angularVelocity||0),s.yv+=s.gravity,s.xv*=s.friction,s.yv*=s.friction,s.x+=s.xv,s.y+=s.yv,!0}}};static Fireworks=class{constructor(t,e,i){this.type="fireworks",this.particles=[],this.particlesPerExplosion=i.particlesPerExplosion??20,this.particlesMinSpeed=i.particlesMinSpeed??5,this.particlesMaxSpeed=i.particlesMaxSpeed??10,this.particlesMinSize=i.particlesMinSize??2,this.particlesMaxSize=i.particlesMaxSize??4,this.options=Object.assign({jitter:.5,frictionMin:.99,frictionMax:.999,gravity:-.05,lifetimeMinMs:1e3,lifetimeMaxMs:2e3,rMin:255,rMax:255,gMin:200,gMax:255,bMin:0,bMax:100},i);for(let s=0;s<this.particlesPerExplosion;s++)this.particles.push(new Pt.Particle(t,e,this.particlesMinSpeed,this.particlesMaxSpeed,this.particlesMinSize,this.particlesMaxSize,this.options));this.updateParticle=function(s,o,n){if(s.gravity<0&&!s.exploded){if(s.yv+=s.gravity,s.y<s.peakY){s.exploded=!0;const a=Math.random()*Math.PI*2,h=Math.random()*4+2;s.xv=Math.cos(a)*h,s.yv=Math.sin(a)*h}}else s.yv+=s.gravity;return s.xv*=s.friction,s.yv*=s.friction,s.x+=s.xv,s.y+=s.yv,!0}}};static Particle=class{constructor(t,e,i,s,o,n,a={}){this.x=t,this.y=e;const h=Math.random()*Math.PI*2,m=Math.random()*(s-i)+i,c=.5+Math.random(),_=m*c;this.xv=Math.cos(h)*_,this.yv=Math.sin(h)*_;const d=(a.jitter||0)*(Math.random()-.5);this.x+=d,this.y+=d,this.size=Pt.randRange(o,n,!1);const u=Object.assign({},a);u.frictionMin!=null&&(u.frictionMin=Number(u.frictionMin)),u.frictionMax!=null&&(u.frictionMax=Number(u.frictionMax)),u.gravity!=null&&(u.gravity=Number(u.gravity)),u.lifetimeMs!=null&&(u.lifetimeMs=Number(u.lifetimeMs)),u.lifetimeMinMs!=null&&(u.lifetimeMinMs=Number(u.lifetimeMinMs)),u.lifetimeMaxMs!=null&&(u.lifetimeMaxMs=Number(u.lifetimeMaxMs)),u.lifetimeJitter=u.lifetimeJitter??.5;const f=u.rMin??113,p=u.rMax??222,v=u.gMin??0,y=u.gMax??100,x=u.bMin??105,A=u.bMax??255;this.r=Math.floor(Pt.randRange(f,p,!1)),this.g=Math.floor(Pt.randRange(v,y,!1)),this.b=Math.floor(Pt.randRange(x,A,!1)),this.friction=Pt.randRange(u.frictionMin??.96,u.frictionMax??.995,!1),this.gravity=u.gravity??.02,this.gravity<0&&(this.peakY=this.y-Math.random()*50-50,this.exploded=!1);const w=u.lifetimeMs!=null?Number(u.lifetimeMs):Pt.randRange(u.lifetimeMinMs,u.lifetimeMaxMs,!1),M=Math.max(0,Math.min(1,Number(u.lifetimeJitter))),S=1-M,C=Math.random()*M+S;this.created=performance.now(),this.lifeJitter=C,this.ttl=Math.max(16,w*C)}};static randRange(t,e,i){const s=Number(t),o=Number(e);return i?Math.floor(Math.random()*(o-s+1))+Math.floor(s):Math.random()*(o-s)+s}}class va{constructor(t){this.objectManager=t,this.canvas=this.objectManager.getById("Main").canvas,this.particlesMark=this.objectManager.register("MarkJSParticles",new Pt(this.canvas))}hexToRgb(t){t=t.replace(/^#/,""),t.length===3&&(t=t.split("").map(i=>i+i).join(""));const e=parseInt(t,16);return{r:e>>16&255,g:e>>8&255,b:e&255}}combineEffect(t,e){const{r:i,g:s,b:o}=this.hexToRgb(e);let n=Math.max(0,i-16),a=Math.min(255,i+16),h=Math.max(0,s-16),m=Math.min(255,s+16),c=Math.max(0,o-16),_=Math.min(255,o+16);this.particlesMark.addEffect("explosion",t,{rMin:n,rMax:a,gMin:h,gMax:m,bMin:c,bMax:_})}update(t){this.particlesMark.update(t)}render(){this.particlesMark.render()}destroy(){this.particlesMark&&(this.particlesMark.destroy(),this.objectManager.deregister(this.particlesMark),this.particlesMark=null)}}const Es=[{name:"Combine1",url:"audio/combine1-pixabay.mp3",type:"sfx",use:"combine"},{name:"Combine2",url:"audio/combine2-pixabay.mp3",type:"sfx",use:"combine"},{name:"Combine3",url:"audio/combine3-pixabay.mp3",type:"sfx",use:"combine"},{name:"Combine4",url:"audio/combine4-pixabay.mp3",type:"sfx",use:"combine"},{name:"Combine5",url:"audio/combine5-pixabay.mp3",type:"sfx",use:"combine"},{name:"Combine6",url:"audio/combine6-pixabay.mp3",type:"sfx",use:"combine"},{name:"Beep",url:"audio/bleep-pixabay.mp3",type:"sfx"},{name:"GameOver",url:"audio/endgame-pixabay.mp3",type:"sfx"},{name:"Achievement",url:"audio/achievement-pixabay.mp3",type:"sfx"},{name:"MenuMusic",url:"audio/calm-background-pixabay.mp3",type:"music"}],zi={"Xmas Bauballs":[{name:"XmasMusic",url:"audio/christmas3-pixabay.mp3",type:"music",use:"bgmusic"}],Smileys:[{name:"GameMusic",url:"audio/BounceXJimHall.mp3",type:"music",use:"bgmusic"}],Default:[{name:"GameMusic",url:"audio/BounceXJimHall.mp3",type:"music",use:"bgmusic"}]},qs=[{url:"images/smiles.png",name:"smiles"},{url:"images/ground.png",name:"ground"},{url:"images/cog.svg",name:"cog"}],Zs={"Xmas Bauballs":{imageCount:35,imageId:"xmas",imageType:"png",edgeColor:"#85cee5"},Smileys:{imageCount:38,imageId:"smiley",imageType:"x.png",edgeColor:"#FFD700"},Default:{imageCount:0,imageId:"",edgeColor:"#FFFFFF"}},te=8,ds=1e3/60;class ya extends oe{constructor(t){super(t),this.pressedKeys={},this.singleFireKeys=new Set(["Space","Escape","ArrowDown"]),this.repeatableKeys=new Set(["ArrowLeft","ArrowRight","KeyA","KeyD"]),this.leftMouseBut=!1,this.audioHandler=t.getById("AudioHandler"),this.sceneManager=t.getById("SceneManager"),this.configManager=t.getById("ConfigManager"),this.achievementsManager=t.getById("AchievementsManager"),this.physics=t.register("PhysicsEngine",new da),this.imageHandler=this.objectManager.getById("ImageHandler"),this.canvasInputHandler=this.objectManager.getById("CanvasInputHandler"),this.canvasUIHandler=this.objectManager.getById("CanvasUIHandler"),this.canvasInputHandler.subscribe(this),this.physics.create(),this.physics.setGravity(0,600),this.physics.setTimeScale(1),pt.setWorld(this.physics.world),this.clock={deltaTime:0,currentTime:performance.now(),lastStatsUpdate:0,cachedDeltaTime:0,cachedFPS:0,stepCount:0,cachedStepCount:0},this.showingDialog=!1,this.exitToMenu=!1,this.restartGame=!1,this.scoreHighest=this.achievementsManager.getHighestScore(`BallsX-${this.configManager.gameSize}`)||0,this.score=0,this.clickedCoord=null,this.gameImagesIdx=[],this.themeEntry=null,this.laserbeamHandler=this.objectManager.register("LaserbeamHandler",new fa(this.objectManager)),this.particlesHandler=this.objectManager.register("ParticlesHandler",new va(this.objectManager)),this.ballManager=this.objectManager.register("BallManager",new _a(this.objectManager)),this.setupWallBoundaries(),this.setupGroundBoundaries(),this.setupZapZone(),this.setupEventHandlers(),this._physicsAccumulator=0,this.transitionActive=!0,this.transitionRadius=5,this.transitionCenterX=this.canvas.width/2,this.transitionCenterY=this.canvas.height/2,this.transitionSpeed=1e3,this.dialogState={None:"none",EndGame:"endgame",PauseGame:"pausegame"},this.dialogStateValue=this.dialogState.None,this.ballColors=null}getSceneStateHtml(){const t=performance.now(),e=t-this.clock.lastStatsUpdate;return e>500&&(this.clock.cachedDeltaTime=this.clock.deltaTime.toFixed(2),this.clock.cachedFPS=(1e3/this.clock.deltaTime).toFixed(1),this.clock.cachedStepCount=(this.clock.stepCount*1e3/e).toFixed(1),this.clock.stepCount=0,this.clock.lastStatsUpdate=t),`
            <strong>Scene: BallsX</strong><br>
            Delta Time: ${this.clock.cachedDeltaTime}ms,&nbsp;
            FPS: ${this.clock.cachedFPS},&nbsp;
            StepsPS: ${this.clock.cachedStepCount}
            <br><hr style="border: none; border-top: 1px solid #00ff00; margin-top: 5px; margin-bottom: 5px;">
            ${this.ballManager.getBallsStateHtml()}
        `}getColorForSize(t){return this.ballColors[(t-1)%this.ballColors.length]}setupEventHandlers(){this.physics.on("collisionStart",t=>{ho.getCollisionPairs(t).forEach(({bodyA:i,bodyB:s})=>{i===s&&alert("Self-collision detected");const o=i.getUserData().label,n=s.getUserData().label;if(o==="ball"&&n==="ball"){const a=i.getUserData().render.size,h=s.getUserData().render.size;if(a===h){const m=i.getUserData()?.ball,c=s.getUserData()?.ball;this.ballManager.combineBalls(m,c)}}if(o==="ball"&&n==="zapzone"||o==="zapzone"&&n==="ball"){const h=(o==="ball"?i:s).getUserData()?.ball;h.playBall||this.handleZapZone(h)}})}),this.physics.on("collisionEnd",t=>{ho.getCollisionPairs(t).forEach(({bodyA:i,bodyB:s})=>{const o=i.getUserData().label,n=s.getUserData().label;(o==="ball"&&n==="zapzone"||o==="zapzone"&&n==="ball")&&((o==="ball"?i:s).getUserData()?.ball).leaveZapZone()})})}setupZapZone(){const e=this.canvas.width-2*te,i={fillStyle:`rgba(255,0,0,${this.configManager.dev?.2:0})`,strokeStyle:"#ff0000",lineWidth:0,width:e,height:400},s=pt.createRectangle(this.canvas.width/2,-20,e,400,{isStatic:!0,userData:{label:"zapzone",render:i},isSensor:!0}),o=s.body.getFixtureList();o&&o.setSensor(!0),this.zapZoneBody=s,this.physics.addBody(s)}setupWallBoundaries(){const t=this.canvas.width,e=this.canvas.height,i=.7,s=.5,o={fillStyle:"#000000",strokeStyle:"#000000",lineWidth:3,width:te,height:e},n=pt.createRectangle(te/2,e/2,te,e,{isStatic:!0,friction:s,restitution:i,userData:{label:"leftwall",render:o}}),a=pt.createRectangle(t-te/2,e/2,te,e,{isStatic:!0,friction:s,restitution:i,userData:{label:"rightwall",render:o}});this.physics.addBody(n),this.physics.addBody(a)}setupGroundBoundaries(){const t=this.canvas.width;this.canvas.height;const e=.7,i=.5,s={fillStyle:"rgba(255, 0, 0, 0.5)",strokeStyle:"#ff0000",lineWidth:1,width:t,height:te},o=[{x:625,y:100},{x:-625,y:100},{x:-625,y:-195},{x:-455,y:-101.5},{x:-390,y:-134},{x:-195,y:-30},{x:-130,y:-62.5},{x:-65,y:-30},{x:0,y:-62.5},{x:65,y:-30},{x:130,y:-62.5},{x:195,y:-30},{x:390,y:-134},{x:455,y:-101.5},{x:625,y:-195}];let n=0;switch(this.configManager.gameSize){case"Large":n=720;break;case"Medium":n=648;break;case"Small":n=576;break}const a={x:t/2,y:n};s.polygon={vertices:o,position:a};const h=pt.createPolygon(o,{isStatic:!0,friction:i,restitution:e,position:a,userData:{label:"ground",render:s}});this.physics.addBody(h)}addBody(t){this.physics.addBody(t)}removeBody(t){this.physics.removeBody(t)}renderRectBody(t){const e=this.ctx,i=t.getPosition(),s={x:Ht(i.x),y:Ht(i.y)},o=t.getAngle();e.save(),e.translate(s.x,s.y),e.rotate(o);let n=t.getUserData().render;e.fillStyle=n.fillStyle,e.strokeStyle=n.strokeStyle,e.lineWidth=n.lineWidth;const a=n.width,h=n.height;e.fillRect(-a/2,-h/2,a,h),e.strokeRect(-a/2,-h/2,a,h),e.restore()}renderGround(t){this.ctx;let e=0;switch(this.configManager.gameSize){case"Large":e=144;break;case"Medium":e=72;break;case"Small":e=0;break}let i=this.imageHandler.getImage("ground");i!=null&&this.ctx.drawImage(i,0,e,this.canvas.width,this.canvas.height)}renderZapZone(t){const e=this.ctx;e.save(),e.strokeStyle="#ff0000",e.lineWidth=2,e.setLineDash([2,6]),e.beginPath(),e.moveTo(te,180),e.lineTo(this.canvas.width-te,180),e.stroke(),e.setLineDash([]),e.restore(),this.renderRectBody(t)}renderBallEffect(t,e,i){const s=this.ctx;s.save(),s.shadowColor="rgba(255,255,255,0.7)",s.shadowBlur=20;const o=s.createRadialGradient(0,0,0,0,0,i);o.addColorStop(0,"#000"),o.addColorStop(1,this.getColorForSize(e)),s.fillStyle=o,s.beginPath(),s.arc(0,0,i,0,2*Math.PI),s.fill(),s.restore(),s.save();const n=Math.max(24,i*.8);s.font=`bold ${n}px Arial`,s.fillStyle="#fff",s.textAlign="center",s.textBaseline="middle",s.strokeStyle="#000",s.lineWidth=2,s.strokeText(e.toString(),0,0),s.fillText(e.toString(),0,0),s.restore()}renderBallImage(t,e,i){const s=this.ctx,o=this.gameImagesIdx[e-1];let n=null;if(o){const u=`${this.themeEntry.imageId}${o.toString().padStart(2,"0")}`;n=this.imageHandler.getImage(u)}let a=n?.data,h=a?.animated||!1,m=a?.imgHeight||128,c=a?.imgWidth||128,_=0,d=t.getUserData().ball;if(h){if(!d?.animData){let u=a?.numFrames||1,f=a?.numHoldFrames||0;d.animData={frameIdx:0,numFrames:u,frameHoldIdx:0,numHoldFrames:f}}_=d.animData.frameIdx*c}s.drawImage(n,_,0,c,m,-i,-i,i*2,i*2),h&&(d.animData.frameHoldIdx++,d.animData.frameHoldIdx>=d.animData.numHoldFrames&&(d.animData.frameIdx=(d.animData.frameIdx+1)%d.animData.numFrames,d.animData.frameHoldIdx=0))}renderBall(t){const e=this.ctx,{x:i,y:s}=t.getPosition(),o=t.getAngle(),n=t.getUserData().render,h=n.radius-4/2;h<=0||(e.save(),e.translate(Ht(i),Ht(s)),e.rotate(o),e.save(),e.shadowColor="rgba(255,255,255,0.7)",e.shadowBlur=20,e.beginPath(),e.arc(0,0,h,0,2*Math.PI),e.fillStyle=this.themeEntry.edgeColor,e.fill(),e.strokeStyle=this.themeEntry.edgeColor,e.lineWidth=4,e.stroke(),e.shadowBlur=0,e.shadowColor="rgba(0,0,0,0)",e.restore(),this.configManager.theme==="Default"?this.renderBallEffect(t,n.size,h):this.renderBallImage(t,n.size,h),e.restore())}updatePhysics(t){for(this._physicsAccumulator+=t;this._physicsAccumulator>=ds;)this.physics.update(ds),this._physicsAccumulator-=ds,this.clock.stepCount++;this.clock.stepTime=ds}renderStatusLine(){this.ctx.save(),this.ctx.fillStyle="#ffffff",this.ctx.font="bold 20px Arial",this.ctx.textAlign="left",this.ctx.textBaseline="top",this.ctx.fillText(this.txt("Highest")+`: ${this.scoreHighest}  `+this.txt("Score")+`: ${this.score}`,16,6),this.ctx.restore()}renderIcons(){const e=this.canvas.width-32-10,i=0,s=this.imageHandler.getImage("cog");s&&this.ctx.drawImage(s,e,i,32,32)}renderScene(){if(this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.transitionActive){const i=this.ctx.createLinearGradient(0,0,this.canvas.width,this.canvas.height);i.addColorStop(0,"#0a0e27"),i.addColorStop(.5,"#1a1f3a"),i.addColorStop(1,"#2d3561"),this.ctx.fillStyle=i,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.save(),this.ctx.beginPath(),this.ctx.arc(this.transitionCenterX,this.transitionCenterY,this.transitionRadius,0,Math.PI*2),this.ctx.clip()}const t=this.ctx.createLinearGradient(0,0,0,this.canvas.height);t.addColorStop(0,"#00008B"),t.addColorStop(1,"#0000FF"),this.ctx.fillStyle=t,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.laserbeamHandler.render();const e=this.physics.getAllBodies();e.forEach(i=>{switch(i.getUserData().label){case"leftwall":case"rightwall":this.renderRectBody(i);break;case"ground":this.renderGround(i);break;case"zapzone":this.renderZapZone(i);break}}),e.forEach(i=>{i.getUserData().label==="ball"&&this.renderBall(i)}),this.particlesHandler.render(),this.renderStatusLine(),this.renderIcons(),this.transitionActive&&this.ctx.restore()}inputTouchAction(t,e,i,s={}){this.gameOver||(i>50?this.ballManager.handleTouchAction(t,e,i,s):e>this.canvas.width-42&&i<42&&t==="touchstart"&&(this.dialogStateValue=this.dialogState.PauseGame))}inputMouseAction(t,e,i,s){this.gameOver||(this.canvas.style.cursor="default",i>50?(t==="mousemove"&&s&&this.ballManager.handleTouchAction("touchmove",e,i),t==="click"&&this.ballManager.handleTouchAction("touchend",e,i)):e>this.canvas.width-42&&i<42&&(t==="mousemove"?this.canvas.style.cursor="pointer":(t="click")&&(this.dialogStateValue=this.dialogState.PauseGame)))}stopMovement(){this.pressedKeys.ArrowLeft=!1,this.pressedKeys.ArrowRight=!1}inputKeyPressed(t){if(!this.gameOver)switch(t){case"ArrowLeft":case"KeyA":this.ballManager.movePlayBall(-1);break;case"ArrowRight":case"KeyD":this.ballManager.movePlayBall(1);break;case"Left-Bumper":case"Left-Dpad":this.stopMovement(),this.ballManager.positionPlayBall(0);break;case"Right-Bumper":case"Right-Dpad":this.stopMovement(),this.ballManager.positionPlayBall(this.canvas.width);break;case"Up-Dpad":this.stopMovement(),this.ballManager.positionPlayBall(this.canvas.width/2);break;case"ArrowDown":case"Space":case"Down-Dpad":case"ButtonA":this.stopMovement(),this.ballManager.dropPlayBall();break;case"Escape":case"ButtonB":this.dialogStateValue=this.dialogState.PauseGame;break}}processInputLoop(){this.canvasInputHandler.update(),this.repeatableKeys.forEach(t=>{this.pressedKeys[t]&&this.inputKeyPressed(t)})}onKeyDown(t){if(this.singleFireKeys.has(t.code)){if(this.pressedKeys[t.code])return;this.pressedKeys[t.code]=!0,this.inputKeyPressed(t.code)}else this.repeatableKeys.has(t.code)&&(this.pressedKeys[t.code]=!0,this.inputKeyPressed(t.code))}onKeyUp(t){this.pressedKeys[t.code]=!1}onMouseMove(t,e){this.inputMouseAction("mousemove",t,e,this.leftMouseBut)}onMouseDown(t,e,i){i===0&&(this.leftMouseBut=!0)}onMouseUp(t,e,i){i===0&&(this.leftMouseBut=!1)}onMouseEnter(t,e){this.leftMouseBut=!1}onMouseClick(t,e,i){this.inputMouseAction("click",t,e,i===0)}onTouchStart(t,e){this.inputTouchAction("touchstart",t,e)}onTouchMove(t,e){this.inputTouchAction("touchmove",t,e)}onTouchEnd(t,e){this.inputTouchAction("touchend",t,e)}onGamepadButton(t){switch(t){case 0:this.inputKeyPressed("ButtonA");break;case 1:this.inputKeyPressed("ButtonB");break;case 4:this.inputKeyPressed("Left-Bumper");break;case 5:this.inputKeyPressed("Right-Bumper");break;case 9:this.inputKeyPressed("Escape");break;case 12:this.inputKeyPressed("Up-Dpad");break;case 13:this.inputKeyPressed("Down-Dpad");break;case 14:this.inputKeyPressed("Left-Dpad");break;case 15:this.inputKeyPressed("Right-Dpad");break}}onGamepadAxis(t){const{leftStick:e,rightStick:i,deadZone:s}=t;if(e){const{x:o,y:n}=e;Math.abs(o)>s?(this.pressedKeys.ArrowLeft=o<-s,this.pressedKeys.ArrowRight=o>s):(this.pressedKeys.ArrowLeft=!1,this.pressedKeys.ArrowRight=!1)}}gameOverStep2(){this.achievementsManager.incrementGamesPlayed(),this.ballManager.gameOver_BonusBalls();const t=()=>{this.ballManager.getBallBodies().length===0?setTimeout(()=>{this.dialogStateValue=this.dialogState.EndGame},1e3):setTimeout(t,200)};t()}gameOverStep1(){this.gameOver||(this.gameOver=!0,this.laserbeamHandler.fire(1),this.audioHandler.stopMusic(),this.audioHandler.playSFX("GameOver"),this.ballManager.gameOver_DeadBalls(),setTimeout(()=>{this.gameOverStep2()},2e3))}handleZapZone2(t){if(!this.showingDialog){setTimeout(()=>{t.zapBall&&this.gameOverStep1()},2e3);return}setTimeout(()=>this.handleZapZone2(t),2e3)}handleZapZone(t){t.enterZapZone();let e=setTimeout(()=>{this.audioHandler.playSFX("Beep");let i=setTimeout(()=>{t.zapBall&&!this.showingDialog?this.gameOverStep1():this.handleZapZone2(t)},2e3);t.setZapZoneTimerId(i)},2e3);t.setZapZoneTimerId(e)}initialiseGameAudio(){let t=this.audioHandler.getGameBGMusic();this.audioHandler.transitionMusic(t)}initialiseGameImages(){const t=this.configManager.theme;if(this.themeEntry=Zs[t]||{imageCount:0,imageId:"?",edgeColor:"#FFF"},this.themeEntry.imageCount===0){this.gameImagesIdx=[];return}this.imageHandler.checkThemeImagesLoaded(t),this.gameImagesIdx=Array.from({length:this.themeEntry.imageCount},(e,i)=>i+1);for(let e=this.gameImagesIdx.length-1;e>0;e--){const i=Math.floor(Math.random()*(e+1));[this.gameImagesIdx[e],this.gameImagesIdx[i]]=[this.gameImagesIdx[i],this.gameImagesIdx[e]]}}sliceColorsArray(t){const e=t.slice();if(e.length<2)return e;const i=Math.floor(Math.random()*e.length),s=e.slice(0,i);let n=e.slice(i).concat(s);return Math.random()<.5&&(n=n.reverse()),n}initialiseBallColors(){this.ballColors=this.sliceColorsArray(["#ff5500","#00ff55","#0000ff","#ffb3ff","#ffff00","#ff0000","#00ffaa","#0055ff","#ffaa00","#aa00ff","#aaff00","#740b43","#0055ff","#5500ff","#228B22","#00ffff","#00aaff","#ff00aa","#00ff00","#b3b3ff"])}enter(){this.initialiseGameAudio(),this.initialiseGameImages(),this.initialiseBallColors(),this.gameOver=!1,this.canvasUIHandler.removeAllControls(),this.canvasUIHandler.setBackgroundNone(),this.ballManager.start()}exit(){this.objectManager.getById("AudioHandler").transitionMusic("MenuMusic"),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.fillStyle="#111111",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ballManager&&(this.ballManager.destroy(),this.objectManager.deregister(this.ballManager),this.ballManager=null),this.physics&&(this.physics.destroy(),this.objectManager.deregister(this.physics),this.physics=null),this.laserbeamHandler&&(this.laserbeamHandler.destroy(),this.objectManager.deregister(this.laserbeamHandler),this.laserbeamHandler=null),this.particlesHandler&&(this.particlesHandler.destroy(),this.objectManager.deregister(this.particlesHandler),this.particlesHandler=null),this.canvasInputHandler.unsubscribe(this)}doPauseGameDialog(){this.showingDialog=!0,this.canvasInputHandler.unsubscribe(this),this.canvasUIHandler.showModal(this.txt("Game paused"),this.txt("Would you like to resume or exit?"),[{label:this.txt("Resume"),callback:()=>{this.showingDialog=!1,this.clock.currentTime=performance.now(),this.pressedKeys={},setTimeout(()=>{this.canvasInputHandler.subscribe(this)},1e3)}},{label:this.txt("Exit"),callback:()=>{this.exitToMenu=!0}}],{escapeButtonLabel:this.txt("Exit")})}doEndGameDialog(){let t="";this.score>this.scoreHighest?(t=this.txt("New High Score!")+` ${this.score}  (`+this.txt("Previous")+`: ${this.scoreHighest}) 

`,this.achievementsManager.setHighestScore(`BallsX-${this.configManager.gameSize}`,this.score)):t=`${this.txt("Your Score")}: ${this.score}  (${this.txt("High score to beat")}: ${this.scoreHighest}) 

`,this.achievementsManager.saveToLocalStorage(),this.showingDialog=!0,this.canvasUIHandler.showModal(this.txt("Game over"),t+this.txt("Would you like to restart or exit?"),[{label:this.txt("Restart"),callback:()=>{this.restartGame=!0}},{label:this.txt("Exit"),callback:()=>{this.exitToMenu=!0}}],{escapeButtonLabel:this.txt("Exit")})}updateFrame(){if(this.exitToMenu)return O.mainmenu;if(this.restartGame)return O.ballsX;if(this.dialogStateValue===this.dialogState.PauseGame&&(this.dialogStateValue=this.dialogState.None,this.doPauseGameDialog()),this.dialogStateValue===this.dialogState.EndGame&&(this.dialogStateValue=this.dialogState.None,this.doEndGameDialog()),this.processInputLoop(),!this.showingDialog){const t=performance.now(),e=this.clock.currentTime;if(this.clock.currentTime=t,this.clock.deltaTime=this.clock.currentTime-e,this.transitionActive){this.transitionRadius+=this.transitionSpeed*(this.clock.deltaTime/1e3);const i=Math.sqrt(Math.pow(this.canvas.width/2,2)+Math.pow(this.canvas.height/2,2));this.transitionRadius>=i&&(this.transitionActive=!1)}this.updatePhysics(this.clock.deltaTime),this.ballManager.updateFrame(),this.particlesHandler.update(this.clock.deltaTime),this.laserbeamHandler.update(this.clock.deltaTime)}return this.renderScene(),this.canvasUIHandler.update(this.clock.deltaTime),null}getObjectStateHtml(){return"?"}logObjectInfo(){console.log("âœ”ï¸")}}class ga extends oe{constructor(t){super(t),this.menuEnter=null}requestFullscreen(){if(/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)||navigator.maxTouchPoints>0&&window.screen.width<1200){const e=document.documentElement;e.requestFullscreen?e.requestFullscreen():e.webkitRequestFullscreen?e.webkitRequestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.msRequestFullscreen&&e.msRequestFullscreen()}}enterSub(){this.imageHandler=this.objectManager.getById("ImageHandler"),this.audioHandler=this.objectManager.getById("AudioHandler"),this.steamHandler=this.objectManager.getById("SteamHandler"),this.steamHandler.doInit(),this.insertControls()}async insertControls(){this.canvasUIHandler.removeAllControls(),this.setbackground();let t=await this.imageHandler.loadImage("images/smiles.png","smiles");this.canvasUIHandler.addImage(t,440,60,400,280),this.canvasUIHandler.addText("OH BALLS MERGE",640,350,{fontSize:72,fontWeight:"bold",align:"center"}),this.canvasUIHandler.addText(this.txt("Version")+" "+ja,640,430,{fontSize:24,align:"center"});let e=[{label:this.txt("Enter"),callback:async()=>await this.doEnter()}],i={fontSize:20,gap:5,orientation:"vertical"};this.menuEnter=this.canvasUIHandler.addMenu(540,480,e,i)}async doEnter(){this.requestFullscreen(),this.canvasUIHandler.removeControl(this.menuEnter),this.canvasUIHandler.addText(this.txt("Loading")+" ....",640,500,{fontSize:24,align:"center"}),await this.audioHandler.initialize(),await this.steamHandler.waitForInit(),setTimeout(()=>{this.audioHandler.setVolume(this.configManager.masterVolume,this.configManager.musicVolume,this.configManager.sfxVolume),this.audioHandler.playMusic("MenuMusic"),this.nextScene=O.mainmenu},1e3)}}class xa extends oe{constructor(t){super(t),this.main=this.objectManager.getById("Main"),this.steamHandler=this.objectManager.getById("SteamHandler")}enterSub(){this.insertControls()}exitSub(){}insertControls(){this.canvasUIHandler.removeAllControls(),this.setbackground(),this.canvasUIHandler.addText(this.txt("Main Menu"),125,30,{fontSize:24,align:"center"});let t=[{label:this.txt("Start game"),callback:()=>this.nextScene=O.ballsX},{label:this.txt("Settings"),callback:()=>this.nextScene=O.settings},{label:this.txt("Achievements"),callback:()=>this.nextScene=O.achievements},{label:this.txt("How to play"),callback:()=>this.nextScene=O.howtoplay},{label:this.txt("Credits"),callback:()=>this.nextScene=O.credits}];const e=window.matchMedia("(display-mode: standalone)").matches||window.navigator.standalone===!0,i=window.location.protocol==="ms-appx-web:";this.main.deferredPrompt&&!e&&!i&&t.push({label:this.txt("Install"),callback:()=>this.doInstall()}),this.steamHandler.enabled()&&t.push({label:this.txt("Exit"),callback:async()=>await this.doExit()});let s={fontSize:20,gap:5,orientation:"vertical"};this.canvasUIHandler.addMenu(30,70,t,s)}async doExit(){this.canvasUIHandler??=this.objectManager.getById("CanvasUIHandler"),this.canvasUIHandler.showToast("Goodbye ...","info",1e3),setTimeout(async()=>{await this.steamHandler.doExit()},1e3)}async doInstall(){if(this.main.deferredPrompt){this.main.deferredPrompt.prompt();const{outcome:t}=await this.main.deferredPrompt.userChoice;this.main.deferredPrompt=null,this.insertControls()}}}class ba extends oe{constructor(t){super(t)}enterSub(){this.achievementsManager=this.objectManager.getById("AchievementsManager"),this.insertControls()}insertControls(){this.canvasUIHandler.removeAllControls(),this.canvasUIHandler.setOnEscape(()=>this.doEscape()),this.canvasUIHandler.addText(this.txt("Achievements"),125,30,{fontSize:24,align:"left"});let t=this.achievementsManager.getHighestScoresText();t+=this.achievementsManager.getLargestBallText(),t+=this.achievementsManager.getGamesPlayedText(),t=t.split(`
`);let e=40;t.forEach(s=>{e+=30,this.canvasUIHandler.addText(s,125,e,{fontSize:18,align:"left"})});let i=[{label:this.txt("Home"),callback:()=>this.doExit()}];this.menuEnter=this.canvasUIHandler.addMenu(125,e,i,{width:120,height:40}),this.canvasUIHandler.focusControl(this.menuEnter)}doExit(){this.nextScene=O.mainmenu}doEscape(){this.nextScene=O.mainmenu}}class Aa extends oe{constructor(t){super(t)}enterSub(){this.insertControls()}insertControls(){this.canvasUIHandler.removeAllControls(),this.canvasUIHandler.setOnEscape(()=>this.doEscape()),this.canvasUIHandler.addText(this.txt("How to play"),125,30,{fontSize:24,align:"left"});let t=this.translationManager.getText("How to play").split(`
`),e=70;t.forEach(s=>{this.canvasUIHandler.addText(s,125,e,{fontSize:18,align:"left"}),e+=30});let i=[{label:this.txt("Home"),callback:()=>this.doExit()}];this.menuEnter=this.canvasUIHandler.addMenu(125,e,i,{width:120,height:40}),this.canvasUIHandler.focusControl(this.menuEnter)}doExit(){this.nextScene=O.mainmenu}doEscape(){this.nextScene=O.mainmenu}}class Ba extends oe{constructor(t){super(t)}enterSub(){this.insertControls()}insertControls(){this.canvasUIHandler.removeAllControls(),this.canvasUIHandler.setOnEscape(()=>this.doEscape()),this.canvasUIHandler.addText(this.txt("Credits"),125,30,{fontSize:24,align:"left"});let t=this.translationManager.getText("Credits").split(`
`),e=70;t.forEach(s=>{this.canvasUIHandler.addText(s,125,e,{fontSize:18,align:"left"}),e+=30});let i=[{label:this.txt("Home"),callback:()=>this.doExit()}];this.menuEnter=this.canvasUIHandler.addMenu(125,e,i,{width:120,height:40}),this.canvasUIHandler.focusControl(this.menuEnter)}doExit(){this.nextScene=O.mainmenu}doEscape(){this.nextScene=O.mainmenu}}class wa extends oe{constructor(t){super(t),this.keySequence=[],this._boundHandleKeyDown=this.handleKeyDown.bind(this)}enterSub(){this.loadConfig(),this.insertControls(),this.setupEventListeners()}exitSub(){this.deleteEventListeners()}loadConfig(){this.dev=this.configManager.dev}saveConfig(){this.configManager.dev=this.dev,this.configManager.saveToLocalStorage(),this.canvasUIHandler.showToast("Developer Mode "+(this.dev?"Enabled":"Disabled"))}setupEventListeners(){window.addEventListener("keydown",this._boundHandleKeyDown)}deleteEventListeners(){window.removeEventListener("keydown",this._boundHandleKeyDown)}handleKeyDown(t){this.keySequence.push(t.key.toLowerCase()),this.keySequence.length>3&&this.keySequence.shift(),this.keySequence.join("")==="dev"&&(this.dev=!this.dev,this.keySequence=[],this.saveConfig(),this.insertControls())}insertControls(){this.canvasUIHandler.removeAllControls(),this.canvasUIHandler.setOnEscape(()=>this.nextScene=O.mainmenu),this.canvasUIHandler.addText(this.txt("Settings"),125,30,{fontSize:24,align:"center"});let t=[{label:this.txt("Home"),callback:()=>this.nextScene=O.mainmenu},{label:this.txt("Audio"),callback:()=>this.nextScene=O.settingsaudio},{label:this.txt("Gameplay"),callback:()=>this.nextScene=O.settingsgameplay},{label:this.txt("Accessibility"),callback:()=>this.nextScene=O.settingsaccessibility}];this.dev&&t.push({label:"Developer",callback:()=>this.nextScene=O.settingsdeveloper});let e={fontSize:20,gap:5,orientation:"vertical"};this.canvasUIHandler.addMenu(30,70,t,e)}}class Ma extends oe{constructor(t){super(t),this.audioHandler=t.getById("AudioHandler")}enterSub(){this.loadConfig(),this.insertControls()}loadConfig(){this.masterVolume=this.configManager.masterVolume,this.musicVolume=this.configManager.musicVolume,this.sfxVolume=this.configManager.sfxVolume}saveConfig(){this.configManager.masterVolume=this.masterVolume,this.configManager.musicVolume=this.musicVolume,this.configManager.sfxVolume=this.sfxVolume,this.configManager.saveToLocalStorage(),this.audioHandler.updateAudioSettings(),this.canvasUIHandler.showToast(this.txt("Audio settings updated"))}insertControls(){this.canvasUIHandler.removeAllControls(),this.canvasUIHandler.setOnEscape(()=>this.doEscape()),this.canvasUIHandler.addText(this.txt("Audio")+" "+this.txt("Settings"),320,30,{fontSize:24,align:"left"});let t={width:900,height:360,backgroundColor:"#0b689d80",borderColor:"#0000FF",borderWidth:0};this.canvasUIHandler.addPanel(300,70,t);let e=this.canvasUIHandler.addSlider(320,100,this.txt("Master Volume")+":",0,100,this.masterVolume,10,s=>this.doMasterVolume(s),{zeroText:this.txt("Audio disabled")});this.canvasUIHandler.addSlider(320,190,this.txt("Music Volume")+":",0,100,this.musicVolume,10,s=>this.doMusicVolume(s),{zeroText:this.txt("Muted")}),this.canvasUIHandler.addSlider(320,280,this.txt("SFX Volume")+":",0,100,this.sfxVolume,10,s=>this.doSfxVolume(s),{zeroText:this.txt("Muted")});let i=[{label:this.txt("Save"),callback:()=>this.doSave()}];this.menuEnter=this.canvasUIHandler.addMenu(320,370,i,{width:120,height:40}),this.canvasUIHandler.focusControl(e)}doMasterVolume(t){this.masterVolume=t}doMusicVolume(t){this.musicVolume=t}doSfxVolume(t){this.sfxVolume=t}doSave(){this.saveConfig(),this.nextScene=O.settings}doEscape(){this.nextScene=O.settings}}class Ca extends oe{constructor(t){super(t)}enterSub(){this.loadConfig(),this.insertControls()}loadConfig(){this.theme=this.configManager.theme,this.gameSize=this.configManager.gameSize}async saveConfig(){this.configManager.theme=this.theme,this.configManager.gameSize=this.gameSize,this.objectManager.getById("ImageHandler").switchThemeImages(this.theme),await this.objectManager.getById("AudioHandler").switchThemeAudio(this.theme),this.configManager.saveToLocalStorage(),this.nextScene=O.settings,this.canvasUIHandler.showToast("Gameplay settings updated")}insertControls(){this.canvasUIHandler.removeAllControls(),this.canvasUIHandler.setOnEscape(()=>this.doEscape()),this.canvasUIHandler.addText(this.txt("Gameplay")+" "+this.txt("Settings"),320,30,{fontSize:24,align:"left"});let t={width:900,height:240,backgroundColor:"#0b689d80",borderColor:"#0000FF",borderWidth:0};this.canvasUIHandler.addPanel(300,70,t);let e={width:200,height:60,orientation:"horizontal"},i=Object.keys(Zs),s=this.canvasUIHandler.addCarousel(320,100,this.txt("Theme")+":",i,this.configManager.theme,(n,a)=>this.doTheme(a),e);i=["Large","Medium","Small"],this.canvasUIHandler.addCarousel(320,170,this.txt("Game Size")+":",i,this.configManager.gameSize,(n,a)=>this.doGameSize(a),e);let o=[{label:this.txt("Save"),callback:async()=>await this.doSave()}];this.menuEnter=this.canvasUIHandler.addMenu(320,240,o,{width:120,height:40}),this.canvasUIHandler.focusControl(s)}doTheme(t){this.theme=t}doGameSize(t){this.gameSize=t}async doSave(){await this.saveConfig(),this.nextScene=O.settings}doEscape(){this.nextScene=O.settings}}class Sa extends oe{constructor(t){super(t),this.hapticsHandler=t.getById("HapticsHandler")}enterSub(){this.loadConfig(),this.insertControls()}loadConfig(){this.language=this.configManager.language,this.rumblerIntensity=this.configManager.rumblerIntensity}async saveConfig(){this.configManager.language=this.language,this.configManager.rumblerIntensity=this.rumblerIntensity,this.configManager.saveToLocalStorage(),this.translationManager.setLocale(),this.hapticsHandler.updateHapticsSettings(),this.nextScene=O.settings,this.canvasUIHandler.showToast(this.txt("Accessibility settings updated"))}insertControls(){this.canvasUIHandler.removeAllControls(),this.canvasUIHandler.setOnEscape(()=>this.doEscape()),this.canvasUIHandler.addText(this.txt("Accessibility")+" "+this.txt("Settings"),320,30,{fontSize:24,align:"left"});let t={width:900,height:240,backgroundColor:"#0b689d80",borderColor:"#0000FF",borderWidth:0};this.canvasUIHandler.addPanel(300,70,t);let e={width:200,height:60,orientation:"horizontal"},i=["English","French","German","Italian","Spanish"],s=this.canvasUIHandler.addCarousel(320,100,this.txt("Language")+":",i,this.configManager.language,(n,a)=>this.doLanguage(a),e);this.canvasUIHandler.addSlider(320,170,this.txt("Rumbler Intensity")+":",0,100,this.configManager.rumblerIntensity,10,n=>this.doRumblerIntensity(n),{zeroText:this.txt("Disabled")});let o=[{label:this.txt("Save"),callback:async()=>await this.doSave()}];this.menuEnter=this.canvasUIHandler.addMenu(320,260,o,{width:120,height:40}),this.canvasUIHandler.focusControl(s)}doLanguage(t){this.language=t}doRumblerIntensity(t){this.rumblerIntensity=t}async doSave(){await this.saveConfig(),this.nextScene=O.settings}doEscape(){this.nextScene=O.settings}}class Ia extends oe{constructor(t){super(t)}enterSub(){this.loadConfig(),this.insertControls()}loadConfig(){this.dev=this.configManager.dev,this.devPanel=this.configManager.devPanel}saveConfig(){this.configManager.dev=this.dev,this.configManager.devPanel=this.devPanel,this.objectManager.getById("DevHandler").enablePanel(this.configManager.dev&&this.configManager.devPanel),this.configManager.saveToLocalStorage(),this.nextScene=O.settings,this.canvasUIHandler.showToast("Developer settings updated")}insertControls(){this.canvasUIHandler.removeAllControls(),this.canvasUIHandler.setOnEscape(()=>this.doEscape()),this.canvasUIHandler.addText("Developer Settings",320,30,{fontSize:24,align:"left"});let t={width:900,height:280,backgroundColor:"#0b689d80",borderColor:"#0000FF",borderWidth:0};this.canvasUIHandler.addPanel(300,70,t);let e={},i=this.canvasUIHandler.addToggle(320,100,"Developer Mode:",this.dev,o=>this.doDeveloperMode(o),e);this.canvasUIHandler.addToggle(320,160,"Developer Panel:",this.devPanel,o=>this.doDeveloperPanel(o),e);let s=[{label:this.txt("Save"),callback:()=>this.doSave()}];this.menuEnter=this.canvasUIHandler.addMenu(320,240,s,{width:120,height:40}),this.canvasUIHandler.focusControl(i)}doDeveloperMode(t){this.dev=t}doDeveloperPanel(t){this.devPanel=t}doSave(){this.saveConfig(),this.nextScene=O.settings}doEscape(){this.nextScene=O.settings}}class Va{constructor(t){this.canvas=t,this.keys={},this.gamepad=null,this.lastGamepadButtons=[],this.lastGamepadAxes=[],this.subscribers=[],this.boundHandleKeyDown=e=>this._handleKeyDown(e),this.boundHandleKeyUp=e=>this._handleKeyUp(e),this.boundHandleMouseMove=e=>this._handleMouseMove(e),this.boundHandleMouseDown=e=>this._handleMouseDown(e),this.boundHandleMouseUp=e=>this._handleMouseUp(e),this.boundHandleMouseEnter=e=>this._handleMouseEnter(e),this.boundHandleMouseClick=e=>this._handleMouseClick(e),this.boundHandleContextMenu=e=>this._handleContextMenu(e),this.boundHandleTouchStart=e=>this._handleTouchStart(e),this.boundHandleTouchMove=e=>this._handleTouchMove(e),this.boundHandleTouchEnd=e=>this._handleTouchEnd(e),this.boundHandleGamepadConnected=e=>this._handleGamepadConnected(e),this._setupEventListeners()}subscribe(t){return this.subscribers.includes(t)||this.subscribers.push(t),{unsubscribe:()=>this.unsubscribe(t)}}unsubscribe(t){const e=this.subscribers.indexOf(t);e>-1&&this.subscribers.splice(e,1)}getCanvasCoordinates(t,e){const i=this.canvas.getBoundingClientRect(),s=i.width,o=i.height,n=this.canvas.width,a=this.canvas.height,h=n/s,m=a/o;let c=(t-i.left)*h,_=(e-i.top)*m;return c=Math.max(0,Math.min(Math.round(c),n)),_=Math.max(0,Math.min(Math.round(_),a)),{x:c,y:_}}update(){this.updateGamepad()}destroy(){window.removeEventListener("keydown",this.boundHandleKeyDown),window.removeEventListener("keyup",this.boundHandleKeyUp),this.canvas.removeEventListener("mousemove",this.boundHandleMouseMove),this.canvas.removeEventListener("mousedown",this.boundHandleMouseDown),this.canvas.removeEventListener("mouseup",this.boundHandleMouseUp),this.canvas.removeEventListener("mouseenter",this.boundHandleMouseEnter),this.canvas.removeEventListener("click",this.boundHandleMouseClick),this.canvas.removeEventListener("contextmenu",this.boundHandleContextMenu),this.canvas.removeEventListener("touchstart",this.boundHandleTouchStart),this.canvas.removeEventListener("touchmove",this.boundHandleTouchMove),this.canvas.removeEventListener("touchend",this.boundHandleTouchEnd),window.removeEventListener("gamepadconnected",this.boundHandleGamepadConnected),this.subscribers=[],this.keys={},this.mouse={x:0,y:0,buttons:0},this.gamepad=null,this.lastGamepadButtons=[],this.lastGamepadAxes=[]}_setupEventListeners(){window.addEventListener("keydown",this.boundHandleKeyDown),window.addEventListener("keyup",this.boundHandleKeyUp),this.canvas.addEventListener("mousemove",this.boundHandleMouseMove,!1),this.canvas.addEventListener("mousedown",this.boundHandleMouseDown,!1),this.canvas.addEventListener("mouseup",this.boundHandleMouseUp,!1),this.canvas.addEventListener("mouseenter",this.boundHandleMouseEnter,!1),this.canvas.addEventListener("click",this.boundHandleMouseClick,!1),this.canvas.addEventListener("contextmenu",this.boundHandleContextMenu,!1),this.canvas.addEventListener("touchstart",this.boundHandleTouchStart,{passive:!1}),this.canvas.addEventListener("touchmove",this.boundHandleTouchMove,{passive:!1}),this.canvas.addEventListener("touchend",this.boundHandleTouchEnd,{passive:!1}),window.addEventListener("gamepadconnected",this.boundHandleGamepadConnected)}_handleKeyDown(t){this.keys[t.key]=!0;for(const e of this.subscribers)e.onKeyDown&&e.onKeyDown(t)}_handleKeyUp(t){this.keys[t.key]=!1;for(const e of this.subscribers)e.onKeyUp&&e.onKeyUp(t)}_handleMouseMove(t){const e=this.getCanvasCoordinates(t.clientX,t.clientY);for(const i of this.subscribers)i.onMouseMove&&i.onMouseMove(e.x,e.y)}_handleMouseDown(t){const e=this.getCanvasCoordinates(t.clientX,t.clientY);for(const i of this.subscribers)i.onMouseDown&&i.onMouseDown(e.x,e.y,t.button)}_handleMouseUp(t){const e=this.getCanvasCoordinates(t.clientX,t.clientY);for(const i of this.subscribers)i.onMouseUp&&i.onMouseUp(e.x,e.y,t.button)}_handleMouseClick(t){const e=this.getCanvasCoordinates(t.clientX,t.clientY);for(const i of this.subscribers)i.onMouseClick&&i.onMouseClick(e.x,e.y,t.button)}_handleContextMenu(t){return t.preventDefault(),!1}_handleMouseEnter(t){const e=this.getCanvasCoordinates(t.clientX,t.clientY);for(const i of this.subscribers)i.onMouseEnter&&i.onMouseEnter(e.x,e.y)}_handleTouchStart(t){t.preventDefault();const e=t.touches[0];if(e){const i=this.getCanvasCoordinates(e.clientX,e.clientY),s={x:i.x,y:i.y};for(const o of this.subscribers)o.onTouchStart&&o.onTouchStart(s.x,s.y)}}_handleTouchMove(t){t.preventDefault();const e=t.touches[0];if(e){const i=this.getCanvasCoordinates(e.clientX,e.clientY);for(const s of this.subscribers)s.onTouchMove&&s.onTouchMove(i.x,i.y)}}_handleTouchEnd(t){t.preventDefault();const e=t.changedTouches[0];if(e){const i=this.getCanvasCoordinates(e.clientX,e.clientY);for(const s of this.subscribers)s.onTouchEnd&&s.onTouchEnd(i.x,i.y)}}_handleGamepadConnected(t){for(const e of this.subscribers)e.onGamepadConnected&&e.onGamepadConnected(t)}updateGamepad(){const t=navigator.getGamepads();if(t){for(let e of t)if(e){this.gamepad=e;const i=.3,s=e.axes[0]||0,o=e.axes[1]||0,n=this.lastGamepadAxes[0]||0,a=this.lastGamepadAxes[1]||0,h=e.axes[2]||0,m=e.axes[3]||0,c=this.lastGamepadAxes[2]||0,_=this.lastGamepadAxes[3]||0;(Math.abs(s-n)>.1||Math.abs(o-a)>.1||Math.abs(h-c)>.1||Math.abs(m-_)>.1)&&this._handleGamepadAxis({leftStick:{x:s,y:o},rightStick:{x:h,y:m},deadZone:i}),this.lastGamepadAxes=[...e.axes];for(let d=0;d<e.buttons.length;d++){const u=e.buttons[d].pressed,f=this.lastGamepadButtons[d]||!1;u&&!f&&this._handleGamepadButton(d)}this.lastGamepadButtons=e.buttons.map(d=>d.pressed);break}}}_handleGamepadButton(t){for(const e of this.subscribers)e.onGamepadButton&&e.onGamepadButton(t)}_handleGamepadAxis(t){for(const e of this.subscribers)e.onGamepadAxis&&e.onGamepadAxis(t)}}class Pa{constructor(t){this.objectManager=t,this.canvas=t.getById("Main").canvas,this.canvasInputMark=this.objectManager.register("MarkJSInput",new Va(this.canvas))}subscribe(t){return this.canvasInputMark.subscribe(t)}unsubscribe(t){return this.canvasInputMark.unsubscribe(t)}update(){this.canvasInputMark.update()}destroy(){this.canvasInputMark.destroy()}}class Ta{constructor(t){this.objectManager=t,this.configManager=this.objectManager.getById("ConfigManager"),this.rumblerIntensity=this.configManager.rumblerIntensity,this.durationMultipler=this.rumblerIntensity/25,this._gamepad=null,this._initSettings(),this._onGamepadConnected=this._refreshGamepad.bind(this),this._onGamepadDisconnected=e=>{this._gamepad===e.gamepad&&this._refreshGamepad()},this._refreshGamepad(),window.addEventListener("gamepadconnected",this._onGamepadConnected),window.addEventListener("gamepaddisconnected",this._onGamepadDisconnected)}_initSettings(){this.rumblerIntensity=this.configManager.rumblerIntensity,this.durationMultipler=this.rumblerIntensity/25}_refreshGamepad(){this._gamepad=navigator.getGamepads?.().find(t=>t?.vibrationActuator)||null}_vibrate(t){if(!(!navigator.vibrate||this.rumblerIntensity===0))try{navigator.vibrate(Math.round(t*this.durationMultipler))}catch(e){console.warn("Mobile vibration failed:",e)}}_rumble({duration:t,weak:e,strong:i}){if(!(!this._gamepad||this.rumblerIntensity===0))try{this._gamepad.vibrationActuator.playEffect("dual-rumble",{duration:Math.round(t*this.durationMultipler),strongMagnitude:Math.min(1,i),weakMagnitude:Math.min(1,e)}).catch(()=>{})}catch(s){console.warn("Haptics rumble failed:",s)}}_patternFor(t){switch(t){case"combine":return{duration:120,weak:.2,strong:1};case"hit":return{duration:60,weak:.3,strong:.7};case"damage":return{duration:120,weak:.2,strong:1};case"confirm":return{duration:40,weak:.6,strong:.1};case"cancel":return{duration:30,weak:.1,strong:.1};case"ui":return{duration:20,weak:.2,strong:0};default:return null}}pulse(t){if(this.rumblerIntensity===0)return;const e=this._patternFor(t);e&&(this._vibrate(e.duration),this._rumble(e))}updateHapticsSettings(){this._initSettings()}getObjectStateHtml(){return"Rumbler: "+this.rumblerIntensity+", Gamepad: "+(this._gamepad?"Connected":"Not connected")+".  "}logObjectInfo(){let t="";t+=`HapticsHandler
`,t+=`Rumbler Intensity: ${this.rumblerIntensity}
`,t+=`Duration Multiplier: ${this.durationMultipler}
`,t+=`Gamepad Connected: ${this._gamepad?"Yes":"No"}
`,console.log(t)}destroy(){window.removeEventListener("gamepadconnected",this._onGamepadConnected),window.removeEventListener("gamepaddisconnected",this._onGamepadDisconnected),this._gamepad=null}}const O=Object.freeze({splash:"splash",mainmenu:"mainmenu",ballsX:"ballsX",settings:"settings",settingsaudio:"settingsaudio",settingsgameplay:"settingsgameplay",settingsaccessibility:"settingsaccessibility",settingsdeveloper:"settingsdeveloper",credits:"credits",howtoplay:"howtoplay",achievements:"achievements"});class za{constructor(t){this.objectManager=t,this.canvas=t.getById("Main").canvas,this.configManager=t.getById("ConfigManager"),this.audioManager=t.getById("AudioHandler"),this.canvasInputHandler=this.objectManager.register("CanvasInputHandler",new Pa(this.objectManager)),this.canvasUIHandler=this.objectManager.register("CanvasUIHandler",new No(this.objectManager)),this.hapticsHandler=this.objectManager.register("HapticsHandler",new Ta(this.objectManager));const e={Theme1:{textColor:"#ffffff",controlColor:"#0080FF",controlSurfaceColor:"#22223b",controlTextColor:"#ffffff",controlBorderColor:"#3d5a80",controlFocusBorderColor:"#ffffff",menuButtonColor:"#22223b",menuButtonActiveColor:"#0080ff",menuButtonClickColor:"#0040ff",menuButtonBorderColor:"#3d5a80",menuButtonFocusBorderColor:"#ffffff",menuButtonFontSize:18,modalSurfaceColor:"#181818",modalBorderColor:"#ffffff",modalTextColor:"#ffffff",modalText2Color:"#888888",modalTextFontSize:20,modalText2FontSize:16,panelSurfaceColor:"#ff0000",panelBorderColor:"#ffffff",borderRadius:10}};this.canvasUIHandler.setTheme(e.Theme1),this.ctx=this.canvas.getContext("2d"),this.currentSceneKey=null,this.currentScene=null,this.devcnt=0}setCurrentScene(t){switch(this.currentScene&&(this.currentScene.exit(),this.objectManager.deregister(this.currentScene),this.currentScene=null),t){case O.splash:this.currentScene=this.objectManager.register("SceneSplash",new ga(this.objectManager));break;case O.mainmenu:this.currentScene=this.objectManager.register("SceneMainmenu",new xa(this.objectManager));break;case O.ballsX:this.currentScene=this.objectManager.register("SceneBallsX",new ya(this.objectManager));break;case O.settings:this.currentScene=this.objectManager.register("SceneSettings",new wa(this.objectManager));break;case O.settingsaudio:this.currentScene=this.objectManager.register("SceneSettingsAudio",new Ma(this.objectManager));break;case O.settingsgameplay:this.currentScene=this.objectManager.register("SceneSettingsGameplay",new Ca(this.objectManager));break;case O.settingsaccessibility:this.currentScene=this.objectManager.register("SceneSettingsAccessibility",new Sa(this.objectManager));break;case O.settingsdeveloper:this.currentScene=this.objectManager.register("SceneSettingsDeveloper",new Ia(this.objectManager));break;case O.howtoplay:this.currentScene=this.objectManager.register("SceneHowToPlay",new Aa(this.objectManager));break;case O.credits:this.currentScene=this.objectManager.register("SceneCredits",new Ba(this.objectManager));break;case O.achievements:this.currentScene=this.objectManager.register("SceneAchievements",new ba(this.objectManager));break;default:alert("Unknown scene key: "+t);break}this.currentSceneKey=t,this.currentScene.enter()}getSceneStateHtml(){let t="";return this.currentScene&&typeof this.currentScene.getSceneStateHtml=="function"&&(t=this.currentScene.getSceneStateHtml()),t}start(){this.devHandler=this.objectManager.register("DevHandler",new ko(this.objectManager)),this.devHandler.enablePanel(this.configManager.dev&&this.configManager.devPanel),this.setCurrentScene(O.splash)}destroy(){this.currentScene.exit(),this.currentScene=null,this.canvasUIHandler.destroy(),this.objectManager.deregister(this.canvasUIHandler),this.canvasInputHandler.destroy(),this.objectManager.deregister(this.canvasInputHandler)}updateFrame(t){const e=this.currentScene.updateFrame(t);e!==null&&this.setCurrentScene(e),this.devHandler.renderPanel()}}class ka{constructor(t){this._config={MasterVolume:80,MusicVolume:80,SfxVolume:80,Theme:"Smileys",UserName:"",UserId:"",GameSize:"Large",Dev:!1,Language:"English",RumblerIntensity:50};const e=(navigator.language||navigator.userLanguage||"en").toLowerCase();e.startsWith("fr")?this._config.Language="French":e.startsWith("es")?this._config.Language="Spanish":e.startsWith("it")?this._config.Language="Italian":e.startsWith("de")&&(this._config.Language="German"),this.key="oh-balls-merge-config",this.objectManager=t,this.loadFromLocalStorage()}get rumblerIntensity(){return this._config.RumblerIntensity}set rumblerIntensity(t){const e=Math.max(0,Math.min(100,parseInt(t,10)||0));this._config.RumblerIntensity=e}get masterVolume(){return this._config.MasterVolume}set masterVolume(t){const e=Math.max(0,Math.min(100,parseInt(t,10)||0));this._config.MasterVolume=e}get musicVolume(){return this._config.MusicVolume}set musicVolume(t){const e=Math.max(0,Math.min(100,parseInt(t,10)||0));this._config.MusicVolume=e}get sfxVolume(){return this._config.SfxVolume}set sfxVolume(t){const e=Math.max(0,Math.min(100,parseInt(t,10)||0));this._config.SfxVolume=e}get theme(){return this._config.Theme}set theme(t){this._config.Theme=String(t)}get userName(){return this._config.UserName}set userName(t){this._config.UserName=String(t)}get userId(){return this._config.UserId}set userId(t){this._config.UserId=String(t)}get language(){return this._config.Language}set language(t){typeof t=="string"&&t.trim().length>0?this._config.Language=t.trim():this._config.Language="English"}get gameSize(){return this._config.GameSize}set gameSize(t){["Small","Medium","Large"].includes(t)?this._config.GameSize=t:this._config.GameSize="Large"}get dev(){return this._config.Dev}set dev(t){this._config.Dev=!!t}get devPanel(){return this._config.DevPanel}set devPanel(t){this._config.DevPanel=!!t}serialize(){return JSON.stringify(this._config)}deserialize(t){try{const e=JSON.parse(t);e.hasOwnProperty("MasterVolume")&&(this.masterVolume=e.MasterVolume),e.hasOwnProperty("MusicVolume")&&(this.musicVolume=e.MusicVolume),e.hasOwnProperty("SfxVolume")&&(this.sfxVolume=e.SfxVolume),e.hasOwnProperty("Theme")&&(this.theme=e.Theme),e.hasOwnProperty("Language")&&(this.language=e.Language),e.hasOwnProperty("UserName")&&(this.userName=e.UserName),e.hasOwnProperty("UserId")&&(this.userId=e.UserId),e.hasOwnProperty("GameSize")&&(this.gameSize=e.GameSize),e.hasOwnProperty("Dev")&&(this.dev=e.Dev),e.hasOwnProperty("DevPanel")&&(this.devPanel=e.DevPanel),e.hasOwnProperty("RumblerIntensity")&&(this.rumblerIntensity=e.RumblerIntensity)}catch(e){throw new Error("Invalid JSON string provided for deserialization: "+e.message)}}saveToLocalStorage(){localStorage.setItem(this.key,this.serialize())}loadFromLocalStorage(){const t=localStorage.getItem(this.key);return t?(this.deserialize(t),!0):!1}getObjectStateHtml(){return"âœ”ï¸"}logObjectInfo(){console.log(this._config)}}class Fa{constructor(t){this._achievements={HighestScores:[],scores:[],balls:[],gamesPlayed:0},this.key="oh-balls-merge-achievements",this.objectManager=t,this.loadFromLocalStorage()}setHighestScore(t,e){if(!t)return;e=Number(e)||0;const i=this._achievements.HighestScores.findIndex(s=>s.GameType===t);i>=0?this._achievements.HighestScores[i].Score=e:this._achievements.HighestScores.push({GameType:t,Score:e})}getHighestScore(t){if(!t)return 0;const e=this._achievements.HighestScores.find(i=>i.GameType===t);return e?e.Score:0}getHighestScoresText(){const t=this._achievements.HighestScores.map(e=>`${e.GameType.replace("BallsX-","")}: ${e.Score}`).join(", ");return t?`Highest scores - ${t}
`:""}doAchievement(t){this.canvasUIHandler??=this.objectManager.getById("CanvasUIHandler"),this.canvasUIHandler.showToast(t,"achievement"),this.audioHandler??=this.objectManager.getById("AudioHandler"),this.audioHandler.audioMark.playSFX("Achievement")}registerScore(t){let e=Math.floor(t/2500);!this._achievements.scores.includes(e)&&e>0&&(this._achievements.scores.push(e),this.doAchievement(`Achievement unlocked!
Score threshold: `+e*2500))}registerBall(t){!this._achievements.balls.includes(t)&&t>=8&&t<=16&&(this._achievements.balls.push(t),this.doAchievement(`Achievement unlocked!
Ball size: `+t))}getLargestBallText(){return this._achievements.balls.length===0?"":`Largest ball created: Size ${Math.max(...this._achievements.balls)}
`}incrementGamesPlayed(){this._achievements.gamesPlayed+=1;const t=this._achievements.gamesPlayed;(t==5||t<100&&t%10===0||t>=100&&t%50===0)&&this.doAchievement(`Achievement unlocked!
Games played: ${t}`)}getGamesPlayedText(){return`Games played: ${this._achievements.gamesPlayed}
`}serialize(){return JSON.stringify(this._achievements)}deserialize(t){try{const e=JSON.parse(t);Array.isArray(e.HighestScores)&&(this._achievements.HighestScores=e.HighestScores.map(i=>({GameType:String(i.GameType),Score:Number(i.Score)||0}))),e.hasOwnProperty("scores")&&(this._achievements.scores=e.scores),e.hasOwnProperty("balls")&&(this._achievements.balls=e.balls),e.hasOwnProperty("gamesPlayed")&&(this._achievements.gamesPlayed=e.gamesPlayed)}catch(e){throw new Error("Invalid JSON string provided for deserialization: "+e.message)}}saveToLocalStorage(){localStorage.setItem(this.key,this.serialize())}loadFromLocalStorage(){const t=localStorage.getItem(this.key);return t?(this.deserialize(t),!0):!1}getObjectStateHtml(){return"âœ”ï¸"}logObjectInfo(){console.log(this._achievements)}}class La{constructor(){this.sfxGain=null,this.volumes={master:100,music:100,sfx:100},this.audioBuffers=new Map,this.preloadedAudioData=new Map,this.activeSources=new Set,this.activeMusicSources=new Set,this.currentMusic=null,this.isMusicPaused=!1,this.musicStartTime=0,this.musicPauseTime=0,this.isInitialized=!1}async waitForAllPreloads(){if(this.preloadedAudioData.size>0)try{return await Promise.all(Array.from(this.preloadedAudioData.values())),!0}catch(t){return alert(`Some audio preloads failed: ${t.message}`),!1}return!0}async initialize(){try{return this.audioContext=new(window.AudioContext||window.webkitAudioContext),this.audioContext.state==="suspended"&&await this.audioContext.resume(),await this.waitForAllPreloads()?(this.masterGain=this.audioContext.createGain(),this.musicGain=this.audioContext.createGain(),this.sfxGain=this.audioContext.createGain(),this.musicGain.connect(this.masterGain),this.sfxGain.connect(this.masterGain),this.masterGain.connect(this.audioContext.destination),this.updateVolumes(),this.isInitialized=!0,!0):!1}catch(t){return alert(`MarkJSAudio initialization failed: ${t.message}`),!1}}async loadAudio(t,e){if(!this.isInitialized)return alert("MarkJSAudio not initialized. Call initialize() first."),!1;try{let i;if(e instanceof ArrayBuffer)i=e.slice(0);else if(e instanceof File)i=await e.arrayBuffer();else{const o=await fetch(e);if(!o.ok)throw new Error(`Failed to fetch audio: ${o.statusText}`);i=await o.arrayBuffer()}const s=await this.audioContext.decodeAudioData(i);return this.audioBuffers.set(t,s),!0}catch(i){return alert(`Failed to load audio "${t}": ${i.message}`),!1}}async loadFromArrayBuffer(t,e){if(!this.isInitialized)return alert("MarkJSAudio not initialized. Call initialize() first."),!1;if(!(e instanceof ArrayBuffer))return alert("loadFromArrayBuffer requires an ArrayBuffer as input."),!1;try{const i=await this.audioContext.decodeAudioData(e.slice(0));return this.audioBuffers.set(t,i),!0}catch(i){return alert(`Failed to load audio from ArrayBuffer "${t}": ${i.message}`),!1}}async preloadAudio(t,e){try{const i=(async()=>{let s;if(e instanceof File)s=await e.arrayBuffer();else{const o=await fetch(e);if(!o.ok)throw new Error(`Failed to fetch audio: ${o.statusText}`);s=await o.arrayBuffer()}return s})();return this.preloadedAudioData.set(t,i),await i,!0}catch(i){return alert(`Failed to preload audio "${t}": ${i.message}`),this.preloadedAudioData.delete(t),!1}}async processPreloadedAudio(t){if(!this.isInitialized)return alert("MarkJSAudio not initialized. Call initialize() first."),!1;const e=this.preloadedAudioData.get(t);if(!e)return alert(`No preloaded audio data found for "${t}".`),!1;try{const s=(await e).slice(0),o=await this.audioContext.decodeAudioData(s);return this.audioBuffers.set(t,o),this.preloadedAudioData.delete(t),!0}catch(i){return alert(`Failed to process preloaded audio "${t}": ${i.message}`),!1}}async processAllPreloadedAudio(){if(!this.isInitialized)return alert("MarkJSAudio not initialized. Call initialize() first."),{preloadsOk:!1,results:[]};const t=await this.waitForAllPreloads(),e=Array.from(this.preloadedAudioData.keys()),i=[];if(!t){for(const s of e)i.push({name:s,success:!1});return{preloadsOk:t,results:i}}for(const s of e){const o=await this.processPreloadedAudio(s);i.push({name:s,success:o})}return{preloadsOk:t,results:i}}unloadAudio(t){let e=!1;return this.audioBuffers.has(t)&&(this.audioBuffers.delete(t),e=!0),this.preloadedAudioData.has(t)&&(this.preloadedAudioData.delete(t),e=!0),e}playSFX(t,e={}){const{loop:i=!1,volume:s=1,fadeIn:o=0}=e;return this._playAudio(t,this.sfxGain,{loop:i,volume:s,fadeIn:o,type:"sfx"})}playMusic(t,e={}){const{loop:i=!0,volume:s=1,fadeIn:o=0,stopCurrent:n=!0}=e;n&&this.currentMusic&&this.stopMusic();const a=this._playAudio(t,this.musicGain,{loop:i,volume:s,fadeIn:o,type:"music"});return a&&(this.currentMusic={source:a,name:t,startTime:this.audioContext.currentTime,loop:i},this.isMusicPaused=!1,this.activeMusicSources.add(a)),a}_playAudio(t,e,i){if(!this.isInitialized)return alert("MarkJSAudio not initialized."),null;const s=this.audioBuffers.get(t);if(!s)return alert(`Audio "${t}" not loaded.`),null;try{const o=this.audioContext.createBufferSource();o.buffer=s,o.loop=i.loop;const n=this.audioContext.createGain();return o.connect(n),n.connect(e),n.gain.setValueAtTime(i.volume,this.audioContext.currentTime),i.fadeIn>0&&(n.gain.setValueAtTime(0,this.audioContext.currentTime),n.gain.linearRampToValueAtTime(i.volume,this.audioContext.currentTime+i.fadeIn)),this.activeSources.add(o),o.onended=()=>{this.activeSources.delete(o),i.type==="music"&&(this.activeMusicSources.delete(o),this.currentMusic&&this.currentMusic.source===o&&(this.currentMusic=null))},o.start(0),o}catch(o){return alert(`Failed to play audio "${t}": ${o.message}`),null}}stopMusic(){this.activeMusicSources.forEach(t=>{try{t.stop()}catch{}}),this.activeMusicSources.clear(),this.currentMusic=null,this.isMusicPaused=!1}pauseMusic(){if(this.currentMusic&&!this.isMusicPaused){if(this.musicPauseTime=this.audioContext.currentTime,this.currentMusic.source){try{this.currentMusic.source.stop()}catch{}this.activeSources.delete(this.currentMusic.source),this.activeMusicSources.delete(this.currentMusic.source),this.currentMusic.source=null}return this.isMusicPaused=!0,!0}return!1}resumeMusic(){if(this.currentMusic&&this.isMusicPaused){const t=this.musicPauseTime-this.currentMusic.startTime,e=this.audioBuffers.get(this.currentMusic.name);if(e){const i=this.audioContext.createBufferSource();i.buffer=e,i.loop=this.currentMusic.loop,i.connect(this.musicGain);const s=this.currentMusic.loop?t%e.duration:t;return i.start(0,Math.max(0,s)),this.currentMusic.source=i,this.currentMusic.startTime=this.audioContext.currentTime-t,this.activeMusicSources.add(i),this.activeSources.add(i),i.onended=()=>{this.activeSources.delete(i),this.activeMusicSources.delete(i),this.currentMusic&&this.currentMusic.source===i&&(this.currentMusic=null,this.isMusicPaused=!1)},this.isMusicPaused=!1,!0}}return!1}stopAll(){this.activeSources.forEach(t=>{try{t.stop()}catch{}}),this.activeSources.clear(),this.activeMusicSources.clear(),this.currentMusic=null,this.isMusicPaused=!1}setVolume(t,e){e=Math.max(0,Math.min(100,e)),this.volumes[t]=e,this.updateVolumes()}getVolume(t){return this.volumes[t]}updateVolumes(){if(!this.isInitialized)return;const t=this.volumes.master/100,e=this.volumes.music/100*t,i=this.volumes.sfx/100*t;this.masterGain.gain.setValueAtTime(t,this.audioContext.currentTime),this.musicGain.gain.setValueAtTime(e,this.audioContext.currentTime),this.sfxGain.gain.setValueAtTime(i,this.audioContext.currentTime)}fadeOut(t,e=1){if(!(!t||!this.isInitialized))try{const i=this.audioContext.currentTime,s=t.connect?this.audioContext.createGain():null;s&&(t.disconnect(),t.connect(s),s.connect(this.musicGain),s.gain.setValueAtTime(1,i),s.gain.linearRampToValueAtTime(0,i+e),setTimeout(()=>{try{t.stop()}catch{}},e*1e3))}catch(i){alert(`Fade out error: ${i.message}`)}}async transitionMusic(t,e=2,i={}){if(!this.audioBuffers.has(t))return alert(`Music track "${t}" not loaded.`),!1;const s=this.currentMusic?this.currentMusic.source:null;return this.playMusic(t,{...i,fadeIn:e,volume:i.volume||1,stopCurrent:!1}),s&&this.fadeOut(s,e),!0}cleanup(){this.stopAll(),this.audioContext&&(this.audioContext.close(),this.audioContext=null),this.audioBuffers.clear(),this.preloadedAudioData.clear(),this.activeSources.clear(),this.activeMusicSources.clear(),this.currentMusic=null,this.isInitialized=!1}getState(){return{isInitialized:this.isInitialized,audioContextState:this.audioContext?this.audioContext.state:"none",loadedAudio:Array.from(this.audioBuffers.keys()),preloadedAudio:Array.from(this.preloadedAudioData.keys()),activeSources:this.activeSources.size,activeMusicSources:this.activeMusicSources.size,currentMusic:this.currentMusic?this.currentMusic.name:null,isMusicPaused:this.isMusicPaused,volumes:{...this.volumes}}}}class Ha{constructor(t){this.objectManager=t,this.configManager=this.objectManager.getById("ConfigManager"),this.audioMark=this.objectManager.register("MarkJSAudio",new La),this.loadedAudio=new Set,this.audioEnabled=this.configManager.masterVolume!==0,this.theme=null,this.currentThemeAudioItems=new Set,this.musicPlaying=!1,this.gameBGMusic="",this.gameCombineSFX=[],this.preloadCoreAudio(),this.preloadThemeAudio(this.configManager.theme),this.setGameAudio()}doToast(t){try{this.canvasUIHandler??=this.objectManager.getById("CanvasUIHandler"),this.canvasUIHandler&&this.canvasUIHandler.showToast(t,"error")}catch{}}async initialize(){if(!await this.audioMark.initialize()){const i="Audio initialization failed.";console.error(i),this.doToast(i);return}const e=await this.audioMark.processAllPreloadedAudio();e.preloadsOk===!1&&(this.doToast("Audio initialization failed."),e.results.forEach(i=>{if(!i.success){const s=`Preload audio failure '${i.name||"unknown"}'`;console.error(s)}}))}preloadAudio(t,e){this.loadedAudio.has(e)||this.audioMark.preloadAudio(e,t).then(i=>{if(i===!0)this.loadedAudio.add(e);else{const s=`Failed to preload audio '${e}' (${t})`;console.error(s),this.doToast(s)}})}preloadCoreAudio(){Es.filter(e=>e&&e.name&&e.url).forEach(e=>this.preloadAudio(e.url,e.name))}preloadThemeAudio(t){let e=zi[t]||[];e=e.filter(i=>i&&i.name&&i.url),e.forEach(i=>{this.currentThemeAudioItems.add(i.name),this.preloadAudio(i.url,i.name),i.use==="bgmusic"&&(this.themeBGMusic=i.name)}),this.theme=t}async switchThemeAudio(t){if(this.theme===t)return;for(const i of this.currentThemeAudioItems)this.removeAudio(i);this.currentThemeAudioItems.clear();let e=zi[t]||[];e=e.filter(i=>i&&i.name&&i.url),e.forEach(i=>this.currentThemeAudioItems.add(i.name)),this.setGameAudio(),await Promise.all(e.map(i=>this.loadAudio(i.name,i.url))),this.theme=t}async loadAudio(t,e){await this.audioMark.loadAudio(t,e),this.loadedAudio.add(t)}removeAudio(t){try{this.audioMark.unloadAudio(t)}catch{}this.loadedAudio.delete(t)}playSFX(t){this.audioEnabled&&this.loadedAudio.has(t)&&this.audioMark.playSFX(t)}playMusic(t){this.audioEnabled&&this.loadedAudio.has(t)&&(this.audioMark.playMusic(t,{loop:!0}),this.musicPlaying=!0)}transitionMusic(t){this.audioEnabled&&this.loadedAudio.has(t)&&this.audioMark.transitionMusic(t,4,{loop:!0})}stopAll(){this.audioMark.stopAll(),this.musicPlaying=!1}stopMusic(){this.audioMark.stopMusic(),this.musicPlaying=!1}setVolume(){this.audioMark.setVolume("master",this.configManager.masterVolume),this.audioMark.setVolume("music",this.configManager.musicVolume),this.audioMark.setVolume("sfx",this.configManager.sfxVolume)}updateAudioSettings(){this.audioEnabled=this.configManager.masterVolume!==0,this.setVolume(),this.audioEnabled?this.musicPlaying||this.playMusic("MenuMusic"):this.stopAll()}isAudioInitialized(){return this.audioMark.isInitialized}getAudioState(){return this.audioMark.getState()}isAllPreloadedAudioProcessed(){const t=this.audioMark.getState();return t.preloadedAudio.length===0&&t.loadedAudio.length>0}getAudioProcessingStatus(){const t=this.audioMark.getState();return{isProcessingComplete:this.isAllPreloadedAudioProcessed(),preloadedCount:t.preloadedAudio.length,loadedCount:t.loadedAudio.length,preloadedItems:t.preloadedAudio,loadedItems:t.loadedAudio}}setGameAudio(){this.gameBGMusic=(zi[this.configManager.theme]||[]).find(e=>e.use==="bgmusic")?.name||"MenuMusic";let t=(zi[this.configManager.theme]||[]).filter(e=>e.use==="combine").map(e=>e.name);t.length>0?this.gameCombineSFX=t:this.gameCombineSFX=(Es||[]).filter(e=>e.use==="combine").map(e=>e.name)}getGameBGMusic(){return this.gameBGMusic}getGameCombineSFX(){return this.gameCombineSFX}getObjectStateHtml(){return this.theme+". "+this.loadedAudio.size+" audio files."}logObjectInfo(){const t=(zi[this.theme]||[]).length,e=Es.length;let i="";i+=`AudioHandler
`,i+=`Theme: ${this.theme}, Audio: ${t}
`,i+=`Core Audio: ${e}
`,i+=`Game BGMusic: ${this.gameBGMusic}, Combine SFX: ${(this.gameCombineSFX||[]).join(", ")}
`,i+=`Audio Loaded: ${this.loadedAudio.size}
`;for(const s of this.loadedAudio)i+=` - ${s}
`;console.log(i),console.log(this.audioMark.getState())}}class Da{constructor(t){this.objectManager=t,this.images=new Map,this.loadingPromises=new Map,this.currentTheme=null,this.currentThemeImageInfo=null,this.isThemeLoaded=!1,this.themeEntry=null,this.configManager=this.objectManager.getById("ConfigManager"),this.preloadCoreImages(),this.preloadThemeImages(this.configManager.theme)}waitForImagesLoaded(t,e=1e4,i="images"){const s=Date.now(),o=()=>{if(t.every(n=>this.isLoaded(n)))return!0;if(Date.now()-s>e)return alert(`Timeout waiting for ${i}`),!1;setTimeout(o,50)};o()}getThemeImageInfo(t){return this.themeEntry=Zs[t]||{imageCount:0,imageId:"?"},this.themeEntry.imageCount>0&&this.themeEntry.imageId?Array.from({length:this.themeEntry.imageCount},(i,s)=>{const o=String(s+1).padStart(2,"0");return{url:`images/${this.themeEntry.imageId}/${this.themeEntry.imageId}${o}.${this.themeEntry.imageType}`,name:`${this.themeEntry.imageId}${o}`}}):[]}checkThemeImagesLoaded(t,e=1e4){if(this.isThemeLoaded===!0)return;const s=this.getThemeImageInfo(t).map(o=>o.name);this.waitForImagesLoaded(s,e,`theme images: ${t}`),this.isThemeLoaded=!0}async checkCoreImagesLoaded(t=1e4){const e=qs.map(i=>i.name);return this.waitForImagesLoaded(e,t,"core images")}async loadImage(t,e){const i=e;if(this.images.has(i))return this.images.get(i);if(this.loadingPromises.has(i))return this.loadingPromises.get(i);const s=new Promise((o,n)=>{const a=new Image;a.onload=()=>{this.images.set(i,a),this.loadingPromises.delete(i);let h=!1,m=1,c=a.width,_=a.height,d=0;t.split("/").pop().endsWith(".x.png")&&(m=Math.floor(a.width/a.height),h=!0,c=a.height,d=3),a.data={animated:h,numFrames:m,imgHeight:_,imgWidth:c,numHoldFrames:d},o(a)},a.onerror=()=>{this.loadingPromises.delete(i),alert(`Failed to load image: ${t}`),o(null)},a.src=t});return this.loadingPromises.set(i,s),s}getImage(t){return this.images.get(t)||null}isLoaded(t){return this.images.has(t)}isLoading(t){return this.loadingPromises.has(t)}preloadImages(t){t.forEach(e=>{this.loadImage(e.url,e.name)})}preloadCoreImages(){this.preloadImages(qs)}preloadThemeImages(t){this.currentThemeImageInfo=this.getThemeImageInfo(t),this.preloadImages(this.currentThemeImageInfo),this.currentThemeName=t}switchThemeImages(t){this.currentThemeName!==t&&(this.currentThemeImageInfo.forEach(e=>{this.removeImage(e.name)}),this.currentThemeImageInfo=null,this.isThemeLoaded=!1,this.preloadThemeImages(t))}removeImage(t){this.images.delete(t),this.loadingPromises.delete(t)}getObjectStateHtml(){return this.currentThemeName+". "+this.images.size+" images."}logObjectInfo(){const t=qs.length;let e="";e+=`Object: ${this.registeredName||"N/A"}
`,e+=`Theme '${this.currentThemeName}' Images: ${this.themeEntry.imageCount}.  Id: ${this.themeEntry.imageId}
`,e+=`Core Images: ${t}
`,e+=`Images Loaded: ${this.images.size}, Loading: ${this.loadingPromises.size}
`;for(const[i,s]of this.images.entries())e+=` - ${i}: ${s.src}
`;console.log(e)}}class Ea{constructor(t){this.objectManager=t,this.configManager=this.objectManager.getById("ConfigManager"),this.setLocale(),this.text={Accessibility:{fr:"AccessibilitÃ©",es:"Accesibilidad",it:"AccessibilitÃ ",de:"Barrierefreiheit"},"Accessibility settings updated":{fr:"ParamÃ¨tres dâ€™accessibilitÃ© mis Ã  jour",es:"ConfiguraciÃ³n de accesibilidad actualizada",it:"Impostazioni di accessibilitÃ  aggiornate",de:"Barrierefreiheits-Einstellungen aktualisiert"},Achievements:{fr:"SuccÃ¨s",es:"Logros",it:"Obiettivi",de:"Errungenschaften"},Audio:{fr:"Audio",es:"Audio",it:"Audio",de:"Audio"},"Audio disabled":{fr:"Audio dÃ©sactivÃ©",es:"Audio desactivado",it:"Audio disattivato",de:"Audio deaktiviert"},"Audio settings updated":{fr:"ParamÃ¨tres audio mis Ã  jour",es:"ConfiguraciÃ³n de audio actualizada",it:"Impostazioni audio aggiornate",de:"Audioeinstellungen aktualisiert"},Credits:{fr:"CrÃ©dits",es:"CrÃ©ditos",it:"Crediti",de:"Credits"},Disabled:{fr:"DÃ©sactivÃ©",es:"Desactivado",it:"Disattivato",de:"Deaktiviert"},Enter:{fr:"Entrer",es:"Entrar",it:"Invio",de:"Eingabe"},Exit:{fr:"Quitter",es:"Salir",it:"Esci",de:"Beenden"},"Game over":{fr:"Fin de la partie",es:"Fin del juego",it:"Fine del gioco",de:"Spiel vorbei"},"Game paused":{fr:"Jeu en pause",es:"Juego en pausa",it:"Gioco in pausa",de:"Spiel pausiert"},"Game Size":{fr:"Taille du jeu",es:"TamaÃ±o del juego",it:"Dimensione del gioco",de:"SpielgrÃ¶ÃŸe"},Gameplay:{fr:"JouabilitÃ©",es:"Jugabilidad",it:"Gameplay",de:"Gameplay"},"Gameplay settings updated":{fr:"ParamÃ¨tres de jouabilitÃ© mis Ã  jour",es:"ConfiguraciÃ³n de jugabilidad actualizada",it:"Impostazioni di gameplay aggiornate",de:"Gameplay-Einstellungen aktualisiert"},"High score to beat":{fr:"Record Ã  battre",es:"RÃ©cord a superar",it:"Record da battere",de:"Zu schlagender highscore"},Highest:{fr:"Record",es:"RÃ©cord",it:"Record",de:"Rekord"},Home:{fr:"Accueil",es:"Inicio",it:"Home",de:"Startseite"},Install:{fr:"Installer",es:"Instalar",it:"Installa",de:"Installieren"},Language:{fr:"Langue",es:"Idioma",it:"Lingua",de:"Sprache"},Loading:{fr:"Chargement",es:"Cargando",it:"Caricamento",de:"Wird geladen"},"How to play":{fr:"Comment jouer",es:"CÃ³mo jugar",it:"Come si gioca",de:"So spielt man"},"Main Menu":{fr:"Menu principal",es:"MenÃº principal",it:"Menu principale",de:"HauptmenÃ¼"},"Master Volume":{fr:"Volume gÃ©nÃ©ral",es:"Volumen maestro",it:"Volume principale",de:"GesamtlautstÃ¤rke"},"Music Volume":{fr:"Volume de la musique",es:"Volumen de la mÃºsica",it:"Volume musica",de:"MusiklautstÃ¤rke"},Muted:{fr:"Muet",es:"Silenciado",it:"Silenziato",de:"Stumm"},"New High Score!":{fr:"Nouveau record !",es:"Â¡Nuevo rÃ©cord!",it:"Nuovo record!",de:"Neuer Highscore!"},No:{fr:"Non",es:"No",it:"No",de:"Nein"},Previous:{fr:"PrÃ©cÃ©dent",es:"Anterior",it:"Precedente",de:"ZurÃ¼ck"},Restart:{fr:"Recommencer",es:"Reiniciar",it:"Ricominciare",de:"Neustart"},Resume:{fr:"Reprendre",es:"Reanudar",it:"Riprendere",de:"Fortsetzen"},"Rumbler Intensity":{fr:"IntensitÃ© du vibreur",es:"Intensidad de vibraciÃ³n",it:"IntensitÃ  vibrazione",de:"VibrationsintensitÃ¤t"},Save:{fr:"Enregistrer",es:"Guardar",it:"Salva",de:"Speichern"},Score:{fr:"Score",es:"PuntuaciÃ³n",it:"Punteggio",de:"Punktzahl"},Settings:{fr:"ParamÃ¨tres",es:"ConfiguraciÃ³n",it:"Impostazioni",de:"Einstellungen"},"SFX Volume":{fr:"Volume des effets",es:"Volumen de efectos",it:"Volume effetti",de:"EffektlautstÃ¤rke"},"Start game":{fr:"DÃ©marrer le jeu",es:"Iniciar juego",it:"Avvia gioco",de:"Spiel starten"},Theme:{fr:"ThÃ¨me",es:"Tema",it:"Tema",de:"Thema"},Version:{fr:"Version",es:"VersiÃ³n",it:"Versione",de:"Version"},"Would you like to restart or exit?":{fr:"Voulez-vous recommencer ou quitter ?",es:"Â¿Quieres reiniciar o salir?",it:"Vuoi ricominciare o uscire?",de:"MÃ¶chtest du neu starten oder das Spiel beenden?"},"Would you like to resume or exit?":{fr:"Voulez-vous reprendre ou quitter ?",es:"Â¿Quieres reanudar o salir?",it:"Vuoi riprendere o uscire?",de:"MÃ¶chtest du fortsetzen oder das Spiel beenden?"},"Your Score":{fr:"Votre score",es:"Tu puntuaciÃ³n",it:"Il tuo punteggio",de:"Dein punktestand"},Yes:{fr:"Oui",es:"SÃ­",it:"SÃ¬",de:"Ja"}}}setLocale(){switch(this.configManager.language){case"French":this.locale="fr";break;case"Spanish":this.locale="es";break;case"Italian":this.locale="it";break;case"German":this.locale="de";break;default:this.locale="en";break}}translate(t){if(this.locale==="en")return t;const e=this.text[t];return e&&e[this.locale]?e[this.locale]:t+"?"}getTextCredits(){let t=`Developed & Published by Harrison Digital - https://harrisondigital.dev/ 
`;return t+=`Game assets from: Pixabay & Jim Hall.
`,t+=`Emoji graphics based on Noto Emoji by Google, licensed under the Apache License 2.0.

`,t+=`Feedback & support, please email: ohballs@harrisondigital.dev
Please review the game & tell a friend. Thank you for playing!`,t}getTextHowToPlay(){let t="";switch(this.locale){case"fr":t=`Laissez tomber des balles depuis le haut pour les fusionner.
Les balles identiques fusionnent lorsqu'elles se touchent.
Fusionnez de grandes balles pour un meilleur score.
Ã‰vitez que la pile n'atteigne le haut.
Visez le meilleur score.
Clavier, souris, tactile ou manette pour jouer.
Amusez-vous Ã  fusionner des balles !`;break;case"es":t=`Suelta bolas desde la parte superior para fusionarlas.
Las bolas iguales se fusionan cuando chocan.
Fusiona bolas mÃ¡s grandes para obtener mÃ¡s puntos.
Evita que la pila llegue a la parte superior.
Apunta al puntaje mÃ¡s alto.
Teclado, ratÃ³n, tÃ¡ctil o mando para jugar.
Â¡DiviÃ©rtete fusionando bolas!`;break;case"it":t=`Lascia cadere le palle dall'alto per unirle.
Le palle uguali si uniscono quando collidono.
Unisci palle piÃ¹ grandi per ottenere punteggi piÃ¹ alti.
Evita che la pila raggiunga la parte superiore.
Punta al punteggio piÃ¹ alto.
Tastiera, mouse, touch o gamepad per giocare.
Divertiti a unire le palle!`;break;case"de":t=`Lass Kugeln von oben fallen, um sie zu verschmelzen.
Gleiche Kugeln verschmelzen beim ZusammenstoÃŸ.
Verschmelze grÃ¶ÃŸere Kugeln fÃ¼r hÃ¶here Punktzahlen.
Vermeide, dass der Stapel den oberen Rand erreicht.
Ziele auf die hÃ¶chste Punktzahl.
Tastatur, Maus, Touch oder Gamepad zum Spielen.
Viel SpaÃŸ beim Verschmelzen der Kugeln!`;break;default:t=`Drop balls from the top to merge them.
Matching balls merge when they collide.
Merge larger balls for higher scores.
Avoid letting the stack reach the top.
Aim for the highest score.
Use keyboard, mouse, touch, or gamepad to play.
Have fun playing with your balls!`;break}return t}getText(t){let e="";switch(t){case"How to play":e=this.getTextHowToPlay();break;case"Credits":e=this.getTextCredits();break;default:e="Unknown";break}return e}}class qa{constructor(t){this.objectManager=t,this.sceneManager=!1}enabled(){return this.isSteamEnabled}doExit(){}doInit(){}async waitForInit(){}getObjectStateHtml(){if(!this.isSteamEnabled)return"Null"}}const Ra="modulepreload",Na=function(r,t){return new URL(r,t).href},mo={},Oa=function(t,e,i){let s=Promise.resolve();if(e&&e.length>0){let m=function(c){return Promise.all(c.map(_=>Promise.resolve(_).then(d=>({status:"fulfilled",value:d}),d=>({status:"rejected",reason:d}))))};const n=document.getElementsByTagName("link"),a=document.querySelector("meta[property=csp-nonce]"),h=a?.nonce||a?.getAttribute("nonce");s=m(e.map(c=>{if(c=Na(c,i),c in mo)return;mo[c]=!0;const _=c.endsWith(".css"),d=_?'[rel="stylesheet"]':"";if(i)for(let f=n.length-1;f>=0;f--){const p=n[f];if(p.href===c&&(!_||p.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${c}"]${d}`))return;const u=document.createElement("link");if(u.rel=_?"stylesheet":Ra,_||(u.as="script"),u.crossOrigin="",u.href=c,h&&u.setAttribute("nonce",h),document.head.appendChild(u),_)return new Promise((f,p)=>{u.addEventListener("load",f),u.addEventListener("error",()=>p(new Error(`Unable to preload CSS for ${c}`)))})}))}function o(n){const a=new Event("vite:preloadError",{cancelable:!0});if(a.payload=n,window.dispatchEvent(a),!a.defaultPrevented)throw n}return s.then(n=>{for(const a of n||[])a.status==="rejected"&&o(a.reason);return t().catch(o)})};function Ua(r={}){const{immediate:t=!1,onNeedRefresh:e,onOfflineReady:i,onRegistered:s,onRegisteredSW:o,onRegisterError:n}=r;let a,h;const m=async(_=!0)=>{await h};async function c(){if("serviceWorker"in navigator){if(a=await Oa(async()=>{const{Workbox:_}=await import("./workbox-window.prod.es5-BIl4cyR9.js");return{Workbox:_}},[],import.meta.url).then(({Workbox:_})=>new _("./sw.js",{scope:"./",type:"classic"})).catch(_=>{n?.(_)}),!a)return;a.addEventListener("activated",_=>{(_.isUpdate||_.isExternal)&&window.location.reload()}),a.addEventListener("installed",_=>{_.isUpdate||i?.()}),a.register({immediate:t}).then(_=>{o?o("./sw.js",_):s?.(_)}).catch(_=>{n?.(_)})}}return h=c(),m}Ua({immediate:!0,onNeedRefresh(){window.location.reload()}});const ja="0.260113.0";class Ga{constructor(){this.registry={}}keyExists(t){return this.registry.hasOwnProperty(t)}register(t,e){this.keyExists(t)&&alert(`ObjectManager: key id '${t}' is already registered!`);const i=e.constructor.name;return e.registeredName||(e.registeredName=t),this.registry[t]={key:t,objectName:i,object:e},e}deregister(t){const e=Object.entries(this.registry).find(([,o])=>o.object===t);if(!e)return alert("ObjectManager: object not found in registry!"),null;const[i,s]=e;return delete this.registry[i],s.object}getById(t){return this.keyExists(t)?this.registry[t].object:(alert(`ObjectManager: key '${t}' does not exist!`),null)}getObjects(){return Object.keys(this.registry)}getAllObjects(){return Object.values(this.registry)}}class Wa{constructor(){this.canvas=document.getElementById("idCanvasControl"),this.running=!1,this.rafId=null,this.deferredPrompt=null,window.addEventListener("beforeinstallprompt",t=>{this.deferredPrompt=t}),this.objectManager=new Ga,this.objectManager.register("Main",this),this.objectManager.register("ConfigManager",new ka(this.objectManager)),this.imageHandler=this.objectManager.register("ImageHandler",new Da(this.objectManager)),this.audioHandler=this.objectManager.register("AudioHandler",new Ha(this.objectManager)),this.objectManager.register("TranslationManager",new Ea(this.objectManager)),this.sceneManager=this.objectManager.register("SceneManager",new za(this.objectManager)),this.objectManager.register("AchievementsManager",new Fa(this.objectManager)),this.objectManager.register("SteamHandler",new qa(this.objectManager)),this.clock={deltaTime:0,currentTime:performance.now()}}gameLoop(){if(this.running){try{const t=performance.now(),e=this.clock.currentTime;this.clock.currentTime=t,this.clock.deltaTime=this.clock.currentTime-e,this.sceneManager.updateFrame(this.clock.deltaTime)}catch(t){alert("Main loop error: "+t),console.error(t),this.running=!1}this.rafId=requestAnimationFrame(()=>this.gameLoop())}}start(){this.running||(this.sceneManager.start(),this.running=!0,this.gameLoop())}destroy(){this.running=!1,this.rafId&&(cancelAnimationFrame(this.rafId),this.rafId=null),this.config&&this.config.saveToLocalStorage(),this.config=null,this.sceneManager=null,this.inputHandler=null}}document.addEventListener("DOMContentLoaded",()=>{window.main=new Wa,window.main.start()});window.addEventListener("beforeunload",()=>{window.main&&window.main.destroy()});
